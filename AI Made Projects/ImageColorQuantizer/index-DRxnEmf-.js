(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const w of document.querySelectorAll('link[rel="modulepreload"]'))n(w);new MutationObserver(w=>{for(const a of w)if(a.type==="childList")for(const t of a.addedNodes)t.tagName==="LINK"&&t.rel==="modulepreload"&&n(t)}).observe(document,{childList:!0,subtree:!0});function d(w){const a={};return w.integrity&&(a.integrity=w.integrity),w.referrerPolicy&&(a.referrerPolicy=w.referrerPolicy),w.crossOrigin==="use-credentials"?a.credentials="include":w.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(w){if(w.ep)return;w.ep=!0;const a=d(w);fetch(w.href,a)}})();const fe={imageUpload:document.getElementById("imageUpload"),paletteUpload:document.getElementById("paletteUpload"),paletteFileNameEl:document.getElementById("paletteFileName"),colorSlider:document.getElementById("colorSlider"),sliderValueEl:document.getElementById("sliderValue"),algorithmSelect:document.getElementById("algorithmSelect"),ditheringCheckbox:document.getElementById("ditheringCheckbox"),collapseThresholdInput:document.getElementById("collapseThresholdInput"),collapseThresholdError:document.getElementById("collapseThresholdError"),maskColorInput:document.getElementById("maskColorInput"),remapAllBtn:document.getElementById("remapAllBtn"),exportPaletteBtn:document.getElementById("exportPaletteBtn"),collapseAllBtn:document.getElementById("collapseAllBtn"),runFullAnalysisBtn:document.getElementById("runFullAnalysisBtn"),resultContainer:document.getElementById("resultContainer"),analysisContainer:document.getElementById("analysisContainer"),paletteSectionContainer:document.getElementById("paletteSectionContainer"),fullAnalysisResults:document.getElementById("fullAnalysisResults"),analysisTableContainer:document.getElementById("analysisTableContainer"),analysisTableBody:document.getElementById("analysisTableBody"),psnrValueEl:document.getElementById("psnrValue"),status:document.getElementById("status"),fileNameEl:document.getElementById("fileName"),originalImageSizeEl:document.getElementById("originalImageSize"),quantizedImageSizeEl:document.getElementById("quantizedImageSize"),appContainer:document.getElementById("appContainer"),paletteContainer:document.getElementById("paletteContainer"),customColorPicker:document.getElementById("customColorPicker"),rgbTabBtn:document.getElementById("rgbTabBtn"),hslTabBtn:document.getElementById("hslTabBtn"),rgbPanel:document.getElementById("rgbPanel"),hslPanel:document.getElementById("hslPanel"),confirmColorBtn:document.getElementById("confirmColorBtn"),cancelColorBtn:document.getElementById("cancelColorBtn"),nativeColorPickerInCustom:document.getElementById("nativeColorPickerInCustom"),hslH:document.getElementById("hslH"),hslS:document.getElementById("hslS"),hslL:document.getElementById("hslL"),hslHValue:document.getElementById("hslHValue"),hslSValue:document.getElementById("hslSValue"),hslLValue:document.getElementById("hslLValue"),hslCurrentColorDisplay:document.getElementById("hslCurrentColorDisplay"),originalCanvas:document.getElementById("originalCanvas"),quantizedCanvas:document.getElementById("quantizedCanvas"),quantizedImageWrapper:document.getElementById("quantizedImageWrapper"),selectionOverlay:document.getElementById("selectionOverlay"),quantizedImage:document.getElementById("quantizedImage")};fe.originalCtx=fe.originalCanvas.getContext("2d");fe.quantizedCtx=fe.quantizedCanvas.getContext("2d");fe.originalCtx.imageSmoothingEnabled=!1;fe.quantizedCtx.imageSmoothingEnabled=!1;const S={originalImageData:null,currentPalette:[],currentImageFile:null,isCustomPaletteActive:!1,currentObjectUrl:null,paletteSwatchLookup:new Map,hoveredPaletteSwatch:null,maskColor:[0,255,0],paletteMaskPreviewActive:!1,paletteMaskTargetColor:null,currentQuantizedImageData:null,originalColorForEditing:null,latestPreviewColor:null,preEditImageData:null,currentEditedSwatch:null};function ie(f,l=!1){fe.status.textContent=f,fe.status.style.color=l?"#dc2626":"#4b5563"}function xt(f){[fe.colorSlider,fe.algorithmSelect,fe.runFullAnalysisBtn,fe.exportPaletteBtn,fe.collapseAllBtn,fe.ditheringCheckbox,fe.paletteUpload,fe.collapseThresholdInput].forEach(d=>{d&&(d.disabled=!f)})}function Pa(f,l=2){if(f===0)return"0 Bytes";const d=1024,n=l<0?0:l,w=["Bytes","KB","MB","GB","TB"],a=Math.floor(Math.log(f)/Math.log(d)),t=f/Math.pow(d,a);return`${parseFloat(t.toFixed(n))} ${w[a]}`}const un=20;function zt(f){const l=new Map,d=f?.data;if(!d)return[];for(let n=0;n<d.length;n+=4){if(d[n+3]<=128)continue;const w=`${d[n]},${d[n+1]},${d[n+2]}`;l.has(w)||l.set(w,[d[n],d[n+1],d[n+2]])}return Array.from(l.values())}function Lt(f,l){if(!f||!l)return null;const d=new Uint8ClampedArray(l.width*l.height*4),n=f.data;for(let w=0;w<l.height;w++){const a=((l.y+w)*f.width+l.x)*4,t=w*l.width*4;d.set(n.subarray(a,a+l.width*4),t)}return new ImageData(d,l.width,l.height)}function dn(f,l,d){if(!f||!l||!d)return;const n=f.data,w=l.data;for(let a=0;a<d.height;a++){const t=((d.y+a)*f.width+d.x)*4,o=a*d.width*4;n.set(w.subarray(o,o+d.width*4),t)}}function Ge(f){return f?new ImageData(new Uint8ClampedArray(f.data),f.width,f.height):null}function Ue(f){return(f||[]).map(l=>[...l])}class cn{constructor(){this.history=[],this.historyLimit=un,this.applySnapshotHandler=null,this.statusHandler=null,this.applyImageHandler=null,this.applyPaletteHandler=null,this.selectionBounds=null,this.selectionPalette=null,this.lastRedoSnapshot=null}setHandlers({applySnapshot:l,updateStatus:d,applyImageUpdate:n,applyPalette:w}){this.applySnapshotHandler=typeof l=="function"?l:null,this.statusHandler=typeof d=="function"?d:null,this.applyImageHandler=typeof n=="function"?n:null,this.applyPaletteHandler=typeof w=="function"?w:null}clearHistory(){this.history=[],this.lastRedoSnapshot=null}saveSnapshot(l){const d=S.currentQuantizedImageData;if(!d)return!1;const n={label:l,imageData:Ge(d),palette:Ue(S.currentPalette)};this.history.push(n);const w=S.historyLimit||this.historyLimit;return this.history.length>w&&this.history.shift(),this.lastRedoSnapshot=null,!0}undo(){if(!this.history.length)return this.statusHandler&&this.statusHandler("Nothing to undo.",!0),!1;const l=this.history.pop();this.lastRedoSnapshot={label:l.label,imageData:Ge(S.currentQuantizedImageData),palette:Ue(S.currentPalette),historySnapshot:l};const d={label:l.label,imageData:Ge(l.imageData),palette:Ue(l.palette)};return this.applySnapshotHandler?this.applySnapshotHandler(d):(S.currentQuantizedImageData=d.imageData,S.currentPalette=d.palette),this.statusHandler&&this.statusHandler(d.label?`Undid ${d.label}.`:"Undid last action."),this.refreshActivePalette(),!0}redo(){if(!this.lastRedoSnapshot)return this.statusHandler&&this.statusHandler("Nothing to redo.",!0),!1;const l=this.lastRedoSnapshot;if(this.lastRedoSnapshot=null,l.historySnapshot){this.history.push(l.historySnapshot);const n=S.historyLimit||this.historyLimit;this.history.length>n&&this.history.shift()}const d={label:l.label,imageData:Ge(l.imageData),palette:Ue(l.palette)};return this.applySnapshotHandler?this.applySnapshotHandler(d):(S.currentQuantizedImageData=d.imageData,S.currentPalette=d.palette),this.statusHandler&&this.statusHandler(d.label?`Redid ${d.label}.`:"Redid last action."),this.refreshActivePalette(),!0}setSelectionBounds(l){this.selectionBounds=l,this.refreshActivePalette(),this.lastRedoSnapshot=null}clearSelectionBounds(){this.selectionBounds=null,this.refreshActivePalette(),this.lastRedoSnapshot=null}refreshActivePalette(){if(!this.applyPaletteHandler)return;const l=this.selectionBounds;if(l&&S.currentQuantizedImageData){const d=Lt(S.currentQuantizedImageData,l),n=zt(d);this.selectionPalette=Ue(n),this.applyPaletteHandler(n,{selectionActive:!0})}else{this.selectionPalette=null;const d=Ue(S.currentPalette);this.applyPaletteHandler(d,{selectionActive:!1})}}executeOnActiveRegion(l,d){if(!S.currentQuantizedImageData)return Promise.resolve();this.saveSnapshot(l);const n=this.selectionBounds,w=n?Lt(S.currentQuantizedImageData,n):Ge(S.currentQuantizedImageData),a=Ue(n?this.selectionPalette||zt(w):S.currentPalette),t={imageData:w,palette:a,selectionBounds:n,getOriginalImage:()=>S.currentQuantizedImageData?n?Lt(S.currentQuantizedImageData,n):Ge(S.currentQuantizedImageData):null},o=d(t);return(o&&typeof o.then=="function"?o:Promise.resolve(o)).then((_={})=>{const c=_.imageData||t.imageData,i=_.palette||t.palette;if(n){const g=Ge(S.currentQuantizedImageData);dn(g,c,n),S.currentQuantizedImageData=g;const b=zt(S.currentQuantizedImageData);S.currentPalette=Ue(b),this.selectionPalette=Ue(i),this.applyPaletteHandler&&this.applyPaletteHandler(i,{selectionActive:!0}),this.applyImageHandler&&this.applyImageHandler(g)}else S.currentQuantizedImageData=c,this.applyImageHandler&&this.applyImageHandler(c),S.currentPalette=i,this.applyPaletteHandler&&this.applyPaletteHandler(i,{selectionActive:!1});_.statusMessage&&this.statusHandler&&this.statusHandler(_.statusMessage,_.statusIsError),this.lastRedoSnapshot=null})}}const Ae=new cn;function gn(f){return f&&f.__esModule&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f}function vn(f){throw new Error('Could not dynamically require "'+f+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Mt={exports:{}},Tt={},fa;function Je(){return fa||(fa=1,(function(f){var l=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";function d(a,t){return Object.prototype.hasOwnProperty.call(a,t)}f.assign=function(a){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var o=t.shift();if(o){if(typeof o!="object")throw new TypeError(o+"must be non-object");for(var r in o)d(o,r)&&(a[r]=o[r])}}return a},f.shrinkBuf=function(a,t){return a.length===t?a:a.subarray?a.subarray(0,t):(a.length=t,a)};var n={arraySet:function(a,t,o,r,_){if(t.subarray&&a.subarray){a.set(t.subarray(o,o+r),_);return}for(var c=0;c<r;c++)a[_+c]=t[o+c]},flattenChunks:function(a){var t,o,r,_,c,i;for(r=0,t=0,o=a.length;t<o;t++)r+=a[t].length;for(i=new Uint8Array(r),_=0,t=0,o=a.length;t<o;t++)c=a[t],i.set(c,_),_+=c.length;return i}},w={arraySet:function(a,t,o,r,_){for(var c=0;c<r;c++)a[_+c]=t[o+c]},flattenChunks:function(a){return[].concat.apply([],a)}};f.setTyped=function(a){a?(f.Buf8=Uint8Array,f.Buf16=Uint16Array,f.Buf32=Int32Array,f.assign(f,n)):(f.Buf8=Array,f.Buf16=Array,f.Buf32=Array,f.assign(f,w))},f.setTyped(l)})(Tt)),Tt}var ot={},Ze={},et={},ha;function _n(){if(ha)return et;ha=1;var f=Je(),l=4,d=0,n=1,w=2;function a(v){for(var P=v.length;--P>=0;)v[P]=0}var t=0,o=1,r=2,_=3,c=258,i=29,g=256,b=g+1+i,u=30,k=19,y=2*b+1,p=15,m=16,E=7,T=256,B=16,M=17,C=18,R=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],H=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],q=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],U=512,N=new Array((b+2)*2);a(N);var $=new Array(u*2);a($);var J=new Array(U);a(J);var V=new Array(c-_+1);a(V);var Y=new Array(i);a(Y);var j=new Array(u);a(j);function ne(v,P,F,Q,I){this.static_tree=v,this.extra_bits=P,this.extra_base=F,this.elems=Q,this.max_length=I,this.has_stree=v&&v.length}var be,ye,ge;function de(v,P){this.dyn_tree=v,this.max_code=0,this.stat_desc=P}function _e(v){return v<256?J[v]:J[256+(v>>>7)]}function ce(v,P){v.pending_buf[v.pending++]=P&255,v.pending_buf[v.pending++]=P>>>8&255}function le(v,P,F){v.bi_valid>m-F?(v.bi_buf|=P<<v.bi_valid&65535,ce(v,v.bi_buf),v.bi_buf=P>>m-v.bi_valid,v.bi_valid+=F-m):(v.bi_buf|=P<<v.bi_valid&65535,v.bi_valid+=F)}function he(v,P,F){le(v,F[P*2],F[P*2+1])}function ae(v,P){var F=0;do F|=v&1,v>>>=1,F<<=1;while(--P>0);return F>>>1}function ee(v){v.bi_valid===16?(ce(v,v.bi_buf),v.bi_buf=0,v.bi_valid=0):v.bi_valid>=8&&(v.pending_buf[v.pending++]=v.bi_buf&255,v.bi_buf>>=8,v.bi_valid-=8)}function Ee(v,P){var F=P.dyn_tree,Q=P.max_code,I=P.stat_desc.static_tree,L=P.stat_desc.has_stree,s=P.stat_desc.extra_bits,O=P.stat_desc.extra_base,G=P.stat_desc.max_length,e,A,z,h,x,D,W=0;for(h=0;h<=p;h++)v.bl_count[h]=0;for(F[v.heap[v.heap_max]*2+1]=0,e=v.heap_max+1;e<y;e++)A=v.heap[e],h=F[F[A*2+1]*2+1]+1,h>G&&(h=G,W++),F[A*2+1]=h,!(A>Q)&&(v.bl_count[h]++,x=0,A>=O&&(x=s[A-O]),D=F[A*2],v.opt_len+=D*(h+x),L&&(v.static_len+=D*(I[A*2+1]+x)));if(W!==0){do{for(h=G-1;v.bl_count[h]===0;)h--;v.bl_count[h]--,v.bl_count[h+1]+=2,v.bl_count[G]--,W-=2}while(W>0);for(h=G;h!==0;h--)for(A=v.bl_count[h];A!==0;)z=v.heap[--e],!(z>Q)&&(F[z*2+1]!==h&&(v.opt_len+=(h-F[z*2+1])*F[z*2],F[z*2+1]=h),A--)}}function Se(v,P,F){var Q=new Array(p+1),I=0,L,s;for(L=1;L<=p;L++)Q[L]=I=I+F[L-1]<<1;for(s=0;s<=P;s++){var O=v[s*2+1];O!==0&&(v[s*2]=ae(Q[O]++,O))}}function te(){var v,P,F,Q,I,L=new Array(p+1);for(F=0,Q=0;Q<i-1;Q++)for(Y[Q]=F,v=0;v<1<<R[Q];v++)V[F++]=Q;for(V[F-1]=Q,I=0,Q=0;Q<16;Q++)for(j[Q]=I,v=0;v<1<<H[Q];v++)J[I++]=Q;for(I>>=7;Q<u;Q++)for(j[Q]=I<<7,v=0;v<1<<H[Q]-7;v++)J[256+I++]=Q;for(P=0;P<=p;P++)L[P]=0;for(v=0;v<=143;)N[v*2+1]=8,v++,L[8]++;for(;v<=255;)N[v*2+1]=9,v++,L[9]++;for(;v<=279;)N[v*2+1]=7,v++,L[7]++;for(;v<=287;)N[v*2+1]=8,v++,L[8]++;for(Se(N,b+1,L),v=0;v<u;v++)$[v*2+1]=5,$[v*2]=ae(v,5);be=new ne(N,R,g+1,b,p),ye=new ne($,H,0,u,p),ge=new ne(new Array(0),q,0,k,E)}function pe(v){var P;for(P=0;P<b;P++)v.dyn_ltree[P*2]=0;for(P=0;P<u;P++)v.dyn_dtree[P*2]=0;for(P=0;P<k;P++)v.bl_tree[P*2]=0;v.dyn_ltree[T*2]=1,v.opt_len=v.static_len=0,v.last_lit=v.matches=0}function Te(v){v.bi_valid>8?ce(v,v.bi_buf):v.bi_valid>0&&(v.pending_buf[v.pending++]=v.bi_buf),v.bi_buf=0,v.bi_valid=0}function ze(v,P,F,Q){Te(v),ce(v,F),ce(v,~F),f.arraySet(v.pending_buf,v.window,P,F,v.pending),v.pending+=F}function xe(v,P,F,Q){var I=P*2,L=F*2;return v[I]<v[L]||v[I]===v[L]&&Q[P]<=Q[F]}function ue(v,P,F){for(var Q=v.heap[F],I=F<<1;I<=v.heap_len&&(I<v.heap_len&&xe(P,v.heap[I+1],v.heap[I],v.depth)&&I++,!xe(P,Q,v.heap[I],v.depth));)v.heap[F]=v.heap[I],F=I,I<<=1;v.heap[F]=Q}function re(v,P,F){var Q,I,L=0,s,O;if(v.last_lit!==0)do Q=v.pending_buf[v.d_buf+L*2]<<8|v.pending_buf[v.d_buf+L*2+1],I=v.pending_buf[v.l_buf+L],L++,Q===0?he(v,I,P):(s=V[I],he(v,s+g+1,P),O=R[s],O!==0&&(I-=Y[s],le(v,I,O)),Q--,s=_e(Q),he(v,s,F),O=H[s],O!==0&&(Q-=j[s],le(v,Q,O)));while(L<v.last_lit);he(v,T,P)}function Be(v,P){var F=P.dyn_tree,Q=P.stat_desc.static_tree,I=P.stat_desc.has_stree,L=P.stat_desc.elems,s,O,G=-1,e;for(v.heap_len=0,v.heap_max=y,s=0;s<L;s++)F[s*2]!==0?(v.heap[++v.heap_len]=G=s,v.depth[s]=0):F[s*2+1]=0;for(;v.heap_len<2;)e=v.heap[++v.heap_len]=G<2?++G:0,F[e*2]=1,v.depth[e]=0,v.opt_len--,I&&(v.static_len-=Q[e*2+1]);for(P.max_code=G,s=v.heap_len>>1;s>=1;s--)ue(v,F,s);e=L;do s=v.heap[1],v.heap[1]=v.heap[v.heap_len--],ue(v,F,1),O=v.heap[1],v.heap[--v.heap_max]=s,v.heap[--v.heap_max]=O,F[e*2]=F[s*2]+F[O*2],v.depth[e]=(v.depth[s]>=v.depth[O]?v.depth[s]:v.depth[O])+1,F[s*2+1]=F[O*2+1]=e,v.heap[1]=e++,ue(v,F,1);while(v.heap_len>=2);v.heap[--v.heap_max]=v.heap[1],Ee(v,P),Se(F,G,v.bl_count)}function nt(v,P,F){var Q,I=-1,L,s=P[1],O=0,G=7,e=4;for(s===0&&(G=138,e=3),P[(F+1)*2+1]=65535,Q=0;Q<=F;Q++)L=s,s=P[(Q+1)*2+1],!(++O<G&&L===s)&&(O<e?v.bl_tree[L*2]+=O:L!==0?(L!==I&&v.bl_tree[L*2]++,v.bl_tree[B*2]++):O<=10?v.bl_tree[M*2]++:v.bl_tree[C*2]++,O=0,I=L,s===0?(G=138,e=3):L===s?(G=6,e=3):(G=7,e=4))}function Qe(v,P,F){var Q,I=-1,L,s=P[1],O=0,G=7,e=4;for(s===0&&(G=138,e=3),Q=0;Q<=F;Q++)if(L=s,s=P[(Q+1)*2+1],!(++O<G&&L===s)){if(O<e)do he(v,L,v.bl_tree);while(--O!==0);else L!==0?(L!==I&&(he(v,L,v.bl_tree),O--),he(v,B,v.bl_tree),le(v,O-3,2)):O<=10?(he(v,M,v.bl_tree),le(v,O-3,3)):(he(v,C,v.bl_tree),le(v,O-11,7));O=0,I=L,s===0?(G=138,e=3):L===s?(G=6,e=3):(G=7,e=4)}}function Re(v){var P;for(nt(v,v.dyn_ltree,v.l_desc.max_code),nt(v,v.dyn_dtree,v.d_desc.max_code),Be(v,v.bl_desc),P=k-1;P>=3&&v.bl_tree[Z[P]*2+1]===0;P--);return v.opt_len+=3*(P+1)+5+5+4,P}function rt(v,P,F,Q){var I;for(le(v,P-257,5),le(v,F-1,5),le(v,Q-4,4),I=0;I<Q;I++)le(v,v.bl_tree[Z[I]*2+1],3);Qe(v,v.dyn_ltree,P-1),Qe(v,v.dyn_dtree,F-1)}function je(v){var P=4093624447,F;for(F=0;F<=31;F++,P>>>=1)if(P&1&&v.dyn_ltree[F*2]!==0)return d;if(v.dyn_ltree[18]!==0||v.dyn_ltree[20]!==0||v.dyn_ltree[26]!==0)return n;for(F=32;F<g;F++)if(v.dyn_ltree[F*2]!==0)return n;return d}var He=!1;function it(v){He||(te(),He=!0),v.l_desc=new de(v.dyn_ltree,be),v.d_desc=new de(v.dyn_dtree,ye),v.bl_desc=new de(v.bl_tree,ge),v.bi_buf=0,v.bi_valid=0,pe(v)}function Ve(v,P,F,Q){le(v,(t<<1)+(Q?1:0),3),ze(v,P,F)}function Ce(v){le(v,o<<1,3),he(v,T,N),ee(v)}function Ne(v,P,F,Q){var I,L,s=0;v.level>0?(v.strm.data_type===w&&(v.strm.data_type=je(v)),Be(v,v.l_desc),Be(v,v.d_desc),s=Re(v),I=v.opt_len+3+7>>>3,L=v.static_len+3+7>>>3,L<=I&&(I=L)):I=L=F+5,F+4<=I&&P!==-1?Ve(v,P,F,Q):v.strategy===l||L===I?(le(v,(o<<1)+(Q?1:0),3),re(v,N,$)):(le(v,(r<<1)+(Q?1:0),3),rt(v,v.l_desc.max_code+1,v.d_desc.max_code+1,s+1),re(v,v.dyn_ltree,v.dyn_dtree)),pe(v),Q&&Te(v)}function lt(v,P,F){return v.pending_buf[v.d_buf+v.last_lit*2]=P>>>8&255,v.pending_buf[v.d_buf+v.last_lit*2+1]=P&255,v.pending_buf[v.l_buf+v.last_lit]=F&255,v.last_lit++,P===0?v.dyn_ltree[F*2]++:(v.matches++,P--,v.dyn_ltree[(V[F]+g+1)*2]++,v.dyn_dtree[_e(P)*2]++),v.last_lit===v.lit_bufsize-1}return et._tr_init=it,et._tr_stored_block=Ve,et._tr_flush_block=Ne,et._tr_tally=lt,et._tr_align=Ce,et}var Bt,ua;function Oa(){if(ua)return Bt;ua=1;function f(l,d,n,w){for(var a=l&65535|0,t=l>>>16&65535|0,o=0;n!==0;){o=n>2e3?2e3:n,n-=o;do a=a+d[w++]|0,t=t+a|0;while(--o);a%=65521,t%=65521}return a|t<<16|0}return Bt=f,Bt}var Rt,da;function Ha(){if(da)return Rt;da=1;function f(){for(var n,w=[],a=0;a<256;a++){n=a;for(var t=0;t<8;t++)n=n&1?3988292384^n>>>1:n>>>1;w[a]=n}return w}var l=f();function d(n,w,a,t){var o=l,r=t+a;n^=-1;for(var _=t;_<r;_++)n=n>>>8^o[(n^w[_])&255];return n^-1}return Rt=d,Rt}var Pt,ca;function ea(){return ca||(ca=1,Pt={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}),Pt}var ga;function pn(){if(ga)return Ze;ga=1;var f=Je(),l=_n(),d=Oa(),n=Ha(),w=ea(),a=0,t=1,o=3,r=4,_=5,c=0,i=1,g=-2,b=-3,u=-5,k=-1,y=1,p=2,m=3,E=4,T=0,B=2,M=8,C=9,R=15,H=8,q=29,Z=256,U=Z+1+q,N=30,$=19,J=2*U+1,V=15,Y=3,j=258,ne=j+Y+1,be=32,ye=42,ge=69,de=73,_e=91,ce=103,le=113,he=666,ae=1,ee=2,Ee=3,Se=4,te=3;function pe(e,A){return e.msg=w[A],A}function Te(e){return(e<<1)-(e>4?9:0)}function ze(e){for(var A=e.length;--A>=0;)e[A]=0}function xe(e){var A=e.state,z=A.pending;z>e.avail_out&&(z=e.avail_out),z!==0&&(f.arraySet(e.output,A.pending_buf,A.pending_out,z,e.next_out),e.next_out+=z,A.pending_out+=z,e.total_out+=z,e.avail_out-=z,A.pending-=z,A.pending===0&&(A.pending_out=0))}function ue(e,A){l._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,A),e.block_start=e.strstart,xe(e.strm)}function re(e,A){e.pending_buf[e.pending++]=A}function Be(e,A){e.pending_buf[e.pending++]=A>>>8&255,e.pending_buf[e.pending++]=A&255}function nt(e,A,z,h){var x=e.avail_in;return x>h&&(x=h),x===0?0:(e.avail_in-=x,f.arraySet(A,e.input,e.next_in,x,z),e.state.wrap===1?e.adler=d(e.adler,A,x,z):e.state.wrap===2&&(e.adler=n(e.adler,A,x,z)),e.next_in+=x,e.total_in+=x,x)}function Qe(e,A){var z=e.max_chain_length,h=e.strstart,x,D,W=e.prev_length,X=e.nice_match,K=e.strstart>e.w_size-ne?e.strstart-(e.w_size-ne):0,oe=e.window,$e=e.w_mask,ve=e.prev,se=e.strstart+j,we=oe[h+W-1],ke=oe[h+W];e.prev_length>=e.good_match&&(z>>=2),X>e.lookahead&&(X=e.lookahead);do if(x=A,!(oe[x+W]!==ke||oe[x+W-1]!==we||oe[x]!==oe[h]||oe[++x]!==oe[h+1])){h+=2,x++;do;while(oe[++h]===oe[++x]&&oe[++h]===oe[++x]&&oe[++h]===oe[++x]&&oe[++h]===oe[++x]&&oe[++h]===oe[++x]&&oe[++h]===oe[++x]&&oe[++h]===oe[++x]&&oe[++h]===oe[++x]&&h<se);if(D=j-(se-h),h=se-j,D>W){if(e.match_start=A,W=D,D>=X)break;we=oe[h+W-1],ke=oe[h+W]}}while((A=ve[A&$e])>K&&--z!==0);return W<=e.lookahead?W:e.lookahead}function Re(e){var A=e.w_size,z,h,x,D,W;do{if(D=e.window_size-e.lookahead-e.strstart,e.strstart>=A+(A-ne)){f.arraySet(e.window,e.window,A,A,0),e.match_start-=A,e.strstart-=A,e.block_start-=A,h=e.hash_size,z=h;do x=e.head[--z],e.head[z]=x>=A?x-A:0;while(--h);h=A,z=h;do x=e.prev[--z],e.prev[z]=x>=A?x-A:0;while(--h);D+=A}if(e.strm.avail_in===0)break;if(h=nt(e.strm,e.window,e.strstart+e.lookahead,D),e.lookahead+=h,e.lookahead+e.insert>=Y)for(W=e.strstart-e.insert,e.ins_h=e.window[W],e.ins_h=(e.ins_h<<e.hash_shift^e.window[W+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[W+Y-1])&e.hash_mask,e.prev[W&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=W,W++,e.insert--,!(e.lookahead+e.insert<Y)););}while(e.lookahead<ne&&e.strm.avail_in!==0)}function rt(e,A){var z=65535;for(z>e.pending_buf_size-5&&(z=e.pending_buf_size-5);;){if(e.lookahead<=1){if(Re(e),e.lookahead===0&&A===a)return ae;if(e.lookahead===0)break}e.strstart+=e.lookahead,e.lookahead=0;var h=e.block_start+z;if((e.strstart===0||e.strstart>=h)&&(e.lookahead=e.strstart-h,e.strstart=h,ue(e,!1),e.strm.avail_out===0)||e.strstart-e.block_start>=e.w_size-ne&&(ue(e,!1),e.strm.avail_out===0))return ae}return e.insert=0,A===r?(ue(e,!0),e.strm.avail_out===0?Ee:Se):(e.strstart>e.block_start&&(ue(e,!1),e.strm.avail_out===0),ae)}function je(e,A){for(var z,h;;){if(e.lookahead<ne){if(Re(e),e.lookahead<ne&&A===a)return ae;if(e.lookahead===0)break}if(z=0,e.lookahead>=Y&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+Y-1])&e.hash_mask,z=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),z!==0&&e.strstart-z<=e.w_size-ne&&(e.match_length=Qe(e,z)),e.match_length>=Y)if(h=l._tr_tally(e,e.strstart-e.match_start,e.match_length-Y),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=Y){e.match_length--;do e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+Y-1])&e.hash_mask,z=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!==0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else h=l._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(h&&(ue(e,!1),e.strm.avail_out===0))return ae}return e.insert=e.strstart<Y-1?e.strstart:Y-1,A===r?(ue(e,!0),e.strm.avail_out===0?Ee:Se):e.last_lit&&(ue(e,!1),e.strm.avail_out===0)?ae:ee}function He(e,A){for(var z,h,x;;){if(e.lookahead<ne){if(Re(e),e.lookahead<ne&&A===a)return ae;if(e.lookahead===0)break}if(z=0,e.lookahead>=Y&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+Y-1])&e.hash_mask,z=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=Y-1,z!==0&&e.prev_length<e.max_lazy_match&&e.strstart-z<=e.w_size-ne&&(e.match_length=Qe(e,z),e.match_length<=5&&(e.strategy===y||e.match_length===Y&&e.strstart-e.match_start>4096)&&(e.match_length=Y-1)),e.prev_length>=Y&&e.match_length<=e.prev_length){x=e.strstart+e.lookahead-Y,h=l._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-Y),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=x&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+Y-1])&e.hash_mask,z=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!==0);if(e.match_available=0,e.match_length=Y-1,e.strstart++,h&&(ue(e,!1),e.strm.avail_out===0))return ae}else if(e.match_available){if(h=l._tr_tally(e,0,e.window[e.strstart-1]),h&&ue(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return ae}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(h=l._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<Y-1?e.strstart:Y-1,A===r?(ue(e,!0),e.strm.avail_out===0?Ee:Se):e.last_lit&&(ue(e,!1),e.strm.avail_out===0)?ae:ee}function it(e,A){for(var z,h,x,D,W=e.window;;){if(e.lookahead<=j){if(Re(e),e.lookahead<=j&&A===a)return ae;if(e.lookahead===0)break}if(e.match_length=0,e.lookahead>=Y&&e.strstart>0&&(x=e.strstart-1,h=W[x],h===W[++x]&&h===W[++x]&&h===W[++x])){D=e.strstart+j;do;while(h===W[++x]&&h===W[++x]&&h===W[++x]&&h===W[++x]&&h===W[++x]&&h===W[++x]&&h===W[++x]&&h===W[++x]&&x<D);e.match_length=j-(D-x),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=Y?(z=l._tr_tally(e,1,e.match_length-Y),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(z=l._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),z&&(ue(e,!1),e.strm.avail_out===0))return ae}return e.insert=0,A===r?(ue(e,!0),e.strm.avail_out===0?Ee:Se):e.last_lit&&(ue(e,!1),e.strm.avail_out===0)?ae:ee}function Ve(e,A){for(var z;;){if(e.lookahead===0&&(Re(e),e.lookahead===0)){if(A===a)return ae;break}if(e.match_length=0,z=l._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,z&&(ue(e,!1),e.strm.avail_out===0))return ae}return e.insert=0,A===r?(ue(e,!0),e.strm.avail_out===0?Ee:Se):e.last_lit&&(ue(e,!1),e.strm.avail_out===0)?ae:ee}function Ce(e,A,z,h,x){this.good_length=e,this.max_lazy=A,this.nice_length=z,this.max_chain=h,this.func=x}var Ne;Ne=[new Ce(0,0,0,0,rt),new Ce(4,4,8,4,je),new Ce(4,5,16,8,je),new Ce(4,6,32,32,je),new Ce(4,4,16,16,He),new Ce(8,16,32,32,He),new Ce(8,16,128,128,He),new Ce(8,32,128,256,He),new Ce(32,128,258,1024,He),new Ce(32,258,258,4096,He)];function lt(e){e.window_size=2*e.w_size,ze(e.head),e.max_lazy_match=Ne[e.level].max_lazy,e.good_match=Ne[e.level].good_length,e.nice_match=Ne[e.level].nice_length,e.max_chain_length=Ne[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=Y-1,e.match_available=0,e.ins_h=0}function v(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=M,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new f.Buf16(J*2),this.dyn_dtree=new f.Buf16((2*N+1)*2),this.bl_tree=new f.Buf16((2*$+1)*2),ze(this.dyn_ltree),ze(this.dyn_dtree),ze(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new f.Buf16(V+1),this.heap=new f.Buf16(2*U+1),ze(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new f.Buf16(2*U+1),ze(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function P(e){var A;return!e||!e.state?pe(e,g):(e.total_in=e.total_out=0,e.data_type=B,A=e.state,A.pending=0,A.pending_out=0,A.wrap<0&&(A.wrap=-A.wrap),A.status=A.wrap?ye:le,e.adler=A.wrap===2?0:1,A.last_flush=a,l._tr_init(A),c)}function F(e){var A=P(e);return A===c&&lt(e.state),A}function Q(e,A){return!e||!e.state||e.state.wrap!==2?g:(e.state.gzhead=A,c)}function I(e,A,z,h,x,D){if(!e)return g;var W=1;if(A===k&&(A=6),h<0?(W=0,h=-h):h>15&&(W=2,h-=16),x<1||x>C||z!==M||h<8||h>15||A<0||A>9||D<0||D>E)return pe(e,g);h===8&&(h=9);var X=new v;return e.state=X,X.strm=e,X.wrap=W,X.gzhead=null,X.w_bits=h,X.w_size=1<<X.w_bits,X.w_mask=X.w_size-1,X.hash_bits=x+7,X.hash_size=1<<X.hash_bits,X.hash_mask=X.hash_size-1,X.hash_shift=~~((X.hash_bits+Y-1)/Y),X.window=new f.Buf8(X.w_size*2),X.head=new f.Buf16(X.hash_size),X.prev=new f.Buf16(X.w_size),X.lit_bufsize=1<<x+6,X.pending_buf_size=X.lit_bufsize*4,X.pending_buf=new f.Buf8(X.pending_buf_size),X.d_buf=1*X.lit_bufsize,X.l_buf=3*X.lit_bufsize,X.level=A,X.strategy=D,X.method=z,F(e)}function L(e,A){return I(e,A,M,R,H,T)}function s(e,A){var z,h,x,D;if(!e||!e.state||A>_||A<0)return e?pe(e,g):g;if(h=e.state,!e.output||!e.input&&e.avail_in!==0||h.status===he&&A!==r)return pe(e,e.avail_out===0?u:g);if(h.strm=e,z=h.last_flush,h.last_flush=A,h.status===ye)if(h.wrap===2)e.adler=0,re(h,31),re(h,139),re(h,8),h.gzhead?(re(h,(h.gzhead.text?1:0)+(h.gzhead.hcrc?2:0)+(h.gzhead.extra?4:0)+(h.gzhead.name?8:0)+(h.gzhead.comment?16:0)),re(h,h.gzhead.time&255),re(h,h.gzhead.time>>8&255),re(h,h.gzhead.time>>16&255),re(h,h.gzhead.time>>24&255),re(h,h.level===9?2:h.strategy>=p||h.level<2?4:0),re(h,h.gzhead.os&255),h.gzhead.extra&&h.gzhead.extra.length&&(re(h,h.gzhead.extra.length&255),re(h,h.gzhead.extra.length>>8&255)),h.gzhead.hcrc&&(e.adler=n(e.adler,h.pending_buf,h.pending,0)),h.gzindex=0,h.status=ge):(re(h,0),re(h,0),re(h,0),re(h,0),re(h,0),re(h,h.level===9?2:h.strategy>=p||h.level<2?4:0),re(h,te),h.status=le);else{var W=M+(h.w_bits-8<<4)<<8,X=-1;h.strategy>=p||h.level<2?X=0:h.level<6?X=1:h.level===6?X=2:X=3,W|=X<<6,h.strstart!==0&&(W|=be),W+=31-W%31,h.status=le,Be(h,W),h.strstart!==0&&(Be(h,e.adler>>>16),Be(h,e.adler&65535)),e.adler=1}if(h.status===ge)if(h.gzhead.extra){for(x=h.pending;h.gzindex<(h.gzhead.extra.length&65535)&&!(h.pending===h.pending_buf_size&&(h.gzhead.hcrc&&h.pending>x&&(e.adler=n(e.adler,h.pending_buf,h.pending-x,x)),xe(e),x=h.pending,h.pending===h.pending_buf_size));)re(h,h.gzhead.extra[h.gzindex]&255),h.gzindex++;h.gzhead.hcrc&&h.pending>x&&(e.adler=n(e.adler,h.pending_buf,h.pending-x,x)),h.gzindex===h.gzhead.extra.length&&(h.gzindex=0,h.status=de)}else h.status=de;if(h.status===de)if(h.gzhead.name){x=h.pending;do{if(h.pending===h.pending_buf_size&&(h.gzhead.hcrc&&h.pending>x&&(e.adler=n(e.adler,h.pending_buf,h.pending-x,x)),xe(e),x=h.pending,h.pending===h.pending_buf_size)){D=1;break}h.gzindex<h.gzhead.name.length?D=h.gzhead.name.charCodeAt(h.gzindex++)&255:D=0,re(h,D)}while(D!==0);h.gzhead.hcrc&&h.pending>x&&(e.adler=n(e.adler,h.pending_buf,h.pending-x,x)),D===0&&(h.gzindex=0,h.status=_e)}else h.status=_e;if(h.status===_e)if(h.gzhead.comment){x=h.pending;do{if(h.pending===h.pending_buf_size&&(h.gzhead.hcrc&&h.pending>x&&(e.adler=n(e.adler,h.pending_buf,h.pending-x,x)),xe(e),x=h.pending,h.pending===h.pending_buf_size)){D=1;break}h.gzindex<h.gzhead.comment.length?D=h.gzhead.comment.charCodeAt(h.gzindex++)&255:D=0,re(h,D)}while(D!==0);h.gzhead.hcrc&&h.pending>x&&(e.adler=n(e.adler,h.pending_buf,h.pending-x,x)),D===0&&(h.status=ce)}else h.status=ce;if(h.status===ce&&(h.gzhead.hcrc?(h.pending+2>h.pending_buf_size&&xe(e),h.pending+2<=h.pending_buf_size&&(re(h,e.adler&255),re(h,e.adler>>8&255),e.adler=0,h.status=le)):h.status=le),h.pending!==0){if(xe(e),e.avail_out===0)return h.last_flush=-1,c}else if(e.avail_in===0&&Te(A)<=Te(z)&&A!==r)return pe(e,u);if(h.status===he&&e.avail_in!==0)return pe(e,u);if(e.avail_in!==0||h.lookahead!==0||A!==a&&h.status!==he){var K=h.strategy===p?Ve(h,A):h.strategy===m?it(h,A):Ne[h.level].func(h,A);if((K===Ee||K===Se)&&(h.status=he),K===ae||K===Ee)return e.avail_out===0&&(h.last_flush=-1),c;if(K===ee&&(A===t?l._tr_align(h):A!==_&&(l._tr_stored_block(h,0,0,!1),A===o&&(ze(h.head),h.lookahead===0&&(h.strstart=0,h.block_start=0,h.insert=0))),xe(e),e.avail_out===0))return h.last_flush=-1,c}return A!==r?c:h.wrap<=0?i:(h.wrap===2?(re(h,e.adler&255),re(h,e.adler>>8&255),re(h,e.adler>>16&255),re(h,e.adler>>24&255),re(h,e.total_in&255),re(h,e.total_in>>8&255),re(h,e.total_in>>16&255),re(h,e.total_in>>24&255)):(Be(h,e.adler>>>16),Be(h,e.adler&65535)),xe(e),h.wrap>0&&(h.wrap=-h.wrap),h.pending!==0?c:i)}function O(e){var A;return!e||!e.state?g:(A=e.state.status,A!==ye&&A!==ge&&A!==de&&A!==_e&&A!==ce&&A!==le&&A!==he?pe(e,g):(e.state=null,A===le?pe(e,b):c))}function G(e,A){var z=A.length,h,x,D,W,X,K,oe,$e;if(!e||!e.state||(h=e.state,W=h.wrap,W===2||W===1&&h.status!==ye||h.lookahead))return g;for(W===1&&(e.adler=d(e.adler,A,z,0)),h.wrap=0,z>=h.w_size&&(W===0&&(ze(h.head),h.strstart=0,h.block_start=0,h.insert=0),$e=new f.Buf8(h.w_size),f.arraySet($e,A,z-h.w_size,h.w_size,0),A=$e,z=h.w_size),X=e.avail_in,K=e.next_in,oe=e.input,e.avail_in=z,e.next_in=0,e.input=A,Re(h);h.lookahead>=Y;){x=h.strstart,D=h.lookahead-(Y-1);do h.ins_h=(h.ins_h<<h.hash_shift^h.window[x+Y-1])&h.hash_mask,h.prev[x&h.w_mask]=h.head[h.ins_h],h.head[h.ins_h]=x,x++;while(--D);h.strstart=x,h.lookahead=Y-1,Re(h)}return h.strstart+=h.lookahead,h.block_start=h.strstart,h.insert=h.lookahead,h.lookahead=0,h.match_length=h.prev_length=Y-1,h.match_available=0,e.next_in=K,e.input=oe,e.avail_in=X,h.wrap=W,c}return Ze.deflateInit=L,Ze.deflateInit2=I,Ze.deflateReset=F,Ze.deflateResetKeep=P,Ze.deflateSetHeader=Q,Ze.deflate=s,Ze.deflateEnd=O,Ze.deflateSetDictionary=G,Ze.deflateInfo="pako deflate (from Nodeca project)",Ze}var tt={},va;function Za(){if(va)return tt;va=1;var f=Je(),l=!0,d=!0;try{String.fromCharCode.apply(null,[0])}catch{l=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{d=!1}for(var n=new f.Buf8(256),w=0;w<256;w++)n[w]=w>=252?6:w>=248?5:w>=240?4:w>=224?3:w>=192?2:1;n[254]=n[254]=1,tt.string2buf=function(t){var o,r,_,c,i,g=t.length,b=0;for(c=0;c<g;c++)r=t.charCodeAt(c),(r&64512)===55296&&c+1<g&&(_=t.charCodeAt(c+1),(_&64512)===56320&&(r=65536+(r-55296<<10)+(_-56320),c++)),b+=r<128?1:r<2048?2:r<65536?3:4;for(o=new f.Buf8(b),i=0,c=0;i<b;c++)r=t.charCodeAt(c),(r&64512)===55296&&c+1<g&&(_=t.charCodeAt(c+1),(_&64512)===56320&&(r=65536+(r-55296<<10)+(_-56320),c++)),r<128?o[i++]=r:r<2048?(o[i++]=192|r>>>6,o[i++]=128|r&63):r<65536?(o[i++]=224|r>>>12,o[i++]=128|r>>>6&63,o[i++]=128|r&63):(o[i++]=240|r>>>18,o[i++]=128|r>>>12&63,o[i++]=128|r>>>6&63,o[i++]=128|r&63);return o};function a(t,o){if(o<65534&&(t.subarray&&d||!t.subarray&&l))return String.fromCharCode.apply(null,f.shrinkBuf(t,o));for(var r="",_=0;_<o;_++)r+=String.fromCharCode(t[_]);return r}return tt.buf2binstring=function(t){return a(t,t.length)},tt.binstring2buf=function(t){for(var o=new f.Buf8(t.length),r=0,_=o.length;r<_;r++)o[r]=t.charCodeAt(r);return o},tt.buf2string=function(t,o){var r,_,c,i,g=o||t.length,b=new Array(g*2);for(_=0,r=0;r<g;){if(c=t[r++],c<128){b[_++]=c;continue}if(i=n[c],i>4){b[_++]=65533,r+=i-1;continue}for(c&=i===2?31:i===3?15:7;i>1&&r<g;)c=c<<6|t[r++]&63,i--;if(i>1){b[_++]=65533;continue}c<65536?b[_++]=c:(c-=65536,b[_++]=55296|c>>10&1023,b[_++]=56320|c&1023)}return a(b,_)},tt.utf8border=function(t,o){var r;for(o=o||t.length,o>t.length&&(o=t.length),r=o-1;r>=0&&(t[r]&192)===128;)r--;return r<0||r===0?o:r+n[t[r]]>o?r:o},tt}var Ot,_a;function Fa(){if(_a)return Ot;_a=1;function f(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}return Ot=f,Ot}var pa;function mn(){if(pa)return ot;pa=1;var f=pn(),l=Je(),d=Za(),n=ea(),w=Fa(),a=Object.prototype.toString,t=0,o=4,r=0,_=1,c=2,i=-1,g=0,b=8;function u(m){if(!(this instanceof u))return new u(m);this.options=l.assign({level:i,method:b,chunkSize:16384,windowBits:15,memLevel:8,strategy:g,to:""},m||{});var E=this.options;E.raw&&E.windowBits>0?E.windowBits=-E.windowBits:E.gzip&&E.windowBits>0&&E.windowBits<16&&(E.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new w,this.strm.avail_out=0;var T=f.deflateInit2(this.strm,E.level,E.method,E.windowBits,E.memLevel,E.strategy);if(T!==r)throw new Error(n[T]);if(E.header&&f.deflateSetHeader(this.strm,E.header),E.dictionary){var B;if(typeof E.dictionary=="string"?B=d.string2buf(E.dictionary):a.call(E.dictionary)==="[object ArrayBuffer]"?B=new Uint8Array(E.dictionary):B=E.dictionary,T=f.deflateSetDictionary(this.strm,B),T!==r)throw new Error(n[T]);this._dict_set=!0}}u.prototype.push=function(m,E){var T=this.strm,B=this.options.chunkSize,M,C;if(this.ended)return!1;C=E===~~E?E:E===!0?o:t,typeof m=="string"?T.input=d.string2buf(m):a.call(m)==="[object ArrayBuffer]"?T.input=new Uint8Array(m):T.input=m,T.next_in=0,T.avail_in=T.input.length;do{if(T.avail_out===0&&(T.output=new l.Buf8(B),T.next_out=0,T.avail_out=B),M=f.deflate(T,C),M!==_&&M!==r)return this.onEnd(M),this.ended=!0,!1;(T.avail_out===0||T.avail_in===0&&(C===o||C===c))&&(this.options.to==="string"?this.onData(d.buf2binstring(l.shrinkBuf(T.output,T.next_out))):this.onData(l.shrinkBuf(T.output,T.next_out)))}while((T.avail_in>0||T.avail_out===0)&&M!==_);return C===o?(M=f.deflateEnd(this.strm),this.onEnd(M),this.ended=!0,M===r):(C===c&&(this.onEnd(r),T.avail_out=0),!0)},u.prototype.onData=function(m){this.chunks.push(m)},u.prototype.onEnd=function(m){m===r&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=l.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg};function k(m,E){var T=new u(E);if(T.push(m,!0),T.err)throw T.msg||n[T.err];return T.result}function y(m,E){return E=E||{},E.raw=!0,k(m,E)}function p(m,E){return E=E||{},E.gzip=!0,k(m,E)}return ot.Deflate=u,ot.deflate=k,ot.deflateRaw=y,ot.gzip=p,ot}var st={},Oe={},Ht,ma;function wn(){if(ma)return Ht;ma=1;var f=30,l=12;return Ht=function(n,w){var a,t,o,r,_,c,i,g,b,u,k,y,p,m,E,T,B,M,C,R,H,q,Z,U,N;a=n.state,t=n.next_in,U=n.input,o=t+(n.avail_in-5),r=n.next_out,N=n.output,_=r-(w-n.avail_out),c=r+(n.avail_out-257),i=a.dmax,g=a.wsize,b=a.whave,u=a.wnext,k=a.window,y=a.hold,p=a.bits,m=a.lencode,E=a.distcode,T=(1<<a.lenbits)-1,B=(1<<a.distbits)-1;e:do{p<15&&(y+=U[t++]<<p,p+=8,y+=U[t++]<<p,p+=8),M=m[y&T];t:for(;;){if(C=M>>>24,y>>>=C,p-=C,C=M>>>16&255,C===0)N[r++]=M&65535;else if(C&16){R=M&65535,C&=15,C&&(p<C&&(y+=U[t++]<<p,p+=8),R+=y&(1<<C)-1,y>>>=C,p-=C),p<15&&(y+=U[t++]<<p,p+=8,y+=U[t++]<<p,p+=8),M=E[y&B];a:for(;;){if(C=M>>>24,y>>>=C,p-=C,C=M>>>16&255,C&16){if(H=M&65535,C&=15,p<C&&(y+=U[t++]<<p,p+=8,p<C&&(y+=U[t++]<<p,p+=8)),H+=y&(1<<C)-1,H>i){n.msg="invalid distance too far back",a.mode=f;break e}if(y>>>=C,p-=C,C=r-_,H>C){if(C=H-C,C>b&&a.sane){n.msg="invalid distance too far back",a.mode=f;break e}if(q=0,Z=k,u===0){if(q+=g-C,C<R){R-=C;do N[r++]=k[q++];while(--C);q=r-H,Z=N}}else if(u<C){if(q+=g+u-C,C-=u,C<R){R-=C;do N[r++]=k[q++];while(--C);if(q=0,u<R){C=u,R-=C;do N[r++]=k[q++];while(--C);q=r-H,Z=N}}}else if(q+=u-C,C<R){R-=C;do N[r++]=k[q++];while(--C);q=r-H,Z=N}for(;R>2;)N[r++]=Z[q++],N[r++]=Z[q++],N[r++]=Z[q++],R-=3;R&&(N[r++]=Z[q++],R>1&&(N[r++]=Z[q++]))}else{q=r-H;do N[r++]=N[q++],N[r++]=N[q++],N[r++]=N[q++],R-=3;while(R>2);R&&(N[r++]=N[q++],R>1&&(N[r++]=N[q++]))}}else if((C&64)===0){M=E[(M&65535)+(y&(1<<C)-1)];continue a}else{n.msg="invalid distance code",a.mode=f;break e}break}}else if((C&64)===0){M=m[(M&65535)+(y&(1<<C)-1)];continue t}else if(C&32){a.mode=l;break e}else{n.msg="invalid literal/length code",a.mode=f;break e}break}}while(t<o&&r<c);R=p>>3,t-=R,p-=R<<3,y&=(1<<p)-1,n.next_in=t,n.next_out=r,n.avail_in=t<o?5+(o-t):5-(t-o),n.avail_out=r<c?257+(c-r):257-(r-c),a.hold=y,a.bits=p},Ht}var Zt,wa;function bn(){if(wa)return Zt;wa=1;var f=Je(),l=15,d=852,n=592,w=0,a=1,t=2,o=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],_=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],c=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];return Zt=function(g,b,u,k,y,p,m,E){var T=E.bits,B=0,M=0,C=0,R=0,H=0,q=0,Z=0,U=0,N=0,$=0,J,V,Y,j,ne,be=null,ye=0,ge,de=new f.Buf16(l+1),_e=new f.Buf16(l+1),ce=null,le=0,he,ae,ee;for(B=0;B<=l;B++)de[B]=0;for(M=0;M<k;M++)de[b[u+M]]++;for(H=T,R=l;R>=1&&de[R]===0;R--);if(H>R&&(H=R),R===0)return y[p++]=1<<24|64<<16|0,y[p++]=1<<24|64<<16|0,E.bits=1,0;for(C=1;C<R&&de[C]===0;C++);for(H<C&&(H=C),U=1,B=1;B<=l;B++)if(U<<=1,U-=de[B],U<0)return-1;if(U>0&&(g===w||R!==1))return-1;for(_e[1]=0,B=1;B<l;B++)_e[B+1]=_e[B]+de[B];for(M=0;M<k;M++)b[u+M]!==0&&(m[_e[b[u+M]]++]=M);if(g===w?(be=ce=m,ge=19):g===a?(be=o,ye-=257,ce=r,le-=257,ge=256):(be=_,ce=c,ge=-1),$=0,M=0,B=C,ne=p,q=H,Z=0,Y=-1,N=1<<H,j=N-1,g===a&&N>d||g===t&&N>n)return 1;for(;;){he=B-Z,m[M]<ge?(ae=0,ee=m[M]):m[M]>ge?(ae=ce[le+m[M]],ee=be[ye+m[M]]):(ae=96,ee=0),J=1<<B-Z,V=1<<q,C=V;do V-=J,y[ne+($>>Z)+V]=he<<24|ae<<16|ee|0;while(V!==0);for(J=1<<B-1;$&J;)J>>=1;if(J!==0?($&=J-1,$+=J):$=0,M++,--de[B]===0){if(B===R)break;B=b[u+m[M]]}if(B>H&&($&j)!==Y){for(Z===0&&(Z=H),ne+=C,q=B-Z,U=1<<q;q+Z<R&&(U-=de[q+Z],!(U<=0));)q++,U<<=1;if(N+=1<<q,g===a&&N>d||g===t&&N>n)return 1;Y=$&j,y[Y]=H<<24|q<<16|ne-p|0}}return $!==0&&(y[ne+$]=B-Z<<24|64<<16|0),E.bits=H,0},Zt}var ba;function xn(){if(ba)return Oe;ba=1;var f=Je(),l=Oa(),d=Ha(),n=wn(),w=bn(),a=0,t=1,o=2,r=4,_=5,c=6,i=0,g=1,b=2,u=-2,k=-3,y=-4,p=-5,m=8,E=1,T=2,B=3,M=4,C=5,R=6,H=7,q=8,Z=9,U=10,N=11,$=12,J=13,V=14,Y=15,j=16,ne=17,be=18,ye=19,ge=20,de=21,_e=22,ce=23,le=24,he=25,ae=26,ee=27,Ee=28,Se=29,te=30,pe=31,Te=32,ze=852,xe=592,ue=15,re=ue;function Be(I){return(I>>>24&255)+(I>>>8&65280)+((I&65280)<<8)+((I&255)<<24)}function nt(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new f.Buf16(320),this.work=new f.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function Qe(I){var L;return!I||!I.state?u:(L=I.state,I.total_in=I.total_out=L.total=0,I.msg="",L.wrap&&(I.adler=L.wrap&1),L.mode=E,L.last=0,L.havedict=0,L.dmax=32768,L.head=null,L.hold=0,L.bits=0,L.lencode=L.lendyn=new f.Buf32(ze),L.distcode=L.distdyn=new f.Buf32(xe),L.sane=1,L.back=-1,i)}function Re(I){var L;return!I||!I.state?u:(L=I.state,L.wsize=0,L.whave=0,L.wnext=0,Qe(I))}function rt(I,L){var s,O;return!I||!I.state||(O=I.state,L<0?(s=0,L=-L):(s=(L>>4)+1,L<48&&(L&=15)),L&&(L<8||L>15))?u:(O.window!==null&&O.wbits!==L&&(O.window=null),O.wrap=s,O.wbits=L,Re(I))}function je(I,L){var s,O;return I?(O=new nt,I.state=O,O.window=null,s=rt(I,L),s!==i&&(I.state=null),s):u}function He(I){return je(I,re)}var it=!0,Ve,Ce;function Ne(I){if(it){var L;for(Ve=new f.Buf32(512),Ce=new f.Buf32(32),L=0;L<144;)I.lens[L++]=8;for(;L<256;)I.lens[L++]=9;for(;L<280;)I.lens[L++]=7;for(;L<288;)I.lens[L++]=8;for(w(t,I.lens,0,288,Ve,0,I.work,{bits:9}),L=0;L<32;)I.lens[L++]=5;w(o,I.lens,0,32,Ce,0,I.work,{bits:5}),it=!1}I.lencode=Ve,I.lenbits=9,I.distcode=Ce,I.distbits=5}function lt(I,L,s,O){var G,e=I.state;return e.window===null&&(e.wsize=1<<e.wbits,e.wnext=0,e.whave=0,e.window=new f.Buf8(e.wsize)),O>=e.wsize?(f.arraySet(e.window,L,s-e.wsize,e.wsize,0),e.wnext=0,e.whave=e.wsize):(G=e.wsize-e.wnext,G>O&&(G=O),f.arraySet(e.window,L,s-O,G,e.wnext),O-=G,O?(f.arraySet(e.window,L,s-O,O,0),e.wnext=O,e.whave=e.wsize):(e.wnext+=G,e.wnext===e.wsize&&(e.wnext=0),e.whave<e.wsize&&(e.whave+=G))),0}function v(I,L){var s,O,G,e,A,z,h,x,D,W,X,K,oe,$e,ve=0,se,we,ke,Le,vt,_t,me,Pe,Ie=new f.Buf8(4),Xe,qe,sa=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!I||!I.state||!I.output||!I.input&&I.avail_in!==0)return u;s=I.state,s.mode===$&&(s.mode=J),A=I.next_out,G=I.output,h=I.avail_out,e=I.next_in,O=I.input,z=I.avail_in,x=s.hold,D=s.bits,W=z,X=h,Pe=i;e:for(;;)switch(s.mode){case E:if(s.wrap===0){s.mode=J;break}for(;D<16;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}if(s.wrap&2&&x===35615){s.check=0,Ie[0]=x&255,Ie[1]=x>>>8&255,s.check=d(s.check,Ie,2,0),x=0,D=0,s.mode=T;break}if(s.flags=0,s.head&&(s.head.done=!1),!(s.wrap&1)||(((x&255)<<8)+(x>>8))%31){I.msg="incorrect header check",s.mode=te;break}if((x&15)!==m){I.msg="unknown compression method",s.mode=te;break}if(x>>>=4,D-=4,me=(x&15)+8,s.wbits===0)s.wbits=me;else if(me>s.wbits){I.msg="invalid window size",s.mode=te;break}s.dmax=1<<me,I.adler=s.check=1,s.mode=x&512?U:$,x=0,D=0;break;case T:for(;D<16;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}if(s.flags=x,(s.flags&255)!==m){I.msg="unknown compression method",s.mode=te;break}if(s.flags&57344){I.msg="unknown header flags set",s.mode=te;break}s.head&&(s.head.text=x>>8&1),s.flags&512&&(Ie[0]=x&255,Ie[1]=x>>>8&255,s.check=d(s.check,Ie,2,0)),x=0,D=0,s.mode=B;case B:for(;D<32;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}s.head&&(s.head.time=x),s.flags&512&&(Ie[0]=x&255,Ie[1]=x>>>8&255,Ie[2]=x>>>16&255,Ie[3]=x>>>24&255,s.check=d(s.check,Ie,4,0)),x=0,D=0,s.mode=M;case M:for(;D<16;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}s.head&&(s.head.xflags=x&255,s.head.os=x>>8),s.flags&512&&(Ie[0]=x&255,Ie[1]=x>>>8&255,s.check=d(s.check,Ie,2,0)),x=0,D=0,s.mode=C;case C:if(s.flags&1024){for(;D<16;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}s.length=x,s.head&&(s.head.extra_len=x),s.flags&512&&(Ie[0]=x&255,Ie[1]=x>>>8&255,s.check=d(s.check,Ie,2,0)),x=0,D=0}else s.head&&(s.head.extra=null);s.mode=R;case R:if(s.flags&1024&&(K=s.length,K>z&&(K=z),K&&(s.head&&(me=s.head.extra_len-s.length,s.head.extra||(s.head.extra=new Array(s.head.extra_len)),f.arraySet(s.head.extra,O,e,K,me)),s.flags&512&&(s.check=d(s.check,O,K,e)),z-=K,e+=K,s.length-=K),s.length))break e;s.length=0,s.mode=H;case H:if(s.flags&2048){if(z===0)break e;K=0;do me=O[e+K++],s.head&&me&&s.length<65536&&(s.head.name+=String.fromCharCode(me));while(me&&K<z);if(s.flags&512&&(s.check=d(s.check,O,K,e)),z-=K,e+=K,me)break e}else s.head&&(s.head.name=null);s.length=0,s.mode=q;case q:if(s.flags&4096){if(z===0)break e;K=0;do me=O[e+K++],s.head&&me&&s.length<65536&&(s.head.comment+=String.fromCharCode(me));while(me&&K<z);if(s.flags&512&&(s.check=d(s.check,O,K,e)),z-=K,e+=K,me)break e}else s.head&&(s.head.comment=null);s.mode=Z;case Z:if(s.flags&512){for(;D<16;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}if(x!==(s.check&65535)){I.msg="header crc mismatch",s.mode=te;break}x=0,D=0}s.head&&(s.head.hcrc=s.flags>>9&1,s.head.done=!0),I.adler=s.check=0,s.mode=$;break;case U:for(;D<32;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}I.adler=s.check=Be(x),x=0,D=0,s.mode=N;case N:if(s.havedict===0)return I.next_out=A,I.avail_out=h,I.next_in=e,I.avail_in=z,s.hold=x,s.bits=D,b;I.adler=s.check=1,s.mode=$;case $:if(L===_||L===c)break e;case J:if(s.last){x>>>=D&7,D-=D&7,s.mode=ee;break}for(;D<3;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}switch(s.last=x&1,x>>>=1,D-=1,x&3){case 0:s.mode=V;break;case 1:if(Ne(s),s.mode=ge,L===c){x>>>=2,D-=2;break e}break;case 2:s.mode=ne;break;case 3:I.msg="invalid block type",s.mode=te}x>>>=2,D-=2;break;case V:for(x>>>=D&7,D-=D&7;D<32;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}if((x&65535)!==(x>>>16^65535)){I.msg="invalid stored block lengths",s.mode=te;break}if(s.length=x&65535,x=0,D=0,s.mode=Y,L===c)break e;case Y:s.mode=j;case j:if(K=s.length,K){if(K>z&&(K=z),K>h&&(K=h),K===0)break e;f.arraySet(G,O,e,K,A),z-=K,e+=K,h-=K,A+=K,s.length-=K;break}s.mode=$;break;case ne:for(;D<14;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}if(s.nlen=(x&31)+257,x>>>=5,D-=5,s.ndist=(x&31)+1,x>>>=5,D-=5,s.ncode=(x&15)+4,x>>>=4,D-=4,s.nlen>286||s.ndist>30){I.msg="too many length or distance symbols",s.mode=te;break}s.have=0,s.mode=be;case be:for(;s.have<s.ncode;){for(;D<3;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}s.lens[sa[s.have++]]=x&7,x>>>=3,D-=3}for(;s.have<19;)s.lens[sa[s.have++]]=0;if(s.lencode=s.lendyn,s.lenbits=7,Xe={bits:s.lenbits},Pe=w(a,s.lens,0,19,s.lencode,0,s.work,Xe),s.lenbits=Xe.bits,Pe){I.msg="invalid code lengths set",s.mode=te;break}s.have=0,s.mode=ye;case ye:for(;s.have<s.nlen+s.ndist;){for(;ve=s.lencode[x&(1<<s.lenbits)-1],se=ve>>>24,we=ve>>>16&255,ke=ve&65535,!(se<=D);){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}if(ke<16)x>>>=se,D-=se,s.lens[s.have++]=ke;else{if(ke===16){for(qe=se+2;D<qe;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}if(x>>>=se,D-=se,s.have===0){I.msg="invalid bit length repeat",s.mode=te;break}me=s.lens[s.have-1],K=3+(x&3),x>>>=2,D-=2}else if(ke===17){for(qe=se+3;D<qe;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}x>>>=se,D-=se,me=0,K=3+(x&7),x>>>=3,D-=3}else{for(qe=se+7;D<qe;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}x>>>=se,D-=se,me=0,K=11+(x&127),x>>>=7,D-=7}if(s.have+K>s.nlen+s.ndist){I.msg="invalid bit length repeat",s.mode=te;break}for(;K--;)s.lens[s.have++]=me}}if(s.mode===te)break;if(s.lens[256]===0){I.msg="invalid code -- missing end-of-block",s.mode=te;break}if(s.lenbits=9,Xe={bits:s.lenbits},Pe=w(t,s.lens,0,s.nlen,s.lencode,0,s.work,Xe),s.lenbits=Xe.bits,Pe){I.msg="invalid literal/lengths set",s.mode=te;break}if(s.distbits=6,s.distcode=s.distdyn,Xe={bits:s.distbits},Pe=w(o,s.lens,s.nlen,s.ndist,s.distcode,0,s.work,Xe),s.distbits=Xe.bits,Pe){I.msg="invalid distances set",s.mode=te;break}if(s.mode=ge,L===c)break e;case ge:s.mode=de;case de:if(z>=6&&h>=258){I.next_out=A,I.avail_out=h,I.next_in=e,I.avail_in=z,s.hold=x,s.bits=D,n(I,X),A=I.next_out,G=I.output,h=I.avail_out,e=I.next_in,O=I.input,z=I.avail_in,x=s.hold,D=s.bits,s.mode===$&&(s.back=-1);break}for(s.back=0;ve=s.lencode[x&(1<<s.lenbits)-1],se=ve>>>24,we=ve>>>16&255,ke=ve&65535,!(se<=D);){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}if(we&&(we&240)===0){for(Le=se,vt=we,_t=ke;ve=s.lencode[_t+((x&(1<<Le+vt)-1)>>Le)],se=ve>>>24,we=ve>>>16&255,ke=ve&65535,!(Le+se<=D);){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}x>>>=Le,D-=Le,s.back+=Le}if(x>>>=se,D-=se,s.back+=se,s.length=ke,we===0){s.mode=ae;break}if(we&32){s.back=-1,s.mode=$;break}if(we&64){I.msg="invalid literal/length code",s.mode=te;break}s.extra=we&15,s.mode=_e;case _e:if(s.extra){for(qe=s.extra;D<qe;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}s.length+=x&(1<<s.extra)-1,x>>>=s.extra,D-=s.extra,s.back+=s.extra}s.was=s.length,s.mode=ce;case ce:for(;ve=s.distcode[x&(1<<s.distbits)-1],se=ve>>>24,we=ve>>>16&255,ke=ve&65535,!(se<=D);){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}if((we&240)===0){for(Le=se,vt=we,_t=ke;ve=s.distcode[_t+((x&(1<<Le+vt)-1)>>Le)],se=ve>>>24,we=ve>>>16&255,ke=ve&65535,!(Le+se<=D);){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}x>>>=Le,D-=Le,s.back+=Le}if(x>>>=se,D-=se,s.back+=se,we&64){I.msg="invalid distance code",s.mode=te;break}s.offset=ke,s.extra=we&15,s.mode=le;case le:if(s.extra){for(qe=s.extra;D<qe;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}s.offset+=x&(1<<s.extra)-1,x>>>=s.extra,D-=s.extra,s.back+=s.extra}if(s.offset>s.dmax){I.msg="invalid distance too far back",s.mode=te;break}s.mode=he;case he:if(h===0)break e;if(K=X-h,s.offset>K){if(K=s.offset-K,K>s.whave&&s.sane){I.msg="invalid distance too far back",s.mode=te;break}K>s.wnext?(K-=s.wnext,oe=s.wsize-K):oe=s.wnext-K,K>s.length&&(K=s.length),$e=s.window}else $e=G,oe=A-s.offset,K=s.length;K>h&&(K=h),h-=K,s.length-=K;do G[A++]=$e[oe++];while(--K);s.length===0&&(s.mode=de);break;case ae:if(h===0)break e;G[A++]=s.length,h--,s.mode=de;break;case ee:if(s.wrap){for(;D<32;){if(z===0)break e;z--,x|=O[e++]<<D,D+=8}if(X-=h,I.total_out+=X,s.total+=X,X&&(I.adler=s.check=s.flags?d(s.check,G,X,A-X):l(s.check,G,X,A-X)),X=h,(s.flags?x:Be(x))!==s.check){I.msg="incorrect data check",s.mode=te;break}x=0,D=0}s.mode=Ee;case Ee:if(s.wrap&&s.flags){for(;D<32;){if(z===0)break e;z--,x+=O[e++]<<D,D+=8}if(x!==(s.total&4294967295)){I.msg="incorrect length check",s.mode=te;break}x=0,D=0}s.mode=Se;case Se:Pe=g;break e;case te:Pe=k;break e;case pe:return y;case Te:default:return u}return I.next_out=A,I.avail_out=h,I.next_in=e,I.avail_in=z,s.hold=x,s.bits=D,(s.wsize||X!==I.avail_out&&s.mode<te&&(s.mode<ee||L!==r))&&lt(I,I.output,I.next_out,X-I.avail_out),W-=I.avail_in,X-=I.avail_out,I.total_in+=W,I.total_out+=X,s.total+=X,s.wrap&&X&&(I.adler=s.check=s.flags?d(s.check,G,X,I.next_out-X):l(s.check,G,X,I.next_out-X)),I.data_type=s.bits+(s.last?64:0)+(s.mode===$?128:0)+(s.mode===ge||s.mode===Y?256:0),(W===0&&X===0||L===r)&&Pe===i&&(Pe=p),Pe}function P(I){if(!I||!I.state)return u;var L=I.state;return L.window&&(L.window=null),I.state=null,i}function F(I,L){var s;return!I||!I.state||(s=I.state,(s.wrap&2)===0)?u:(s.head=L,L.done=!1,i)}function Q(I,L){var s=L.length,O,G,e;return!I||!I.state||(O=I.state,O.wrap!==0&&O.mode!==N)?u:O.mode===N&&(G=1,G=l(G,L,s,0),G!==O.check)?k:(e=lt(I,L,s,s),e?(O.mode=pe,y):(O.havedict=1,i))}return Oe.inflateReset=Re,Oe.inflateReset2=rt,Oe.inflateResetKeep=Qe,Oe.inflateInit=He,Oe.inflateInit2=je,Oe.inflate=v,Oe.inflateEnd=P,Oe.inflateGetHeader=F,Oe.inflateSetDictionary=Q,Oe.inflateInfo="pako inflate (from Nodeca project)",Oe}var Ft,xa;function Na(){return xa||(xa=1,Ft={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}),Ft}var Nt,Ia;function In(){if(Ia)return Nt;Ia=1;function f(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}return Nt=f,Nt}var ya;function yn(){if(ya)return st;ya=1;var f=xn(),l=Je(),d=Za(),n=Na(),w=ea(),a=Fa(),t=In(),o=Object.prototype.toString;function r(i){if(!(this instanceof r))return new r(i);this.options=l.assign({chunkSize:16384,windowBits:0,to:""},i||{});var g=this.options;g.raw&&g.windowBits>=0&&g.windowBits<16&&(g.windowBits=-g.windowBits,g.windowBits===0&&(g.windowBits=-15)),g.windowBits>=0&&g.windowBits<16&&!(i&&i.windowBits)&&(g.windowBits+=32),g.windowBits>15&&g.windowBits<48&&(g.windowBits&15)===0&&(g.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var b=f.inflateInit2(this.strm,g.windowBits);if(b!==n.Z_OK)throw new Error(w[b]);if(this.header=new t,f.inflateGetHeader(this.strm,this.header),g.dictionary&&(typeof g.dictionary=="string"?g.dictionary=d.string2buf(g.dictionary):o.call(g.dictionary)==="[object ArrayBuffer]"&&(g.dictionary=new Uint8Array(g.dictionary)),g.raw&&(b=f.inflateSetDictionary(this.strm,g.dictionary),b!==n.Z_OK)))throw new Error(w[b])}r.prototype.push=function(i,g){var b=this.strm,u=this.options.chunkSize,k=this.options.dictionary,y,p,m,E,T,B=!1;if(this.ended)return!1;p=g===~~g?g:g===!0?n.Z_FINISH:n.Z_NO_FLUSH,typeof i=="string"?b.input=d.binstring2buf(i):o.call(i)==="[object ArrayBuffer]"?b.input=new Uint8Array(i):b.input=i,b.next_in=0,b.avail_in=b.input.length;do{if(b.avail_out===0&&(b.output=new l.Buf8(u),b.next_out=0,b.avail_out=u),y=f.inflate(b,n.Z_NO_FLUSH),y===n.Z_NEED_DICT&&k&&(y=f.inflateSetDictionary(this.strm,k)),y===n.Z_BUF_ERROR&&B===!0&&(y=n.Z_OK,B=!1),y!==n.Z_STREAM_END&&y!==n.Z_OK)return this.onEnd(y),this.ended=!0,!1;b.next_out&&(b.avail_out===0||y===n.Z_STREAM_END||b.avail_in===0&&(p===n.Z_FINISH||p===n.Z_SYNC_FLUSH))&&(this.options.to==="string"?(m=d.utf8border(b.output,b.next_out),E=b.next_out-m,T=d.buf2string(b.output,m),b.next_out=E,b.avail_out=u-E,E&&l.arraySet(b.output,b.output,m,E,0),this.onData(T)):this.onData(l.shrinkBuf(b.output,b.next_out))),b.avail_in===0&&b.avail_out===0&&(B=!0)}while((b.avail_in>0||b.avail_out===0)&&y!==n.Z_STREAM_END);return y===n.Z_STREAM_END&&(p=n.Z_FINISH),p===n.Z_FINISH?(y=f.inflateEnd(this.strm),this.onEnd(y),this.ended=!0,y===n.Z_OK):(p===n.Z_SYNC_FLUSH&&(this.onEnd(n.Z_OK),b.avail_out=0),!0)},r.prototype.onData=function(i){this.chunks.push(i)},r.prototype.onEnd=function(i){i===n.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=l.flattenChunks(this.chunks)),this.chunks=[],this.err=i,this.msg=this.strm.msg};function _(i,g){var b=new r(g);if(b.push(i,!0),b.err)throw b.msg||w[b.err];return b.result}function c(i,g){return g=g||{},g.raw=!0,_(i,g)}return st.Inflate=r,st.inflate=_,st.inflateRaw=c,st.ungzip=_,st}var qt,Ca;function Cn(){if(Ca)return qt;Ca=1;var f=Je().assign,l=mn(),d=yn(),n=Na(),w={};return f(w,l,d,n),qt=w,qt}var ka;function kn(){return ka||(ka=1,(function(f){(function(){var l={},d;f.exports=l,typeof vn=="function"?d=Cn():d=window.pako,(function(n,w){n.toRGBA8=function(a){var t=a.width,o=a.height;if(a.tabs.acTL==null)return[n.toRGBA8.decodeImage(a.data,t,o,a).buffer];var r=[];a.frames[0].data==null&&(a.frames[0].data=a.data);for(var _,c=new Uint8Array(t*o*4),i=0;i<a.frames.length;i++){var g=a.frames[i],b=g.rect.x,u=g.rect.y,k=g.rect.width,y=g.rect.height,p=n.toRGBA8.decodeImage(g.data,k,y,a);if(i==0?_=p:g.blend==0?n._copyTile(p,k,y,_,t,o,b,u,0):g.blend==1&&n._copyTile(p,k,y,_,t,o,b,u,1),r.push(_.buffer),_=_.slice(0),g.dispose!=0){if(g.dispose==1)n._copyTile(c,k,y,_,t,o,b,u,0);else if(g.dispose==2){for(var m=i-1;a.frames[m].dispose==2;)m--;_=new Uint8Array(r[m]).slice(0)}}}return r},n.toRGBA8.decodeImage=function(a,t,o,r){var _=t*o,c=n.decode._getBPP(r),i=Math.ceil(t*c/8),g=new Uint8Array(_*4),b=new Uint32Array(g.buffer),u=r.ctype,k=r.depth,y=n._bin.readUshort;if(u==6){var p=_<<2;if(k==8)for(var m=0;m<p;m++)g[m]=a[m];if(k==16)for(var m=0;m<p;m++)g[m]=a[m<<1]}else if(u==2){var E=r.tabs.tRNS,T=-1,B=-1,M=-1;if(E&&(T=E[0],B=E[1],M=E[2]),k==8)for(var m=0;m<_;m++){var C=m<<2,R=m*3;g[C]=a[R],g[C+1]=a[R+1],g[C+2]=a[R+2],g[C+3]=255,T!=-1&&a[R]==T&&a[R+1]==B&&a[R+2]==M&&(g[C+3]=0)}if(k==16)for(var m=0;m<_;m++){var C=m<<2,R=m*6;g[C]=a[R],g[C+1]=a[R+2],g[C+2]=a[R+4],g[C+3]=255,T!=-1&&y(a,R)==T&&y(a,R+2)==B&&y(a,R+4)==M&&(g[C+3]=0)}}else if(u==3){var H=r.tabs.PLTE,q=r.tabs.tRNS,Z=q?q.length:0;if(k==1)for(var U=0;U<o;U++)for(var N=U*i,$=U*t,m=0;m<t;m++){var C=$+m<<2,J=a[N+(m>>3)]>>7-((m&7)<<0)&1,V=3*J;g[C]=H[V],g[C+1]=H[V+1],g[C+2]=H[V+2],g[C+3]=J<Z?q[J]:255}if(k==2)for(var U=0;U<o;U++)for(var N=U*i,$=U*t,m=0;m<t;m++){var C=$+m<<2,J=a[N+(m>>2)]>>6-((m&3)<<1)&3,V=3*J;g[C]=H[V],g[C+1]=H[V+1],g[C+2]=H[V+2],g[C+3]=J<Z?q[J]:255}if(k==4)for(var U=0;U<o;U++)for(var N=U*i,$=U*t,m=0;m<t;m++){var C=$+m<<2,J=a[N+(m>>1)]>>4-((m&1)<<2)&15,V=3*J;g[C]=H[V],g[C+1]=H[V+1],g[C+2]=H[V+2],g[C+3]=J<Z?q[J]:255}if(k==8)for(var m=0;m<_;m++){var C=m<<2,J=a[m],V=3*J;g[C]=H[V],g[C+1]=H[V+1],g[C+2]=H[V+2],g[C+3]=J<Z?q[J]:255}}else if(u==4){if(k==8)for(var m=0;m<_;m++){var C=m<<2,Y=m<<1,j=a[Y];g[C]=j,g[C+1]=j,g[C+2]=j,g[C+3]=a[Y+1]}if(k==16)for(var m=0;m<_;m++){var C=m<<2,Y=m<<2,j=a[Y];g[C]=j,g[C+1]=j,g[C+2]=j,g[C+3]=a[Y+2]}}else if(u==0){var T=r.tabs.tRNS?r.tabs.tRNS:-1;if(k==1)for(var m=0;m<_;m++){var j=255*(a[m>>3]>>7-(m&7)&1),ne=j==T*255?0:255;b[m]=ne<<24|j<<16|j<<8|j}if(k==2)for(var m=0;m<_;m++){var j=85*(a[m>>2]>>6-((m&3)<<1)&3),ne=j==T*85?0:255;b[m]=ne<<24|j<<16|j<<8|j}if(k==4)for(var m=0;m<_;m++){var j=17*(a[m>>1]>>4-((m&1)<<2)&15),ne=j==T*17?0:255;b[m]=ne<<24|j<<16|j<<8|j}if(k==8)for(var m=0;m<_;m++){var j=a[m],ne=j==T?0:255;b[m]=ne<<24|j<<16|j<<8|j}if(k==16)for(var m=0;m<_;m++){var j=a[m<<1],ne=y(a,m<<1)==T?0:255;b[m]=ne<<24|j<<16|j<<8|j}}return g},n.decode=function(a){for(var t=new Uint8Array(a),o=8,r=n._bin,_=r.readUshort,c=r.readUint,i={tabs:{},frames:[]},g=new Uint8Array(t.length),b=0,u,k=0,y=[137,80,78,71,13,10,26,10],p=0;p<8;p++)if(t[p]!=y[p])throw"The input is not a PNG file!";for(;o<t.length;){var m=r.readUint(t,o);o+=4;var E=r.readASCII(t,o,4);if(o+=4,E=="IHDR")n.decode._IHDR(t,o,i);else if(E=="IDAT"){for(var p=0;p<m;p++)g[b+p]=t[o+p];b+=m}else if(E=="acTL")i.tabs[E]={num_frames:c(t,o),num_plays:c(t,o+4)},u=new Uint8Array(t.length);else if(E=="fcTL"){if(k!=0){var T=i.frames[i.frames.length-1];T.data=n.decode._decompress(i,u.slice(0,k),T.rect.width,T.rect.height),k=0}var B={x:c(t,o+12),y:c(t,o+16),width:c(t,o+4),height:c(t,o+8)},M=_(t,o+22);M=_(t,o+20)/(M==0?100:M);var C={rect:B,delay:Math.round(M*1e3),dispose:t[o+24],blend:t[o+25]};i.frames.push(C)}else if(E=="fdAT"){for(var p=0;p<m-4;p++)u[k+p]=t[o+p+4];k+=m-4}else if(E=="pHYs")i.tabs[E]=[r.readUint(t,o),r.readUint(t,o+4),t[o+8]];else if(E=="cHRM"){i.tabs[E]=[];for(var p=0;p<8;p++)i.tabs[E].push(r.readUint(t,o+p*4))}else if(E=="tEXt"){i.tabs[E]==null&&(i.tabs[E]={});var R=r.nextZero(t,o),H=r.readASCII(t,o,R-o),q=r.readASCII(t,R+1,o+m-R-1);i.tabs[E][H]=q}else if(E=="iTXt"){i.tabs[E]==null&&(i.tabs[E]={});var R=0,Z=o;R=r.nextZero(t,Z);var H=r.readASCII(t,Z,R-Z);Z=R+1,t[Z],t[Z+1],Z+=2,R=r.nextZero(t,Z),r.readASCII(t,Z,R-Z),Z=R+1,R=r.nextZero(t,Z),r.readUTF8(t,Z,R-Z),Z=R+1;var q=r.readUTF8(t,Z,m-(Z-o));i.tabs[E][H]=q}else if(E=="PLTE")i.tabs[E]=r.readBytes(t,o,m);else if(E=="hIST"){var U=i.tabs.PLTE.length/3;i.tabs[E]=[];for(var p=0;p<U;p++)i.tabs[E].push(_(t,o+p*2))}else if(E=="tRNS")i.ctype==3?i.tabs[E]=r.readBytes(t,o,m):i.ctype==0?i.tabs[E]=_(t,o):i.ctype==2&&(i.tabs[E]=[_(t,o),_(t,o+2),_(t,o+4)]);else if(E=="gAMA")i.tabs[E]=r.readUint(t,o)/1e5;else if(E=="sRGB")i.tabs[E]=t[o];else if(E=="bKGD")i.ctype==0||i.ctype==4?i.tabs[E]=[_(t,o)]:i.ctype==2||i.ctype==6?i.tabs[E]=[_(t,o),_(t,o+2),_(t,o+4)]:i.ctype==3&&(i.tabs[E]=t[o]);else if(E=="IEND"){if(k!=0){var T=i.frames[i.frames.length-1];T.data=n.decode._decompress(i,u.slice(0,k),T.rect.width,T.rect.height),k=0}i.data=n.decode._decompress(i,g,i.width,i.height);break}o+=m,r.readUint(t,o),o+=4}return delete i.compress,delete i.interlace,delete i.filter,i},n.decode._decompress=function(a,t,o,r){return a.compress==0&&(t=n.decode._inflate(t)),a.interlace==0?t=n.decode._filterZero(t,a,0,o,r):a.interlace==1&&(t=n.decode._readInterlace(t,a)),t},n.decode._inflate=function(a){return w.inflate(a)},n.decode._readInterlace=function(a,t){for(var o=t.width,r=t.height,_=n.decode._getBPP(t),c=_>>3,i=Math.ceil(o*_/8),g=new Uint8Array(r*i),b=0,u=[0,0,4,0,2,0,1],k=[0,4,0,2,0,1,0],y=[8,8,8,4,4,2,2],p=[8,8,4,4,2,2,1],m=0;m<7;){for(var E=y[m],T=p[m],B=0,M=0,C=u[m];C<r;)C+=E,M++;for(var R=k[m];R<o;)R+=T,B++;var H=Math.ceil(B*_/8);n.decode._filterZero(a,t,b,B,M);for(var q=0,Z=u[m];Z<r;){for(var U=k[m],N=b+q*H<<3;U<o;){if(_==1){var $=a[N>>3];$=$>>7-(N&7)&1,g[Z*i+(U>>3)]|=$<<7-((U&3)<<0)}if(_==2){var $=a[N>>3];$=$>>6-(N&7)&3,g[Z*i+(U>>2)]|=$<<6-((U&3)<<1)}if(_==4){var $=a[N>>3];$=$>>4-(N&7)&15,g[Z*i+(U>>1)]|=$<<4-((U&1)<<2)}if(_>=8)for(var J=Z*i+U*c,V=0;V<c;V++)g[J+V]=a[(N>>3)+V];N+=_,U+=T}q++,Z+=E}B*M!=0&&(b+=M*(1+H)),m=m+1}return g},n.decode._getBPP=function(a){var t=[1,null,3,1,2,null,4][a.ctype];return t*a.depth},n.decode._filterZero=function(a,t,o,r,_){var c=n.decode._getBPP(t),i=Math.ceil(r*c/8),g=n.decode._paeth;c=Math.ceil(c/8);for(var b=0;b<_;b++){var u=o+b*i,k=u+b+1,y=a[k-1];if(y==0)for(var p=0;p<i;p++)a[u+p]=a[k+p];else if(y==1){for(var p=0;p<c;p++)a[u+p]=a[k+p];for(var p=c;p<i;p++)a[u+p]=a[k+p]+a[u+p-c]&255}else if(b==0){for(var p=0;p<c;p++)a[u+p]=a[k+p];if(y==2)for(var p=c;p<i;p++)a[u+p]=a[k+p]&255;if(y==3)for(var p=c;p<i;p++)a[u+p]=a[k+p]+(a[u+p-c]>>1)&255;if(y==4)for(var p=c;p<i;p++)a[u+p]=a[k+p]+g(a[u+p-c],0,0)&255}else{if(y==2)for(var p=0;p<i;p++)a[u+p]=a[k+p]+a[u+p-i]&255;if(y==3){for(var p=0;p<c;p++)a[u+p]=a[k+p]+(a[u+p-i]>>1)&255;for(var p=c;p<i;p++)a[u+p]=a[k+p]+(a[u+p-i]+a[u+p-c]>>1)&255}if(y==4){for(var p=0;p<c;p++)a[u+p]=a[k+p]+g(0,a[u+p-i],0)&255;for(var p=c;p<i;p++)a[u+p]=a[k+p]+g(a[u+p-c],a[u+p-i],a[u+p-c-i])&255}}}return a},n.decode._paeth=function(a,t,o){var r=a+t-o,_=Math.abs(r-a),c=Math.abs(r-t),i=Math.abs(r-o);return _<=c&&_<=i?a:c<=i?t:o},n.decode._IHDR=function(a,t,o){var r=n._bin;o.width=r.readUint(a,t),t+=4,o.height=r.readUint(a,t),t+=4,o.depth=a[t],t++,o.ctype=a[t],t++,o.compress=a[t],t++,o.filter=a[t],t++,o.interlace=a[t],t++},n._bin={nextZero:function(a,t){for(;a[t]!=0;)t++;return t},readUshort:function(a,t){return a[t]<<8|a[t+1]},writeUshort:function(a,t,o){a[t]=o>>8&255,a[t+1]=o&255},readUint:function(a,t){return a[t]*(256*256*256)+(a[t+1]<<16|a[t+2]<<8|a[t+3])},writeUint:function(a,t,o){a[t]=o>>24&255,a[t+1]=o>>16&255,a[t+2]=o>>8&255,a[t+3]=o&255},readASCII:function(a,t,o){for(var r="",_=0;_<o;_++)r+=String.fromCharCode(a[t+_]);return r},writeASCII:function(a,t,o){for(var r=0;r<o.length;r++)a[t+r]=o.charCodeAt(r)},readBytes:function(a,t,o){for(var r=[],_=0;_<o;_++)r.push(a[t+_]);return r},pad:function(a){return a.length<2?"0"+a:a},readUTF8:function(a,t,o){for(var r="",_,c=0;c<o;c++)r+="%"+n._bin.pad(a[t+c].toString(16));try{_=decodeURIComponent(r)}catch{return n._bin.readASCII(a,t,o)}return _}},n._copyTile=function(a,t,o,r,_,c,i,g,b){for(var u=Math.min(t,_),k=Math.min(o,c),y=0,p=0,m=0;m<k;m++)for(var E=0;E<u;E++)if(i>=0&&g>=0?(y=m*t+E<<2,p=(g+m)*_+i+E<<2):(y=(-g+m)*t-i+E<<2,p=m*_+E<<2),b==0)r[p]=a[y],r[p+1]=a[y+1],r[p+2]=a[y+2],r[p+3]=a[y+3];else if(b==1){var T=a[y+3]*.00392156862745098,B=a[y]*T,M=a[y+1]*T,C=a[y+2]*T,R=r[p+3]*(1/255),H=r[p]*R,q=r[p+1]*R,Z=r[p+2]*R,U=1-T,N=T+R*U,$=N==0?0:1/N;r[p+3]=255*N,r[p+0]=(B+H*U)*$,r[p+1]=(M+q*U)*$,r[p+2]=(C+Z*U)*$}else if(b==2){var T=a[y+3],B=a[y],M=a[y+1],C=a[y+2],R=r[p+3],H=r[p],q=r[p+1],Z=r[p+2];T==R&&B==H&&M==q&&C==Z?(r[p]=0,r[p+1]=0,r[p+2]=0,r[p+3]=0):(r[p]=B,r[p+1]=M,r[p+2]=C,r[p+3]=T)}else if(b==3){var T=a[y+3],B=a[y],M=a[y+1],C=a[y+2],R=r[p+3],H=r[p],q=r[p+1],Z=r[p+2];if(T==R&&B==H&&M==q&&C==Z)continue;if(T<220&&R>20)return!1}return!0},n.encode=function(a,t,o,r,_,c){r==null&&(r=0),c==null&&(c=!1);for(var i=new Uint8Array(a[0].byteLength*a.length+100),g=[137,80,78,71,13,10,26,10],b=0;b<8;b++)i[b]=g[b];var u=8,k=n._bin,y=n.crc.crc,p=k.writeUint,m=k.writeUshort,E=k.writeASCII,T=n.encode.compressPNG(a,t,o,r,c);p(i,u,13),u+=4,E(i,u,"IHDR"),u+=4,p(i,u,t),u+=4,p(i,u,o),u+=4,i[u]=T.depth,u++,i[u]=T.ctype,u++,i[u]=0,u++,i[u]=0,u++,i[u]=0,u++,p(i,u,y(i,u-17,17)),u+=4,p(i,u,1),u+=4,E(i,u,"sRGB"),u+=4,i[u]=1,u++,p(i,u,y(i,u-5,5)),u+=4;var B=a.length>1;if(B&&(p(i,u,8),u+=4,E(i,u,"acTL"),u+=4,p(i,u,a.length),u+=4,p(i,u,0),u+=4,p(i,u,y(i,u-12,12)),u+=4),T.ctype==3){var M=T.plte.length;p(i,u,M*3),u+=4,E(i,u,"PLTE"),u+=4;for(var b=0;b<M;b++){var C=b*3,R=T.plte[b],H=R&255,q=R>>8&255,Z=R>>16&255;i[u+C+0]=H,i[u+C+1]=q,i[u+C+2]=Z}if(u+=M*3,p(i,u,y(i,u-M*3-4,M*3+4)),u+=4,T.gotAlpha){p(i,u,M),u+=4,E(i,u,"tRNS"),u+=4;for(var b=0;b<M;b++)i[u+b]=T.plte[b]>>24&255;u+=M,p(i,u,y(i,u-M-4,M+4)),u+=4}}for(var U=0,N=0;N<T.frames.length;N++){var $=T.frames[N];B&&(p(i,u,26),u+=4,E(i,u,"fcTL"),u+=4,p(i,u,U++),u+=4,p(i,u,$.rect.width),u+=4,p(i,u,$.rect.height),u+=4,p(i,u,$.rect.x),u+=4,p(i,u,$.rect.y),u+=4,m(i,u,_[N]),u+=2,m(i,u,1e3),u+=2,i[u]=$.dispose,u++,i[u]=$.blend,u++,p(i,u,y(i,u-30,30)),u+=4);var J=$.cimg,M=J.length;p(i,u,M+(N==0?0:4)),u+=4;var V=u;E(i,u,N==0?"IDAT":"fdAT"),u+=4,N!=0&&(p(i,u,U++),u+=4);for(var b=0;b<M;b++)i[u+b]=J[b];u+=M,p(i,u,y(i,V,u-V)),u+=4}return p(i,u,0),u+=4,E(i,u,"IEND"),u+=4,p(i,u,y(i,u-4,4)),u+=4,i.buffer.slice(0,u)},n.encode.compressPNG=function(a,t,o,r,_){for(var c=n.encode.compress(a,t,o,r,!1,_),i=0;i<a.length;i++){var g=c.frames[i];g.rect.width;var b=g.rect.height,u=g.bpl,k=g.bpp,y=new Uint8Array(b*u+b);g.cimg=n.encode._filterZero(g.img,b,k,u,y)}return c},n.encode.compress=function(a,t,o,r,_,c){c==null&&(c=!1);for(var i=6,g=8,b=4,u=255,k=0;k<a.length;k++)for(var y=new Uint8Array(a[k]),p=y.length,m=0;m<p;m+=4)u&=y[m+3];var E=u!=255,T={},B=[];if(a.length!=0&&(T[0]=0,B.push(0),r!=0&&r--),r!=0){var M=n.quantize(a,r,_);a=M.bufs;for(var m=0;m<M.plte.length;m++){var C=M.plte[m].est.rgba;T[C]==null&&(T[C]=B.length,B.push(C))}}else for(var k=0;k<a.length;k++)for(var R=new Uint32Array(a[k]),p=R.length,m=0;m<p;m++){var C=R[m];if((m<t||C!=R[m-1]&&C!=R[m-t])&&T[C]==null&&(T[C]=B.length,B.push(C),B.length>=300))break}var H=E?_:!1,q=B.length;q<=256&&c==!1&&(q<=2?g=1:q<=4?g=2:q<=16?g=4:g=8,_&&(g=8),E=!0);for(var Z=[],k=0;k<a.length;k++){var U=new Uint8Array(a[k]),N=new Uint32Array(U.buffer),$=0,J=0,V=t,Y=o,j=0;if(k!=0&&!H){for(var ne=_||k==1||Z[Z.length-2].dispose==2?1:2,be=0,ye=1e9,ge=0;ge<ne;ge++){for(var Se=new Uint8Array(a[k-1-ge]),de=new Uint32Array(a[k-1-ge]),_e=t,ce=o,le=-1,he=-1,ae=0;ae<o;ae++)for(var ee=0;ee<t;ee++){var m=ae*t+ee;N[m]!=de[m]&&(ee<_e&&(_e=ee),ee>le&&(le=ee),ae<ce&&(ce=ae),ae>he&&(he=ae))}var Ee=le==-1?1:(le-_e+1)*(he-ce+1);Ee<ye&&(ye=Ee,be=ge,le==-1?($=J=0,V=Y=1):($=_e,J=ce,V=le-_e+1,Y=he-ce+1))}var Se=new Uint8Array(a[k-1-be]);be==1&&(Z[Z.length-1].dispose=2);var te=new Uint8Array(V*Y*4);new Uint32Array(te.buffer),n._copyTile(Se,t,o,te,V,Y,-$,-J,0),n._copyTile(U,t,o,te,V,Y,-$,-J,3)?(n._copyTile(U,t,o,te,V,Y,-$,-J,2),j=1):(n._copyTile(U,t,o,te,V,Y,-$,-J,0),j=0),U=te,N=new Uint32Array(U.buffer)}var pe=4*V;if(q<=256&&c==!1){pe=Math.ceil(g*V/8);for(var te=new Uint8Array(pe*Y),ae=0;ae<Y;ae++){var m=ae*pe,Te=ae*V;if(g==8)for(var ee=0;ee<V;ee++)te[m+ee]=T[N[Te+ee]];else if(g==4)for(var ee=0;ee<V;ee++)te[m+(ee>>1)]|=T[N[Te+ee]]<<4-(ee&1)*4;else if(g==2)for(var ee=0;ee<V;ee++)te[m+(ee>>2)]|=T[N[Te+ee]]<<6-(ee&3)*2;else if(g==1)for(var ee=0;ee<V;ee++)te[m+(ee>>3)]|=T[N[Te+ee]]<<7-(ee&7)*1}U=te,i=3,b=1}else if(E==!1&&a.length==1){for(var te=new Uint8Array(V*Y*3),ze=V*Y,m=0;m<ze;m++){var xe=m*3,ue=m*4;te[xe]=U[ue],te[xe+1]=U[ue+1],te[xe+2]=U[ue+2]}U=te,i=2,b=3,pe=3*V}Z.push({rect:{x:$,y:J,width:V,height:Y},img:U,bpl:pe,bpp:b,blend:j,dispose:H?1:0})}return{ctype:i,depth:g,plte:B,gotAlpha:E,frames:Z}},n.encode._filterZero=function(a,t,o,r,_){for(var c=[],i=0;i<5;i++)if(!(t*r>5e5&&(i==2||i==3||i==4))){for(var g=0;g<t;g++)n.encode._filterLine(_,a,g,r,o,i);if(c.push(w.deflate(_)),o==1)break}for(var b,u=1e9,k=0;k<c.length;k++)c[k].length<u&&(b=k,u=c[k].length);return c[b]},n.encode._filterLine=function(a,t,o,r,_,c){var i=o*r,g=i+o,b=n.decode._paeth;if(a[g]=c,g++,c==0)for(var u=0;u<r;u++)a[g+u]=t[i+u];else if(c==1){for(var u=0;u<_;u++)a[g+u]=t[i+u];for(var u=_;u<r;u++)a[g+u]=t[i+u]-t[i+u-_]+256&255}else if(o==0){for(var u=0;u<_;u++)a[g+u]=t[i+u];if(c==2)for(var u=_;u<r;u++)a[g+u]=t[i+u];if(c==3)for(var u=_;u<r;u++)a[g+u]=t[i+u]-(t[i+u-_]>>1)+256&255;if(c==4)for(var u=_;u<r;u++)a[g+u]=t[i+u]-b(t[i+u-_],0,0)+256&255}else{if(c==2)for(var u=0;u<r;u++)a[g+u]=t[i+u]+256-t[i+u-r]&255;if(c==3){for(var u=0;u<_;u++)a[g+u]=t[i+u]+256-(t[i+u-r]>>1)&255;for(var u=_;u<r;u++)a[g+u]=t[i+u]+256-(t[i+u-r]+t[i+u-_]>>1)&255}if(c==4){for(var u=0;u<_;u++)a[g+u]=t[i+u]+256-b(0,t[i+u-r],0)&255;for(var u=_;u<r;u++)a[g+u]=t[i+u]+256-b(t[i+u-_],t[i+u-r],t[i+u-_-r])&255}}},n.crc={table:(function(){for(var a=new Uint32Array(256),t=0;t<256;t++){for(var o=t,r=0;r<8;r++)o&1?o=3988292384^o>>>1:o=o>>>1;a[t]=o}return a})(),update:function(a,t,o,r){for(var _=0;_<r;_++)a=n.crc.table[(a^t[o+_])&255]^a>>>8;return a},crc:function(a,t,o){return n.crc.update(4294967295,a,t,o)^4294967295}},n.quantize=function(a,t,o){for(var r=[],_=0,c=0;c<a.length;c++)r.push(n.encode.alphaMul(new Uint8Array(a[c]),o)),_+=a[c].byteLength;for(var i=new Uint8Array(_),g=new Uint32Array(i.buffer),b=0,c=0;c<r.length;c++){for(var u=r[c],k=u.length,y=0;y<k;y++)i[b+y]=u[y];b+=k}var p={i0:0,i1:i.length,bst:null,est:null,tdst:0,left:null,right:null};p.bst=n.quantize.stats(i,p.i0,p.i1),p.est=n.quantize.estats(p.bst);for(var m=[p];m.length<t;){for(var E=0,T=0,c=0;c<m.length;c++)m[c].est.L>E&&(E=m[c].est.L,T=c);if(E<.001)break;var B=m[T],M=n.quantize.splitPixels(i,g,B.i0,B.i1,B.est.e,B.est.eMq255),C={i0:B.i0,i1:M,bst:null,est:null,tdst:0,left:null,right:null};C.bst=n.quantize.stats(i,C.i0,C.i1),C.est=n.quantize.estats(C.bst);var R={i0:M,i1:B.i1,bst:null,est:null,tdst:0,left:null,right:null};R.bst={R:[],m:[],N:B.bst.N-C.bst.N};for(var c=0;c<16;c++)R.bst.R[c]=B.bst.R[c]-C.bst.R[c];for(var c=0;c<4;c++)R.bst.m[c]=B.bst.m[c]-C.bst.m[c];R.est=n.quantize.estats(R.bst),B.left=C,B.right=R,m[T]=C,m.push(R)}m.sort(function(ne,be){return be.bst.N-ne.bst.N});for(var H=0;H<r.length;H++){for(var q=n.quantize.planeDst,Z=new Uint8Array(r[H].buffer),U=new Uint32Array(r[H].buffer),N=Z.length,c=0;c<N;c+=4){for(var $=Z[c]*.00392156862745098,J=Z[c+1]*(1/255),V=Z[c+2]*(1/255),Y=Z[c+3]*(1/255),j=p;j.left;)j=q(j.est,$,J,V,Y)<=0?j.left:j.right;U[c>>2]=j.est.rgba}r[H]=U.buffer}return{bufs:r,plte:m}},n.quantize.getNearest=function(a,t,o,r,_){if(a.left==null)return a.tdst=n.quantize.dist(a.est.q,t,o,r,_),a;var c=n.quantize.planeDst(a.est,t,o,r,_),i=a.left,g=a.right;c>0&&(i=a.right,g=a.left);var b=n.quantize.getNearest(i,t,o,r,_);if(b.tdst<=c*c)return b;var u=n.quantize.getNearest(g,t,o,r,_);return u.tdst<b.tdst?u:b},n.quantize.planeDst=function(a,t,o,r,_){var c=a.e;return c[0]*t+c[1]*o+c[2]*r+c[3]*_-a.eMq},n.quantize.dist=function(a,t,o,r,_){var c=t-a[0],i=o-a[1],g=r-a[2],b=_-a[3];return c*c+i*i+g*g+b*b},n.quantize.splitPixels=function(a,t,o,r,_,c){var i=n.quantize.vecDot;for(r-=4;o<r;){for(;i(a,o,_)<=c;)o+=4;for(;i(a,r,_)>c;)r-=4;if(o>=r)break;var g=t[o>>2];t[o>>2]=t[r>>2],t[r>>2]=g,o+=4,r-=4}for(;i(a,o,_)>c;)o-=4;return o+4},n.quantize.vecDot=function(a,t,o){return a[t]*o[0]+a[t+1]*o[1]+a[t+2]*o[2]+a[t+3]*o[3]},n.quantize.stats=function(a,t,o){for(var r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],_=[0,0,0,0],c=o-t>>2,i=t;i<o;i+=4){var g=a[i]*.00392156862745098,b=a[i+1]*(1/255),u=a[i+2]*(1/255),k=a[i+3]*(1/255);_[0]+=g,_[1]+=b,_[2]+=u,_[3]+=k,r[0]+=g*g,r[1]+=g*b,r[2]+=g*u,r[3]+=g*k,r[5]+=b*b,r[6]+=b*u,r[7]+=b*k,r[10]+=u*u,r[11]+=u*k,r[15]+=k*k}return r[4]=r[1],r[8]=r[2],r[12]=r[3],r[9]=r[6],r[13]=r[7],r[14]=r[11],{R:r,m:_,N:c}},n.quantize.estats=function(a){var t=a.R,o=a.m,r=a.N,_=o[0],c=o[1],i=o[2],g=o[3],b=r==0?0:1/r,u=[t[0]-_*_*b,t[1]-_*c*b,t[2]-_*i*b,t[3]-_*g*b,t[4]-c*_*b,t[5]-c*c*b,t[6]-c*i*b,t[7]-c*g*b,t[8]-i*_*b,t[9]-i*c*b,t[10]-i*i*b,t[11]-i*g*b,t[12]-g*_*b,t[13]-g*c*b,t[14]-g*i*b,t[15]-g*g*b],k=u,y=n.M4,p=[.5,.5,.5,.5],m=0,E=0;if(r!=0)for(var T=0;T<10&&(p=y.multVec(k,p),E=Math.sqrt(y.dot(p,p)),p=y.sml(1/E,p),!(Math.abs(E-m)<1e-9));T++)m=E;var B=[_*b,c*b,i*b,g*b],M=y.dot(y.sml(255,B),p),C=B[3]<.001?0:1/B[3];return{Cov:u,q:B,e:p,L:m,eMq255:M,eMq:y.dot(p,B),rgba:(Math.round(255*B[3])<<24|Math.round(255*B[2]*C)<<16|Math.round(255*B[1]*C)<<8|Math.round(255*B[0]*C)<<0)>>>0}},n.M4={multVec:function(a,t){return[a[0]*t[0]+a[1]*t[1]+a[2]*t[2]+a[3]*t[3],a[4]*t[0]+a[5]*t[1]+a[6]*t[2]+a[7]*t[3],a[8]*t[0]+a[9]*t[1]+a[10]*t[2]+a[11]*t[3],a[12]*t[0]+a[13]*t[1]+a[14]*t[2]+a[15]*t[3]]},dot:function(a,t){return a[0]*t[0]+a[1]*t[1]+a[2]*t[2]+a[3]*t[3]},sml:function(a,t){return[a*t[0],a*t[1],a*t[2],a*t[3]]}},n.encode.alphaMul=function(a,t){for(var o=new Uint8Array(a.length),r=a.length>>2,_=0;_<r;_++){var c=_<<2,i=a[c+3];t&&(i=i<128?0:255);var g=i*(1/255);o[c+0]=a[c+0]*g,o[c+1]=a[c+1]*g,o[c+2]=a[c+2]*g,o[c+3]=i}return o}})(l,d)})()})(Mt)),Mt.exports}var En=kn();const Ea=gn(En);function Sn(){if(!S.originalImageData)return Promise.resolve([]);S.isCustomPaletteActive=!1,fe.paletteFileNameEl.textContent="Upload Palette (TXT)...";const f=parseInt(fe.colorSlider.value,10),l=fe.algorithmSelect.value,d=fe.ditheringCheckbox.checked,n=fe.algorithmSelect.options[fe.algorithmSelect.selectedIndex].textContent;return ie(`Processing for ${f} colors using ${n}...`),new Promise((w,a)=>{setTimeout(()=>{try{let t,o;if(l==="median-cut")t=qa(S.originalImageData,f),o=We(S.originalImageData,Ke(t.palette));else if(l==="k-means")t=Ua(S.originalImageData,f),o=We(S.originalImageData,Ke(t.palette));else if(l==="neuquant")t=$a(S.originalImageData,f),o=We(S.originalImageData,Ke(t.palette));else if(l==="octree"){const _=Xa(S.originalImageData,f);t={palette:_.palette},o=_.quantizedData}else throw new Error("Unknown quantization algorithm selected.");const r=Ke(t.palette);if(S.currentPalette=r,d){ie("Applying dithering...");const _=new ImageData(new Uint8ClampedArray(S.originalImageData.data),S.originalImageData.width,S.originalImageData.height);St(_,r),o=_}It(o),ie(`Image quantized to ${S.currentPalette.length} unique colors.`),w(S.currentPalette)}catch(t){console.error("Quantization error:",t),ie("An error occurred during quantization: "+t.message,!0),a(t)}},10)})}function It(f){S.currentQuantizedImageData=f;const l=Ka(S.originalImageData,S.currentQuantizedImageData);fe.psnrValueEl.innerHTML=isFinite(l)?`${l.toFixed(2)} dB`:"&infin;";let d;try{const w=S.currentPalette.length>0?Math.max(S.currentPalette.length,2):256;d=Ea.encode([f.data.buffer],f.width,f.height,w)}catch(w){console.warn("PNG Encoding Error (retrying with 256):",w);try{d=Ea.encode([f.data.buffer],f.width,f.height,256)}catch(a){console.error("Final PNG Encoding Error:",a),ie("Error creating indexed PNG.",!0),fe.quantizedImageSizeEl.textContent="(Error)";return}}S.currentObjectUrl&&URL.revokeObjectURL(S.currentObjectUrl);const n=new Blob([d],{type:"image/png"});S.currentObjectUrl=URL.createObjectURL(n),fe.quantizedImage.src=S.currentObjectUrl,fe.quantizedImageSizeEl.textContent=`(${Pa(d.byteLength)})`,fe.exportPaletteBtn.disabled=!1}function Ke(f){const l=new Map;for(const d of f){const n=d.join(",");l.has(n)||l.set(n,d)}return Array.from(l.values())}function St(f,l){const d=f.data,n=f.width,w=f.height,a=new Float32Array(d.length);for(let o=0;o<d.length;o++)a[o]=d[o];const t=(o,r,_,c,i,g)=>{if(o<0||o>=n||r<0||r>=w)return;const b=(r*n+o)*4;a[b]+=_*g,a[b+1]+=c*g,a[b+2]+=i*g};for(let o=0;o<w;o++)for(let r=0;r<n;r++){const _=(o*n+r)*4,c=a[_],i=a[_+1],g=a[_+2],[b,u,k]=Ya([c,i,g],l);d[_]=b,d[_+1]=u,d[_+2]=k;const y=c-b,p=i-u,m=g-k;t(r+1,o,y,p,m,7/16),t(r-1,o+1,y,p,m,3/16),t(r,o+1,y,p,m,5/16),t(r+1,o+1,y,p,m,1/16)}}function qa(f,l){const d=An(f);return d.length===0?{palette:[]}:{palette:zn([d],l).filter(t=>t.length>0).map(Mn)}}function Ua(f,l,d=20){const n=ta(f);if(n.length===0)return{palette:[]};l>n.length&&(l=n.length);let w=[];const a=Array.from({length:n.length},(r,_)=>_);for(let r=0;r<l;r++){const _=a.splice(Math.floor(Math.random()*a.length),1)[0];w.push([...n[_]])}let t=new Uint32Array(n.length),o=!0;for(let r=0;o&&r<d;r++){o=!1;for(let c=0;c<n.length;c++){const i=n[c];let g=1/0,b=-1;for(let u=0;u<l;u++){const k=(i[0]-w[u][0])**2+(i[1]-w[u][1])**2+(i[2]-w[u][2])**2;k<g&&(g=k,b=u)}t[c]!==b&&(t[c]=b,o=!0)}const _=Array.from({length:l},()=>[0,0,0,0]);for(let c=0;c<n.length;c++){const i=n[c],g=t[c];g!==-1&&(_[g][0]+=i[0],_[g][1]+=i[1],_[g][2]+=i[2],_[g][3]++)}for(let c=0;c<l;c++)_[c][3]>0?w[c]=[Math.round(_[c][0]/_[c][3]),Math.round(_[c][1]/_[c][3]),Math.round(_[c][2]/_[c][3])]:(w[c]=[...n[Math.floor(Math.random()*n.length)]],o=!0)}return{palette:w}}function $a(f,l,d=.2,n=30,w=30*l){const a=ta(f);if(a.length===0)return{palette:[]};const t=Array.from({length:l},()=>[Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256)]),o=Math.min(a.length,w),r=o;for(let _=0;_<o;_++){const c=a[Math.floor(Math.random()*a.length)],i=d*Math.exp(-_/r),g=n*Math.exp(-_/r);let b=0,u=1/0;for(let y=0;y<l;y++){const p=Sa(c,t[y]);p<u&&(u=p,b=y)}const k=t[b];for(let y=0;y<l;y++){const p=Sa(t[y],k);if(p<=g){const m=Math.exp(-(p*p)/(2*g*g)),E=i*m;t[y][0]=Ut(t[y][0]+E*(c[0]-t[y][0])),t[y][1]=Ut(t[y][1]+E*(c[1]-t[y][1])),t[y][2]=Ut(t[y][2]+E*(c[2]-t[y][2]))}}}return{palette:t}}class Dn{constructor(){this.heap=[]}isEmpty(){return this.heap.length===0}push(l){this.heap.push(l),this.bubbleUp(this.heap.length-1)}pop(){if(this.isEmpty())return null;const l=this.heap[0],d=this.heap.pop();return this.heap.length>0&&(this.heap[0]=d,this.sinkDown(0)),l}bubbleUp(l){for(;l>0;){const d=Math.floor((l-1)/2);if(this.heap[d].pixelCount>this.heap[l].pixelCount)[this.heap[d],this.heap[l]]=[this.heap[l],this.heap[d]],l=d;else break}}sinkDown(l){const d=2*l+1,n=2*l+2;let w=l;d<this.heap.length&&this.heap[d].pixelCount<this.heap[w].pixelCount&&(w=d),n<this.heap.length&&this.heap[n].pixelCount<this.heap[w].pixelCount&&(w=n),w!==l&&([this.heap[w],this.heap[l]]=[this.heap[l],this.heap[w]],this.sinkDown(w))}}class ht{constructor(l,d){this.children=new Array(8).fill(null),this.isLeaf=!0,this.pixelCount=0,this.redSum=0,this.greenSum=0,this.blueSum=0,this.paletteIndex=-1,this.level=l,this.parent=d}addPixel(l,d,n){if(!this.isLeaf){const a=bt(l,d);this.children[a]||(this.children[a]=new ht(d+1,this)),this.children[a].addPixel(l,d+1,n);return}if(d===7){this.pixelCount++,this.redSum+=l[0],this.greenSum+=l[1],this.blueSum+=l[2];return}if(this.pixelCount>0){const a=[this.redSum/this.pixelCount,this.greenSum/this.pixelCount,this.blueSum/this.pixelCount],t=bt(a,d);this.children[t]=new ht(d+1,this),this.children[t].pixelCount=this.pixelCount,this.children[t].redSum=this.redSum,this.children[t].greenSum=this.greenSum,this.children[t].blueSum=this.blueSum}this.isLeaf=!1,this.pixelCount=0,this.redSum=0,this.greenSum=0,this.blueSum=0,n[this.level].push(this);const w=bt(l,d);this.children[w]||(this.children[w]=new ht(d+1,this)),this.children[w].addPixel(l,d+1,n)}mergeChildren(){if(!this.isLeaf){for(let l=0;l<8;l++){const d=this.children[l];d&&(this.redSum+=d.redSum,this.greenSum+=d.greenSum,this.blueSum+=d.blueSum,this.pixelCount+=d.pixelCount,this.children[l]=null)}this.isLeaf=!0}}getLeaves(l){if(this.isLeaf)this.pixelCount&&l.push(this);else for(let d=0;d<8;d++)this.children[d]&&this.children[d].getLeaves(l)}getAverageColor(){return this.pixelCount===0?[0,0,0]:[Math.round(this.redSum/this.pixelCount),Math.round(this.greenSum/this.pixelCount),Math.round(this.blueSum/this.pixelCount)]}}function bt(f,l){let d=0;const n=7-l;return f[0]>>n&1&&(d|=4),f[1]>>n&1&&(d|=2),f[2]>>n&1&&(d|=1),d}function Xa(f,l){const d=ta(f);if(!d.length)return{quantizedData:new ImageData(f.width,f.height),palette:[]};const n=new ht(0,null),w=Array.from({length:8},()=>new Dn);for(const g of d)n.addPixel(g,0,w);const a=[];n.getLeaves(a);let t=a.length;if(t>l){let g=7;for(;t>l&&g>=0;){for(;!w[g].isEmpty()&&t>l;){const b=w[g].pop();if(!b)continue;const u=[];b.getLeaves(u);const k=u.length;b.mergeChildren(),t=t-k+1,b.parent&&!b.parent.isLeaf&&b.parent.level>0&&w[b.parent.level].push(b.parent)}g--}}const o=[];n.getLeaves(o);const r=o.map(g=>g.getAverageColor()),_=new ImageData(f.width,f.height),c=f.data,i=_.data;for(let g=0;g<c.length;g+=4){const b=c[g+3];if(b<128){i[g]=c[g],i[g+1]=c[g+1],i[g+2]=c[g+2],i[g+3]=b;continue}const u=[c[g],c[g+1],c[g+2]];let k=n;for(let p=0;p<=7&&!k.isLeaf;p++){const m=bt(u,p);if(!k.children[m])break;k=k.children[m]}const y=k.getAverageColor();i[g]=y[0],i[g+1]=y[1],i[g+2]=y[2],i[g+3]=b}return{quantizedData:_,palette:r}}function Sa(f,l){const d=f[0]-l[0],n=f[1]-l[1],w=f[2]-l[2];return Math.sqrt(.3*d*d+.59*n*n+.11*w*w)}function Ut(f){return Math.min(255,Math.max(0,Math.round(f)))}function An(f){const l=[],d=f.data;for(let n=0;n<d.length;n+=4)if(d[n+3]>128){const w=[d[n],d[n+1],d[n+2]];l.push({rgb:w,lab:ft(w)})}return l}function ta(f){const l=[],d=f.data;for(let n=0;n<d.length;n+=4)d[n+3]>128&&l.push([d[n],d[n+1],d[n+2]]);return l}function zn(f,l){for(;f.length<l;){let d=-1,n=-1,w=-1;for(let o=0;o<f.length;o++)if(f[o].length>1){const{range:r,channelIndex:_}=Ln(f[o]);r>n&&(n=r,d=o,w=_)}if(d===-1)break;const a=f[d];a.sort((o,r)=>o.lab[w]-r.lab[w]);const t=Math.floor(a.length/2);f.splice(d,1,a.slice(0,t),a.slice(t))}return f}function Ln(f){let l=1/0,d=-1/0,n=1/0,w=-1/0,a=1/0,t=-1/0;for(const c of f){const[i,g,b]=c.lab;i<l&&(l=i),i>d&&(d=i),g<n&&(n=g),g>w&&(w=g),b<a&&(a=b),b>t&&(t=b)}const o=d-l,r=w-n,_=t-a;return o>=r&&o>=_?{channelIndex:0,range:o}:r>=o&&r>=_?{channelIndex:1,range:r}:{channelIndex:2,range:_}}function Mn(f){let l=0,d=0,n=0;for(const w of f)l+=w.lab[0],d+=w.lab[1],n+=w.lab[2];return On([l/f.length,d/f.length,n/f.length])}function Tn([f,l,d]){let[n,w,a]=[f,l,d].map(t=>(t/=255,t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92));return[n*.4124564+w*.3575761+a*.1804375,n*.2126729+w*.7151522+a*.072175,n*.0193339+w*.119192+a*.9503041]}function Bn([f,l,d]){const[n,w,a]=[.95047,1,1.08883],t=c=>c>.008856?Math.cbrt(c):7.787*c+16/116,o=t(f/n),r=t(l/w),_=t(d/a);return[116*r-16,500*(o-r),200*(r-_)]}function ft(f){return Bn(Tn(f))}function Rn([f,l,d]){const[n,w,a]=[.95047,1,1.08883],t=(f+16)/116,o=l/500+t,r=t-d/200,_=i=>i*i*i,c=i=>_(i)>.008856?_(i):(i-16/116)/7.787;return[n*c(o),w*c(t),a*c(r)]}function Pn([f,l,d]){let n=f*3.2406+l*-1.5372+d*-.4986,w=f*-.9689+l*1.8758+d*.0415,a=f*.0557+l*-.204+d*1.057;const t=o=>o>.0031308?1.055*Math.pow(o,1/2.4)-.055:12.92*o;return[Math.round(Math.min(Math.max(0,t(n)),1)*255),Math.round(Math.min(Math.max(0,t(w)),1)*255),Math.round(Math.min(Math.max(0,t(a)),1)*255)]}function On(f){return Pn(Rn(f))}function Ya(f,l){let d=1/0,n=l[0];for(const w of l){const a=(f[0]-w[0])**2+(f[1]-w[1])**2+(f[2]-w[2])**2;a<d&&(d=a,n=w)}return n}function We(f,l){const d=new ImageData(f.width,f.height);if(l.length===0)return d;const n=f.data,w=d.data,a={};for(let t=0;t<n.length;t+=4){const o=n[t+3];if(o<128){w[t]=n[t],w[t+1]=n[t+1],w[t+2]=n[t+2],w[t+3]=o;continue}const r=n[t],_=n[t+1],c=n[t+2],i=`${r}|${_}|${c}`;let g=a[i];g||(g=Ya([r,_,c],l),a[i]=g),w[t]=g[0],w[t+1]=g[1],w[t+2]=g[2],w[t+3]=o}return d}function Ka(f,l){const d=f.data,n=l.data;let w=0,a=0;for(let t=0;t<d.length;t+=4)d[t+3]>128&&(w+=(d[t]-n[t])**2,w+=(d[t+1]-n[t+1])**2,w+=(d[t+2]-n[t+2])**2,a++);return w===0?1/0:(w=w/(a*3),20*Math.log10(255)-10*Math.log10(w))}const{paletteContainer:Da,quantizedCanvas:ct,quantizedImage:gt,quantizedCtx:aa,colorSlider:Qa,sliderValueEl:ja,customColorPicker:Fe,rgbTabBtn:pt,hslTabBtn:mt,rgbPanel:Aa,hslPanel:za,ditheringCheckbox:Hn,nativeColorPickerInCustom:ut,hslH:Va,hslS:Wa,hslL:Ja,hslHValue:Ga,hslSValue:en,hslLValue:tn,hslCurrentColorDisplay:Dt,collapseThresholdInput:yt,collapseThresholdError:jt}=fe;function Zn(f,{selectionActive:l}={}){if(l){dt(f);return}S.currentPalette=f,dt(S.currentPalette);const d=S.currentPalette.length;ja.textContent=d,S.isCustomPaletteActive||(Qa.value=d)}Ae.setHandlers({applySnapshot:({imageData:f,palette:l})=>{if(!f||!l)return;S.currentPalette=l,It(f),dt(S.currentPalette);const d=S.currentPalette.length;ja.textContent=d,S.isCustomPaletteActive||(Qa.value=d)},updateStatus:ie,applyImageUpdate:f=>{f&&It(f)},applyPalette:Zn});function dt(f){wt(),S.paletteSwatchLookup.clear(),Da.innerHTML="",f.forEach(l=>{const[d,n,w]=l,a=De(d,n,w),t=document.createElement("div");t.className="palette-swatch",t.style.backgroundColor=a;const o=l.join(",");t.dataset.r=d,t.dataset.g=n,t.dataset.b=w,t.dataset.colorKey=o,t.title=`Click to edit ${a.toUpperCase()} (or right-click to copy)`,t.innerHTML=`<span>${a.toUpperCase()}</span>`,S.paletteSwatchLookup.set(o,t);const r=document.createElement("button");r.className="delete-color-btn",r.innerHTML="&times;",r.title=`Remove color ${a.toUpperCase()}`,r.addEventListener("click",g=>{g.stopPropagation(),Nn(l)});const _=document.createElement("button");_.className="neighbor-color-btn",_.innerHTML="&#8635;",_.title=`Remap ${a.toUpperCase()} to nearby colors`,_.addEventListener("click",g=>{g.stopPropagation(),wt(),qn(l)});const c=document.createElement("div");c.className="palette-action-wrapper",c.appendChild(_),c.appendChild(r),t.appendChild(c);const i=document.createElement("button");i.className="collapse-color-btn",i.innerHTML="&#8611;",i.title="Collapse similar colors",i.addEventListener("click",g=>{g.stopPropagation(),Un(l)}),t.appendChild(i),t.addEventListener("mouseenter",()=>Fn(l)),t.addEventListener("mouseleave",()=>wt()),t.addEventListener("click",g=>{g.preventDefault(),wt(),ct.classList.remove("hidden"),gt.classList.add("hidden"),aa.putImageData(S.currentQuantizedImageData,0,0),S.currentEditedSwatch=t,S.originalColorForEditing=[parseInt(t.dataset.r),parseInt(t.dataset.g),parseInt(t.dataset.b)],S.preEditImageData=new ImageData(new Uint8ClampedArray(S.currentQuantizedImageData.data),S.currentQuantizedImageData.width,S.currentQuantizedImageData.height),S.latestPreviewColor=[...S.originalColorForEditing];const b=De(...S.originalColorForEditing);Dt.style.backgroundColor=b,ut.value=b,Fe.classList.remove("hidden");const u=t.getBoundingClientRect();let k=u.bottom+window.scrollY+10,y=u.left+window.scrollX;y+Fe.offsetWidth>window.innerWidth&&(y=window.innerWidth-Fe.offsetWidth-20),y<0&&(y=20),k+Fe.offsetHeight>window.innerHeight+window.scrollY&&(k=u.top+window.scrollY-Fe.offsetHeight-10),k<0&&(k=20),Fe.style.top=`${k}px`,Fe.style.left=`${y}px`,Vt("rgb")}),t.addEventListener("contextmenu",g=>{g.preventDefault(),navigator.clipboard.writeText(a).then(()=>{ie(`Copied ${a.toUpperCase()} to clipboard!`)})}),Da.appendChild(t)})}function Fn(f){if(!S.currentQuantizedImageData||!Fe.classList.contains("hidden"))return;S.paletteMaskPreviewActive=!0,S.paletteMaskTargetColor=[...f];const l=new ImageData(new Uint8ClampedArray(S.currentQuantizedImageData.data),S.currentQuantizedImageData.width,S.currentQuantizedImageData.height),d=l.data,[n,w,a]=f,[t,o,r]=S.maskColor,_=Ae.selectionBounds,c=l.width,i=l.height,g=_?_.y:0,b=_?_.y+_.height:i,u=_?_.x:0,k=_?_.x+_.width:c;for(let y=g;y<b;y++)for(let p=u;p<k;p++){const m=(y*c+p)*4;d[m]===n&&d[m+1]===w&&d[m+2]===a&&(d[m]=t,d[m+1]=o,d[m+2]=r)}aa.putImageData(l,0,0),ct.classList.remove("hidden"),gt.classList.add("hidden")}function wt(){S.paletteMaskPreviewActive&&(S.paletteMaskPreviewActive=!1,S.paletteMaskTargetColor=null,Fe.classList.contains("hidden")&&(ct.classList.add("hidden"),gt.classList.remove("hidden")))}function Nn(f){if(!S.originalImageData||!S.currentQuantizedImageData){ie("Cannot remove color without a loaded image.",!0);return}return ie(`Removing color ${De(...f)}...`),Ae.executeOnActiveRegion(`removal of ${De(...f)}`,({imageData:l,palette:d})=>new Promise(n=>{setTimeout(()=>{if(d.length<=2){n({imageData:l,palette:d,statusMessage:"Cannot have fewer than 2 colors in the palette.",statusIsError:!0});return}const w=d.findIndex(r=>JSON.stringify(r)===JSON.stringify(f));if(w===-1){n({imageData:l,palette:d,statusMessage:"Could not find the color to remove.",statusIsError:!0});return}d.splice(w,1);const a=Hn.checked,t=new ImageData(new Uint8ClampedArray(l.data),l.width,l.height);let o;a?(o=new ImageData(new Uint8ClampedArray(t.data),t.width,t.height),St(o,d)):o=We(t,d),n({imageData:o,palette:d,statusMessage:`Color removed. New palette has ${d.length} colors.`})},10)}))}function qn(f){return!S.originalImageData||!S.currentQuantizedImageData?(ie("Cannot remap colors without a loaded image.",!0),Promise.resolve()):(ie(`Remapping ${De(...f)} using neighboring colors...`),Ae.executeOnActiveRegion(`remap of ${De(...f)}`,({imageData:l})=>new Promise(d=>{setTimeout(()=>{const n=new Uint8ClampedArray(l.data),w=l.width,a=l.height,t=new Uint8ClampedArray(n),[o,r,_]=f,c=u=>u[0]===o&&u[1]===r&&u[2]===_,i=[[0,-1],[1,0],[0,1],[-1,0]];let g=0;for(let u=0;u<a;u++)for(let k=0;k<w;k++){const y=(u*w+k)*4;if(n[y]!==o||n[y+1]!==r||n[y+2]!==_)continue;const p=[],m=[];for(const[H,q]of i){const Z=k+H,U=u+q;if(Z<0||U<0||Z>=w||U>=a)continue;const N=(U*w+Z)*4,$=[n[N],n[N+1],n[N+2]];p.push($),c($)||m.push($)}if(p.length===0||m.length===0)continue;const E=new Map;for(const H of p){const q=H.join(","),Z=E.get(q);Z?Z.count+=1:E.set(q,{color:H,count:1,isTarget:c(H)})}const T=`${o},${r},${_}`;p.length===4&&E.size===4&&E.has(T)&&E.delete(T);const B=[...E.values()].sort((H,q)=>q.count-H.count);let M=null;const C=B.filter(H=>!H.isTarget),R=C.find(H=>H.count>=3);if(R&&(M=R.color),!M&&p.length<4){const H=C[0],q=C[1];H&&H.count>=2&&(!q||H.count>q.count)&&(M=H.color)}if(!M&&p.length===4&&B.length===2&&B[0].count===2&&B[1].count===2&&!B.some(q=>q.isTarget)){const q=Math.random()<.5?0:1;M=B[q].color}if(!M&&p.length===4){const H=B.find(Z=>Z.count===2&&!Z.isTarget),q=B.filter(Z=>Z.count===1).length;H&&q===2&&(M=H.color)}if(!M){const H=C[0];H&&(C.length===1||H.count>(C[1]?.count||0))&&(M=H.color)}if(!M&&m.length>0){const H=Math.floor(Math.random()*m.length);M=m[H]}M&&(t[y]=M[0],t[y+1]=M[1],t[y+2]=M[2],g++)}if(g===0){d({imageData:l,statusMessage:"No eligible neighboring pixels found; nothing changed.",statusIsError:!0});return}const b=new ImageData(t,w,a);d({imageData:b,statusMessage:`Remapped ${g} pixel(s) of ${De(...f)} using neighbors.`})},10)})))}function Un(f){const l=yt.value,d=parseFloat(l);if(l===""||isNaN(d)||d<0){jt.textContent="Invalid input. Must be a positive number.",yt.value="2.5";return}if(jt.textContent="",!S.originalImageData||!S.currentQuantizedImageData){ie("Cannot collapse colors without a loaded image.",!0);return}if(S.currentPalette.length<=2){ie("Cannot collapse further, minimum of 2 colors required.",!0);return}return ie(`Collapsing colors similar to ${De(...f)}...`),Ae.executeOnActiveRegion(`collapse of ${De(...f)}`,({imageData:n,palette:w})=>new Promise(a=>{setTimeout(()=>{const t=ft(f),o=[],r=new Set,_=JSON.stringify(f);for(const k of w){if(JSON.stringify(k)===_){o.push(k);continue}const y=ft(k);Math.sqrt(Math.pow(t[0]-y[0],2)+Math.pow(t[1]-y[1],2)+Math.pow(t[2]-y[2],2))>=d?o.push(k):r.add(k.join(","))}if(o.length===w.length){a({imageData:n,palette:w,statusMessage:"No colors found within that threshold to collapse."});return}if(o.length<2){a({imageData:n,palette:w,statusMessage:"Collapse would result in fewer than 2 colors. Aborting.",statusIsError:!0});return}const c=new ImageData(new Uint8ClampedArray(n.data),n.width,n.height),i=c.data,[g,b,u]=f;for(let k=0;k<i.length;k+=4){const y=`${i[k]},${i[k+1]},${i[k+2]}`;r.has(y)&&(i[k]=g,i[k+1]=b,i[k+2]=u)}a({imageData:c,palette:o,statusMessage:`Colors collapsed. New palette has ${o.length} colors.`})},10)}))}function $n(){if(!S.originalImageData||!S.currentQuantizedImageData){ie("Cannot collapse colors without a loaded image.",!0);return}if(S.currentPalette.length<=2){ie("Cannot collapse further minimum of 2 colors required.",!0);return}const f=parseFloat(yt.value);if(isNaN(f)||f<0){jt.textContent="Invalid threshold. Using default 2.5",yt.value="2.5";return}return ie("Attempting to collapse all colors..."),Ae.executeOnActiveRegion("collapse all colors",({imageData:l,palette:d})=>new Promise(n=>{setTimeout(()=>{let w=!1,a=0;const t=100,o=[...d],r=new ImageData(new Uint8ClampedArray(l.data),l.width,l.height);for(;a<t&&o.length>2;){const _=o.length;let c=!1;for(let i=0;i<o.length&&o.length>2;i++){const g=o[i],b=ft(g),u=JSON.stringify(g);let k=!1;for(let y=0;y<o.length;y++){if(i===y)continue;const p=o[y],m=ft(p);if(Math.sqrt(Math.pow(b[0]-m[0],2)+Math.pow(b[1]-m[1],2)+Math.pow(b[2]-m[2],2))<f){k=!0;break}}if(k){const y=[],p=new Set;for(const m of o){if(JSON.stringify(m)===u){y.push(m);continue}const E=ft(m);Math.sqrt(Math.pow(b[0]-E[0],2)+Math.pow(b[1]-E[1],2)+Math.pow(b[2]-E[2],2))>=f?y.push(m):p.add(m.join(","))}if(y.length>=2){o.length=0,o.push(...y);const m=r.data,[E,T,B]=g;for(let M=0;M<m.length;M+=4){const C=`${m[M]},${m[M+1]},${m[M+2]}`;p.has(C)&&(m[M]=E,m[M+1]=T,m[M+2]=B)}c=!0,w=!0;break}}}if(!c||o.length===_)break;a++}n(w?{imageData:r,palette:o,statusMessage:`Collapsed to ${o.length} colors after ${a} iteration(s).`}:{imageData:l,palette:d,statusMessage:"No colors found within threshold to collapse."})},10)}))}function an(f,l,d,n=null){const w=f.data,a=f.width,t=f.height,[o,r,_]=l,[c,i,g]=d,b=n?Math.max(n.y,0):0,u=n?Math.min(n.y+n.height,t):t,k=n?Math.max(n.x,0):0,y=n?Math.min(n.x+n.width,a):a;for(let p=b;p<u;p++)for(let m=k;m<y;m++){const E=(p*a+m)*4;w[E]===o&&w[E+1]===r&&w[E+2]===_&&(w[E]=c,w[E+1]=i,w[E+2]=g)}}function Vt(f){if(f==="rgb")Aa.classList.remove("hidden"),za.classList.add("hidden"),pt.classList.add("border-indigo-500","text-indigo-700"),pt.classList.remove("border-transparent","text-gray-500","hover:text-gray-700"),mt.classList.remove("border-indigo-500","text-indigo-700"),mt.classList.add("border-transparent","text-gray-500","hover:text-gray-700"),ut.value=De(...S.latestPreviewColor);else if(f==="hsl"){Aa.classList.add("hidden"),za.classList.remove("hidden"),mt.classList.add("border-indigo-500","text-indigo-700"),mt.classList.remove("border-transparent","text-gray-500","hover:text-gray-700"),pt.classList.remove("border-indigo-500","text-indigo-700"),pt.classList.add("border-transparent","text-gray-500","hover:text-gray-700");const[l,d,n]=Qn(...S.latestPreviewColor);Va.value=l,Wa.value=d,Ja.value=n,Ga.textContent=l,en.textContent=`${d}%`,tn.textContent=`${n}%`,Dt.style.backgroundColor=De(...S.latestPreviewColor)}}function nn(f){if(!S.preEditImageData||!S.originalColorForEditing)return;const l=new ImageData(new Uint8ClampedArray(S.preEditImageData.data),S.preEditImageData.width,S.preEditImageData.height),d=Ae.selectionBounds||null;an(l,S.originalColorForEditing,f,d),aa.putImageData(l,0,0),S.latestPreviewColor=f,ie(`Previewing color ${De(...f)}...`)}function Xn(){const f=rn(ut.value);Dt.style.backgroundColor=ut.value,nn(f)}function $t(){const f=parseInt(Va.value),l=parseInt(Wa.value),d=parseInt(Ja.value);Ga.textContent=f,en.textContent=`${l}%`,tn.textContent=`${d}%`;const n=jn(f,l,d),w=De(...n);Dt.style.backgroundColor=w,ut.value=w,nn(n)}function Yn(){if(!S.originalColorForEditing||!S.latestPreviewColor)return;const f=De(...S.latestPreviewColor),l=[...S.originalColorForEditing],d=[...S.latestPreviewColor],n=Ae.executeOnActiveRegion(`color edit to ${f}`,({imageData:w,palette:a})=>new Promise(t=>{setTimeout(()=>{const o=a.findIndex(r=>JSON.stringify(r)===JSON.stringify(l));if(o===-1){t({imageData:w,palette:a,statusMessage:"Could not find the color to edit.",statusIsError:!0});return}an(w,l,d),a[o]=d,t({imageData:w,palette:a,statusMessage:`Color updated to ${f}.`})},0)}));return n.finally(()=>{ct.classList.add("hidden"),gt.classList.remove("hidden"),Fe.classList.add("hidden"),S.originalColorForEditing=null,S.latestPreviewColor=null,S.preEditImageData=null,S.currentEditedSwatch=null}),n}function Kn(){S.preEditImageData&&(ct.classList.add("hidden"),gt.classList.remove("hidden"),ie("Color change cancelled.",!1),Fe.classList.add("hidden"),S.originalColorForEditing=null,S.latestPreviewColor=null,S.preEditImageData=null,S.currentEditedSwatch=null)}function De(f,l,d){return"#"+((1<<24)+(f<<16)+(l<<8)+d).toString(16).slice(1).toUpperCase()}function rn(f){const l=f.startsWith("#")?f.slice(1):f;if(l.length===3){const d=parseInt(l[0]+l[0],16),n=parseInt(l[1]+l[1],16),w=parseInt(l[2]+l[2],16);return[d,n,w]}else if(l.length===6){const d=parseInt(l.slice(0,2),16),n=parseInt(l.slice(2,4),16),w=parseInt(l.slice(4,6),16);return[d,n,w]}return[0,0,0]}function Qn(f,l,d){f/=255,l/=255,d/=255;const n=Math.max(f,l,d),w=Math.min(f,l,d);let a=0,t,o=(n+w)/2;if(n===w)a=t=0;else{const r=n-w;switch(t=o>.5?r/(2-n-w):r/(n+w),n){case f:a=(l-d)/r+(l<d?6:0);break;case l:a=(d-f)/r+2;break;case d:a=(f-l)/r+4;break}a/=6}return[Math.round(a*360),Math.round(t*100),Math.round(o*100)]}function jn(f,l,d){f/=360,l/=100,d/=100;let n,w,a;if(l===0)n=w=a=d;else{const t=(_,c,i)=>(i<0&&(i+=1),i>1&&(i-=1),i<.16666666666666666?_+(c-_)*6*i:i<.5?c:i<.6666666666666666?_+(c-_)*(.6666666666666666-i)*6:_),o=d<.5?d*(1+l):d+l-d*l,r=2*d-o;n=t(r,o,f+1/3),w=t(r,o,f),a=t(r,o,f-1/3)}return[Math.round(n*255),Math.round(w*255),Math.round(a*255)]}function Vn(){if(!S.currentPalette||S.currentPalette.length===0){ie("No palette to export.",!0);return}const f=S.currentPalette.map(w=>De(...w)).join(`
`),l=new Blob([f],{type:"text/plain;charset=utf-8"}),d=URL.createObjectURL(l),n=document.createElement("a");n.href=d,n.download="palette.txt",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(d),ie("Palette exported successfully!")}const{imageUpload:Wn,paletteUpload:ln,paletteFileNameEl:na,colorSlider:At,sliderValueEl:on,algorithmSelect:sn,ditheringCheckbox:ra,collapseThresholdInput:Wt,collapseThresholdError:La,exportPaletteBtn:Jn,collapseAllBtn:Gn,runFullAnalysisBtn:Jt,resultContainer:er,analysisContainer:tr,paletteSectionContainer:ar,fullAnalysisResults:fn,analysisTableBody:Xt,analysisTableContainer:Ma,fileNameEl:nr,originalImageSizeEl:rr,appContainer:Yt,rgbTabBtn:ir,hslTabBtn:lr,nativeColorPickerInCustom:or,hslH:sr,hslS:fr,hslL:hr,confirmColorBtn:ur,cancelColorBtn:dr,originalCanvas:Ta,quantizedCanvas:Kt,quantizedImage:at,quantizedImageWrapper:Gt,selectionOverlay:Me,originalCtx:Qt,quantizedCtx:cr}=fe;let Ct=!1,Ye=null;const kt=()=>Sn().then(f=>dt(f||[])).catch(()=>{}),gr=Lr(kt,250);function Ba(){vr(),_r(),on.textContent=At.value,xt(!1)}function vr(){Wn.addEventListener("change",f=>ia(f.target.files[0])),ln.addEventListener("change",f=>Er(f.target.files[0])),At.addEventListener("input",Cr),sn.addEventListener("change",kt),ra.addEventListener("change",kt),Jn.addEventListener("click",Vn),Gn.addEventListener("click",$n),Jt.addEventListener("click",kr),ir.addEventListener("click",()=>Vt("rgb")),lr.addEventListener("click",()=>Vt("hsl")),or.addEventListener("input",Xn),sr.addEventListener("input",$t),fr.addEventListener("input",$t),hr.addEventListener("input",$t),ur.addEventListener("click",Yn),dr.addEventListener("click",Kn),Wt.addEventListener("input",Ar),document.addEventListener("paste",mr,!1),document.addEventListener("keydown",wr,!1),at.setAttribute("draggable","false"),at.addEventListener("dragstart",f=>f.preventDefault()),at.addEventListener("mousedown",br,!1),document.addEventListener("mousemove",xr,!1),document.addEventListener("mouseup",Ir,!1),window.addEventListener("resize",()=>Et(Ae.selectionBounds)),at.addEventListener("load",()=>Et(Ae.selectionBounds))}function _r(){const f=l=>{l.preventDefault(),l.stopPropagation()};["dragenter","dragover","dragleave","drop"].forEach(l=>{document.body.addEventListener(l,f,!1)}),document.body.addEventListener("dragenter",()=>Yt.classList.add("drag-over"),!1),document.body.addEventListener("dragleave",()=>Yt.classList.remove("drag-over"),!1),document.body.addEventListener("drop",l=>{Yt.classList.remove("drag-over"),pr(l)},!1)}function ia(f){if(!f||!f.type.startsWith("image/")){ie("Please select or drop/paste a valid image file.",!0);return}S.currentImageFile=f,nr.textContent=hn(f.name),rr.textContent=`(${Pa(f.size)})`;const l=new FileReader;l.onload=d=>{const n=new Image;n.onload=()=>{Ta.width=n.width,Ta.height=n.height,Kt.width=n.width,Kt.height=n.height,Qt.imageSmoothingEnabled=!1,cr.imageSmoothingEnabled=!1,Qt.drawImage(n,0,0),S.originalImageData=Qt.getImageData(0,0,n.width,n.height),Ae.clearSelectionBounds(),Et(null),er.classList.remove("hidden"),tr.classList.remove("hidden"),ar.classList.remove("hidden"),fn.classList.add("hidden"),Kt.classList.add("hidden"),at.classList.remove("hidden"),xt(!0),S.isCustomPaletteActive=!1,na.textContent="Upload Palette (TXT)...",ie("Image loaded. Ready to quantize."),kt()},n.src=d.target?.result||""},l.readAsDataURL(f)}function pr(f){f.preventDefault(),f.dataTransfer?.files?.length&&ia(f.dataTransfer.files[0])}function mr(f){f.preventDefault();const l=f.clipboardData?.items||[];for(const d of l)if(d.type.includes("image")){const n=d.getAsFile();if(n){ia(n);return}}ie("No image found in clipboard.",!0)}function wr(f){const l=typeof f.key=="string"?f.key.toLowerCase():"",d=(f.ctrlKey||f.metaKey)&&!f.shiftKey&&l==="z",n=(f.ctrlKey||f.metaKey)&&!f.shiftKey&&l==="y",w=f.target,a=w&&(w.tagName==="INPUT"||w.tagName==="TEXTAREA"||w.isContentEditable);d&&!a?(f.preventDefault(),Ae.undo()):n&&!a&&(f.preventDefault(),Ae.redo())}function br(f){if(f.button!==0)return;const l=oa(f);l&&(f.preventDefault(),Ct=!0,Ye=l,Me.classList.remove("hidden"),la(l.wrapperX,l.wrapperY,l.wrapperX,l.wrapperY))}function xr(f){if(!Ct||!Ye)return;const l=oa(f);l&&la(Ye.wrapperX,Ye.wrapperY,l.wrapperX,l.wrapperY)}function Ir(f){if(!Ct||f.button!==0)return;f.preventDefault();const l=oa(f)||Ye;if(Ct=!1,!Ye||!l){Ra(!1),Ye=null;return}const d=yr(Ye,l);if(Ye=null,!d||d.width<2||d.height<2){Ra(!0);return}Ae.setSelectionBounds(d),Et(d),ie("Focused on selected region.")}function la(f,l,d,n){if(!Me)return;const w=Math.min(f,d),a=Math.min(l,n),t=Math.abs(f-d),o=Math.abs(l-n);Me.style.left=`${w}px`,Me.style.top=`${a}px`,Me.style.width=`${t}px`,Me.style.height=`${o}px`}function yr(f,l){if(!S.currentQuantizedImageData)return null;const d=S.currentQuantizedImageData.width,n=S.currentQuantizedImageData.height,w=Math.max(Math.min(f.imageX,l.imageX),0),a=Math.max(Math.min(f.imageY,l.imageY),0),t=Math.min(Math.max(f.imageX,l.imageX),d),o=Math.min(Math.max(f.imageY,l.imageY),n),r=Math.floor(w),_=Math.floor(a),c=Math.max(1,Math.ceil(t)-r),i=Math.max(1,Math.ceil(o)-_);return{x:r,y:_,width:c,height:i}}function Ra(f){Ae.clearSelectionBounds(),Me&&Me.classList.add("hidden"),f&&ie("Focus reset to the entire image.")}function Et(f){if(!Me||!f||!S.currentQuantizedImageData){Me&&Me.classList.add("hidden");return}const l=at.getBoundingClientRect();if(!l.width||!l.height){Me.classList.add("hidden");return}const d=Gt.getBoundingClientRect(),n=l.width/S.currentQuantizedImageData.width,w=l.height/S.currentQuantizedImageData.height,a=f.x*n+(l.left-d.left),t=f.y*w+(l.top-d.top),o=f.width*n,r=f.height*w;Me.classList.remove("hidden"),la(a,t,a+o,t+r)}function oa(f){if(!S.currentQuantizedImageData||!Gt)return null;const l=at.getBoundingClientRect(),d=Gt.getBoundingClientRect();if(!l.width||!l.height)return null;const n=f.clientX-l.left,w=f.clientY-l.top,a=Math.min(Math.max(n,0),l.width),t=Math.min(Math.max(w,0),l.height),o=a+(l.left-d.left),r=t+(l.top-d.top),_=S.currentQuantizedImageData.width/l.width,c=S.currentQuantizedImageData.height/l.height;return{imageX:a*_,imageY:t*c,wrapperX:o,wrapperY:r}}function Cr(){on.textContent=At.value,S.originalImageData&&gr()}async function kr(){if(!S.originalImageData){ie("Please upload an image first.",!0);return}xt(!1),Jt.disabled=!0,fn.classList.remove("hidden"),Xt.innerHTML="";const f=parseInt(At.value,10);let l=null;const d=sn.value,n=ra.checked;S.isCustomPaletteActive=!1,na.textContent="Upload Palette (TXT)...";try{for(let w=2;w<=f;w++){ie(`Analysis: Processing for ${w} colors...`),await zr(10);try{let a,t;if(d==="median-cut")a=qa(S.originalImageData,w),t=We(S.originalImageData,Ke(a.palette));else if(d==="k-means")a=Ua(S.originalImageData,w),t=We(S.originalImageData,Ke(a.palette));else if(d==="neuquant")a=$a(S.originalImageData,w),t=We(S.originalImageData,Ke(a.palette));else if(d==="octree"){const i=Xa(S.originalImageData,w);a={palette:i.palette},t=i.quantizedData}else throw new Error("Unknown quantization algorithm selected.");const o=Ke(a.palette);n&&(t=new ImageData(new Uint8ClampedArray(S.originalImageData.data),S.originalImageData.width,S.originalImageData.height),St(t,o));const r=Ka(S.originalImageData,t),_=Xt.insertRow();_.className="border-b border-gray-100",_.insertCell().textContent=w,_.insertCell().textContent=Number.isFinite(r)?r.toFixed(2):"";const c=_.insertCell();if(l!==null&&Number.isFinite(r)&&Number.isFinite(l)){const i=r-l;c.textContent=i.toFixed(2),c.classList.add(i>=0?"delta-positive":"delta-negative")}else c.textContent="N/A";l=r,Ma.scrollTop=Ma.scrollHeight}catch(a){console.error(`Error during full analysis for ${w} colors:`,a);const t=Xt.insertRow();t.className="border-b border-gray-100 text-red-600",t.insertCell().textContent=w,t.insertCell().textContent="Error",t.insertCell().textContent="Error",ie(`An error occurred during analysis for ${w} colors.`,!0);break}}ie("Full analysis complete!")}finally{xt(!0),Jt.disabled=!1}}function Er(f){if(!f||!f.type.startsWith("text/")){ie("Please select a valid text file for the palette.",!0);return}na.textContent=hn(f.name);const l=new FileReader;l.onload=d=>{try{const n=Sr(d.target?.result||"");if(n.length===0){ie("No valid colors found in the palette file.",!0);return}Dr(n),ie(`Custom palette with ${n.length} colors loaded.`)}catch(n){console.error("Error parsing palette file:",n),ie("Error parsing palette file. Please check format.",!0)}},l.readAsText(f),ln.value=""}function Sr(f){return f.split(`
`).map(l=>l.trim()).filter(Boolean).map(l=>{if(l.startsWith("#")||l.length===6||l.length===3)return rn(l);if(l.includes(",")){const d=l.split(",").map(n=>parseInt(n.trim(),10));if(d.length===3&&d.every(n=>Number.isInteger(n)&&n>=0&&n<=255))return d}return console.warn(`Could not parse color: ${l}`),null}).filter(l=>Array.isArray(l)&&l.every(d=>!Number.isNaN(d)))}function Dr(f){if(!S.originalImageData){ie("Please upload an image first to apply a palette.",!0);return}S.isCustomPaletteActive=!0,S.currentPalette=Ke(f);const l=ra.checked;let d;l?(ie("Applying dithering with custom palette..."),d=new ImageData(new Uint8ClampedArray(S.originalImageData.data),S.originalImageData.width,S.originalImageData.height),St(d,S.currentPalette)):d=We(S.originalImageData,S.currentPalette),It(d),dt(S.currentPalette),ie(`Image mapped to custom palette with ${S.currentPalette.length} unique colors.`)}function Ar(){const f=parseFloat(Wt.value);Wt.value===""||!Number.isNaN(f)&&f>=0?La.textContent="":La.textContent="Invalid input. Must be a positive number."}function hn(f){return f.length>20?`${f.substring(0,17)}...`:f}function zr(f){return new Promise(l=>setTimeout(l,f))}function Lr(f,l=250){let d;return(...n)=>{d&&clearTimeout(d),d=setTimeout(()=>f.apply(null,n),l)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ba):Ba();
