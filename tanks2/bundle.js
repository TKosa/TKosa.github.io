(()=>{var he=class{constructor(){this.eventHandlers={}}on(t,e){this.eventHandlers[t]||(this.eventHandlers[t]=[]),this.eventHandlers[t].push(e)}emit(t,...e){let i=this.eventHandlers[t];!i||i.length===0||i.forEach(s=>{try{s.apply(null,e)}catch{}})}},C=new he;var b=document.getElementById("myCanvas"),c=b.getContext("2d");c.imageSmoothingEnabled=!1;c.mozImageSmoothingEnabled=!1;c.webkitImageSmoothingEnabled=!1;c.msImageSmoothingEnabled=!1;var G=1280,R=720;b.width=G;b.height=R;function Et(r){let t=document.getElementById("hud-scoreboard");t&&t.classList.toggle("hidden",!r)}function Ct(){let r=document.getElementById("hud-scoreboard");if(!r)return;let t=b.getBoundingClientRect(),e=Math.round(t.height*.2);r.style.left=Math.round(t.left)+"px",r.style.top=Math.round(t.top)+"px",r.style.width=Math.round(t.width)+"px",r.style.height=e+"px"}function Kt(){let r=document.getElementById("game-slot")||document.body,t=r.clientWidth||window.innerWidth,e=r.clientHeight||window.innerHeight,i=G/R,s=t,n=Math.round(s/i);n>e&&(n=e,s=Math.round(n*i)),b.style.width=s+"px",b.style.height=n+"px",b.style.margin="0";try{Ct()}catch{}}Kt();window.addEventListener("resize",Kt);var De=!1;function je(){De||(document.addEventListener("click",function(r){if(!(r.target&&r.target.closest?r.target.closest(".sb-network"):null))return;r.stopPropagation(),r.preventDefault();let e=document.getElementById("net-stats-overlay");e&&e.classList.toggle("hidden")},!0),document.addEventListener("click",function(r){if(r.target&&r.target.closest&&r.target.closest(".sb-test")){r.stopPropagation(),r.preventDefault();try{window.__mazeRef&&typeof window.__mazeRef.testFlattenAndRegen=="function"&&window.__mazeRef.testFlattenAndRegen()}catch{}}},!0),De=!0)}function We(r){return!!(r&&r.tagName==="IMG"&&r.complete&&r.naturalWidth>0)}var st=class{constructor(t,e=0,i=0){this.x=e,this.y=i,this.width=20,this.height=20,this.maze=t,this.delegate=null,this._handled=!1,t&&typeof t.nextPowerupId=="number"?this.id=t.nextPowerupId++:this.id=this.id||0}getMessage(){return this.name}draw(){if(We(this.img)){var t=c.imageSmoothingEnabled;c.imageSmoothingEnabled=!0,c.drawImage(this.img,this.x,this.y,this.width,this.height),c.imageSmoothingEnabled=t;return}c.lineWidth=1,c.strokeStyle=this.color,c.strokeRect(this.x,this.y,this.width,this.width)}onBulletHit(t){this.pickup(t)}pickup(t){if(!this.maze)return!1;var e=null;if(typeof t=="string"){var i=t;if(Array.isArray(this.maze.tanks)){for(var s=0;s<this.maze.tanks.length;s++)if(this.maze.tanks[s]&&this.maze.tanks[s].id===i){e=this.maze.tanks[s];break}}}else e=t;if(!e||this._handled)return!1;this._handled=!0;try{this.maze.removePowerup(this)}catch{}this.tank=e;try{e.removeAllPowerups()}catch{}try{e.addPowerup(this)}catch{}try{this.timeout=setTimeout(this.teardown.bind(this),this.maze.settings.powerup_duration*1e3)}catch{}try{this.notifyActivate(e)}catch{}try{this.maze.drawScoreboardTop&&this.maze.drawScoreboardTop()}catch{}return!0}teardown(){try{this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.tank&&this.tank.removePowerup(this),this.maze&&this.maze.drawScoreboardTop&&this.maze.drawScoreboardTop()}catch{}}registerDelegate(t){this.delegate=t}broadcast(t){typeof this.delegate=="function"&&this.delegate(t)}getTargetType(){return"tank"}serialize(){return{name:this.name,type:this.constructor&&this.constructor.name?this.constructor.name:this.name,spriteId:this.img&&this.img.id?this.img.id:null}}notifyActivate(t){this.emitEvent("activate",t)}notifyDeactivate(t){this.emitEvent("deactivate",t)}emitEvent(t,e){let i={type:"powerup",status:t,powerup:this.constructor&&this.constructor.name?this.constructor.name:this.name,target:this.getTargetType()};e&&(i.tankId=e.id,i.peerId=e.ownerPeerId),this.id&&(i.powerupId=this.id),this.broadcast(i);try{var s=["X",i.powerup,t,i.target||"",i.tankId||"",this.id||""];y.broadcast(s.join(","))}catch{}}},Yt=class extends st{constructor(t,e,i){super(t,e,i),this.name="Trippy",this.color="green",this.img=document.getElementById("pills")}effect(t){typeof this.maze.trippyCount!="number"&&(this.maze.trippyCount=0),this.maze.trippyCount+=1}undo(t){typeof this.maze.trippyCount!="number"&&(this.maze.trippyCount=0),this.maze.trippyCount=Math.max(0,(this.maze.trippyCount||0)-1)}getTargetType(){return"global"}};function ue(r,t){var e=String(r||"");try{if(/Trippy/i.test(e))return new Yt(t);if(/Remove\s*Bullet\s*Limit|RemoveBulletLimit/i.test(e))return new Vt(t);if(/Triple\s*-?Shot|TripleShot/i.test(e))return new qt(t);if(/MoveThroughWalls|ghost/i.test(e))return new Rt(t);if(/Teleport/i.test(e))return new Xt(t);if(/Cannon(ball)?/i.test(e))return new Jt(t);if(/Invis/i.test(e))return new le(t);if(/Shinra/i.test(e))return new Qt(t);if(/Hex/i.test(e))return new ce(t)}catch{}return null}var Vt=class extends st{constructor(t,e,i){super(t,e,i),this.name="Remove Bullet Limit",this.color="orange",this.img=document.getElementById("unlimited")}effect(t){t.shouldFire=function(){return!!this.shooting}}undo(t){t.shouldFire=function(){return!!(this.shooting&&this.bullets.length<this.bullet_limit)}}},qt=class extends st{constructor(t,e,i){super(t,e,i),this.name="Triple-Shot",this.color="red",this.img=document.getElementById("tripleshot")}effect(t){t.fire=function(){this.fire_helper(this.rotation,this.maze.settings.bullet_speed),this.fire_helper(this.rotation-Math.PI/12,this.maze.settings.bullet_speed),this.fire_helper(this.rotation+Math.PI/12,this.maze.settings.bullet_speed)},t.bullet_limit=3*this.maze.settings.bullet_limit}undo(t){t.fire=function(){this.fire_helper(this.rotation,this.maze.settings.bullet_speed)},t.bullet_limit=this.maze.settings.bullet_limit}},Rt=class extends st{constructor(t,e,i){super(t,e,i),this.name="ghost",this.color="blue",this.img=document.getElementById("ghost")}effect(t){t.tryMovingTo=function(e){var i=e[0],s=e[1];this.maze.isOutOfBounds([i,s])||(this.x=i,this.y=s)}}undo(t){if(t.tryMovingTo=function(s){var n=s[0],o=s[1];this.maze.doesRectCollide([n,o,this.width,this.height])||(this.x=n,this.y=o)},t.maze.doesRectCollide([t.x,t.y,t.width,t.height])){var e=t.maze.getSquareAtXY([t.x,t.y]);if(e){var i=e.getCenter();t.x=i[0],t.y=i[1]}}}},Xt=class extends st{constructor(t,e,i){super(t,e,i),this.name="Teleport",this.color="cyan",this.img=document.getElementById("teleport")}effect(t){this.draw_mirror=function(){c.save(),c.translate(b.width-(this.x+this.width/2),this.maze.height-(this.y+this.height/2)),c.rotate(this.rotation||0);var e=c.globalAlpha;c.globalAlpha=.3;var i=document.getElementById("tank");if(We(i)){var s=c.imageSmoothingEnabled;c.imageSmoothingEnabled=!0,c.drawImage(i,-this.width/2,-this.height/2,this.width,this.height),c.imageSmoothingEnabled=s}else c.fillStyle=this.colour,c.fillRect(-this.width/2,-this.height/2,this.width,this.height);c.globalAlpha=e,c.restore()}.bind(t);try{this.draw_mirror.__tp_tankId=t.id}catch{}t.maze.extraFunctionsPerCycle.push(this.draw_mirror),t.maze.teleportMirrors[t.id]=!0,t.special=function(){if(this.poweruplock!=!0){this.x=b.width-this.x-this.width,this.y=this.maze.height-this.y-this.height,this.tryMovingTo([this.x,this.y]);try{if(y&&y.isHost&&this.maze.doesRectCollide([this.x,this.y,this.width,this.height])){var e=this.maze.getSquareAtXY([this.x,this.y]);if(e){var i=e.getCenter();this.x=i[0],this.y=i[1]}}}catch{}this.poweruplock=!0}}}undo(t){try{removeElementFromArray(this.draw_mirror,t.maze.extraFunctionsPerCycle);var e=t.maze.extraFunctionsPerCycle;if(Array.isArray(e))for(var i=e.length-1;i>=0;i--){var s=e[i];s&&s.__tp_tankId&&s.__tp_tankId===t.id&&e.splice(i,1)}}catch{}try{delete t.maze.teleportMirrors[t.id]}catch{}if(t.special=function(){},t.poweruplock=!1,t.maze.doesRectCollide([t.x,t.y,t.width,t.height])){var n=t.maze.getSquareAtXY([t.x,t.y]);if(n){var o=n.getCenter();t.x=o[0],t.y=o[1]}}}},Jt=class extends st{constructor(t,e,i){super(t,e,i),this.name="CannonBall",this.color="grey",this.img=document.getElementById("cannonball")}onBulletHit(t){super.onBulletHit(t),this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}effect(t){t.special=function(){this.fire();var e=this.bullets[this.bullets.length-1];e.radius=50;var i=2;e.direction[0]*=i,e.direction[1]*=i,e.handleMovement=function(){this.x+=this.direction[0],this.y+=this.direction[1],(this.x>b.width+this.radius||this.x<0-this.radius||this.y>this.tank.maze.height+this.radius||this.y<0-this.radius)&&this.tank.removeBullet(this)},this.special=function(){},this.removeAllPowerups()}}undo(t){t.special=function(){}}},le=class extends st{constructor(t,e,i){super(t,e,i),this.name="Invisibility",this.color="grey",this.img=document.getElementById("invisible")}effect(t){t.old_draw=t.draw,t.draw=function(){this.bullets.forEach(function(e){e.draw()})},t.special=t.old_draw}undo(t){t.draw=t.old_draw}},Qt=class r extends st{constructor(t,e,i){super(t,e,i),this.name="Shinra Tensei",this.color="purple",this.img=document.getElementById("repel")}effect(t){t.special=function(){this.maze.tanks.forEach(function(e){r.repelTank(this,e),e.bullets.forEach(function(i){r.repelBullet(this,i)}.bind(this))}.bind(this))}}undo(t){t.special=function(){}}static repelTank(t,e){if(t!=e){var i=e.x-t.x,s=e.y-t.y,n=Math.sqrt(i*i+s*s)||1,o=2,a=i/n,l=s/n;e.tryMovingTo([e.x+a*o,e.y+l*o])}}static repelBullet(t,e){var i=e.x-t.x,s=e.y-t.y,n=Math.sqrt(i*i+s*s)||1,o=i/n,a=s/n,l=.5,h=e.direction[0]+o*l,u=e.direction[1]+a*l,f=t&&t.maze&&t.maze.settings&&t.maze.settings.bullet_speed?t.maze.settings.bullet_speed:3,d=Math.sqrt(h*h+u*u);if(d>f){var p=f/d;h*=p,u*=p}e.direction[0]=h,e.direction[1]=u}},ce=class extends st{constructor(t,e,i){super(t,e,i),this.name="Hex",this.color="purple",this.img=document.getElementById("hex")}effect(t){t.maze.tanks.forEach(function(e){[e.onLeftPress,e.onRightPress]=[e.onRightPress,e.onLeftPress],[e.onUpPress,e.onDownPress]=[e.onDownPress,e.onUpPress]})}undo(t){this.effect(t)}};function fe(r){switch(Math.floor(8*Math.random())){case 0:return new Yt(r);case 1:return new Vt(r);case 2:return new qt(r);case 3:return new Rt(r);case 4:return new Xt(r);case 5:return new Jt(r);case 6:return new Qt(r);case 7:return new Rt(r)}}var K={},E=K;K.encodeFreeText=function(r){return(""+(r??"")).replace(/,/g,"\xB7").replace(/[|;]/g,"/")};K.decodeFreeText=function(r){return(""+(r??"")).replace(/·/g,",")};K.buildCompactPlayerList=function(r){var t=(r||[]).map(function(e){var i=e&&e.id?e.id:"",s=e&&e.nickname?K.encodeFreeText(e.nickname):"Player";return i+"|"+s}).join(";");return"P,"+t};K.handlePeerMessage=function(r,t,e){if(t=N&&N.hydrate?N.hydrate(t,r,e):t,t!=null&&!(typeof t!="string"||!t.length)){var i=t[0];switch(i){case"U":{if(!r.isHost&&r.game&&r.game.maze&&typeof r.game.maze.applyUnifiedSnapshot=="function")try{r.game.maze.applyUnifiedSnapshot(t.substring(2))}catch{}return}case"S":{if(r.isHost)return;try{if(!r.game||!r.game.maze)return;var s=r.game.maze,n=t.substring(2)||"";if(!n)return;var o=n.split("|"),a=o[0]||"",l=parseInt(o[1]||"0",10)||0,h=parseInt(o[2]||"0",10)||0,u=parseInt(o[3]||"0",10)||0,f=parseInt(o[4]||"20",10)||20,d=parseInt(o[5]||"20",10)||20,p=o[6]||"",g=o[7]||"";s.remotePowerups||(s.remotePowerups=[]),s.remotePowerups.push({id:l,type:a,name:a,x:h,y:u,width:f,height:d,spriteId:p,color:g}),s.remoteState={tanks:s.remoteTankMeta,powerups:s.remotePowerups}}catch{}return}case"Q":{if(r.isHost)try{var v=parseInt(t.substring(2),10)||0;e&&e.send&&e.send(N.buildPong(v))}catch{}return}case"q":{if(!r.isHost)try{var _=parseInt(t.substring(2),10)>>>0,w=Math.floor(performance.now()),m=w>>>0,S=m-_>>>0;S<=3e4&&(r._stats.rttMs=S)}catch{}return}case"I":{!r.isHost&&r.game&&typeof r.game.startFromHostCompact=="function"&&r.game.startFromHostCompact(t);return}case"D":{!r.isHost&&r.game&&typeof r.game.updateStateFromHostCompact=="function"&&r.game.updateStateFromHostCompact(t);return}case"C":{if(r.isHost)try{var P=t.split(","),x={tankId:P[1],upPressed:P[2]==="1",rightPressed:P[3]==="1",downPressed:P[4]==="1",leftPressed:P[5]==="1",shooting:P[6]==="1",specialKeyPressed:P[7]==="1",peerId:e&&e.peer};r.applyInputState(x)}catch{}return}case"P":{try{var n=t.substring(2)||"",M=[];n&&n.split(";").forEach(function(ht){if(ht){var J=ht.split("|"),lt=J[0],ne=K.decodeFreeText(J[1]||"Player");lt&&M.push({id:lt,nickname:ne})}}),r.updatePlayersFromPayload(M),r.maybeEmitReady("player-list-compact")}catch{}return}case"N":{try{var T=t.split(","),U=T[1]||e&&e.peer,L=K.decodeFreeText(T[2]||"Player");U&&(r.players.set(U,L),r.emitPlayerList(),r.isHost&&(r.broadcast(t,e),r.broadcastPlayerList())),r.isHost||r.maybeEmitReady("nickname-compact")}catch{}return}case"M":{try{var F=t.split(","),O=K.decodeFreeText(F[1]||"Player"),$=K.decodeFreeText(F.slice(2).join(","));Z(O+": "+$,"other-message"),r.isHost&&r.broadcast(t,e)}catch{}return}case"E":{try{var j=K.decodeFreeText(t.substring(2));Z("* "+j,"notification-message"),r.isHost&&r.broadcast(t,e)}catch{}return}case"V":{if(!r.isHost&&r.game&&r.game.maze&&typeof r.game.maze.applyUnifiedDelta=="function")try{r.game.maze.applyUnifiedDelta(t.substring(2))}catch{}return}case"X":{try{var ot=t.split(","),It=ot[1]||"",At=ot[2]||"",St=ot[3]||"",mt=ot[4]||"",Y=parseInt(ot[5]||"0",10)||0,x={type:"powerup",powerup:It,status:At,target:St,tankId:mt,powerupId:Y};if(r.isHost&&r.game&&r.game.maze){var W=r.game.maze,yt=!1;if(Y&&Array.isArray(W.powerups))for(var gt=0;gt<W.powerups.length;gt++){var at=W.powerups[gt];if(at&&at.id===Y&&typeof at.pickup=="function"){yt=at.pickup(mt)||yt;break}}if(!yt)try{var wt=ue(It,W);if(wt&&typeof wt.pickup=="function")try{wt.pickup(mt)}catch{}}catch{}r.broadcast(t,e);return}if(!r.isHost&&r.game&&r.game.maze){var s=r.game.maze;typeof s.applyPowerupEvent=="function"&&s.applyPowerupEvent(x);try{if(x&&x.status==="activate"&&x.powerupId&&Array.isArray(s.powerups))for(var z=0;z<s.powerups.length;z++){var ut=s.powerups[z];if(ut&&ut.id===x.powerupId&&typeof ut.pickup=="function"){ut.pickup(x.tankId||"");break}}}catch{}if(x&&x.tankId&&x.status==="activate"&&typeof s.resolvePowerupSpriteId=="function"){s.state=s.state||{tanks:{},powerups:{},meta:{nextPowerupId:0}};var Bt=s.state.tanks[x.tankId]||(s.state.tanks[x.tankId]={id:x.tankId,powerups:[]}),tt=s.resolvePowerupSpriteId(x.powerup);if(Bt.powerups=tt?[{type:x.powerup,spriteId:tt}]:[{type:x.powerup}],s.remoteTankMap){var _t=s.remoteTankMap[x.tankId]||(s.remoteTankMap[x.tankId]={id:x.tankId});_t.powerups=(Bt.powerups||[]).slice(),s.remoteTankMeta=s.collectRemoteTankMeta(),s.remoteState={tanks:s.remoteTankMeta,powerups:s.remotePowerups}}typeof s.recomputeGlobalPowerups=="function"&&s.recomputeGlobalPowerups()}}}catch{}return}case"T":{try{var ft=t.split(","),dt=ft[1]||e&&e.peer,pt=ft[2]||"",et=[];pt&&pt.split(";").forEach(function(A){if(A){for(var ht=A.split("|"),J={panelId:K.decodeFreeText(ht[0]||""),colour:K.decodeFreeText(ht[1]||""),controls:[]},lt=2;lt<8;lt++)J.controls.push(K.decodeFreeText(ht[lt]||""));et.push(J)}}),dt&&(r.remoteTankConfigs[dt]=et,dt===r.id&&(r.localTankConfigs=et)),r.isHost&&r.broadcast(t,e)}catch{}return}}}};var k={};k.BIN_TYPE={INPUT:1,PING:2,PONG:3,PLAYERS:16,NICK:17,CHAT:18,NOTIFY:19,PWR:20,SPAWN:21,INIT:32,DELTA:33};k.utf8Encode=function(r){r=""+(r??"");for(var t=new Uint8Array(r.length*4),e=0,i=0;i<r.length;i++){var s=r.charCodeAt(i);s<128?t[e++]=s:s<2048?(t[e++]=192|s>>6,t[e++]=128|s&63):s<65536?(t[e++]=224|s>>12,t[e++]=128|s>>6&63,t[e++]=128|s&63):(t[e++]=240|s>>18,t[e++]=128|s>>12&63,t[e++]=128|s>>6&63,t[e++]=128|s&63)}return t.slice(0,e)};k.utf8Decode=function(r){for(var t=r instanceof Uint8Array?r:new Uint8Array(r||0),e="",i=0;i<t.length;i++){var s=t[i];if(s<128)e+=String.fromCharCode(s);else if((s&224)===192){var n=t[++i];e+=String.fromCharCode((s&31)<<6|n&63)}else if((s&240)===224){var o=t[++i],a=t[++i];e+=String.fromCharCode((s&15)<<12|(o&63)<<6|a&63)}else{var l=t[++i],h=t[++i],u=t[++i],f=(s&7)<<18|(l&63)<<12|(h&63)<<6|u&63;f-=65536,e+=String.fromCharCode(55296+(f>>10),56320+(f&1023))}}return e};function D(){this._a=[]}D.prototype.writeU8=function(r){this._a.push((r&255)>>>0)};D.prototype.writeU16=function(r){r>>>=0,this._a.push(r&255,r>>>8&255)};D.prototype.writeU32=function(r){r>>>=0,this._a.push(r&255,r>>>8&255,r>>>16&255,r>>>24&255)};D.prototype.writeF32=function(r){var t=new ArrayBuffer(4);new DataView(t).setFloat32(0,+r||0,!0);for(var e=new Uint8Array(t),i=0;i<4;i++)this._a.push(e[i])};D.prototype.writeBytes=function(r){for(var t=r instanceof Uint8Array?r:new Uint8Array(r||0),e=0;e<t.length;e++)this._a.push(t[e])};D.prototype.writeStr8=function(r){var t=k.utf8Encode(r||""),e=Math.min(255,t.length);this.writeU8(e);for(var i=0;i<e;i++)this._a.push(t[i])};D.prototype.writeStr16=function(r){var t=k.utf8Encode(r||""),e=Math.min(65535,t.length);this.writeU16(e);for(var i=0;i<e;i++)this._a.push(t[i])};D.prototype.toBuffer=function(){for(var r=new Uint8Array(this._a.length),t=0;t<r.length;t++)r[t]=this._a[t];return r.buffer};k.ByteWriter=D;k.buildInput=function(r){var t=k.utf8Encode(r.tankId||""),e=(r.upPressed?1:0)|(r.rightPressed?1:0)<<1|(r.downPressed?1:0)<<2|(r.leftPressed?1:0)<<3|(r.shooting?1:0)<<4|(r.specialKeyPressed?1:0)<<5,i=Math.min(255,t.length),s=new Uint8Array(3+i);s[0]=k.BIN_TYPE.INPUT,s[1]=i;for(var n=0;n<i;n++)s[2+n]=t[n];return s[2+i]=e&63,s.buffer};k.buildPing=function(r){var t=new ArrayBuffer(5),e=new DataView(t);return e.setUint8(0,k.BIN_TYPE.PING),e.setUint32(1,r>>>0),t};k.buildPong=function(r){var t=new ArrayBuffer(5),e=new DataView(t);return e.setUint8(0,k.BIN_TYPE.PONG),e.setUint32(1,r>>>0),t};k.buildPlayerList=function(r){var t=new D;t.writeU8(k.BIN_TYPE.PLAYERS);var e=Array.isArray(r)?r:[],i=Math.min(255,e.length);t.writeU8(i);for(var s=0;s<i;s++){var n=e[s]||{};t.writeStr8(n.id||""),t.writeStr8(n.nickname||"Player")}return t.toBuffer()};k.buildNickname=function(r,t){var e=new D;return e.writeU8(k.BIN_TYPE.NICK),e.writeStr8(r||""),e.writeStr8(t||""),e.toBuffer()};k.buildChat=function(r,t){var e=new D;return e.writeU8(k.BIN_TYPE.CHAT),e.writeStr8(r||""),e.writeStr16(t||""),e.toBuffer()};k.buildNotify=function(r){var t=new D;return t.writeU8(k.BIN_TYPE.NOTIFY),t.writeStr16(r||""),t.toBuffer()};k.buildPowerupEventFromString=function(r){var t=(r||"").split(",");if(t[0]!=="X")return null;var e=new D;e.writeU8(k.BIN_TYPE.PWR),e.writeStr8(t[1]||""),e.writeStr8(t[2]||""),e.writeStr8(t[3]||""),e.writeStr8(t[4]||"");var i=parseInt(t[5]||"0",10)||0;return e.writeU16(i),e.toBuffer()};k.buildSpawnFromString=function(r){if(typeof r!="string"||r[0]!=="S")return null;var t=r.substring(2)||"",e=t.split("|"),i=function(n){var o=parseInt(n,10);return isNaN(o)?0:o},s=new D;return s.writeU8(k.BIN_TYPE.SPAWN),s.writeStr8(e[0]||""),s.writeU16(i(e[1]||0)),s.writeU16(i(e[2]||0)),s.writeU16(i(e[3]||0)),s.writeU16(i(e[4]||0)),s.writeU16(i(e[5]||0)),s.writeStr8(e[6]||""),s.writeStr8(e[7]||""),s.toBuffer()};k.buildInitFromString=function(r){var t=(r||"").split(",");if(t[0]!=="I")return null;var e=function(O){var $=parseInt(O,10);return isNaN($)?0:$},i=function(O){var $=parseFloat(O);return isNaN($)?0:$},s=new D;s.writeU8(k.BIN_TYPE.INIT);var n=e(t[1]),o=e(t[2]),a=e(t[3]),l=i(t[4]),h=i(t[5]),u=i(t[6]),f=e(t[7]),d=e(t[8]),p=i(t[9]),g=e(t[10]),v=i(t[11]),_=t[12]==="1"?1:0;s.writeU16(n),s.writeU16(o),s.writeU16(a),s.writeF32(l),s.writeF32(h),s.writeF32(u),s.writeU16(f),s.writeU16(d),s.writeF32(p),s.writeU16(g),s.writeF32(v),s.writeU8(_),s.writeStr16(t[13]||"");var w=t[14]||"",m=w?w.split(";").filter(Boolean):[],S=Math.min(65535,m.length);s.writeU16(S);for(var P=0;P<S;P++){var x=m[P].split("|");s.writeU16(e(x[0]||0)),s.writeU16(e(x[1]||0)),s.writeU16(e(x[2]||0)),s.writeU16(e(x[3]||0)),s.writeStr8(x[4]||""),s.writeStr8(x[5]||"")}var M=t[15]||"",T=M?M.split(";").filter(Boolean):[],U=Math.min(65535,T.length);s.writeU16(U);for(var L=0;L<U;L++){var F=T[L].split("|");s.writeStr8(F[0]||""),s.writeU16(e(F[1]||0)),s.writeU16(e(F[2]||0)),s.writeF32(i(F[3]||0)),s.writeU16(e(F[4]||0)),s.writeU16(e(F[5]||0)),s.writeStr8(F[6]||""),s.writeU16(e(F[7]||0))}return s.toBuffer()};k.buildDeltaFromString=function(r){var t=(r||"").split(",");if(t[0]!=="D")return null;var e=function(F){var O=parseInt(F,10);return isNaN(O)?0:O},i=function(F){var O=parseFloat(F);return isNaN(O)?0:O},s=new D;s.writeU8(k.BIN_TYPE.DELTA);var n=t.length>=6?2:1;s.writeU32(0);var o=t[n]||"",a=o?o.split(";").filter(Boolean):[],l=Math.min(65535,a.length);s.writeU16(l);for(var h=0;h<l;h++){var u=a[h].split("|");s.writeStr8(u[0]||""),s.writeU16(e(u[1]||0)),s.writeU16(e(u[2]||0)),s.writeF32(i(u[3]||0)),s.writeU16(e(u[4]||0)),s.writeU8(e(u[5]||1))}var f=t[n+1]||"",d=f?f.split(";").filter(Boolean):[],p=Math.min(65535,d.length);s.writeU16(p);for(var g=0;g<p;g++){var v=d[g].split("|");s.writeU16(e(v[0]||0)),s.writeU16(e(v[1]||0)),s.writeF32(i(v[2]||0)),s.writeF32(i(v[3]||0)),s.writeStr8(v[4]||""),s.writeU8(e(v[5]||1))}var _=t[n+2]||"",w=_?_.split(";").filter(Boolean):[],m=Math.min(65535,w.length);s.writeU16(m);for(var S=0;S<m;S++){var P=w[S].split("|");s.writeU16(e(P[0]||0)),s.writeU16(e(P[1]||0)),s.writeU16(e(P[2]||0)),s.writeU16(e(P[3]||0)),s.writeStr8(P[4]||""),s.writeStr8(P[5]||"")}var x=t[n+3]||"",M=x?x.split(";").filter(Boolean):[],T=Math.min(65535,M.length);s.writeU16(T);for(var U=0;U<T;U++){var L=M[U].split("|");s.writeStr8(L[0]||""),s.writeStr8(L[1]||""),s.writeStr8(L[2]||""),s.writeStr8(L[3]||"")}return s.toBuffer()};k.hydrate=function(r,t,e){try{if(typeof r=="string")return r;if(typeof Blob<"u"&&r instanceof Blob&&r.arrayBuffer)return r.arrayBuffer().then(function(I){try{E&&E.handlePeerMessage&&E.handlePeerMessage(t,I,e)}catch{}}),null;var i=null;if(r&&r.byteLength!=null&&!(r instanceof ArrayBuffer)?i=new Uint8Array(r):r instanceof ArrayBuffer&&(i=new Uint8Array(r)),!i||i.length===0)return r;var s=i[0],n=k.BIN_TYPE;switch(s){case n.INPUT:{var o=i[1]||0,a=i.slice(2,2+o),l=k.utf8Decode(a),h=i[2+o]||0,u=function(I){return h>>I&1?"1":"0"};return["C",l,u(0),u(1),u(2),u(3),u(4),u(5)].join(",")}case n.PING:{var f=new DataView(i.buffer,i.byteOffset||0,i.byteLength),d=f.getUint32(1);return"Q,"+d}case n.PONG:{var p=new DataView(i.buffer,i.byteOffset||0,i.byteLength),g=p.getUint32(1);return"q,"+g}case n.PLAYERS:{for(var v=1,_=i[v++]||0,w=[],m=0;m<_;m++){var S=i[v++]||0,P=k.utf8Decode(i.slice(v,v+S));v+=S;var x=i[v++]||0,M=k.utf8Decode(i.slice(v,v+x));v+=x,w.push(P+"|"+(E&&E.encodeFreeText?E.encodeFreeText(M):M))}return"P,"+w.join(";")}case n.NICK:{var T=1,U=function(){return i[T++]},L=function(){var I=U(),B=k.utf8Decode(i.slice(T,T+I));return T+=I,B},F=L(),O=L(),$=E&&E.encodeFreeText?E.encodeFreeText:function(I){return I};return"N,"+F+","+$(O)}case n.CHAT:{var j=1,ot=function(){return i[j++]},It=function(){var B=i[j]|i[j+1]<<8;return j+=2,B>>>0},L=function(){var B=ot(),Ot=k.utf8Decode(i.slice(j,j+B));return j+=B,Ot},At=function(){var B=It(),Ot=k.utf8Decode(i.slice(j,j+B));return j+=B,Ot},St=L(),mt=At(),Y=E&&E.encodeFreeText?E.encodeFreeText:function(B){return B};return"M,"+Y(St)+","+Y(mt)}case n.NOTIFY:{var W=1,yt=function(){var I=i[W]|i[W+1]<<8;return W+=2,I>>>0},gt=function(){var I=yt(),B=k.utf8Decode(i.slice(W,W+I));return W+=I,B},at=gt(),wt=E&&E.encodeFreeText?E.encodeFreeText:function(I){return I};return"E,"+wt(at)}case n.PWR:{var z=1,ut=function(){return i[z++]},Bt=function(){var I=i[z]|i[z+1]<<8;return z+=2,I>>>0},tt=function(){var I=ut(),B=k.utf8Decode(i.slice(z,z+I));return z+=I,B},_t=tt(),ft=tt(),dt=tt(),pt=tt(),et=Bt();return["X",_t,ft,dt,pt,et].join(",")}case n.SPAWN:{var A=1,ht=function(){return i[A++]},J=function(){var B=i[A]|i[A+1]<<8;return A+=2,B>>>0},lt=function(){var B=ht(),Ot=k.utf8Decode(i.slice(A,A+B));return A+=B,Ot},s=lt(),ne=J(),ti=J(),ei=J(),ii=J(),si=J(),ri=lt(),ni=lt();return"S,"+[s,ne,ti,ei,ii,si,ri,ni].join("|")}case n.INIT:{for(var Q=1,H=function(){var I=i[Q]|i[Q+1]<<8;return Q+=2,I>>>0},Ee=function(){return i[Q++]},Ft=function(){var I=new DataView(i.buffer,(i.byteOffset||0)+Q,4),B=I.getFloat32(0,!0);return Q+=4,B},Gt=function(){var I=Ee(),B=k.utf8Decode(i.slice(Q,Q+I));return Q+=I,B},oi=function(){var I=H(),B=k.utf8Decode(i.slice(Q,Q+I));return Q+=I,B},ai=H(),hi=H(),li=H(),ci=Ft(),ui=Ft(),fi=Ft(),di=H(),pi=H(),vi=Ft(),mi=H(),yi=Ft(),gi=Ee(),wi=oi(),_i=H(),Ce=[],Me=0;Me<_i;Me++){var xi=H(),bi=H(),ki=H(),Pi=H(),Ii=Gt(),Si=Gt();Ce.push([xi,bi,ki,Pi,Ii,Si].join("|"))}for(var Bi=H(),Te=[],Ae=0;Ae<Bi;Ae++){var Ei=Gt(),Ci=H(),Mi=H(),Ti=Ft(),Ai=H(),Fi=H(),Ui=Gt(),Ni=H();Te.push([Ei,Ci,Mi,Ti,Ai,Fi,Ui,Ni].join("|"))}return["I",ai,hi,li,ci,ui,fi,di,pi,vi,mi,yi,gi?1:0,wi,Ce.join(";"),Te.join(";")].join(",")}case n.DELTA:{var it=1,V=function(){var I=i[it]|i[it+1]<<8;return it+=2,I>>>0},oe=function(){return i[it++]},Li=function(){var I=new DataView(i.buffer,(i.byteOffset||0)+it,4),B=I.getUint32(0,!0);return it+=4,B>>>0},ae=function(){var I=new DataView(i.buffer,(i.byteOffset||0)+it,4),B=I.getFloat32(0,!0);return it+=4,B},xt=function(){var I=oe(),B=k.utf8Decode(i.slice(it,it+I));return it+=I,B};Li();for(var zi=V(),Fe=[],Ue=0;Ue<zi;Ue++){var Hi=xt(),Oi=V(),Ri=V(),Di=ae(),ji=V(),Wi=oe();Fe.push([Hi,Oi,Ri,Di,ji,Wi].join("|"))}for(var Gi=V(),Ne=[],Le=0;Le<Gi;Le++){var Ki=V(),Yi=V(),Vi=ae(),qi=ae(),Xi=xt(),Ji=oe();Ne.push([Ki,Yi,Vi,qi,Xi,Ji].join("|"))}for(var Qi=V(),ze=[],He=0;He<Qi;He++){var Zi=V(),$i=V(),ts=V(),es=V(),is=xt(),ss=xt();ze.push([Zi,$i,ts,es,is,ss].join("|"))}for(var rs=V(),Oe=[],Re=0;Re<rs;Re++){var _t=xt(),ns=xt(),dt=xt(),os=xt();Oe.push([_t,ns,dt,os].join("|"))}return["D",Fe.join(";"),Ne.join(";"),ze.join(";"),Oe.join(";")].join(",")}}}catch{}return r};var N=k;var de=class{constructor(){this.remoteTankConfigs={},this.localTankConfigs=[],this.game=null,this.reset(),this._stats={sentBytes:0,sentMessages:0,recvBytes:0,recvMessages:0,sentPerSec:0,recvPerSec:0,bytesSentPerSec:0,bytesRecvPerSec:0,rttMs:null},this._lastStatsSnapshot={sentBytes:0,recvBytes:0,sentMessages:0,recvMessages:0},this._statsTimer=null,this._pingTimer=null}reset(){if(this.peer)try{this.peer.destroy()}catch{}this.peer=null,this.connections=[],this.nickname="",this.players=new Map,this.isHost=!1,this.id=null,this.roomName="",this.readyNotified=!1,this.lastStartPayload=null,this.remoteTankConfigs={},this.isHost&&(this.remoteTankConfigs[this.id||"host"]=this.localTankConfigs||[]),this.stopInstrumentation()}hostRoom(t,e){if(!window.Peer){C.emit("network-status","PeerJS library not available.");return}if(t=Zt(t),e=Zt(e)||"Commander",!t){C.emit("network-status","Please provide a room name to host.");return}this.reset(),this.isHost=!0,this.roomName=t,this.nickname=e,this.peer=new Peer(t),this.peer.on("connection",i=>{this.setupConnection(i)}),this.peer.on("open",i=>{this.id=i,this.players.set(i,this.nickname),C.emit("network-status",'Hosting room "'+t+'". '),C.emit("network-ready",{role:"host",roomId:i}),this.readyNotified=!0,this.emitPlayerList(),Z('You are hosting the room as "'+this.nickname+'".',"notification-message"),this.startInstrumentation()}),this.peer.on("error",i=>{C.emit("network-status","Error hosting room: "+(i&&i.type?i.type:"unknown")),i&&(i.type==="unavailable-id"||/taken/i.test(i.message||""))?C.emit("network-status","Room name already taken. Ask friends for the room code to join."):Z("* Host error: "+(i&&i.type?i.type:"unknown"),"notification-message")})}joinRoom(t,e){if(!window.Peer){C.emit("network-status","PeerJS library not available.");return}if(t=Zt(t),e=Zt(e)||"Scout",!t){C.emit("network-status","Please enter a room name or ID to join.");return}this.reset(),this.isHost=!1,this.roomName=t,this.nickname=e,this.peer=new Peer,this.peer.on("open",i=>{this.id=i,this.players.set(i,this.nickname),C.emit("network-status",'Attempting to join room "'+t+'"...'),this.emitPlayerList();let s=this.peer.connect(t);s.on("error",n=>{C.emit("network-status","Connection error: "+(n&&n.type?n.type:"unknown"))}),this.setupConnection(s)}),this.peer.on("error",i=>{C.emit("network-status","Error joining room: "+(i&&i.type?i.type:"unknown"))})}setupConnection(t){!t||t._handled||(t._handled=!0,this.connections.push(t),t.on("data",e=>{try{var i=0;typeof e=="string"?i=e.length:e&&e.byteLength&&(i=e.byteLength),this._stats.recvBytes+=i,this._stats.recvMessages+=1}catch{}E&&typeof E.handlePeerMessage=="function"&&E.handlePeerMessage(this,e,t)}),t.on("close",()=>{this.connections=this.connections.filter(i=>i!==t);let e=this.players.get(t.peer);this.players.delete(t.peer),this.remoteTankConfigs&&delete this.remoteTankConfigs[t.peer],this.broadcastPlayerList(),e&&(Z("* "+e+" disconnected.","notification-message"),this.isHost&&this.sendNotification(e+" left the room."))}),t.on("error",e=>{C.emit("network-status","Connection error with "+t.peer)}),t.on("open",()=>{this.isHost||(C.emit("network-status",'Connected to host "'+t.peer+'".'),C.emit("network-ready",{role:"guest",roomId:this.roomName}),Z('You joined room "'+this.roomName+'" as "'+this.nickname+'".',"notification-message"),this.startInstrumentation());try{t.send(N.buildNickname(this.id,this.nickname))}catch{try{t.send(["N",this.id,E.encodeFreeText(this.nickname)].join(","))}catch{}}if(this.isHost&&(this.sendPlayerListTo(t),this.broadcastPlayerList(),this.game&&this.game.main_object&&typeof this.game.main_object.getCachedSnapshot=="function")){if(this.game&&this.game.maze&&typeof this.game.maze.serializeInitString=="function")try{var e=this.game.maze.serializeInitString(),i=null;try{i=N.buildInitFromString(e)}catch{i=null}i?t.send(i):t.send(e)}catch{}try{if(this.game&&this.game.maze&&typeof this.game.maze.serializeUnifiedSnapshot=="function"){var s=this.game.maze.serializeUnifiedSnapshot();t.send("U,"+s)}}catch{}}}))}broadcast(t,e){let i=t;try{if(typeof t=="string"&&t.length){let s=t[0];if(s==="I"){let n=N.buildInitFromString(t);n&&(i=n)}else if(s==="D"){let n=N.buildDeltaFromString(t);n&&(i=n)}else if(s==="P")i=N.buildPlayerList(this.getPlayerListPayload());else if(s==="M"){let n=t.split(","),o=E.decodeFreeText(n[1]||""),a=E.decodeFreeText(n.slice(2).join(","));i=N.buildChat(o,a)}else if(s==="E"){let n=E.decodeFreeText(t.substring(2));i=N.buildNotify(n)}else if(s==="X"){let n=N.buildPowerupEventFromString(t);n&&(i=n)}else if(s==="S"){let n=N.buildSpawnFromString(t);n&&(i=n)}else if(s==="N"){let n=t.split(","),o=n[1]||"",a=E.decodeFreeText(n[2]||"");i=N.buildNickname(o,a)}}}catch{}this.connections.forEach(s=>{if(s.open&&s!==e)try{s.send(i);try{var n=0;typeof i=="string"?n=i.length:i&&i.byteLength&&(n=i.byteLength),this._stats.sentBytes+=n,this._stats.sentMessages+=1}catch{}}catch{}})}broadcastPlayerList(){try{this.broadcast(N.buildPlayerList(this.getPlayerListPayload()))}catch{try{this.broadcast(E.buildCompactPlayerList(this.getPlayerListPayload()))}catch{}}this.emitPlayerList()}sendPlayerListTo(t){if(!(!t||!t.open))try{t.send(N.buildPlayerList(this.getPlayerListPayload()))}catch{try{t.send(E.buildCompactPlayerList(this.getPlayerListPayload()))}catch{}}}emitPlayerList(){C.emit("network-player-list",this.getPlayerListPayload()),this.isHost||this.maybeEmitReady("player-list")}getPlayerListPayload(){let t=[];return this.players.forEach((e,i)=>{t.push({id:i,nickname:e})}),t}sendTankConfig(t){if(this.localTankConfigs=t||[],!this.peer)return;let e=this.id||"pending";this.isHost&&(this.remoteTankConfigs[e]=this.localTankConfigs);try{let i=(this.localTankConfigs||[]).map(n=>{let o=E.encodeFreeText(n.panelId||""),a=E.encodeFreeText(n.colour||""),l=(n.controls||[]).slice(0,6).map(E.encodeFreeText);for(;l.length<6;)l.push("");return[o,a].concat(l).join("|")}).join(";"),s=["T",e,i].join(",");this.broadcast(s)}catch{}}sendInputState(t){if(!(!t||!t.tankId)){if(t.peerId=this.id,this.isHost){this.applyInputState(t);return}try{this.broadcast(N.buildInput(t))}catch{var e=function(n){return n?1:0},i=["C",t.tankId,e(t.upPressed),e(t.rightPressed),e(t.downPressed),e(t.leftPressed),e(t.shooting),e(t.specialKeyPressed)].join(",");this.broadcast(i)}}}updatePlayersFromPayload(t){if(this.players=new Map,Array.isArray(t))for(let e=0;e<t.length;e++){let i=t[e];i&&i.id&&this.players.set(i.id,i.nickname||"Player")}this.id&&!this.players.has(this.id)&&this.players.set(this.id,this.nickname),this.emitPlayerList()}applyInputState(t){t&&(this.isHost&&(this.remoteTankConfigs=this.remoteTankConfigs||{},t.peerId&&!this.remoteTankConfigs[t.peerId]&&(this.remoteTankConfigs[t.peerId]=[])),this.game&&this.game.main_object&&typeof this.game.main_object.applyInputState=="function"&&this.game.main_object.applyInputState(t))}addPlayer(t,e){t&&(this.players.set(t,e||"Player"),this.broadcastPlayerList())}sendChatMessage(t){let e=E.encodeFreeText(this.nickname),i=E.encodeFreeText(t);this.broadcast(["M",e,i].join(","))}sendNotification(t){Z("* "+t,"notification-message");let e=E.encodeFreeText(t);this.broadcast(["E",e].join(","))}getNickname(){return this.nickname}maybeEmitReady(t){this.readyNotified||(this.readyNotified=!0,C.emit("network-ready",{role:this.isHost?"host":"guest",roomId:this.isHost?this.id:this.roomName}))}startInstrumentation(){this.stopInstrumentation(),this._statsTimer=setInterval(()=>{let t=this._stats.sentBytes-this._lastStatsSnapshot.sentBytes,e=this._stats.recvBytes-this._lastStatsSnapshot.recvBytes,i=this._stats.sentMessages-this._lastStatsSnapshot.sentMessages,s=this._stats.recvMessages-this._lastStatsSnapshot.recvMessages;this._lastStatsSnapshot={sentBytes:this._stats.sentBytes,recvBytes:this._stats.recvBytes,sentMessages:this._stats.sentMessages,recvMessages:this._stats.recvMessages},this._stats.bytesSentPerSec=t,this._stats.bytesRecvPerSec=e,this._stats.sentPerSec=i,this._stats.recvPerSec=s,C.emit("network-stats",Object.assign({},this._stats))},1e3),this.isHost||(this._pingTimer=setInterval(()=>{let t=Math.floor(performance.now());try{this.broadcast(N.buildPing(t))}catch{}},2e3))}stopInstrumentation(){this._statsTimer&&(clearInterval(this._statsTimer),this._statsTimer=null),this._pingTimer&&(clearInterval(this._pingTimer),this._pingTimer=null),this._stats&&(this._stats.rttMs=null,this._stats.sentBytes=0,this._stats.recvBytes=0,this._stats.sentMessages=0,this._stats.recvMessages=0,this._stats.bytesSentPerSec=0,this._stats.bytesRecvPerSec=0,this._stats.sentPerSec=0,this._stats.recvPerSec=0),this._lastStatsSnapshot={sentBytes:0,recvBytes:0,sentMessages:0,recvMessages:0}}};function Zt(r){return(r||"").replace(/[^a-zA-Z0-9 _-]/g,"").trim()}function Ge(r){r=""+(r??"");let t=new Uint8Array(r.length*4),e=0;for(let i=0;i<r.length;i++){let s=r.charCodeAt(i);s<128?t[e++]=s:s<2048?(t[e++]=192|s>>6,t[e++]=128|s&63):s<65536?(t[e++]=224|s>>12,t[e++]=128|s>>6&63,t[e++]=128|s&63):(t[e++]=240|s>>18,t[e++]=128|s>>12&63,t[e++]=128|s>>6&63,t[e++]=128|s&63)}return t.slice(0,e)}function bt(){this._a=[]}bt.prototype.writeU8=function(r){this._a.push((r&255)>>>0)};bt.prototype.writeU16=function(r){r>>>=0,this._a.push(r&255,r>>>8&255)};bt.prototype.writeU32=function(r){r>>>=0,this._a.push(r&255,r>>>8&255,r>>>16&255,r>>>24&255)};bt.prototype.writeF32=function(r){let t=new ArrayBuffer(4);new DataView(t).setFloat32(0,+r||0,!0);let e=new Uint8Array(t);for(let i=0;i<4;i++)this._a.push(e[i])};bt.prototype.writeBytes=function(r){let t=r instanceof Uint8Array?r:new Uint8Array(r||0);for(let e=0;e<t.length;e++)this._a.push(t[e])};bt.prototype.writeStr8=function(r){let t=Ge(r||""),e=Math.min(255,t.length);this.writeU8(e);for(let i=0;i<e;i++)this._a.push(t[i])};bt.prototype.writeStr16=function(r){let t=Ge(r||""),e=Math.min(65535,t.length);this.writeU16(e);for(let i=0;i<e;i++)this._a.push(t[i])};bt.prototype.toBuffer=function(){let r=new Uint8Array(this._a.length);for(let t=0;t<r.length;t++)r[t]=this._a[t];return r.buffer};function Z(r,t){var e=document.getElementById("chat-messages");if(e){var i=document.createElement("div");i.textContent=r,i.className="chat-message "+(t||"notification-message"),e.appendChild(i),e.scrollTop=e.scrollHeight}}var y=new de;function q(r){this.game=r,this.connectOverlay=null,this.chatOverlay=null,this.chatPanel=null,this.statusEls=[],this.roomInput=null,this.nicknameInput=null,this.hostButton=null,this.joinButton=null,this.enterLobbyButton=null,this.playerListEl=null,this.roomCodeEl=null,this.chatInput=null,this.sendButton=null,this.closeConnectButton=null,this.closeChatButton=null,this._boundResize=null,this._chatDrag={active:!1,startX:0,startWidth:0},this.overlayEnabled=!0,this.overlayRequested=!1,this.ensureDom(),this.sendButton&&(this.sendButton.disabled=!0),this.chatInput&&(this.chatInput.disabled=!0),this.registerListeners()}q.prototype.ensureDom=function(){this.connectOverlay=document.getElementById("networking-connect-overlay"),this.chatOverlay=null,this.statusEls=Array.from(document.querySelectorAll("#network-status, #network-status-connect, #network-status-chat")),this.roomInput=document.getElementById("room-name"),this.nicknameInput=document.getElementById("nickname"),this.hostButton=document.getElementById("host-room-btn"),this.joinButton=document.getElementById("join-room-btn"),this.enterLobbyButton=document.getElementById("enter-lobby-btn"),this.playerListEl=document.getElementById("player-list"),this.roomCodeEl=document.getElementById("room-code"),this.chatInput=document.getElementById("chat-message-input"),this.sendButton=document.getElementById("chat-send-btn"),this.chatPanel=document.getElementById("networking-chat-panel"),this.closeConnectButton=document.getElementById("networking-close-connect-btn"),this.closeChatButton=document.getElementById("networking-close-chat-btn")};q.prototype.registerListeners=function(){var r=this;this.hostButton&&this.hostButton.addEventListener("click",function(){y.hostRoom(r.roomInput.value,r.nicknameInput.value),r.showChatOverlay()}),this.joinButton&&this.joinButton.addEventListener("click",function(){y.joinRoom(r.roomInput.value,r.nicknameInput.value),r.showChatOverlay()}),this.closeConnectButton&&this.closeConnectButton.addEventListener("click",function(){r.hideOverlay()}),this.sendButton&&this.sendButton.addEventListener("click",function(){r.handleSendMessage()}),this.chatInput&&this.chatInput.addEventListener("keydown",function(e){e.key==="Enter"&&(e.preventDefault(),r.handleSendMessage())}),C.on("network-status",function(e){for(var i=0;i<r.statusEls.length;i++)r.statusEls[i].textContent=e}),C.on("network-ready",function(e){if(e){r.sendButton&&(r.sendButton.disabled=!1),r.chatInput&&(r.chatInput.disabled=!1),r.overlayEnabled&&r.showChatOverlay();try{var i=localStorage.getItem("chatPanelWidthPx");if(i&&r.chatPanel){var s=Math.max(0,Math.min(window.innerWidth*.9,parseInt(i,10)||0));s>0&&(r.chatPanel.style.width=s+"px",r.chatPanel.classList.add("chat-open"))}}catch{}r.game&&r.game.pregame&&typeof r.game.pregame.emitTankConfig=="function"&&r.game.pregame.emitTankConfig()}}),C.on("network-player-list",function(e){r.renderPlayerList(e||[])}),C.on("network-stats",function(e){if(!(!e||!r.statusEls||r.statusEls.length===0)){var i=document.getElementById("network-status-connect"),s=null,n=document.getElementById("network-status"),o=[],a=[];if(typeof e.rttMs=="number"&&(o.push("Ping: "+e.rttMs+" ms"),a.push("Ping: "+e.rttMs+" ms")),a.push("Tx: "+e.sentPerSec+" msg/s"),a.push("Rx: "+e.recvPerSec+" msg/s"),a.push("Up: "+e.bytesSentPerSec+" B/s"),a.push("Down: "+e.bytesRecvPerSec+" B/s"),i){var l=(i.textContent||"").split(`
`)[0]||i.textContent;i.textContent=l+`
`+o.join(`
`)}if(n){var h=(n.textContent||"").split(`
`)[0]||n.textContent;n.textContent=h+`
`+a.join(`
`)}if(!i&&!s&&!n)for(var u=a,f=0;f<r.statusEls.length;f++){var d=r.statusEls[f],p=(d.textContent||"").split(`
`)[0]||d.textContent;d.textContent=p+`
`+u.join(`
`)}}});var t=document.getElementById("chat-resize-handle");t&&this.chatPanel&&(t.addEventListener("mousedown",function(e){e.preventDefault(),r._chatDrag.active=!0,r._chatDrag.startX=e.clientX,r._chatDrag.startWidth=r.chatPanel.getBoundingClientRect().width,document.body.classList.add("resizing-chat")}),window.addEventListener("mousemove",function(e){if(r._chatDrag.active){var i=r._chatDrag.startX-e.clientX,s=Math.max(0,Math.min(window.innerWidth*.9,r._chatDrag.startWidth+i));r.chatPanel.style.width=s+"px",r.chatPanel.classList.add("chat-open")}}),window.addEventListener("mouseup",function(){if(r._chatDrag.active){r._chatDrag.active=!1,document.body.classList.remove("resizing-chat");try{var e=r.chatPanel.getBoundingClientRect().width;localStorage.setItem("chatPanelWidthPx",Math.round(e))}catch{}}}))};q.prototype.layoutChatRight=function(){};q.prototype.handleSendMessage=function(){if(!this.chatInput.disabled){var r=(this.chatInput.value||"").trim();if(r){var t=y.getNickname?y.getNickname():"Me";Z("You: "+r,"self-message"),y.sendChatMessage(r),this.chatInput.value=""}}};q.prototype.renderPlayerList=function(r){if(this.playerListEl){for(;this.playerListEl.firstChild;)this.playerListEl.removeChild(this.playerListEl.firstChild);if(!r||r.length===0){var t=document.createElement("li");t.textContent="Waiting for players...",t.className="player-list-empty",this.playerListEl.appendChild(t);return}for(var e=this.game&&this.game.pregame?this.game.pregame.tank_panels.length:0,i=0;i<r.length;i++){var s=document.createElement("li"),n=r[i],o=n.nickname||"Player";n.id&&y.id===n.id?(o+=" (This device",e&&(o+=", Tanks: "+e),o+=")"):o+=" (ID "+(n.id?n.id.substring(0,6):"????")+")",s.textContent=o,this.playerListEl.appendChild(s)}}};q.prototype.showOverlay=function(){this.overlayEnabled&&(y&&(y.connections||[]).length>0||y&&y.readyNotified?this.showChatOverlay():this.showConnectOverlay())};q.prototype.showConnectOverlay=function(){if(this.overlayEnabled&&(this.overlayRequested=!0,this.connectOverlay||this.ensureDom(),this.chatOverlay&&(this.chatOverlay.classList.add("hidden"),this.chatOverlay.style.display=""),this.connectOverlay&&(this.connectOverlay.classList.remove("hidden"),this.connectOverlay.style.display="flex",this.roomInput)))try{this.roomInput.focus()}catch{}};q.prototype.showChatOverlay=function(){if(this.overlayEnabled&&(this.ensureDom(),this.connectOverlay&&(this.connectOverlay.classList.add("hidden"),this.connectOverlay.style.display=""),this.chatPanel&&(this.chatPanel.classList.remove("hidden"),this.chatPanel.classList.add("chat-open"),this.chatInput)))try{this.chatInput.focus()}catch{}};q.prototype.hideOverlay=function(){this.ensureDom(),this.overlayRequested=!1,this.connectOverlay&&(this.connectOverlay.classList.add("hidden"),this.connectOverlay.style.display=""),this.chatPanel&&(this.chatPanel.classList.add("chat-open"),this.chatPanel.classList.remove("hidden"))};q.prototype.enableOverlay=function(){this.overlayEnabled=!0};q.prototype.disableOverlay=function(){this.overlayEnabled=!1,this.hideOverlay()};var Dt=class{constructor(t,e,i,s,n){this.x=t|0,this.y=e|0,this.width=i|0,this.height=s|0,this.orientation=n,this.isActive=!0,this.N=null,this.S=null,this.W=null,this.E=null}getRect(){return[this.x,this.y,this.width,this.height]}},$t=class{constructor(t,e){this.x=t|0,this.y=e|0,this.north=null,this.south=null,this.west=null,this.east=null}};function vt(r,t){return!(r[0]+r[2]<t[0]||r[0]>t[0]+t[2]||r[1]+r[3]<t[1]||r[1]>t[1]+t[3])}function Ke(r,t){if(!t||!Array.isArray(t))return;let e=t.indexOf(r);e>=0&&t.splice(e,1)}function Ye(r){for(var t=[],e=r.slice();e.length>0;){var i=Math.floor(Math.random()*e.length);t.push(e[i]),e.splice(i,1)}return t}var jt=class{constructor(t,e,i){this.maze=t,this.row=e,this.col=i,this.north=null,this.east=null,this.south=null,this.west=null;var s=this.maze.getCellRect(e,i);this.width=s.width,this.height=s.height,this.wall_thiccness=t.wall_thiccness,this.x=s.x,this.y=s.y,this.visited=!1}draw(){}removeBorder(t){this.row==t.row&&(this.col==t.col-1&&(this.east&&(this.east.isActive=!1),t.west&&(t.west.isActive=!1)),this.col==t.col+1&&(this.west&&(this.west.isActive=!1),t.east&&(t.east.isActive=!1))),this.col==t.col&&(this.row==t.row-1&&(this.south&&(this.south.isActive=!1),t.north&&(t.north.isActive=!1)),this.row==t.row+1&&(this.north&&(this.north.isActive=!1),t.south&&(t.south.isActive=!1)))}getNeighbours(){var t=[];return this.col>0&&t.push(this.maze.squares[this.row][this.col-1]),this.col<this.maze.num_of_columns-1&&t.push(this.maze.squares[this.row][this.col+1]),this.row>0&&t.push(this.maze.squares[this.row-1][this.col]),this.row<this.maze.num_of_rows-1&&t.push(this.maze.squares[this.row+1][this.col]),t}getCenter(){return[this.x+this.width/2,this.y+this.height/2]}getWalls(){var t=[];return this.row===0&&this.north&&this.north.isActive&&t.push(this.north.getRect()),this.col===0&&this.west&&this.west.isActive&&t.push(this.west.getRect()),this.east&&this.east.isActive&&t.push(this.east.getRect()),this.south&&this.south.isActive&&t.push(this.south.getRect()),t}hasActiveBorderWith(t){if(this.row==t.row){if(this.col==t.col+1)return this.west;if(this.col==t.col-1)return this.east}if(this.col==t.col){if(this.row==t.row+1)return this.north;if(this.row==t.row-1)return this.south}return!1}};var te=class{constructor(t,e){this.game=t;let i={num_of_rows:6,num_of_columns:9,wall_thiccness:4,speed:1,move_speed:3,rotation_speed:9/100,bullet_speed:3,seconds_between_rounds:3,friendly_fire:!1,bullet_limit:7,bounce_limit:7,powerup_interval:2,powerup_limit:20,powerup_duration:10};this.settings=Object.assign({},i,e||{}),this.num_of_rows=this.settings.num_of_rows,this.num_of_columns=this.settings.num_of_columns,this.wall_thiccness=this.settings.wall_thiccness,this.scoreboardHeight=Math.floor(b.height*1/5),this.width=b.width-this.wall_thiccness,this.height=b.height-this.scoreboardHeight-this.wall_thiccness,this._buildGridEdges(),this.tanks=[],this.powerups=[],this.state={tanks:{},powerups:{},meta:{nextPowerupId:1,nextTankId:1}},this.pendingPowerupEvents=[],this.teleportMirrors={},this.lastSnapshot=null,this.message="Shoot the opposing tanks!",this.num_of_destroyed_tanks=0,this.spectator=!1,this.remoteState=null,this.remoteTankMeta=[],this.remoteTankMap={},this.remotePowerups=[],this.remoteBulletCache={},this.remoteBulletLerpDuration=60,this.remoteBulletPredictionWindow=120,this.remoteGlobalBullets=[],this.nextPowerupId=1,this.nextTankId=1,this.tankById={},this.lastStateBroadcast=0,this.lastRemoteStateTime=0,this.hostOwned=!1,this.squares=[];for(var s=0;s<this.num_of_rows;s++){for(var n=[],o=0;o<this.num_of_columns;o++)n.push(new jt(this,s,o));this.squares.push(n)}this._initWalls(),this.extraFunctionsPerCycle=[],this.trippyCount=0}_buildGridEdges(){var t=this.num_of_rows,e=this.num_of_columns,i=Math.floor(this.width/e),s=this.width-i*e;this._colX=[0];for(var n=0;n<e;n++){var o=i+(n<s?1:0);this._colX.push(this._colX[n]+o)}var a=Math.floor(this.height/t),l=this.height-a*t;this._rowY=[0];for(var h=0;h<t;h++){var u=a+(h<l?1:0);this._rowY.push(this._rowY[h]+u)}}getCellRect(t,e){var i=this._colX[e],s=this._colX[e+1],n=this._rowY[t],o=this._rowY[t+1];return{x:i,y:n,width:s-i,height:o-n}}main(){if(this.spectator){this.drawSpectator();return}this.tanks.forEach(function(t){t.main()}),this.draw(),this.broadcastState()}draw(){if((this.trippyCount||0)>0){this.drawScoreboardTop(),this.drawDynamicObjects();return}this.drawScoreboardTop(),this.drawBackground(),this.drawDynamicObjects()}drawBackground(){c.save(),typeof c.setTransform=="function"&&c.setTransform(1,0,0,1,0,0);var t=this.scoreboardHeight,e=b.height-t;c.clearRect(0,t,b.width,e),c.translate(0,this.scoreboardHeight),c.translate(this.wall_thiccness/2,this.wall_thiccness/2);for(var i=0;i<this.squares.length;i++)for(var s=this.squares[i],n=0;n<s.length;n++){var o=s[n],a=(o.row+o.col)%2==0?"#C0C0C0":"#E0E0E0";c.fillStyle=a,c.fillRect(o.x,o.y,o.width,o.height)}c.fillStyle="black";for(var l=0;l<this.walls.length;l++){var h=this.walls[l];h.isActive&&c.fillRect(h.x,h.y,h.width,h.height)}c.restore()}prerenderBackground(){}beginGameplay(){this._generated||(this.randomize(),this.prerenderBackground(),this._generated=!0),y&&y.isHost&&(this.assignSequentialTankIds(),this.broadcastStartState()),this._powerupsLoopStarted||(this._powerupsLoopStarted=!0,setTimeout(this.tryAddPowerupAndRepeat.bind(this),this.settings.powerup_interval*1e3,this))}assignSequentialTankIds(){this.tankById={};for(var t=1,e=0;e<this.tanks.length;e++){var i=this.tanks[e];i.id=t,this.tankById[i.id]=i,t++}this.nextTankId=t}serializeTankRoster(){for(var t=[],e=0;e<this.tanks.length;e++){var i=this.tanks[e];t.push({id:i.id,x:Math.round(i.x)||0,y:Math.round(i.y)||0,rotation:i.rotation||0,colour:i.colour||i.color||"#000",width:i.width||20,height:i.height||20,ownerPeerId:i.ownerPeerId||null,controls:i.controls||[]})}return t}broadcastStartState(){if(!(!y||!y.isHost))try{var t={role:"host",type:"init",tanks:this.serializeTankRoster(),maze:this.serializeLayout?this.serializeLayout():null,gameConfig:this.settings};if(typeof this.serializeUnifiedSnapshot=="function"){var e=this.serializeUnifiedSnapshot();y.broadcast("U,"+e)}C.emit("network-ready",{role:"host",roomId:y.id})}catch{}}drawDynamicObjects(){try{this._pruneStaleExtraFunctions()}catch{}c.save(),c.translate(0,this.scoreboardHeight),c.translate(this.wall_thiccness/2,this.wall_thiccness/2),this.tanks.forEach(function(t){t.is_dead||t.draw()}),this.powerups.forEach(function(t){t.draw()}),this.extraFunctionsPerCycle.forEach(function(t){try{t()}catch{}}),c.restore()}_pruneStaleExtraFunctions(){if(!(!Array.isArray(this.extraFunctionsPerCycle)||this.extraFunctionsPerCycle.length===0)){for(var t=this.teleportMirrors||{},e=[],i=0;i<this.extraFunctionsPerCycle.length;i++){var s=this.extraFunctionsPerCycle[i];s&&s.__tp_tankId!=null?t&&t[s.__tp_tankId]&&e.push(s):e.push(s)}this.extraFunctionsPerCycle=e}}_initWalls(){var t=this.wall_thiccness,e=t/2;this.walls=[],this.intersections=[];for(var i=0;i<=this.num_of_rows;i++){for(var s=[],n=0;n<=this.num_of_columns;n++)s.push(new $t(this._colX[n],this._rowY[i]));this.intersections.push(s)}for(var n=0;n<=this.num_of_columns;n++)for(var i=0;i<this.num_of_rows;i++){var o=this._colX[n]-e,a=this._rowY[i]-e,l=this._rowY[i+1]-this._rowY[i]+t,h=new Dt(o,a,t,l,"vertical");h.N=this.intersections[i][n],h.S=this.intersections[i+1][n],n>0&&(this.squares[i][n-1].east=h),n<this.num_of_columns&&this.squares[i][n]&&(this.squares[i][n].west=h),this.intersections[i][n].east||(this.intersections[i][n].east=h),this.intersections[i+1][n].west||(this.intersections[i+1][n].west=h),this.walls.push(h)}for(var i=0;i<=this.num_of_rows;i++)for(var n=0;n<this.num_of_columns;n++){var u=this._colX[n]-e,f=this._rowY[i]-e,d=this._colX[n+1]-this._colX[n]+t,p=new Dt(u,f,d,t,"horizontal");p.W=this.intersections[i][n],p.E=this.intersections[i][n+1],i>0&&(this.squares[i-1][n].south=p),i<this.num_of_rows&&this.squares[i]&&this.squares[i][n]&&(this.squares[i][n].north=p),this.intersections[i][n].south||(this.intersections[i][n].south=p),this.intersections[i][n+1].north||(this.intersections[i][n+1].north=p),this.walls.push(p)}}drawScoreboardTop(){typeof c.setTransform=="function"&&c.setTransform(1,0,0,1,0,0);var t=this.scoreboardHeight;c.clearRect(0,0,b.width,t),this._gearBtnRect=null;var e=document.getElementById("hud-scoreboard");if(e){try{Ct(),Et(!0)}catch{}for(var i=this.spectator?this.remoteTankMeta||[]:this.tanks||[],s=[],n=0;n<i.length;n++){var o=i[n];if(o){var a=o.colour||o.color||"#ffffff",l=typeof o.score=="number"?o.score:parseInt(o.score||"0",10)||0,h=null;if(this.spectator){if(o.powerups&&o.powerups.length)for(var d=0;d<o.powerups.length;d++){var p=o.powerups[d];if(p&&(h=p.spriteId||null,h))break}}else if(o.powerups&&o.powerups.length)for(var u=0;u<o.powerups.length;u++){var f=o.powerups[u];if(f&&(h=f.img&&f.img.id?f.img.id:f.spriteId||null,h))break}var g="";if(h){var v=document.getElementById(h);v&&v.src&&(g=v.src)}var _=g?'<img class="sb-icon" src="'+g.replace(/"/g,"&quot;")+'" alt="" />':"",w=document.getElementById("tank"),m=w&&w.src?w.src:"",S=m?'<img class="sb-tank" src="'+m.replace(/"/g,"&quot;")+'" alt="" />':"";s.push('<div class="sb-player">'+_+'<div class="sb-row">'+S+'<span class="sb-score">'+String(l)+"</span></div></div>")}}var P=(function(){var M=document.getElementById("network-icon");return M&&M.src?M.src:"res/ui/network.png"})(),x='<div class="sb-inner">'+(s.join("")||"")+'<button class="sb-test" title="Flatten walls + regen powerups">Test</button><div class="sb-network" title="Network Stats"><img src="'+P.replace(/"/g,"&quot;")+'" alt="network" /></div></div>';s.length!==0&&this._lastHudHtml!==x&&(e.innerHTML=x,this._lastHudHtml=x)}}testFlattenAndRegen(){try{for(var t=0;t<this.num_of_rows;t++)for(var e=0;e<this.num_of_columns;e++){var i=this.squares[t][e];i&&i.east&&(i.east.isActive=!1),i&&i.south&&(i.south.isActive=!1)}for(var s=(this.powerups||[]).slice(),n=0;n<s.length;n++){var o=s[n];try{o&&o.timeout&&(clearTimeout(o.timeout),o.timeout=null)}catch{}try{this.removePowerup(o)}catch{}}for(var a=Math.max(0,this.settings&&this.settings.powerup_limit?this.settings.powerup_limit:0),l=0;l<a;l++){var h=fe(this);this.placeObject(h),this.addPowerup(h)}this.drawBackground(),this.drawScoreboardTop()}catch{}}keyDownHandler(t){this.tanks.forEach(function(e){e.keyDownHandler(t)})}randomize(){this.squares.forEach(function(e){e.forEach(function(i){i.visited=!1})}),(this.walls||[]).forEach(function(e){e.isActive=!0});var t=this.squares[0][0];this.visit(this.getRandomSquare(),this.getRandomSquare())}visit(t,e){t.removeBorder(e),e.visited=!0;var i=e.getNeighbours();i=Ye(i);for(var s=0;s<i.length;s++)i[s].visited==!1&&this.visit(e,i[s])}getSquareAtXY(t){var e=t[0],i=t[1];return this.isOutOfBounds(t)?!1:this.squares[Math.floor(i/this.height*this.num_of_rows)][Math.floor(e/this.width*this.num_of_columns)]}getRandomSquare(){var t=Math.floor(Math.random()*this.squares.length),e=this.squares[t],i=e[Math.floor(Math.random()*e.length)];return i}doesRectCollide(t){if(this.isOutOfBounds([t[0],t[1]]))return!0;var e=this.getSquareAtXY([t[0],t[1]]);if(!e)return!0;var i=e.getNeighbours().concat([e]),s=[];i.forEach(function(o){o.getWalls().forEach(function(a){s.push(a)})});var n=!1;return s.forEach(function(o){vt(t,o)&&(n=!0)}),n}isOutOfBounds(t){return t[0]<=0||t[0]>=this.width||t[1]<=0||t[1]>=this.height}tankDestroyed(){if(this.num_of_destroyed_tanks+=1,this.num_of_destroyed_tanks==this.tanks.length-1)for(var t=0;t<this.tanks.length;t++){var e=this.tanks[t];if(e.is_dead==!1){e.score+=1,this.restart_helper(this.settings.seconds_between_rounds);return}}}restart_helper(t){if(t==0){this.restart();return}this.message="Next round starting in time seconds".replace("time",t),setTimeout(this.restart_helper.bind(this),1e3,t-1)}restart(){this.randomize(),this.message="restart",this.num_of_destroyed_tanks=0;for(var t=0;t<this.tanks.length;t++)this.tanks[t].restart();this.powerups=[],this.pendingPowerupEvents=[],this.teleportMirrors={},this.lastSnapshot=null}placeObject(t){var e=this.getRandomSquare(),i=this.wall_thiccness,s=e.west&&e.west.isActive?1:0,n=e.east&&e.east.isActive?1:0,o=e.north&&e.north.isActive?1:0,a=e.south&&e.south.isActive?1:0,l=e.x+i*s,h=e.x+e.width-i*n-t.width,u=e.y+i*o,f=e.y+e.height-i*a-t.height;t.x=l+Math.random()*(h-l),t.y=u+Math.random()*(f-u)}registerTank(t){this.tankById[t.id||"tank-"+this.tanks.length]=t}serializeLayout(){for(var t=[],e=0;e<this.squares.length;e++){for(var i=[],s=0;s<this.squares[e].length;s++){var n=this.squares[e][s];i.push({north:!!(n.north&&n.north.isActive),south:!!(n.south&&n.south.isActive),east:!!(n.east&&n.east.isActive),west:!!(n.west&&n.west.isActive)})}t.push(i)}return{num_of_rows:this.num_of_rows,num_of_columns:this.num_of_columns,wall_thiccness:this.wall_thiccness,squares:t}}loadLayout(t){if(!(!t||!t.squares)){this.num_of_rows=t.num_of_rows||this.num_of_rows,this.num_of_columns=t.num_of_columns||this.num_of_columns,this.wall_thiccness=t.wall_thiccness||this.wall_thiccness;for(var e=0;e<this.squares.length&&e<t.squares.length;e++)for(var i=0;i<this.squares[e].length&&i<t.squares[e].length;i++){var s=this.squares[e][i],n=t.squares[e][i]||{};s.north&&(s.north.isActive=!!n.north),s.south&&(s.south.isActive=!!n.south),s.east&&(s.east.isActive=!!n.east),s.west&&(s.west.isActive=!!n.west)}}}serializeState(){return this.captureState()}captureState(){var t=this,e=this.tanks.map(function(a,l){return t.cloneTankState({id:a.id||"tank-"+l,colour:a.colour,ownerPeerId:a.ownerPeerId,x:a.x,y:a.y,rotation:a.rotation,score:a.score,is_dead:a.is_dead,width:a.width,height:a.height,bullets:a.bullets.map(function(h){return{x:h.x,y:h.y,radius:h.radius,colour:a.colour}}),powerups:a.powerups.map(function(h){return h.serialize?h.serialize():{name:h.name,type:h.constructor&&h.constructor.name?h.constructor.name:h.name,spriteId:h.img&&h.img.id?h.img.id:null}})})}),i=this.serializeBoardPowerups(),s={message:this.message,tanks:e,powerups:i,events:this.consumePendingEvents?this.consumePendingEvents():[]};try{this.state.tanks={};for(var n=0;n<e.length;n++){var o=e[n];this.state.tanks[o.id]={id:o.id,x:o.x,y:o.y,rotation:o.rotation,width:o.width,height:o.height,colour:o.colour,score:o.score,is_dead:o.is_dead,powerups:(o.powerups||[]).map(function(a){return{type:a.type||a.name,spriteId:a.spriteId||null}})}}}catch{}return s}serializeBoardPowerups(){for(var t=[],e=0;e<this.powerups.length;e++){var i=this.powerups[e];if(i){i.id||(i.id="powerup-"+this.nextPowerupId++),t.push({id:i.id,type:i.constructor&&i.constructor.name?i.constructor.name:i.name,name:i.name,x:i.x,y:i.y,width:i.width,height:i.height,spriteId:i.img&&i.img.id?i.img.id:null,color:i.color||"#ffffff"});try{this.state&&(this.state.powerups[i.id]={id:i.id,type:t[t.length-1].type,x:i.x,y:i.y,width:i.width,height:i.height})}catch{}}}return t}cloneTankState(t){return JSON.parse(JSON.stringify(t))}clonePowerupState(t){return JSON.parse(JSON.stringify(t))}clonePowerupList(t){var e=this,i=Array.isArray(t)?t:[];return i.map(function(s){return e.clonePowerupState(s)})}cloneSnapshot(t){if(!t)return{message:"",tanks:[],powerups:[],events:[]};var e=Array.isArray(t.tanks)?t.tanks:[],i=this;return{message:t.message,tanks:e.map(function(s){return i.cloneTankState(s)}),powerups:i.clonePowerupList(t.powerups),events:[]}}collectRemoteTankMeta(){var t=[];if(!this.remoteTankMap)return t;for(var e in this.remoteTankMap)Object.prototype.hasOwnProperty.call(this.remoteTankMap,e)&&t.push(this.remoteTankMap[e]);return t}buildStatePacket(){var t=this.captureState(),e=null;if(!this.lastSnapshot)e={type:"state-init",state:t};else{var i=this.diffSnapshots(this.lastSnapshot,t);i&&(e={type:"state-delta",delta:i})}return this.lastSnapshot=this.cloneSnapshot(t),e}buildUnifiedDeltaPacket(){try{var t=this._lastUnifiedState||{tanks:{},powerups:{}},e=this.serializeUnifiedDelta(t);return this._lastUnifiedState=JSON.parse(this.serializeUnifiedSnapshot()),"V,"+e}catch{return null}}serializeUnifiedSnapshot(){try{return JSON.stringify({tanks:this.state.tanks||{},powerups:this.state.powerups||{}})}catch{return"{}"}}applyUnifiedSnapshot(t){try{var e=typeof t=="string"?JSON.parse(t):t||{};this.state.tanks=e.tanks||{},this.state.powerups=e.powerups||{},this.remoteTankMap={};for(var i in this.state.tanks)Object.prototype.hasOwnProperty.call(this.state.tanks,i)&&(this.remoteTankMap[i]=this.state.tanks[i]);this.remoteTankMeta=this.collectRemoteTankMeta(),typeof this.recomputeGlobalPowerups=="function"&&this.recomputeGlobalPowerups()}catch{}}serializeUnifiedDelta(t){var e={tanks:{set:{},del:[]},powerups:{set:{},del:[]}};try{var i=t&&t.tanks||{},s=this.state.tanks||{};for(var n in s)if(Object.prototype.hasOwnProperty.call(s,n)){var o=JSON.stringify(i[n]||null),a=JSON.stringify(s[n]);o!==a&&(e.tanks.set[n]=s[n])}for(var l in i)Object.prototype.hasOwnProperty.call(i,l)&&(Object.prototype.hasOwnProperty.call(s,l)||e.tanks.del.push(l));var h=t&&t.powerups||{},u=this.state.powerups||{};for(var f in u)if(Object.prototype.hasOwnProperty.call(u,f)){var d=JSON.stringify(h[f]||null),p=JSON.stringify(u[f]);d!==p&&(e.powerups.set[f]=u[f])}for(var g in h)Object.prototype.hasOwnProperty.call(h,g)&&(Object.prototype.hasOwnProperty.call(u,g)||e.powerups.del.push(g))}catch{}return JSON.stringify(e)}applyUnifiedDelta(t){try{var e=typeof t=="string"?JSON.parse(t):t||{},i=e.tanks||{},s=e.powerups||{};this.state.tanks=this.state.tanks||{},(i.del||[]).forEach(h=>{delete this.state.tanks[h],delete this.remoteTankMap[h]});var n=i.set||{};for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(this.state.tanks[o]=n[o],this.remoteTankMap[o]=n[o]);this.state.powerups=this.state.powerups||{},(s.del||[]).forEach(h=>{delete this.state.powerups[h]});var a=s.set||{};for(var l in a)Object.prototype.hasOwnProperty.call(a,l)&&(this.state.powerups[l]=a[l]);this.remoteTankMeta=this.collectRemoteTankMeta(),typeof this.recomputeGlobalPowerups=="function"&&this.recomputeGlobalPowerups()}catch{}}serializeInitString(){var t=this.settings||{},e=this.num_of_rows||t.num_of_rows||0,i=this.num_of_columns||t.num_of_columns||0,s=this.wall_thiccness||t.wall_thiccness||0,n=+(t.move_speed!=null?t.move_speed:0),o=+(t.rotation_speed!=null?t.rotation_speed:0),a=+(t.bullet_speed!=null?t.bullet_speed:0),l=+(t.bullet_limit!=null?t.bullet_limit:0),h=+(t.bounce_limit!=null?t.bounce_limit:0),u=+(t.powerup_interval!=null?t.powerup_interval:0),f=+(t.powerup_limit!=null?t.powerup_limit:0),d=+(t.powerup_duration!=null?t.powerup_duration:0),p=t.friendly_fire?1:0,g=this.serializeLayout?this.serializeLayout():null,v=g?btoa(unescape(encodeURIComponent(JSON.stringify(g)))):"",_=(this.powerups||[]).map(function(m){if(!m)return"";var S=Math.round(m.x)||0,P=Math.round(m.y)||0,x=Math.round(m.width)||0,M=Math.round(m.height)||0,T=m.img&&m.img.id?m.img.id:"",U=(m.color||"").replace(/[,|;]/g,"");return[S,P,x,M,T,U].join("|")}).filter(Boolean).join(";"),w=(this.tanks||[]).map(function(m,S){if(!m)return"";var P=m.id||"tank-"+S,x=Math.round(m.x)||0,M=Math.round(m.y)||0,T=+(m.rotation||0).toFixed(4),U=Math.round(m.width)||0,L=Math.round(m.height)||0,F=(m.colour||"").replace(/[,|;]/g,""),O=+(m.score||0);return[P,x,M,T,U,L,F,O].join("|")}).filter(Boolean).join(";");return["I",e,i,s,n,o,a,l,h,u,f,d,p,v,_,w].join(",")}serializeDeltaString(){var t=(this.tanks||[]).map(function(p,g){if(!p)return"";var v=p.id||"tank-"+g,_=Math.round(p.x)||0,w=Math.round(p.y)||0,m=+(p.rotation||0).toFixed(4),S=+(p.score||0),P=p.is_dead?0:1;return[v,_,w,m,S,P].join("|")}).filter(Boolean).join(";"),e=[];(this.tanks||[]).forEach(function(p){(p.bullets||[]).forEach(function(g){var v=+(g.direction&&g.direction[0]||0).toFixed(3),_=+(g.direction&&g.direction[1]||0).toFixed(3),w=(p.colour||"").replace(/[,|;]/g,""),m=Math.round(g.radius||1);e.push([Math.round(g.x)||0,Math.round(g.y)||0,v,_,w,m].join("|"))})});var i=(this.powerups||[]).map(function(p){if(!p)return"";var g=Math.round(p.x)||0,v=Math.round(p.y)||0,_=Math.round(p.width)||0,w=Math.round(p.height)||0,m=p.img&&p.img.id?p.img.id:"",S=(p.color||"").replace(/[,|;]/g,"");return[g,v,_,w,m,S].join("|")}).filter(Boolean).join(";"),s=this.consumePendingEvents(),n="";if(s&&s.length){for(var o=[],a=0;a<s.length;a++){var l=s[a];if(l){var h=(l.powerup||"").replace(/[,|;]/g,""),u=(l.status||"").replace(/[,|;]/g,""),f=(l.target||"").replace(/[,|;]/g,""),d=(l.tankId||"").replace(/[,|;]/g,"");o.push([h,u,f,d].join("|"))}}n=o.join(";")}return["D",t,e.join(";"),i,n].join(",")}applyInitString(t){if(!(typeof t!="string"||!t||t[0]!=="I")){var e=t.split(","),i=function(P){var x=parseInt(P,10);return isNaN(x)?0:x},s=function(P){var x=parseFloat(P);return isNaN(x)?0:x};this.num_of_rows=i(e[1]),this.num_of_columns=i(e[2]),this.wall_thiccness=i(e[3]),this.settings.move_speed=s(e[4]),this.settings.rotation_speed=s(e[5]),this.settings.bullet_speed=s(e[6]),this.settings.bullet_limit=i(e[7]),this.settings.bounce_limit=i(e[8]),this.settings.powerup_interval=s(e[9]),this.settings.powerup_limit=i(e[10]),this.settings.powerup_duration=s(e[11]),this.settings.friendly_fire=e[12]==="1";var n=null;try{var o=e[13]||"";if(o){var a=decodeURIComponent(escape(atob(o)));n=JSON.parse(a)}}catch{n=null}this._buildGridEdges(),this.squares=[];for(var l=0;l<this.num_of_rows;l++){for(var h=[],u=0;u<this.num_of_columns;u++)h.push(new jt(this,l,u));this.squares.push(h)}this._initWalls(),n&&n.squares&&this.loadLayout&&this.loadLayout(n),this.remotePowerups=[];var f=e[14]||"";if(f)for(var d=f.split(";"),p=0;p<d.length;p++){var g=d[p];if(g){var v=g.split("|");this.remotePowerups.push({x:parseInt(v[0],10)||0,y:parseInt(v[1],10)||0,width:parseInt(v[2],10)||0,height:parseInt(v[3],10)||0,spriteId:v[4]||"",color:v[5]||"#ffffff"})}}this.remoteTankMap={};var _=e[15]||"";if(_)for(var w=_.split(";"),m=0;m<w.length;m++){var g=w[m];if(g){var v=g.split("|"),S=v[0];this.remoteTankMap[S]={id:S,x:i(v[1]),y:i(v[2]),rotation:s(v[3]),width:i(v[4]),height:i(v[5]),colour:v[6]||"#ffffff",score:i(v[7])}}}this.remoteTankMeta=this.collectRemoteTankMeta(),this.remoteState={tanks:this.remoteTankMeta,powerups:this.remotePowerups},this.recomputeGlobalPowerups&&this.recomputeGlobalPowerups(),this.prerenderBackground(),this.message="Awaiting host updates..."}}applyDeltaString(t){if(!(typeof t!="string"||!t||t[0]!=="D")){var e=t.split(","),i=function(pt){var et=parseInt(pt,10);return isNaN(et)?0:et},s=function(pt){var et=parseFloat(pt);return isNaN(et)?0:et},n=1;e.length>=6&&(n=2);var o=e[n]||"";if(o)for(var a=o.split(";"),l=0;l<a.length;l++){var h=a[l];if(h){var u=h.split("|"),f=u[0],d=this.remoteTankMap&&this.remoteTankMap[f]?this.remoteTankMap[f]:{id:f};if(d.x=i(u[1]),d.y=i(u[2]),d.rotation=s(u[3]),d.score=i(u[4]),u.length>5&&u[5]!==""){var p=i(u[5]);d.is_dead=p===0}else typeof d.is_dead!="boolean"&&(d.is_dead=!1);this.remoteTankMap[f]=d}}this.remoteTankMeta=this.collectRemoteTankMeta();try{if(this.settings&&this.settings.friendly_fire)for(var g=this.remoteTankMeta||[],v=this.remoteGlobalBullets||[],_=0;_<g.length;_++){var w=g[_];if(!(!w||w.is_dead))for(var m=w.x,S=w.y,P=w.width||this.width/this.num_of_columns/3,x=w.height||this.height/this.num_of_rows/3,M=0;M<v.length;M++){var T=v[M];if(T&&!(T.colour&&w.colour&&T.colour===w.colour)){var U=T.radius||1,L=T.x-U,F=T.y-U,O=U*2,$=U*2;if(vt([m,S,P,x],[L,F,O,$])){w.is_dead=!0;var j=this.remoteTankMap&&this.remoteTankMap[w.id];j&&(j.is_dead=!0);break}}}}}catch{}var ot=[],It=e[n+1]||"";if(It)for(var At=It.split(";"),St=0;St<At.length;St++){var mt=At[St];if(mt){var Y=mt.split("|");ot.push({x:i(Y[0]),y:i(Y[1]),vx:s(Y[2]),vy:s(Y[3]),colour:Y[4]||"#000000",radius:i(Y[5])||1})}}this.remoteGlobalBullets=ot;var W=[],yt=e[n+2]||"";if(yt)for(var gt=yt.split(";"),at=0;at<gt.length;at++){var wt=gt[at];if(wt){var z=wt.split("|");W.push({x:i(z[0]),y:i(z[1]),width:i(z[2]),height:i(z[3]),spriteId:z[4]||"",color:z[5]||"#ffffff"})}}this.remotePowerups=W,this.remoteState={tanks:this.remoteTankMeta,powerups:this.remotePowerups};var ut=e[n+3]||"";if(ut)for(var Bt=ut.split(";"),tt=0;tt<Bt.length;tt++){var _t=Bt[tt];if(_t){var ft=_t.split("|"),dt={type:"powerup",powerup:ft[0]||"",status:ft[1]||"",target:ft[2]||"",tankId:ft[3]||""};this.applyPowerupEvent(dt)}}}}diffSnapshots(t,e){t=t||{},e=e||{};var i={},s=Array.isArray(t.tanks)?t.tanks:[],n=Array.isArray(e.tanks)?e.tanks:[],o=Array.isArray(t.powerups)?t.powerups:[],a=Array.isArray(e.powerups)?e.powerups:[];e.message!==t.message&&(i.message=e.message);var l=[],h={},u={};s.forEach(function(m,S){if(m){var P=m.id?m.id:"tank-"+S;h[P]=m}}),n.forEach(function(m,S){if(m){var P=m.id?m.id:"tank-"+S;u[P]=m}});var f=this;for(var d in u){var p=u[d],g=h[d];(!g||f.hasTankChanged(g,p))&&l.push(p)}l.length&&(i.tanks=l);var v=[];for(var _ in h)u[_]||v.push(_);v.length&&(i.removedTanks=v),this.haveBoardPowerupsChanged(o,a)&&(i.powerups=this.clonePowerupList(a));var w=Array.isArray(e.events)?e.events:[];return w.length&&(i.events=w),Object.keys(i).length?i:null}hasTankChanged(t,e){return!t||!e?t!==e:!!(t.x!==e.x||t.y!==e.y||t.rotation!==e.rotation||t.colour!==e.colour||t.ownerPeerId!==e.ownerPeerId||t.width!==e.width||t.height!==e.height||t.score!==e.score||!!t.is_dead!=!!e.is_dead||this.haveBulletsChanged(t.bullets,e.bullets)||this.havePowerupsChanged(t.powerups,e.powerups))}haveBulletsChanged(t,e){if(t=t||[],e=e||[],t.length!==e.length)return!0;for(var i=0;i<t.length;i++){var s=t[i],n=e[i];if(s.x!==n.x||s.y!==n.y||s.radius!==n.radius)return!0}return!1}syncGlobalPowerups(){this.recomputeGlobalPowerups()}recomputeGlobalPowerups(){try{for(var t=this.remoteTankMeta||[],e=0,i=0;i<t.length;i++){var s=t[i];if(!(!s||!s.powerups))for(var n=0;n<s.powerups.length;n++){var o=s.powerups[n],a=(o&&(o.type||o.name||""))+"";if(/Trippy/i.test(a)){e++;break}}}this.trippyCount=e}catch{}}havePowerupsChanged(t,e){if(t=t||[],e=e||[],t.length!==e.length)return!0;for(var i=0;i<t.length;i++){var s=t[i],n=e[i];if((s&&s.type)!==(n&&n.type))return!0}return!1}haveBoardPowerupsChanged(t,e){if(t=Array.isArray(t)?t:[],e=Array.isArray(e)?e:[],t.length!==e.length)return!0;var i={};t.forEach(function(l,h){if(l){var u=l.id||"powerup-"+h;i[u]=l}});for(var s=0;s<e.length;s++){var n=e[s];if(!n)return!0;var o=n.id||"powerup-"+s,a=i[o];if(!a||a.x!==n.x||a.y!==n.y||a.width!==n.width||a.height!==n.height||(a.spriteId||null)!==(n.spriteId||null)||(a.type||null)!==(n.type||null)||(a.color||null)!==(n.color||null))return!0}return!1}getCachedSnapshot(){if(this.lastSnapshot)return this.cloneSnapshot(this.lastSnapshot);var t=this.captureState();return this.lastSnapshot=this.cloneSnapshot(t),t}applyInputState(t){if(!(!t||!t.tankId)){var e=this.tankById?this.tankById[t.tankId]:null;e&&e.applyNetworkInput({upPressed:!!t.upPressed,downPressed:!!t.downPressed,leftPressed:!!t.leftPressed,rightPressed:!!t.rightPressed,shooting:!!t.shooting,specialKeyPressed:!!t.specialKeyPressed})}}broadcastState(){if(!(!y||!y.isHost||!y.connections||y.connections.length===0)){var t=performance.now();if(!(this.lastSnapshot&&t-this.lastStateBroadcast<30)){var e=this.buildStatePacket();if(e){this.lastStateBroadcast=t;try{e.type==="state-init"?y.broadcast(this.serializeInitString()):e.type==="state-delta"&&y.broadcast(this.serializeDeltaString())}catch{}}}}}drawSpectator(){if(this.drawScoreboardTop(),!((this.trippyCount||0)>0))try{typeof c.setTransform=="function"&&c.setTransform(1,0,0,1,0,0),this.drawBackground()}catch{}if(c.save(),c.translate(0,this.scoreboardHeight),c.translate(this.wall_thiccness/2,this.wall_thiccness/2),!((this.trippyCount||0)>0)){c.fillStyle="black";for(var t=0;t<this.walls.length;t++){var e=this.walls[t];e.isActive&&c.fillRect(e.x,e.y,e.width,e.height)}}var i=null;if(this.state&&this.state.powerups&&Object.keys(this.state.powerups).length?i=Object.values(this.state.powerups):i=this.remoteState&&this.remoteState.powerups?this.remoteState.powerups:this.remotePowerups,i&&i.length)for(var s=0;s<i.length;s++)this.drawRemotePowerup(i[s]);if(this.remoteGlobalBullets&&this.remoteGlobalBullets.length)for(var n=0;n<this.remoteGlobalBullets.length;n++){var o=this.remoteGlobalBullets[n];this.drawRemoteBullet({x:o.x,y:o.y,radius:o.radius||1,colour:o.colour||"#000000"})}var a=this.remoteState&&this.remoteState.tanks?this.remoteState.tanks:this.remoteTankMeta;if(a)for(var t=0;t<a.length;t++){var l=a[t];this.drawRemoteTank(l);var h=l&&l.id,u=h&&this.teleportMirrors&&this.teleportMirrors[h]||l&&l.powerups&&l.powerups.some(function(d){return d&&d.type==="TeleportPowerup"});u&&this.drawTeleportMirrorState(l)}c.restore(),c.font="15px Verdana",c.fillStyle="black",c.fillText(this.message||"",b.width/2,this.scoreboardHeight+this.height+20)}drawRemotePowerup(t){if(t){var e=t.width||20,i=t.height||20,s=t.x||0,n=t.y||0,o=t.spriteId?document.getElementById(t.spriteId):null;if(o){var a=c.imageSmoothingEnabled;c.imageSmoothingEnabled=!0,c.drawImage(o,s,n,e,i),c.imageSmoothingEnabled=a;return}c.lineWidth=1,c.strokeStyle=t.color||"#ffffff",c.strokeRect(s,n,e,i)}}drawRemoteTank(t){if(t&&!t.is_dead){var e=t.width||this.width/this.num_of_columns/3,i=t.height||this.height/this.num_of_rows/3;c.save(),c.translate(t.x+e/2,t.y+i/2),c.rotate(t.rotation||0);var s=document.getElementById("tank");if(s){var n=c.imageSmoothingEnabled;c.imageSmoothingEnabled=!0,c.drawImage(s,-e/2,-i/2,e,i),c.imageSmoothingEnabled=n}else c.fillStyle=t.colour||"#ffffff",c.fillRect(-e/2,-i/2,e,i);c.restore()}}drawRemoteBullet(t){if(t){c.beginPath();var e=typeof t.radius=="number"&&t.radius>0?t.radius:1,i=t.colour||"#000000";c.fillStyle="#000000",c.strokeStyle=i,c.lineWidth=1,c.arc(t.x,t.y,e,0,2*Math.PI),c.fill(),c.stroke()}}drawTeleportMirrorState(t){var e=t.width||this.width/this.num_of_columns/3,i=t.height||this.height/this.num_of_rows/3;c.save(),c.translate(b.width-(t.x+e/2),this.height-(t.y+i/2)),c.rotate(t.rotation||0);var s=c.globalAlpha;c.globalAlpha=.3;var n=document.getElementById("tank");if(n){var o=c.imageSmoothingEnabled;c.imageSmoothingEnabled=!0,c.drawImage(n,-e/2,-i/2,e,i),c.imageSmoothingEnabled=o}else c.fillStyle=t.colour||"#ffffff",c.fillRect(-e/2,-i/2,e,i);c.globalAlpha=s,c.restore()}tryAddPowerupAndRepeat(){if(!this.spectator){if(this.powerups.length!=this.settings.powerup_limit){this.powerups.length>=this.settings.powerup_limit&&this.powerups.shift();var t=fe(this);this.placeObject(t),this.addPowerup(t),this.message=t.getMessage()}setTimeout(this.tryAddPowerupAndRepeat.bind(this),this.settings.powerup_interval*1e3,this)}}addPowerup(t){if(t){t.id||(t.id="powerup-"+this.nextPowerupId++),this.powerups.push(t),t.registerDelegate&&t.registerDelegate(this.broadcastPowerupEvent.bind(this));try{if(y&&y.isHost){var e=t.constructor&&t.constructor.name?t.constructor.name:t.name||"",i=t.img&&t.img.id?t.img.id:"",s=(t.color||"").replace(/[|]/g,""),n=[e,t.id,Math.round(t.x)||0,Math.round(t.y)||0,Math.round(t.width)||0,Math.round(t.height)||0,i,s].join("|");y.broadcast(["S",n].join(","))}}catch{}}}removePowerup(t){this.powerups.splice(this.powerups.indexOf(t),1)}broadcastPowerupEvent(t){if(t){this.pendingPowerupEvents||(this.pendingPowerupEvents=[]),this.pendingPowerupEvents.push(t);try{if(this.game&&this.game.peer_manager&&this.game.peer_manager.isHost&&typeof this.buildUnifiedDeltaPacket=="function"){var e=this.buildUnifiedDeltaPacket();e&&typeof this.game.peer_manager.broadcast=="function"&&this.game.peer_manager.broadcast(e)}}catch{}}}consumePendingEvents(){var t=this.pendingPowerupEvents||[];return this.pendingPowerupEvents=[],t}applyPowerupEvent(t){if(t){var e=null;if(t.tankId&&this.tankById&&(e=this.tankById[t.tankId]||null),t.powerup==="TeleportPowerup"&&t.tankId&&(this.teleportMirrors||(this.teleportMirrors={}),t.status==="activate"?this.teleportMirrors[t.tankId]=!0:t.status==="deactivate"&&delete this.teleportMirrors[t.tankId]),t.tankId){this.state=this.state||{tanks:{},powerups:{},meta:{nextPowerupId:0}};var i=this.state.tanks[t.tankId]||(this.state.tanks[t.tankId]={id:t.tankId,powerups:[]});if(t.status==="activate"){var s=this.resolvePowerupSpriteId(t.powerup);i.powerups=s?[{type:t.powerup,spriteId:s}]:[{type:t.powerup}]}else t.status==="deactivate"&&(i.powerups=[]);if(this.remoteTankMap){var n=this.remoteTankMap[t.tankId]||(this.remoteTankMap[t.tankId]={id:t.tankId});n.powerups=(i.powerups||[]).slice(),this.remoteTankMeta=this.collectRemoteTankMeta(),this.remoteState={tanks:this.remoteTankMeta,powerups:this.remotePowerups}}typeof this.recomputeGlobalPowerups=="function"&&this.recomputeGlobalPowerups()}var o=null;if(t.powerupId&&this.powerups)for(var a=0;a<this.powerups.length;a++){var l=this.powerups[a];if(l&&l.id===t.powerupId){o=l;break}}if(!o&&this.powerups)for(var h=0;h<this.powerups.length;h++){var u=this.powerups[h];if(u&&String(u.id)===String(t.powerupId)){o=u;break}}if(t.status==="activate"){if(o){if(typeof o.pickup=="function"){o.pickup(e||t.tankId||"");return}if(typeof o.onBulletHit=="function"&&e){o.onBulletHit(e);return}if(typeof o.effect=="function"){o.effect(e);return}}return}if(t.status==="deactivate"){if(e&&Array.isArray(e.powerups))for(var f=0;f<e.powerups.length;f++){var d=e.powerups[f],p=d&&d.constructor&&d.constructor.name?d.constructor.name:d&&d.name;p===t.powerup&&(typeof d.teardown=="function"?d.teardown():typeof d.undo=="function"&&d.undo(e))}o&&(typeof o.teardown=="function"?o.teardown():typeof o.undo=="function"&&o.undo(e));return}}}resolvePowerupSpriteId(t){var e=String(t||"");return/Trippy/i.test(e)?"pills":/Remove\s*Bullet\s*Limit|RemoveBulletLimit/i.test(e)?"unlimited":/Triple\s*-?Shot|TripleShot/i.test(e)?"tripleshot":/MoveThroughWalls|ghost/i.test(e)?"ghost":/Teleport/i.test(e)?"teleport":/Cannon(ball)?/i.test(e)?"cannonball":/Invis/i.test(e)?"invisible":/Shinra/i.test(e)?"repel":/Hex/i.test(e)?"hex":null}addTank(t){this.tanks.push(t)}onclick(t,e){}};var pe=class{constructor({x:t=0,y:e=0,width:i=0,height:s=0,visible:n=!0}={}){this.x=t,this.y=e,this.width=i,this.height=s,this.visible=n,this.children=[],this.parent=null}addChild(t){return t?(t.parent&&t.parent.removeChild(t),t.parent=this,this.children.push(t),t):null}removeChild(t){let e=this.children.indexOf(t);e!==-1&&(t.parent=null,this.children.splice(e,1))}setChildren(t){this.children.slice().forEach(e=>this.removeChild(e)),(t||[]).forEach(e=>this.addChild(e))}containsPoint(t,e){return this.visible&&t>=this.x&&e>=this.y&&t<=this.x+this.width&&e<=this.y+this.height}draw(t){this.visible&&(this.drawSelf(t),this.children.forEach(e=>e.draw(t)))}drawSelf(t){}dispatchClick(t,e){if(!this.containsPoint(t,e))return!1;for(let i=this.children.length-1;i>=0;i--)if(this.children[i].dispatchClick(t,e))return!0;return this.handleClick(t,e)}handleClick(){return!1}},Ut=pe;var ve=class extends Ut{constructor(t){super({x:0,y:0,width:b.width/5,height:b.height}),this.colour=t,this.buttons=[],this.north_border=5,this.east_border=5/2,this.south_border=5,this.west_border=5/2}addButton(t){this.buttons.push(t),this.addChild(t)}drawSelf(t){t.fillStyle="black",t.fillRect(this.x,this.y,this.width,this.height),t.fillStyle=this.colour,t.fillRect(this.x+this.west_border,this.y+this.north_border,this.width-this.west_border-this.east_border,this.height-this.north_border-this.south_border)}},Nt=ve;var me=class extends Ut{constructor(t,e,i,s=""){super({x:0,y:i,width:t.width/1.5,height:20}),this.text=s,this.panel=t}get_as_Rect(){return[this.x,this.y,this.width,this.height]}update(){this.resize_horiontals()}resize_horiontals(){this.width=this.panel.width/1.5,this.x=this.panel.x+this.panel.width/2-this.width/2}drawSelf(){this.panel.pregame.focus==this?(c.fillStyle="red",c.fillRect(this.x,this.y,this.width,this.height)):(c.fillStyle="white",c.fillRect(this.x,this.y,this.width,this.height)),c.fillStyle="white",c.fillRect(this.x+2,this.y+2,this.width-4,this.height-4),c.fillStyle="black",c.textAlign="center",c.font="10px Arial",this.fill_text()}fill_text(){c.fillText(this.text.toString(),this.x+this.width/2,this.y+this.height/1.5)}center_horizontally(){this.width=this.panel.width/2,this.x=this.panel.x+this.panel.width/2-this.width/2}center_vertically(){this.y=this.panel.y+this.panel.height/2-this.height/2}handleClick(){return this.onclick?(this.onclick(),!0):!1}},rt=me;var ye=class extends rt{constructor(t,e,i,s,n=""){super(t,e,i,s+": "),this.control=s+": ",this.value=n,this.panel.addButton(this)}keyDownHandler(t){this.value=t,this.panel&&this.panel.pregame&&typeof this.panel.pregame.emitTankConfig=="function"&&this.panel.pregame.emitTankConfig()}onclick(){this.panel.pregame.focus=this}fill_text(){var t=this.text.toString()+this.value.toString();c.fillText(t,this.x+this.width/2,this.y+this.height/1.5)}},Lt=ye;var ge=class extends Nt{constructor(t,e="green",i=void 0){super(e),this.panelId="panel-"+Math.random().toString(36).slice(2,8),this.pregame=t;var s=new rt(this,0,this.height*10/12,"delete");s.onclick=function(){this.pregame.removeTankPanel(this)}.bind(this),this.addButton(s),s.center_horizontally();for(var n=["up","right","down","left","attack","special"],o=0;o<n.length;o++){var a=new Lt(this,0,this.height*(3+o)/12,n[o],i?i[o]:void 0);a.center_horizontally()}this.pregame&&typeof this.pregame.emitTankConfig=="function"&&this.pregame.emitTankConfig()}},zt=ge;var we=class{constructor(t,e,i,s,n=1){this.tank=t,this.direction=e,this.x=i,this.y=s,this.radius=n,this.bounces=0}main(){this.handleMovement(),this.handleTankCollisions(),this.handlePowerupCollisions()}draw(){c.beginPath(),c.fillStyle="black",c.strokeStyle=this.tank.colour,c.lineWidth=1,c.arc(this.x,this.y,this.radius,0,2*Math.PI),c.fill(),c.stroke()}handleMovement(){this.tank.maze.doesRectCollide([this.x-this.radius+this.direction[0],this.y-this.radius,this.radius,this.radius])?(this.direction[0]*=-1,this.bounces+=1):this.x+=this.direction[0],this.tank.maze.doesRectCollide([this.x-this.radius,this.y-this.radius+this.direction[1],this.radius,this.radius])?(this.direction[1]*=-1,this.bounces+=1):this.y+=this.direction[1],this.bounces>=this.tank.bounce_limit&&this.tank.removeBullet(this)}handleTankCollisions(){this.tank.maze.tanks.forEach(function(t){if(t.is_dead==!1&&(t!=this.tank||t.maze.settings.friendly_fire==!0)){var e=[this.x-this.radius,this.y-this.radius,this.radius*2,this.radius*2],i=[t.x,t.y,t.width,t.height];vt(i,e)&&t.onBulletHit()}}.bind(this))}handlePowerupCollisions(){this.tank.maze.powerups.forEach(function(t){var e=[this.x-this.radius,this.y-this.radius,this.radius*2,this.radius*2],i=[t.x,t.y,t.width,t.height];vt(i,e)&&t.onBulletHit(this.tank)}.bind(this))}},Ve=we;var ie=["up","right","down","left","fire","special"];function ee(){return{up:!1,right:!1,down:!1,left:!1,fire:!1,special:!1}}function _e(r,t){return{x:Math.sin(r)*t,y:-Math.cos(r)*t}}var be=class{constructor(t,e,i,s,n="black",o){this.x=t,this.y=e,this.maze=i,this.colour=n,this.powerups=[],this.maze.tanks.push(this);let a=o||{};this.disableInput=!!a.disableInput;let l=this.maze.squares[0][0];this.width=this.maze.width/this.maze.num_of_columns/3,this.height=this.maze.height/this.maze.num_of_rows/3,this.rotation=0,this.bullets=[],this.bullet_limit=this.maze.settings.bullet_limit,this.bounce_limit=this.maze.settings.bounce_limit,this.score=0,this.is_dead=!1,this.poweruplock=!1,this.move_speed=this.maze.settings.move_speed*Math.min(l.width,l.height)/60*.8,this.rotation_speed=this.maze.settings.rotation_speed*1.2,this.localInput=ee(),this.networkInput=ee(),this.activePowerups=[],this.pendingPowerupUpdates=!1,this.fireWasActive=!1,this.upPressed=!1,this.rightPressed=!1,this.downPressed=!1,this.leftPressed=!1,this.shooting=!1,this.specialKeyPressed=!1,this.hasFiredThisPress=!1,this.special=function(){},this.setControls(s)}setControls(t){this.controls=Array.isArray(t)?t.slice(0,ie.length):[],this.disableInput||xe.registerTank(this)}setLocalAction(t,e){Object.prototype.hasOwnProperty.call(this.localInput,t)&&this.localInput[t]!==e&&(this.localInput[t]=e,t==="special"&&!e&&(this.poweruplock=!1),t==="fire"&&(e||(this.hasFiredThisPress=!1)),this.syncDerivedInput())}applyNetworkInput(t){t&&(ie.forEach((e,i)=>{let s=e==="fire"?"shooting":e==="special"?"specialKeyPressed":`${e}Pressed`;e==="fire"&&typeof t.shooting=="boolean"?this.networkInput.fire=t.shooting:e==="special"&&typeof t.specialKeyPressed=="boolean"?(this.networkInput.special=t.specialKeyPressed,t.specialKeyPressed||(this.poweruplock=!1)):typeof t[s]=="boolean"&&(this.networkInput[e]=t[s])}),this.syncDerivedInput(),this.pendingPowerupUpdates=!0)}syncDerivedInput(){this.upPressed=this.isActionActive("up"),this.rightPressed=this.isActionActive("right"),this.downPressed=this.isActionActive("down"),this.leftPressed=this.isActionActive("left"),this.shooting=this.isActionActive("fire"),this.specialKeyPressed=this.isActionActive("special"),this.shooting||(this.fireWasActive=!1,this.hasFiredThisPress=!1),this.specialKeyPressed||(this.poweruplock=!1)}isActionActive(t){return!!(this.localInput[t]||this.networkInput[t])}actionForKey(t){let e=this.controls?this.controls.indexOf(t):-1;return e>=0?ie[e]:null}setLocalActionForKey(t,e){let i=this.actionForKey(t);i&&this.setLocalAction(i,e)}main(){this.is_dead||(this.shouldFire()&&this.fire(),this.isActionActive("special")&&this.special(),this.bullets.forEach(t=>t.main()),this.handleMovement())}draw(){this.drawBullets(),this.drawBody()}drawBullets(){this.bullets.forEach(t=>t.draw())}drawBody(){if(!this.img){var t=document.getElementById("tank");t&&t.tagName==="IMG"&&t.complete&&t.naturalWidth>0&&(this.img=t)}if(c.save(),c.translate(this.x+this.width/2,this.y+this.height/2),c.rotate(this.rotation),this.img&&this.img.tagName==="IMG"&&this.img.complete&&this.img.naturalWidth>0){var e=c.imageSmoothingEnabled;c.imageSmoothingEnabled=!0,c.drawImage(this.img,-this.width/2,-this.height/2,this.width,this.height),c.imageSmoothingEnabled=e}else c.fillStyle=this.colour,c.fillRect(-this.width/2,-this.height/2,this.width,this.height);c.restore()}getPowerupState(){if(this.pendingPowerupUpdates){this.pendingPowerupUpdates=!1;var t=this.powerups.map(function(e){return e.name});return{tankId:this.id,powerups:t}}}shouldFire(){return this.isActionActive("fire")?this.hasFiredThisPress||this.bullets.length>=this.bullet_limit?!1:(this.hasFiredThisPress=!0,this.fireWasActive=!0,!0):(this.fireWasActive=!1,!1)}fire(){this.fireHelper(this.rotation,this.maze.settings.bullet_speed)}fireHelper(t,e){let i=_e(t,e),s=this.x+this.width/2,n=this.y+this.height/2,o=new Ve(this,[i.x,i.y],s,n);this.bullets.push(o)}fire_helper(t,e){this.fireHelper(t,e)}handleMovement(){if(this.isActionActive("right")&&(this.rotation+=this.rotation_speed),this.isActionActive("left")&&(this.rotation-=this.rotation_speed),this.isActionActive("up")){let t=_e(this.rotation,this.move_speed);this.tryMovingTo([this.x+t.x,this.y]),this.tryMovingTo([this.x,this.y+t.y])}if(this.isActionActive("down")){let t=_e(this.rotation,-this.move_speed);this.tryMovingTo([this.x+t.x,this.y]),this.tryMovingTo([this.x,this.y+t.y])}}tryMovingTo(t){if(this.maze.doesRectCollide([this.x,this.y,this.width,this.height])){let i=this.maze.getSquareAtXY([this.x,this.y]).getCenter();this.x=i[0],this.y=i[1]}if(!this.maze.doesRectCollide([t[0],t[1],this.width,this.height])){this.x=t[0],this.y=t[1];return}if(!this.maze.doesRectCollide([t[0],this.y,this.width,this.height])){this.x=t[0];return}if(!this.maze.doesRectCollide([this.x,t[1],this.width,this.height])){this.y=t[1];return}let e=this.maze.getSquareAtXY([this.x,this.y]).getCenter();this.x=e[0],this.y=e[1]}keyDownHandler(t){if(this.disableInput)return;let e=typeof t=="string"?t:t&&t.key;e&&this.setLocalActionForKey(e,!0)}keyUpHandler(t){if(this.disableInput)return;let e=typeof t=="string"?t:t&&t.key;e&&this.setLocalActionForKey(e,!1)}loadImage(t){this.img=t}originalMovement(){let t=this.move_speed;this.upPressed&&this.tryMovingTo([this.x,this.y-t]),this.rightPressed&&this.tryMovingTo([this.x+t,this.y]),this.downPressed&&this.tryMovingTo([this.x,this.y+t]),this.leftPressed&&this.tryMovingTo([this.x-t,this.y])}onBulletHit(){this.destroy()}destroy(){this.disableInput||xe.unregisterTank(this),this.is_dead=!0,this.maze.tankDestroyed()}restart(){this.disableInput||xe.registerTank(this),this.is_dead=!1;let t=this.maze.getRandomSquare().getCenter();this.x=t[0],this.y=t[1],this.bullets=[],this.fireWasActive=!1,this.localInput=ee(),this.networkInput=ee(),this.syncDerivedInput(),this.removeAllPowerups()}addPowerup(t){this.removeAllPowerups(),this.powerups.push(t),t.effect(this),this.pendingPowerupUpdates=!0}removePowerup(t){let e=this.powerups.indexOf(t);if(e!==-1){try{t&&t.timeout&&(clearTimeout(t.timeout),t.timeout=null)}catch{}t.undo(this),typeof t.notifyDeactivate=="function"&&t.notifyDeactivate(this),this.powerups.splice(e,1),this.pendingPowerupUpdates=!0}}removeAllPowerups(){this.powerups.slice().forEach(t=>{t.tank.removePowerup(t)})}removeBullet(t){Ke(t,this.bullets)}},ke=be,xe=(function(){let r=new Map,t=new Set,e=!1;function i(){e||(document.addEventListener("keydown",n,!0),document.addEventListener("keyup",o,!0),e=!0)}function s(){!e||t.size>0||(document.removeEventListener("keydown",n,!0),document.removeEventListener("keyup",o,!0),e=!1)}function n(h){let u=r.get(h.key);u&&(u.forEach(({tank:f,action:d})=>{f.setLocalAction(d,!0)}),h.key.startsWith("Arrow")&&h.preventDefault())}function o(h){let u=r.get(h.key);u&&u.forEach(({tank:f,action:d})=>{f.setLocalAction(d,!1)})}function a(h){!h||h.disableInput||(l(h),i(),h.controls.forEach((u,f)=>{if(!u)return;let d=ie[f];if(!d)return;let p={tank:h,action:d};r.has(u)||r.set(u,[]),r.get(u).push(p)}),t.add(h))}function l(h){h&&(r.forEach((u,f)=>{let d=u.filter(p=>p.tank!==h);d.length>0?r.set(f,d):r.delete(f)}),t.delete(h),s())}return{registerTank:a,unregisterTank:l}})();var nt=null,X=null,kt=null;function Wt(){nt||(nt=document.getElementById("pregame-overlay")),X||(X=document.getElementById("pregame-inner"))}function Pt(r){Wt(),nt&&(nt.classList.toggle("hidden",!r),r&&Mt())}function Mt(){if(Wt(),!nt||!X)return;let r=b.getBoundingClientRect();nt.style.left=Math.round(r.left)+"px",nt.style.top=Math.round(r.top)+"px",nt.style.width=Math.round(r.width)+"px",nt.style.height=Math.round(r.height)+"px",X.style.width=G+"px",X.style.height=R+"px";let t=r.width/G,e=r.height/R;X.style.transform="scale("+t+","+e+")"}function as(r){document.addEventListener("keydown",function(e){if(!kt)return;e.stopPropagation(),e.preventDefault();let i=e.key;try{kt.button.value=i,kt.node&&(kt.node.textContent=kt.button.text+(kt.button.value||"")),r&&typeof r.emitTankConfig=="function"&&r.emitTankConfig()}catch{}kt=null},!0)}function qe(){if(Wt(),!!X)for(;X.firstChild;)X.removeChild(X.firstChild)}function Pe({x:r,y:t,width:e,height:i,colour:s,borders:n}){let o=document.createElement("div");o.className="pg-panel",o.style.left=r+"px",o.style.top=t+"px",o.style.width=e+"px",o.style.height=i+"px";let a=document.createElement("div");return a.className="pg-panel-inner",a.setAttribute("data-inset",""),a.style.setProperty("--pg-inset-n",(n.north||0)+"px"),a.style.setProperty("--pg-inset-e",(n.east||0)+"px"),a.style.setProperty("--pg-inset-s",(n.south||0)+"px"),a.style.setProperty("--pg-inset-w",(n.west||0)+"px"),o.appendChild(a),X.appendChild(o),{outer:o,inner:a}}function Tt(r){if(Wt(),!nt||!X)return;as(r),qe();let t=r.start_panel,e=Math.floor(G/5),i=Pe({x:0,y:0,width:e,height:R,colour:t.colour,borders:{north:t.north_border,east:t.east_border,south:t.south_border,west:t.west_border}}),s=(a,l,h)=>{let u=document.createElement("button");u.className="pg-btn";let f=Math.floor(e/2);return u.style.width=f+"px",u.style.left=Math.floor(e/2-f/2)+"px",u.style.top=Math.floor(l)+"px",u.textContent=a,u.addEventListener("click",h),i.inner.appendChild(u),u};s("Start",R*9/20,()=>{t&&typeof t.start=="function"&&t.start.call(r)}),s("Add Tank",R*11/20,()=>{let a=r.tank_panels.length,l=r.colour_templates[a%r.colour_templates.length]||"#63C132",h=r.controls_templates[a%r.controls_templates.length]||["ArrowUp","ArrowRight","ArrowDown","ArrowLeft","1","2"];r.addTankPanel(new zt(r,l,h)),Mt(),Tt(r)}),s("Settings",R*13/20,()=>{r.showSettingsPanel()}),s("Networking",R*15/20,()=>{r&&r.game&&r.game.networking&&r.game.networking.showConnectOverlay&&r.game.networking.showConnectOverlay()});let n=r.tank_panels.length,o=n>0?(G-e)/n:0;for(let a=0;a<n;a++){let l=r.tank_panels[a],h=e+Math.floor(a*o),u={north:l.north_border,east:l.east_border,south:l.south_border,west:l.west_border},f=Pe({x:h,y:0,width:Math.floor(o),height:R,colour:l.colour,borders:u}),d=["up","right","down","left","attack","special"];for(let v=0;v<d.length;v++){let _=l.buttons[1+v],w=document.createElement("div");w.className="pg-label";let m=Math.floor(o/2);w.style.width=m+"px",w.style.left=Math.floor(o/2-m/2)+"px",w.style.top=Math.floor(R*(3+v)/12)+"px";let S=_&&_.text?_.text.toString()+(_.value||""):d[v]+": ";w.textContent=S,w.title="Click, then press a key",w.addEventListener("click",function(P){P.stopPropagation(),P.preventDefault(),kt={panel:l,button:_,node:w}}),f.inner.appendChild(w)}let p=document.createElement("button");p.className="pg-btn";let g=Math.floor(o/2);p.style.width=g+"px",p.style.left=Math.floor(o/2-g/2)+"px",p.style.top=Math.floor(R*10/12)+"px",p.textContent="delete",p.addEventListener("click",function(){r.removeTankPanel(l),Mt(),Tt(r)}),f.inner.appendChild(p)}}function Xe(r){if(Wt(),!nt||!X)return;qe();let t=r.settings,e=Pe({x:0,y:0,width:G,height:R,colour:t.colour,borders:{north:t.north_border,east:t.east_border,south:t.south_border,west:t.west_border}}),i=t.buttons.length;for(let o=0;o<i;o++){let a=t.buttons[o];if(!a||a===t.back)continue;let l=document.createElement("div");l.className="pg-setting";let h=Math.floor(G/1.5);l.style.width=h+"px",l.style.left=Math.floor(G/2-h/2)+"px",l.style.top=Math.floor(a.y)+"px";let u=document.createElement("span");u.textContent=a.text||"";let f=document.createElement("input");(a.text||"").toLowerCase().indexOf("friendly fire")!==-1?(f.type="text",f.value=(a.value||"").toString()||"false",f.readOnly=!0,l.style.cursor="pointer",l.addEventListener("click",function(){f.value=f.value==="true"?"false":"true",a.value=f.value})):(f.type="text",f.value=(a.value||"").toString(),f.addEventListener("click",d=>{d.stopPropagation()}),f.addEventListener("input",function(){a.value=f.value}),f.addEventListener("keydown",function(d){d.stopPropagation()})),l.appendChild(u),l.appendChild(f),e.inner.appendChild(l)}let s=document.createElement("button");s.className="pg-btn";let n=Math.floor(G/2);s.style.width=n+"px",s.style.left=Math.floor(G/2-n/2)+"px",s.style.top=Math.floor(R*5/6)+"px",s.textContent=t&&t.back&&t.back.text?t.back.text:"Back",s.addEventListener("click",function(){if(!t.save()){s.textContent=t&&t.back&&t.back.text?t.back.text:"Back";return}r.showMainPanels()}),e.inner.appendChild(s)}window.addEventListener("resize",Mt);var Ie=class extends Nt{constructor(t,e){super(t),this.pregame=e,this.west_border=5,this.east_border=5;var i=new rt(this,0,0,"Start");i.onclick=this.start.bind(this.pregame),i.center_horizontally(),i.y=b.height*9/20,this.addButton(i);var s=new rt(this,0,0,"Add Tank");s.onclick=function(){var a=this.panel.pregame,l=a.tank_panels.length;a.addTankPanel(new zt(a,a.colour_templates[l],a.controls_templates[l]))},s.y=b.height*11/20,s.center_horizontally(),this.addButton(s);var n=new rt(this,0,0,"Settings");n.onclick=function(){this.pregame.showSettingsPanel()}.bind(this),n.y=b.height*13/20,n.center_horizontally(),this.addButton(n);var o=new rt(this,0,0,"Networking");o.onclick=function(){this.pregame.game&&this.pregame.game.networking&&(this.pregame.game.networking.showConnectOverlay(),y&&typeof y.emitPlayerList=="function"&&y.emitPlayerList())}.bind(this),o.y=b.height*15/20,o.center_horizontally(),this.addButton(o)}start(){if(this.pregame&&this.pregame.game&&this.pregame.game.networking)try{this.pregame.game.networking.disableOverlay()}catch{}if(y&&y.connections&&y.connections.length>0&&!y.isHost){Z("* Only the host can start the match.","notification-message");return}var t=this.game.maze;this.game.main_object=t,typeof t.beginGameplay=="function"&&t.beginGameplay();try{Et(!0),Ct()}catch{}try{Pt(!1)}catch{}t.hostOwned=!0;for(var e=[],i=y&&y.id?y.id:"local",s=0;s<this.tank_panels.length;s++){var n=this.tank_panels[s],o=n.buttons,a=[o[1].value,o[2].value,o[3].value,o[4].value,o[5].value,o[6].value],l=t.getRandomSquare().getCenter(),h=new ke(0,0,t,a,n.colour);h.id=i+"-"+(n.panelId||"tank-"+s),h.ownerPeerId=i;var u=document.getElementById("tank");u&&u.tagName==="IMG"&&u.complete&&u.naturalWidth>0&&h.loadImage(u),t.registerTank&&t.registerTank(h),t.placeObject(h),e.push({id:h.id,colour:h.colour,controls:a,ownerPeerId:i,score:h.score,x:h.x,y:h.y,rotation:h.rotation,width:h.width,height:h.height})}if(y&&y.isHost){var f=y.remoteTankConfigs||{};Object.keys(f).forEach(function(d){!f[d]||f[d].length===0||d!==i&&f[d].forEach(function(p,g){var v=p.controls&&p.controls.length?p.controls:["w","d","s","a","f","g"],_=new ke(0,0,t,v,p.colour||"#cccccc",{disableInput:!0});_.id=d+"-"+(p.panelId||"tank-"+g),_.ownerPeerId=d,_.score=p.score||0;var w=document.getElementById("tank");w&&_.loadImage(w),t.registerTank&&t.registerTank(_),t.placeObject(_),e.push({id:_.id,colour:_.colour,controls:v,ownerPeerId:d,score:_.score,x:_.x,y:_.y,rotation:_.rotation,width:_.width,height:_.height})})})}if(y&&y.isHost&&y.connections&&y.connections.length>0){if(typeof t.serializeInitString=="function")try{y.broadcast(t.serializeInitString())}catch{}y.maybeEmitReady&&y.maybeEmitReady("host-start")}}},Je=Ie;var Se=class extends Lt{constructor(t,e,i,s,n="",o){super(t,e,i,s,n),this.attribute_name=o;var a=this.panel.pregame.game,l=a.maze&&a.maze.settings?a.maze.settings:{};this.value=(o in l?l[o]:"").toString()}keyDownHandler(t){if(t=="Backspace"){this.value=this.value.slice(0,-1);return}if(t=="Enter"){this.panel.pregame.focus=this.panel.back;return}this.value+=t}onclick(){this.panel.pregame.focus=this,this.value=""}fill_text(){var t=this.value?this.text.toString()+this.value.toString():this.text.toString();c.fillText(t,this.x+this.width/2,this.y+this.height/1.5)}},Qe=Se;var Be=class extends Nt{constructor(t){super("Green"),this.width=b.width,this.pregame=t,this.settings=[["Number of Rows","num_of_rows"],["Number of Columns","num_of_columns"],["Movement Speed","move_speed"],["Friendly Fire","friendly_fire"],["Number of Bullets","bullet_limit"],["Time Between Powerups (s)","powerup_interval"],["Max powerups on screen","powerup_limit"],["Duration of powerups (s)","powerup_duration"]],this.settings.forEach(function(n){this.make_button(n)}.bind(this)),this.addBackButton();for(var e=this.buttons.length,i=0;i<e;i++){var s=this.buttons[i];s.y=b.height*4/5/(e-1)*i+s.height,s.resize_horiontals()}}addBackButton(){var t=new rt(this,0,0,"Back");this.back=t,t.y=b.height*5/6,t.update(),t.onclick=function(){var e=this.save();e&&this.pregame.showMainPanels()}.bind(this),t.keyDownHandler=function(e){e=="Enter"&&this.panel.pregame.focus==this&&this.onclick()},this.addButton(t)}save(){for(var t=this.back,e=[0,1,4,6],i=[2,5,7],s=0;s<e.length;s++){var n=this.buttons[e[s]];if(!this.isPosInt(n.value))return t.text="x must be positive Integer".replace("x",n.text).replace(":",""),!1;var o=n.panel.pregame.game,a=n.attribute_name,l=n.value,h=["num_of_rows","num_of_columns","bullet_limit","powerup_limit","seconds_between_rounds"],u=["move_speed","rotation_speed","bullet_speed","powerup_interval","powerup_duration"],f=l;h.indexOf(a)!==-1&&(f=parseInt(l,10)),u.indexOf(a)!==-1&&(f=parseFloat(l)),o.maze.settings[a]=f}for(var s=0;s<i.length;s++){var n=this.buttons[i[s]];if(!this.isPosNumber(n.value))return t.text="x must be positive Integer".replace("x",n.text).replace(":",""),!1}var d=this.buttons[3];this.pregame.game.maze.settings.friendly_fire=d.value=="true",this.pregame.showMainPanels(),t.text="Back"}isPosInt(t){if(isNaN(t))return!1;var e=parseFloat(t);return!(!Number.isInteger(e)||e<0)}isPosNumber(t){if(isNaN(t))return!1;var e=parseFloat(t);return!(e<=0)}make_button(t){var e=t[0],i=t[1];this[i]=new Qe(this,0,0,e,"",i),t[0]=="Friendly Fire"&&(this[i].onclick=function(){this.panel.pregame.focus=this,this.value=="true"?this.value="false":this.value="true"})}},Ze=Be;var se=class{constructor(t,e){this.game=t,this.height=b.height,this.width=b.width,this.root=new Ut({x:0,y:0,width:this.width,height:this.height}),this.focus=null,this.start_panel=new Je("red",this),this.tank_panels=[],this.settings=new Ze(this),this.current_panels=[],this.colour_templates=["#63C132","#FFAD69","#54F2F2","#D90429","#04A777","#042A2B","#6D98BA","#D3B99F","#1E3888","#1282A2","#D90368"],this.controls_templates=[["ArrowUp","ArrowRight","ArrowDown","ArrowLeft","1","2"],["w","d","s","a","f","g"],["y","j","h","g","k","l"]],this.showMainPanels(),this.updatePanelHorizontals(),this.ensureDefaultTank();try{Pt(!0),Mt(),Tt(this)}catch{}}main(){try{Mt()}catch{}}draw(){}syncRootWithPanels(t){this.current_panels=t,this.root.setChildren(t)}showMainPanels(){this.focus=null,this.syncRootWithPanels([this.start_panel].concat(this.tank_panels));try{Pt(!0),Tt(this)}catch{}}showSettingsPanel(){this.focus=null,this.syncRootWithPanels([this.settings]);try{Pt(!0),Xe(this)}catch{}}addTankPanel(t){this.tank_panels.push(t),this.showMainPanels(),this.updatePanelHorizontals(),this.emitTankConfig();try{Tt(this)}catch{}}removeTankPanel(t){this.tank_panels.splice(this.tank_panels.indexOf(t),1),this.showMainPanels(),this.updatePanelHorizontals(),this.emitTankConfig();try{Tt(this)}catch{}}updatePanelHorizontals(){for(var t=(b.width-this.start_panel.width)/this.tank_panels.length,e=0;e<this.tank_panels.length;e++){var i=this.tank_panels[e];i.x=this.start_panel.width+e*t,i.width=t,i.buttons.forEach(function(s){s.update()}),i.east_border=5/2}this.tank_panels.length>0&&(this.tank_panels[this.tank_panels.length-1].east_border=5)}onclick(t,e){this.button_has_been_found=!1;for(var i=this.current_panels||[],s=0;s<i.length&&!this.button_has_been_found;s++)for(var n=i[s],o=n.buttons||[],a=0;a<o.length&&!this.button_has_been_found;a++){var l=o[a],h=[t,e,1,1],u=l.get_as_Rect?l.get_as_Rect():[l.x,l.y,l.width,l.height],f=typeof vt=="function"?vt(h,u):t>=l.x&&e>=l.y&&t<=l.x+l.width&&e<=l.y+l.height;f&&(this.button_has_been_found=!0,typeof l.onclick=="function"&&l.onclick())}}keyDownHandler(t){this.focus!=null&&this.focus.keyDownHandler(t)}emitTankConfig(){if(typeof y.sendTankConfig=="function"){var t=this.getTankPanelConfigs();y.sendTankConfig(t)}}getTankPanelConfigs(){return this.tank_panels.map(function(t,e){var i=t.buttons.filter(function(s){return s instanceof Lt}).map(function(s){return s.value||""});return{panelId:t.panelId||"panel-"+e,colour:t.colour,controls:i}})}ensureDefaultTank(){if(this.tank_panels.length===0){var t=this.colour_templates[0]||"#63C132",e=this.controls_templates[0]||["ArrowUp","ArrowRight","ArrowDown","ArrowLeft","1","2"];this.addTankPanel(new zt(this,t,e))}}};var re=class{constructor(){this.maze=new te(this);try{window.__mazeRef=this.maze}catch{}this.pregame=new se(this,b.height*3/4),this.networking=new q(this),this.main_object=this.pregame,this.clientControlMap={},this.clientInputState={},this.clientInputHandlers=null,this.clientInputBound=!1;try{Et(!1)}catch{}try{je()}catch{}}main(){this.main_object.main()}onclick(t,e){this.main_object.onclick(t,e)}keyDownHandler(t){this.main_object.keyDownHandler(t)}startFromHostCompact(t){this.pregame.focus=null,this.networking&&this.networking.hideOverlay(),this.maze&&typeof this.maze.applyInitString=="function"&&this.maze.applyInitString(t);try{c.setTransform(1,0,0,1,0,0),c.clearRect(0,0,b.width,b.height)}catch{}this.maze.spectator=!0,this.main_object=this.maze,this.maze.beginGameplay&&this.maze.beginGameplay();try{Et(!0),Ct(),Pt(!1)}catch{}this.setupClientControllers({tanks:this.maze.remoteTankMeta})}updateStateFromHostCompact(t){!t||!this.maze||typeof this.maze.applyDeltaString!="function"||this.maze.applyDeltaString(t)}setupClientControllers(t){this.unregisterClientInputRelay(),this.clientControlMap={},this.clientInputState={};var e=y;if(!e||e.isHost||!e.id){this.clientInputBound=!1;return}for(var i=e.id,s=t&&t.tanks?t.tanks:[],n=[{action:"up",payloadKey:"upPressed"},{action:"right",payloadKey:"rightPressed"},{action:"down",payloadKey:"downPressed"},{action:"left",payloadKey:"leftPressed"},{action:"fire",payloadKey:"shooting"},{action:"special",payloadKey:"specialKeyPressed"}],o=!1,a=e&&e.localTankConfigs?e.localTankConfigs.slice():[],l=new Set,h=0;h<s.length;h++){var u=s[h],f=u&&u.ownerPeerId?u.ownerPeerId:null;if(!f&&u&&u.id&&i&&u.id.indexOf(i+"-")===0&&(f=i),f===i){o=!0,this.clientInputState[u.id]={upPressed:!1,rightPressed:!1,downPressed:!1,leftPressed:!1,shooting:!1,specialKeyPressed:!1};var d=Array.isArray(u.controls)?u.controls.slice():null;if(!d||d.length===0){for(var p=u&&u.id?u.id.substring((i+"-").length):"",g=-1,v=0;v<a.length;v++){var _=a[v];if(!l.has(v)&&_&&_.panelId&&p&&_.panelId===p){g=v;break}}if(g===-1){for(var w=0;w<a.length;w++)if(!l.has(w)){g=w;break}}g>=0&&a[g]&&Array.isArray(a[g].controls)&&(d=a[g].controls.slice(),l.add(g))}d=Array.isArray(d)?d:[];for(var m=0;m<d.length&&m<n.length;m++){var S=d[m];S&&(this.clientControlMap[S]={tankId:u.id,action:n[m].action,payloadKey:n[m].payloadKey})}}}o?this.registerClientInputRelay():this.clientInputBound=!1}registerClientInputRelay(){this.clientInputBound||(this.clientInputHandlers={keydown:this.handleClientKeyDown.bind(this),keyup:this.handleClientKeyUp.bind(this)},document.addEventListener("keydown",this.clientInputHandlers.keydown,!0),document.addEventListener("keyup",this.clientInputHandlers.keyup,!0),this.clientInputBound=!0)}unregisterClientInputRelay(){!this.clientInputBound||!this.clientInputHandlers||(document.removeEventListener("keydown",this.clientInputHandlers.keydown,!0),document.removeEventListener("keyup",this.clientInputHandlers.keyup,!0),this.clientInputHandlers=null,this.clientInputBound=!1)}handleClientKeyDown(t){var e=y;if(!(!e||e.isHost)){var i=this.clientControlMap[t.key];if(i){var s=this.clientInputState[i.tankId];if(s){var n=this.setInputStateFlag(s,i.payloadKey,!0);n&&this.queueInputSend(i.tankId),t.key.indexOf("Arrow")===0&&t.preventDefault()}}}}handleClientKeyUp(t){var e=y;if(!(!e||e.isHost)){var i=this.clientControlMap[t.key];if(i){var s=this.clientInputState[i.tankId];if(s){var n=this.setInputStateFlag(s,i.payloadKey,!1);n&&this.queueInputSend(i.tankId)}}}}setInputStateFlag(t,e,i){return t[e]===i?!1:(t[e]=i,!0)}queueInputSend(t){var e=y;if(!(!e||!e.sendInputState)){var i=this.clientInputState[t];i&&e.sendInputState({tankId:t,upPressed:!!i.upPressed,downPressed:!!i.downPressed,leftPressed:!!i.leftPressed,rightPressed:!!i.rightPressed,shooting:!!i.shooting,specialKeyPressed:!!i.specialKeyPressed})}}};var Ht=new re;y.game=Ht;function $e(){Ht.main_object!==Ht.maze&&(c.setTransform(1,0,0,1,0,0),c.clearRect(0,0,b.width,b.height)),Ht.main(),requestAnimationFrame($e)}function hs(){Kt(),b.addEventListener("click",function(r){let t=b.getBoundingClientRect(),e=G/t.width,i=R/t.height,s=(r.clientX-t.left)*e,n=(r.clientY-t.top)*i;Ht.onclick(s,n)},!1),addEventListener("keydown",function(r){Ht.keyDownHandler(r.key)},!1),$e()}hs();})();
//# sourceMappingURL=bundle.js.map
