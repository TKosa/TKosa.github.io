(()=>{var oe=class{constructor(){this.eventHandlers={}}on(t,e){this.eventHandlers[t]||(this.eventHandlers[t]=[]),this.eventHandlers[t].push(e)}emit(t,...e){let i=this.eventHandlers[t];!i||i.length===0||i.forEach(r=>{try{r.apply(null,e)}catch{}})}},B=new oe;var S=document.getElementById("myCanvas"),u=S.getContext("2d");u.imageSmoothingEnabled=!1;u.mozImageSmoothingEnabled=!1;u.webkitImageSmoothingEnabled=!1;u.msImageSmoothingEnabled=!1;var he=1280,le=720;S.width=he;S.height=le;function Et(s){let t=document.getElementById("hud-scoreboard");t&&t.classList.toggle("hidden",!s)}function Bt(){let s=document.getElementById("hud-scoreboard");if(!s)return;let t=S.getBoundingClientRect(),e=Math.round(t.height*.2);s.style.left=Math.round(t.left)+"px",s.style.top=Math.round(t.top)+"px",s.style.width=Math.round(t.width)+"px",s.style.height=e+"px"}window.addEventListener("resize",()=>{try{Bt()}catch{}});var Ye=!1;function Ke(){Ye||(document.addEventListener("click",function(s){if(!(s.target&&s.target.closest?s.target.closest(".sb-network"):null))return;s.stopPropagation(),s.preventDefault();let e=document.getElementById("net-stats-overlay");e&&e.classList.toggle("hidden")},!0),document.addEventListener("click",function(s){if(s.target&&s.target.closest&&s.target.closest(".sb-test")){s.stopPropagation(),s.preventDefault();try{window.__mazeRef&&typeof window.__mazeRef.testFlattenAndRegen=="function"&&window.__mazeRef.testFlattenAndRegen()}catch{}}},!0),Ye=!0)}function Ve(s){return!!(s&&s.tagName==="IMG"&&s.complete&&s.naturalWidth>0)}var it=class{constructor(t,e=0,i=0){this.x=e,this.y=i,this.width=20,this.height=20,this.maze=t,this.delegate=null,this._handled=!1,t&&typeof t.nextPowerupId=="number"?this.id=t.nextPowerupId++:this.id=this.id||0}getMessage(){return this.name}draw(){if(Ve(this.img)){var t=u.imageSmoothingEnabled;u.imageSmoothingEnabled=!0,u.drawImage(this.img,this.x,this.y,this.width,this.height),u.imageSmoothingEnabled=t;return}u.lineWidth=1,u.strokeStyle=this.color,u.strokeRect(this.x,this.y,this.width,this.width)}onBulletHit(t){this.pickup(t)}pickup(t){if(!this.maze)return!1;var e=null;if(typeof t=="string"){var i=t;if(Array.isArray(this.maze.tanks)){for(var r=0;r<this.maze.tanks.length;r++)if(this.maze.tanks[r]&&this.maze.tanks[r].id===i){e=this.maze.tanks[r];break}}}else e=t;if(!e||this._handled)return!1;this._handled=!0;try{this.maze.removePowerup(this)}catch{}this.tank=e;try{e.removeAllPowerups()}catch{}try{e.addPowerup(this)}catch{}try{this.timeout=setTimeout(this.teardown.bind(this),this.maze.settings.powerup_duration*1e3)}catch{}try{this.notifyActivate(e)}catch{}try{this.maze.drawScoreboardTop&&this.maze.drawScoreboardTop()}catch{}return!0}teardown(){try{this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.tank&&this.tank.removePowerup(this),this.maze&&this.maze.drawScoreboardTop&&this.maze.drawScoreboardTop()}catch{}}registerDelegate(t){this.delegate=t}broadcast(t){typeof this.delegate=="function"&&this.delegate(t)}getTargetType(){return"tank"}serialize(){return{name:this.name,type:this.constructor&&this.constructor.name?this.constructor.name:this.name,spriteId:this.img&&this.img.id?this.img.id:null}}notifyActivate(t){this.emitEvent("activate",t)}notifyDeactivate(t){this.emitEvent("deactivate",t)}emitEvent(t,e){let i={type:"powerup",status:t,powerup:this.constructor&&this.constructor.name?this.constructor.name:this.name,target:this.getTargetType()};e&&(i.tankId=e.id,i.peerId=e.ownerPeerId),this.id&&(i.powerupId=this.id),this.broadcast(i);try{var r=["X",i.powerup,t,i.target||"",i.tankId||"",this.id||""];g.broadcast(r.join(","))}catch{}}},Yt=class extends it{constructor(t,e,i){super(t,e,i),this.name="Trippy",this.color="green",this.img=document.getElementById("pills")}effect(t){typeof this.maze.trippyCount!="number"&&(this.maze.trippyCount=0),this.maze.trippyCount+=1}undo(t){typeof this.maze.trippyCount!="number"&&(this.maze.trippyCount=0),this.maze.trippyCount=Math.max(0,(this.maze.trippyCount||0)-1)}getTargetType(){return"global"}};function de(s,t){var e=String(s||"");try{if(/Trippy/i.test(e))return new Yt(t);if(/Remove\s*Bullet\s*Limit|RemoveBulletLimit/i.test(e))return new Kt(t);if(/Triple\s*-?Shot|TripleShot/i.test(e))return new Vt(t);if(/MoveThroughWalls|ghost/i.test(e))return new Rt(t);if(/Teleport/i.test(e))return new qt(t);if(/Cannon(ball)?/i.test(e))return new Xt(t);if(/Invis/i.test(e))return new ce(t);if(/Shinra/i.test(e))return new Jt(t);if(/Hex/i.test(e))return new ue(t)}catch{}return null}var Kt=class extends it{constructor(t,e,i){super(t,e,i),this.name="Remove Bullet Limit",this.color="orange",this.img=document.getElementById("unlimited")}effect(t){t.shouldFire=function(){return!!this.shooting}}undo(t){t.shouldFire=function(){return!!(this.shooting&&this.bullets.length<this.bullet_limit)}}},Vt=class extends it{constructor(t,e,i){super(t,e,i),this.name="Triple-Shot",this.color="red",this.img=document.getElementById("tripleshot")}effect(t){t.fire=function(){this.fire_helper(this.rotation,this.maze.settings.bullet_speed),this.fire_helper(this.rotation-Math.PI/12,this.maze.settings.bullet_speed),this.fire_helper(this.rotation+Math.PI/12,this.maze.settings.bullet_speed)},t.bullet_limit=3*this.maze.settings.bullet_limit}undo(t){t.fire=function(){this.fire_helper(this.rotation,this.maze.settings.bullet_speed)},t.bullet_limit=this.maze.settings.bullet_limit}},Rt=class extends it{constructor(t,e,i){super(t,e,i),this.name="ghost",this.color="blue",this.img=document.getElementById("ghost")}effect(t){t.tryMovingTo=function(e){var i=e[0],r=e[1];this.maze.isOutOfBounds([i,r])||(this.x=i,this.y=r)}}undo(t){if(t.tryMovingTo=function(r){var n=r[0],a=r[1];this.maze.doesRectCollide([n,a,this.width,this.height])||(this.x=n,this.y=a)},t.maze.doesRectCollide([t.x,t.y,t.width,t.height])){var e=t.maze.getSquareAtXY([t.x,t.y]);if(e){var i=e.getCenter();t.x=i[0],t.y=i[1]}}}},qt=class extends it{constructor(t,e,i){super(t,e,i),this.name="Teleport",this.color="cyan",this.img=document.getElementById("teleport")}effect(t){this.draw_mirror=function(){u.save(),u.translate(S.width-(this.x+this.width/2),this.maze.height-(this.y+this.height/2)),u.rotate(this.rotation||0);var e=u.globalAlpha;u.globalAlpha=.3;var i=document.getElementById("tank");if(Ve(i)){var r=u.imageSmoothingEnabled;u.imageSmoothingEnabled=!0,u.drawImage(i,-this.width/2,-this.height/2,this.width,this.height),u.imageSmoothingEnabled=r}else u.fillStyle=this.colour,u.fillRect(-this.width/2,-this.height/2,this.width,this.height);u.globalAlpha=e,u.restore()}.bind(t);try{this.draw_mirror.__tp_tankId=t.id}catch{}t.maze.extraFunctionsPerCycle.push(this.draw_mirror),t.maze.teleportMirrors[t.id]=!0,t.special=function(){if(this.poweruplock!=!0){this.x=S.width-this.x-this.width,this.y=this.maze.height-this.y-this.height,this.tryMovingTo([this.x,this.y]);try{if(g&&g.isHost&&this.maze.doesRectCollide([this.x,this.y,this.width,this.height])){var e=this.maze.getSquareAtXY([this.x,this.y]);if(e){var i=e.getCenter();this.x=i[0],this.y=i[1]}}}catch{}this.poweruplock=!0}}}undo(t){try{removeElementFromArray(this.draw_mirror,t.maze.extraFunctionsPerCycle);var e=t.maze.extraFunctionsPerCycle;if(Array.isArray(e))for(var i=e.length-1;i>=0;i--){var r=e[i];r&&r.__tp_tankId&&r.__tp_tankId===t.id&&e.splice(i,1)}}catch{}try{delete t.maze.teleportMirrors[t.id]}catch{}if(t.special=function(){},t.poweruplock=!1,t.maze.doesRectCollide([t.x,t.y,t.width,t.height])){var n=t.maze.getSquareAtXY([t.x,t.y]);if(n){var a=n.getCenter();t.x=a[0],t.y=a[1]}}}},Xt=class extends it{constructor(t,e,i){super(t,e,i),this.name="CannonBall",this.color="grey",this.img=document.getElementById("cannonball")}onBulletHit(t){super.onBulletHit(t),this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}effect(t){t.special=function(){this.fire();var e=this.bullets[this.bullets.length-1];e.radius=50;var i=2;e.direction[0]*=i,e.direction[1]*=i,e.handleMovement=function(){this.x+=this.direction[0],this.y+=this.direction[1],(this.x>S.width+this.radius||this.x<0-this.radius||this.y>this.tank.maze.height+this.radius||this.y<0-this.radius)&&this.tank.removeBullet(this)},this.special=function(){},this.removeAllPowerups()}}undo(t){t.special=function(){}}},ce=class extends it{constructor(t,e,i){super(t,e,i),this.name="Invisibility",this.color="grey",this.img=document.getElementById("invisible")}effect(t){t.old_draw=t.draw,t.draw=function(){this.bullets.forEach(function(e){e.draw()})},t.special=t.old_draw}undo(t){t.draw=t.old_draw}},Jt=class s extends it{constructor(t,e,i){super(t,e,i),this.name="Shinra Tensei",this.color="purple",this.img=document.getElementById("repel")}effect(t){t.special=function(){this.maze.tanks.forEach(function(e){s.repelTank(this,e),e.bullets.forEach(function(i){s.repelBullet(this,i)}.bind(this))}.bind(this))}}undo(t){t.special=function(){}}static repelTank(t,e){if(t!=e){var i=e.x-t.x,r=e.y-t.y,n=Math.sqrt(i*i+r*r)||1,a=2,o=i/n,h=r/n;e.tryMovingTo([e.x+o*a,e.y+h*a])}}static repelBullet(t,e){var i=e.x-t.x,r=e.y-t.y,n=Math.sqrt(i*i+r*r)||1,a=i/n,o=r/n,h=.5,l=e.direction[0]+a*h,c=e.direction[1]+o*h,p=t&&t.maze&&t.maze.settings&&t.maze.settings.bullet_speed?t.maze.settings.bullet_speed:3,d=Math.sqrt(l*l+c*c);if(d>p){var f=p/d;l*=f,c*=f}e.direction[0]=l,e.direction[1]=c}},ue=class extends it{constructor(t,e,i){super(t,e,i),this.name="Hex",this.color="purple",this.img=document.getElementById("hex")}effect(t){t.maze.tanks.forEach(function(e){[e.onLeftPress,e.onRightPress]=[e.onRightPress,e.onLeftPress],[e.onUpPress,e.onDownPress]=[e.onDownPress,e.onUpPress]})}undo(t){this.effect(t)}};function fe(s){switch(Math.floor(8*Math.random())){case 0:return new Yt(s);case 1:return new Kt(s);case 2:return new Vt(s);case 3:return new Rt(s);case 4:return new qt(s);case 5:return new Xt(s);case 6:return new Jt(s);case 7:return new Rt(s)}}var W={},E=W;W.encodeFreeText=function(s){return(""+(s??"")).replace(/,/g,"\xB7").replace(/[|;]/g,"/")};W.decodeFreeText=function(s){return(""+(s??"")).replace(/Â·/g,",")};W.buildCompactPlayerList=function(s){var t=(s||[]).map(function(e){var i=e&&e.id?e.id:"",r=e&&e.nickname?W.encodeFreeText(e.nickname):"Player";return i+"|"+r}).join(";");return"P,"+t};W.handlePeerMessage=function(s,t,e){if(t=N&&N.hydrate?N.hydrate(t,s,e):t,t!=null&&!(typeof t!="string"||!t.length)){var i=t[0];switch(i){case"U":{if(!s.isHost&&s.game&&s.game.maze&&typeof s.game.maze.applyUnifiedSnapshot=="function")try{s.game.maze.applyUnifiedSnapshot(t.substring(2))}catch{}return}case"S":{if(s.isHost)return;try{if(!s.game||!s.game.maze)return;var r=s.game.maze,n=t.substring(2)||"";if(!n)return;var a=n.split("|"),o=a[0]||"",h=parseInt(a[1]||"0",10)||0,l=parseInt(a[2]||"0",10)||0,c=parseInt(a[3]||"0",10)||0,p=parseInt(a[4]||"20",10)||20,d=parseInt(a[5]||"20",10)||20,f=a[6]||"",y=a[7]||"";r.remotePowerups||(r.remotePowerups=[]),r.remotePowerups.push({id:h,type:o,name:o,x:l,y:c,width:p,height:d,spriteId:f,color:y}),r.remoteState={tanks:r.remoteTankMeta,powerups:r.remotePowerups}}catch{}return}case"Q":{if(s.isHost)try{var m=parseInt(t.substring(2),10)||0;e&&e.send&&e.send(N.buildPong(m))}catch{}return}case"q":{if(!s.isHost)try{var w=parseInt(t.substring(2),10)>>>0,_=Math.floor(performance.now()),v=_>>>0,b=v-w>>>0;b<=3e4&&(s._stats.rttMs=b)}catch{}return}case"I":{!s.isHost&&s.game&&typeof s.game.startFromHostCompact=="function"&&s.game.startFromHostCompact(t);return}case"D":{!s.isHost&&s.game&&typeof s.game.updateStateFromHostCompact=="function"&&s.game.updateStateFromHostCompact(t);return}case"C":{if(s.isHost)try{var P=t.split(","),k={tankId:P[1],upPressed:P[2]==="1",rightPressed:P[3]==="1",downPressed:P[4]==="1",leftPressed:P[5]==="1",shooting:P[6]==="1",specialKeyPressed:P[7]==="1",peerId:e&&e.peer};s.applyInputState(k)}catch{}return}case"P":{try{var n=t.substring(2)||"",U=[];n&&n.split(";").forEach(function(at){if(at){var q=at.split("|"),ot=q[0],se=W.decodeFreeText(q[1]||"Player");ot&&U.push({id:ot,nickname:se})}}),s.updatePlayersFromPayload(U),s.maybeEmitReady("player-list-compact")}catch{}return}case"N":{try{var T=t.split(","),F=T[1]||e&&e.peer,L=W.decodeFreeText(T[2]||"Player");F&&(s.players.set(F,L),s.emitPlayerList(),s.isHost&&(s.broadcast(t,e),s.broadcastPlayerList())),s.isHost||s.maybeEmitReady("nickname-compact")}catch{}return}case"M":{try{var M=t.split(","),D=W.decodeFreeText(M[1]||"Player"),Q=W.decodeFreeText(M.slice(2).join(","));J(D+": "+Q,"other-message"),s.isHost&&s.broadcast(t,e)}catch{}return}case"E":{try{var O=W.decodeFreeText(t.substring(2));J("* "+O,"notification-message"),s.isHost&&s.broadcast(t,e)}catch{}return}case"V":{if(!s.isHost&&s.game&&s.game.maze&&typeof s.game.maze.applyUnifiedDelta=="function")try{s.game.maze.applyUnifiedDelta(t.substring(2))}catch{}return}case"X":{try{var st=t.split(","),It=st[1]||"",At=st[2]||"",St=st[3]||"",pt=st[4]||"",G=parseInt(st[5]||"0",10)||0,k={type:"powerup",powerup:It,status:At,target:St,tankId:pt,powerupId:G};if(s.isHost&&s.game&&s.game.maze){var j=s.game.maze,mt=!1;if(G&&Array.isArray(j.powerups))for(var vt=0;vt<j.powerups.length;vt++){var nt=j.powerups[vt];if(nt&&nt.id===G&&typeof nt.pickup=="function"){mt=nt.pickup(pt)||mt;break}}if(!mt)try{var gt=de(It,j);if(gt&&typeof gt.pickup=="function")try{gt.pickup(pt)}catch{}}catch{}s.broadcast(t,e);return}if(!s.isHost&&s.game&&s.game.maze){var r=s.game.maze;typeof r.applyPowerupEvent=="function"&&r.applyPowerupEvent(k);try{if(k&&k.status==="activate"&&k.powerupId&&Array.isArray(r.powerups))for(var z=0;z<r.powerups.length;z++){var lt=r.powerups[z];if(lt&&lt.id===k.powerupId&&typeof lt.pickup=="function"){lt.pickup(k.tankId||"");break}}}catch{}if(k&&k.tankId&&k.status==="activate"&&typeof r.resolvePowerupSpriteId=="function"){r.state=r.state||{tanks:{},powerups:{},meta:{nextPowerupId:0}};var Ct=r.state.tanks[k.tankId]||(r.state.tanks[k.tankId]={id:k.tankId,powerups:[]}),Z=r.resolvePowerupSpriteId(k.powerup);if(Ct.powerups=Z?[{type:k.powerup,spriteId:Z}]:[{type:k.powerup}],r.remoteTankMap){var yt=r.remoteTankMap[k.tankId]||(r.remoteTankMap[k.tankId]={id:k.tankId});yt.powerups=(Ct.powerups||[]).slice(),r.remoteTankMeta=r.collectRemoteTankMeta(),r.remoteState={tanks:r.remoteTankMeta,powerups:r.remotePowerups}}typeof r.recomputeGlobalPowerups=="function"&&r.recomputeGlobalPowerups()}}}catch{}return}case"T":{try{var ct=t.split(","),ut=ct[1]||e&&e.peer,dt=ct[2]||"",tt=[];dt&&dt.split(";").forEach(function(A){if(A){for(var at=A.split("|"),q={panelId:W.decodeFreeText(at[0]||""),colour:W.decodeFreeText(at[1]||""),controls:[]},ot=2;ot<8;ot++)q.controls.push(W.decodeFreeText(at[ot]||""));tt.push(q)}}),ut&&(s.remoteTankConfigs[ut]=tt,ut===s.id&&(s.localTankConfigs=tt)),s.isHost&&s.broadcast(t,e)}catch{}return}}}};var x={};x.BIN_TYPE={INPUT:1,PING:2,PONG:3,PLAYERS:16,NICK:17,CHAT:18,NOTIFY:19,PWR:20,SPAWN:21,INIT:32,DELTA:33};x.utf8Encode=function(s){s=""+(s??"");for(var t=new Uint8Array(s.length*4),e=0,i=0;i<s.length;i++){var r=s.charCodeAt(i);r<128?t[e++]=r:r<2048?(t[e++]=192|r>>6,t[e++]=128|r&63):r<65536?(t[e++]=224|r>>12,t[e++]=128|r>>6&63,t[e++]=128|r&63):(t[e++]=240|r>>18,t[e++]=128|r>>12&63,t[e++]=128|r>>6&63,t[e++]=128|r&63)}return t.slice(0,e)};x.utf8Decode=function(s){for(var t=s instanceof Uint8Array?s:new Uint8Array(s||0),e="",i=0;i<t.length;i++){var r=t[i];if(r<128)e+=String.fromCharCode(r);else if((r&224)===192){var n=t[++i];e+=String.fromCharCode((r&31)<<6|n&63)}else if((r&240)===224){var a=t[++i],o=t[++i];e+=String.fromCharCode((r&15)<<12|(a&63)<<6|o&63)}else{var h=t[++i],l=t[++i],c=t[++i],p=(r&7)<<18|(h&63)<<12|(l&63)<<6|c&63;p-=65536,e+=String.fromCharCode(55296+(p>>10),56320+(p&1023))}}return e};function R(){this._a=[]}R.prototype.writeU8=function(s){this._a.push((s&255)>>>0)};R.prototype.writeU16=function(s){s>>>=0,this._a.push(s&255,s>>>8&255)};R.prototype.writeU32=function(s){s>>>=0,this._a.push(s&255,s>>>8&255,s>>>16&255,s>>>24&255)};R.prototype.writeF32=function(s){var t=new ArrayBuffer(4);new DataView(t).setFloat32(0,+s||0,!0);for(var e=new Uint8Array(t),i=0;i<4;i++)this._a.push(e[i])};R.prototype.writeBytes=function(s){for(var t=s instanceof Uint8Array?s:new Uint8Array(s||0),e=0;e<t.length;e++)this._a.push(t[e])};R.prototype.writeStr8=function(s){var t=x.utf8Encode(s||""),e=Math.min(255,t.length);this.writeU8(e);for(var i=0;i<e;i++)this._a.push(t[i])};R.prototype.writeStr16=function(s){var t=x.utf8Encode(s||""),e=Math.min(65535,t.length);this.writeU16(e);for(var i=0;i<e;i++)this._a.push(t[i])};R.prototype.toBuffer=function(){for(var s=new Uint8Array(this._a.length),t=0;t<s.length;t++)s[t]=this._a[t];return s.buffer};x.ByteWriter=R;x.buildInput=function(s){var t=x.utf8Encode(s.tankId||""),e=(s.upPressed?1:0)|(s.rightPressed?1:0)<<1|(s.downPressed?1:0)<<2|(s.leftPressed?1:0)<<3|(s.shooting?1:0)<<4|(s.specialKeyPressed?1:0)<<5,i=Math.min(255,t.length),r=new Uint8Array(3+i);r[0]=x.BIN_TYPE.INPUT,r[1]=i;for(var n=0;n<i;n++)r[2+n]=t[n];return r[2+i]=e&63,r.buffer};x.buildPing=function(s){var t=new ArrayBuffer(5),e=new DataView(t);return e.setUint8(0,x.BIN_TYPE.PING),e.setUint32(1,s>>>0),t};x.buildPong=function(s){var t=new ArrayBuffer(5),e=new DataView(t);return e.setUint8(0,x.BIN_TYPE.PONG),e.setUint32(1,s>>>0),t};x.buildPlayerList=function(s){var t=new R;t.writeU8(x.BIN_TYPE.PLAYERS);var e=Array.isArray(s)?s:[],i=Math.min(255,e.length);t.writeU8(i);for(var r=0;r<i;r++){var n=e[r]||{};t.writeStr8(n.id||""),t.writeStr8(n.nickname||"Player")}return t.toBuffer()};x.buildNickname=function(s,t){var e=new R;return e.writeU8(x.BIN_TYPE.NICK),e.writeStr8(s||""),e.writeStr8(t||""),e.toBuffer()};x.buildChat=function(s,t){var e=new R;return e.writeU8(x.BIN_TYPE.CHAT),e.writeStr8(s||""),e.writeStr16(t||""),e.toBuffer()};x.buildNotify=function(s){var t=new R;return t.writeU8(x.BIN_TYPE.NOTIFY),t.writeStr16(s||""),t.toBuffer()};x.buildPowerupEventFromString=function(s){var t=(s||"").split(",");if(t[0]!=="X")return null;var e=new R;e.writeU8(x.BIN_TYPE.PWR),e.writeStr8(t[1]||""),e.writeStr8(t[2]||""),e.writeStr8(t[3]||""),e.writeStr8(t[4]||"");var i=parseInt(t[5]||"0",10)||0;return e.writeU16(i),e.toBuffer()};x.buildSpawnFromString=function(s){if(typeof s!="string"||s[0]!=="S")return null;var t=s.substring(2)||"",e=t.split("|"),i=function(n){var a=parseInt(n,10);return isNaN(a)?0:a},r=new R;return r.writeU8(x.BIN_TYPE.SPAWN),r.writeStr8(e[0]||""),r.writeU16(i(e[1]||0)),r.writeU16(i(e[2]||0)),r.writeU16(i(e[3]||0)),r.writeU16(i(e[4]||0)),r.writeU16(i(e[5]||0)),r.writeStr8(e[6]||""),r.writeStr8(e[7]||""),r.toBuffer()};x.buildInitFromString=function(s){var t=(s||"").split(",");if(t[0]!=="I")return null;var e=function(D){var Q=parseInt(D,10);return isNaN(Q)?0:Q},i=function(D){var Q=parseFloat(D);return isNaN(Q)?0:Q},r=new R;r.writeU8(x.BIN_TYPE.INIT);var n=e(t[1]),a=e(t[2]),o=e(t[3]),h=i(t[4]),l=i(t[5]),c=i(t[6]),p=e(t[7]),d=e(t[8]),f=i(t[9]),y=e(t[10]),m=i(t[11]),w=t[12]==="1"?1:0;r.writeU16(n),r.writeU16(a),r.writeU16(o),r.writeF32(h),r.writeF32(l),r.writeF32(c),r.writeU16(p),r.writeU16(d),r.writeF32(f),r.writeU16(y),r.writeF32(m),r.writeU8(w),r.writeStr16(t[13]||"");var _=t[14]||"",v=_?_.split(";").filter(Boolean):[],b=Math.min(65535,v.length);r.writeU16(b);for(var P=0;P<b;P++){var k=v[P].split("|");r.writeU16(e(k[0]||0)),r.writeU16(e(k[1]||0)),r.writeU16(e(k[2]||0)),r.writeU16(e(k[3]||0)),r.writeStr8(k[4]||""),r.writeStr8(k[5]||"")}var U=t[15]||"",T=U?U.split(";").filter(Boolean):[],F=Math.min(65535,T.length);r.writeU16(F);for(var L=0;L<F;L++){var M=T[L].split("|");r.writeStr8(M[0]||""),r.writeU16(e(M[1]||0)),r.writeU16(e(M[2]||0)),r.writeF32(i(M[3]||0)),r.writeU16(e(M[4]||0)),r.writeU16(e(M[5]||0)),r.writeStr8(M[6]||""),r.writeU16(e(M[7]||0))}return r.toBuffer()};x.buildDeltaFromString=function(s){var t=(s||"").split(",");if(t[0]!=="D")return null;var e=function(M){var D=parseInt(M,10);return isNaN(D)?0:D},i=function(M){var D=parseFloat(M);return isNaN(D)?0:D},r=new R;r.writeU8(x.BIN_TYPE.DELTA);var n=t.length>=6?2:1;r.writeU32(0);var a=t[n]||"",o=a?a.split(";").filter(Boolean):[],h=Math.min(65535,o.length);r.writeU16(h);for(var l=0;l<h;l++){var c=o[l].split("|");r.writeStr8(c[0]||""),r.writeU16(e(c[1]||0)),r.writeU16(e(c[2]||0)),r.writeF32(i(c[3]||0)),r.writeU16(e(c[4]||0)),r.writeU8(e(c[5]||1))}var p=t[n+1]||"",d=p?p.split(";").filter(Boolean):[],f=Math.min(65535,d.length);r.writeU16(f);for(var y=0;y<f;y++){var m=d[y].split("|");r.writeU16(e(m[0]||0)),r.writeU16(e(m[1]||0)),r.writeF32(i(m[2]||0)),r.writeF32(i(m[3]||0)),r.writeStr8(m[4]||""),r.writeU8(e(m[5]||1))}var w=t[n+2]||"",_=w?w.split(";").filter(Boolean):[],v=Math.min(65535,_.length);r.writeU16(v);for(var b=0;b<v;b++){var P=_[b].split("|");r.writeU16(e(P[0]||0)),r.writeU16(e(P[1]||0)),r.writeU16(e(P[2]||0)),r.writeU16(e(P[3]||0)),r.writeStr8(P[4]||""),r.writeStr8(P[5]||"")}var k=t[n+3]||"",U=k?k.split(";").filter(Boolean):[],T=Math.min(65535,U.length);r.writeU16(T);for(var F=0;F<T;F++){var L=U[F].split("|");r.writeStr8(L[0]||""),r.writeStr8(L[1]||""),r.writeStr8(L[2]||""),r.writeStr8(L[3]||"")}return r.toBuffer()};x.hydrate=function(s,t,e){try{if(typeof s=="string")return s;if(typeof Blob<"u"&&s instanceof Blob&&s.arrayBuffer)return s.arrayBuffer().then(function(I){try{E&&E.handlePeerMessage&&E.handlePeerMessage(t,I,e)}catch{}}),null;var i=null;if(s&&s.byteLength!=null&&!(s instanceof ArrayBuffer)?i=new Uint8Array(s):s instanceof ArrayBuffer&&(i=new Uint8Array(s)),!i||i.length===0)return s;var r=i[0],n=x.BIN_TYPE;switch(r){case n.INPUT:{var a=i[1]||0,o=i.slice(2,2+a),h=x.utf8Decode(o),l=i[2+a]||0,c=function(I){return l>>I&1?"1":"0"};return["C",h,c(0),c(1),c(2),c(3),c(4),c(5)].join(",")}case n.PING:{var p=new DataView(i.buffer,i.byteOffset||0,i.byteLength),d=p.getUint32(1);return"Q,"+d}case n.PONG:{var f=new DataView(i.buffer,i.byteOffset||0,i.byteLength),y=f.getUint32(1);return"q,"+y}case n.PLAYERS:{for(var m=1,w=i[m++]||0,_=[],v=0;v<w;v++){var b=i[m++]||0,P=x.utf8Decode(i.slice(m,m+b));m+=b;var k=i[m++]||0,U=x.utf8Decode(i.slice(m,m+k));m+=k,_.push(P+"|"+(E&&E.encodeFreeText?E.encodeFreeText(U):U))}return"P,"+_.join(";")}case n.NICK:{var T=1,F=function(){return i[T++]},L=function(){var I=F(),C=x.utf8Decode(i.slice(T,T+I));return T+=I,C},M=L(),D=L(),Q=E&&E.encodeFreeText?E.encodeFreeText:function(I){return I};return"N,"+M+","+Q(D)}case n.CHAT:{var O=1,st=function(){return i[O++]},It=function(){var C=i[O]|i[O+1]<<8;return O+=2,C>>>0},L=function(){var C=st(),Dt=x.utf8Decode(i.slice(O,O+C));return O+=C,Dt},At=function(){var C=It(),Dt=x.utf8Decode(i.slice(O,O+C));return O+=C,Dt},St=L(),pt=At(),G=E&&E.encodeFreeText?E.encodeFreeText:function(C){return C};return"M,"+G(St)+","+G(pt)}case n.NOTIFY:{var j=1,mt=function(){var I=i[j]|i[j+1]<<8;return j+=2,I>>>0},vt=function(){var I=mt(),C=x.utf8Decode(i.slice(j,j+I));return j+=I,C},nt=vt(),gt=E&&E.encodeFreeText?E.encodeFreeText:function(I){return I};return"E,"+gt(nt)}case n.PWR:{var z=1,lt=function(){return i[z++]},Ct=function(){var I=i[z]|i[z+1]<<8;return z+=2,I>>>0},Z=function(){var I=lt(),C=x.utf8Decode(i.slice(z,z+I));return z+=I,C},yt=Z(),ct=Z(),ut=Z(),dt=Z(),tt=Ct();return["X",yt,ct,ut,dt,tt].join(",")}case n.SPAWN:{var A=1,at=function(){return i[A++]},q=function(){var C=i[A]|i[A+1]<<8;return A+=2,C>>>0},ot=function(){var C=at(),Dt=x.utf8Decode(i.slice(A,A+C));return A+=C,Dt},r=ot(),se=q(),fi=q(),pi=q(),mi=q(),vi=q(),gi=ot(),yi=ot();return"S,"+[r,se,fi,pi,mi,vi,gi,yi].join("|")}case n.INIT:{for(var X=1,H=function(){var I=i[X]|i[X+1]<<8;return X+=2,I>>>0},Me=function(){return i[X++]},Mt=function(){var I=new DataView(i.buffer,(i.byteOffset||0)+X,4),C=I.getFloat32(0,!0);return X+=4,C},Gt=function(){var I=Me(),C=x.utf8Decode(i.slice(X,X+I));return X+=I,C},wi=function(){var I=H(),C=x.utf8Decode(i.slice(X,X+I));return X+=I,C},_i=H(),ki=H(),xi=H(),bi=Mt(),Pi=Mt(),Ii=Mt(),Si=H(),Ci=H(),Ei=Mt(),Bi=H(),Ti=Mt(),Ai=Me(),Mi=wi(),Fi=H(),Fe=[],Ne=0;Ne<Fi;Ne++){var Ni=H(),Ui=H(),Li=H(),zi=H(),Hi=Gt(),Di=Gt();Fe.push([Ni,Ui,Li,zi,Hi,Di].join("|"))}for(var Ri=H(),Ue=[],Le=0;Le<Ri;Le++){var Oi=Gt(),ji=H(),Wi=H(),Gi=Mt(),Yi=H(),Ki=H(),Vi=Gt(),qi=H();Ue.push([Oi,ji,Wi,Gi,Yi,Ki,Vi,qi].join("|"))}return["I",_i,ki,xi,bi,Pi,Ii,Si,Ci,Ei,Bi,Ti,Ai?1:0,Mi,Fe.join(";"),Ue.join(";")].join(",")}case n.DELTA:{var et=1,Y=function(){var I=i[et]|i[et+1]<<8;return et+=2,I>>>0},ne=function(){return i[et++]},Xi=function(){var I=new DataView(i.buffer,(i.byteOffset||0)+et,4),C=I.getUint32(0,!0);return et+=4,C>>>0},ae=function(){var I=new DataView(i.buffer,(i.byteOffset||0)+et,4),C=I.getFloat32(0,!0);return et+=4,C},wt=function(){var I=ne(),C=x.utf8Decode(i.slice(et,et+I));return et+=I,C};Xi();for(var Ji=Y(),ze=[],He=0;He<Ji;He++){var $i=wt(),Qi=Y(),Zi=Y(),tr=ae(),er=Y(),ir=ne();ze.push([$i,Qi,Zi,tr,er,ir].join("|"))}for(var rr=Y(),De=[],Re=0;Re<rr;Re++){var sr=Y(),nr=Y(),ar=ae(),or=ae(),hr=wt(),lr=ne();De.push([sr,nr,ar,or,hr,lr].join("|"))}for(var cr=Y(),Oe=[],je=0;je<cr;je++){var ur=Y(),dr=Y(),fr=Y(),pr=Y(),mr=wt(),vr=wt();Oe.push([ur,dr,fr,pr,mr,vr].join("|"))}for(var gr=Y(),We=[],Ge=0;Ge<gr;Ge++){var yt=wt(),yr=wt(),ut=wt(),wr=wt();We.push([yt,yr,ut,wr].join("|"))}return["D",ze.join(";"),De.join(";"),Oe.join(";"),We.join(";")].join(",")}}}catch{}return s};var N=x;var pe=class{constructor(){this.remoteTankConfigs={},this.localTankConfigs=[],this.game=null,this.reset(),this._stats={sentBytes:0,sentMessages:0,recvBytes:0,recvMessages:0,sentPerSec:0,recvPerSec:0,bytesSentPerSec:0,bytesRecvPerSec:0,rttMs:null},this._lastStatsSnapshot={sentBytes:0,recvBytes:0,sentMessages:0,recvMessages:0},this._statsTimer=null,this._pingTimer=null}reset(){if(this.peer)try{this.peer.destroy()}catch{}this.peer=null,this.connections=[],this.nickname="",this.players=new Map,this.isHost=!1,this.id=null,this.roomName="",this.readyNotified=!1,this.lastStartPayload=null,this.remoteTankConfigs={},this.isHost&&(this.remoteTankConfigs[this.id||"host"]=this.localTankConfigs||[]),this.stopInstrumentation()}hostRoom(t,e){if(!window.Peer){B.emit("network-status","PeerJS library not available.");return}if(t=$t(t),e=$t(e)||"Commander",!t){B.emit("network-status","Please provide a room name to host.");return}this.reset(),this.isHost=!0,this.roomName=t,this.nickname=e,this.peer=new Peer(t),this.peer.on("connection",i=>{this.setupConnection(i)}),this.peer.on("open",i=>{this.id=i,this.players.set(i,this.nickname),B.emit("network-status",'Hosting room "'+t+'". '),B.emit("network-ready",{role:"host",roomId:i}),this.readyNotified=!0,this.emitPlayerList(),J('You are hosting the room as "'+this.nickname+'".',"notification-message"),this.startInstrumentation()}),this.peer.on("error",i=>{B.emit("network-status","Error hosting room: "+(i&&i.type?i.type:"unknown")),i&&(i.type==="unavailable-id"||/taken/i.test(i.message||""))?B.emit("network-status","Room name already taken. Ask friends for the room code to join."):J("* Host error: "+(i&&i.type?i.type:"unknown"),"notification-message")})}joinRoom(t,e){if(!window.Peer){B.emit("network-status","PeerJS library not available.");return}if(t=$t(t),e=$t(e)||_r(),!t){B.emit("network-status","Please enter a room name or ID to join.");return}this.reset(),this.isHost=!1,this.roomName=t,this.nickname=e,this.peer=new Peer,this.peer.on("open",i=>{this.id=i,this.players.set(i,this.nickname),B.emit("network-status",'Attempting to join room "'+t+'"...'),this.emitPlayerList();let r=this.peer.connect(t);r.on("error",n=>{B.emit("network-status","Connection error: "+(n&&n.type?n.type:"unknown"))}),this.setupConnection(r)}),this.peer.on("error",i=>{B.emit("network-status","Error joining room: "+(i&&i.type?i.type:"unknown"))})}setupConnection(t){!t||t._handled||(t._handled=!0,this.connections.push(t),t.on("data",e=>{try{var i=0;typeof e=="string"?i=e.length:e&&e.byteLength&&(i=e.byteLength),this._stats.recvBytes+=i,this._stats.recvMessages+=1}catch{}E&&typeof E.handlePeerMessage=="function"&&E.handlePeerMessage(this,e,t)}),t.on("close",()=>{this.connections=this.connections.filter(i=>i!==t);let e=this.players.get(t.peer);this.players.delete(t.peer),this.remoteTankConfigs&&delete this.remoteTankConfigs[t.peer],this.broadcastPlayerList(),e&&(J("* "+e+" disconnected.","notification-message"),this.isHost&&this.sendNotification(e+" left the room."))}),t.on("error",e=>{B.emit("network-status","Connection error with "+t.peer)}),t.on("open",()=>{this.isHost||(B.emit("network-status",'Connected to host "'+t.peer+'".'),B.emit("network-ready",{role:"guest",roomId:this.roomName}),J('You joined room "'+this.roomName+'" as "'+this.nickname+'".',"notification-message"),this.startInstrumentation());try{t.send(N.buildNickname(this.id,this.nickname))}catch{try{t.send(["N",this.id,E.encodeFreeText(this.nickname)].join(","))}catch{}}if(this.isHost&&(this.sendPlayerListTo(t),this.broadcastPlayerList(),this.game&&this.game.main_object&&typeof this.game.main_object.getCachedSnapshot=="function")){if(this.game&&this.game.maze&&typeof this.game.maze.serializeInitString=="function")try{var e=this.game.maze.serializeInitString(),i=null;try{i=N.buildInitFromString(e)}catch{i=null}i?t.send(i):t.send(e)}catch{}try{if(this.game&&this.game.maze&&typeof this.game.maze.serializeUnifiedSnapshot=="function"){var r=this.game.maze.serializeUnifiedSnapshot();t.send("U,"+r)}}catch{}}}))}broadcast(t,e){let i=t;try{if(typeof t=="string"&&t.length){let r=t[0];if(r==="I"){let n=N.buildInitFromString(t);n&&(i=n)}else if(r==="D"){let n=N.buildDeltaFromString(t);n&&(i=n)}else if(r==="P")i=N.buildPlayerList(this.getPlayerListPayload());else if(r==="M"){let n=t.split(","),a=E.decodeFreeText(n[1]||""),o=E.decodeFreeText(n.slice(2).join(","));i=N.buildChat(a,o)}else if(r==="E"){let n=E.decodeFreeText(t.substring(2));i=N.buildNotify(n)}else if(r==="X"){let n=N.buildPowerupEventFromString(t);n&&(i=n)}else if(r==="S"){let n=N.buildSpawnFromString(t);n&&(i=n)}else if(r==="N"){let n=t.split(","),a=n[1]||"",o=E.decodeFreeText(n[2]||"");i=N.buildNickname(a,o)}}}catch{}this.connections.forEach(r=>{if(r.open&&r!==e)try{r.send(i);try{var n=0;typeof i=="string"?n=i.length:i&&i.byteLength&&(n=i.byteLength),this._stats.sentBytes+=n,this._stats.sentMessages+=1}catch{}}catch{}})}broadcastPlayerList(){try{this.broadcast(N.buildPlayerList(this.getPlayerListPayload()))}catch{try{this.broadcast(E.buildCompactPlayerList(this.getPlayerListPayload()))}catch{}}this.emitPlayerList()}sendPlayerListTo(t){if(!(!t||!t.open))try{t.send(N.buildPlayerList(this.getPlayerListPayload()))}catch{try{t.send(E.buildCompactPlayerList(this.getPlayerListPayload()))}catch{}}}emitPlayerList(){B.emit("network-player-list",this.getPlayerListPayload()),this.isHost||this.maybeEmitReady("player-list")}getPlayerListPayload(){let t=[];return this.players.forEach((e,i)=>{t.push({id:i,nickname:e})}),t}sendTankConfig(t){if(this.localTankConfigs=t||[],!this.peer)return;let e=this.id||"pending";this.isHost&&(this.remoteTankConfigs[e]=this.localTankConfigs);try{let i=(this.localTankConfigs||[]).map(n=>{let a=E.encodeFreeText(n.panelId||""),o=E.encodeFreeText(n.colour||""),h=(n.controls||[]).slice(0,6).map(E.encodeFreeText);for(;h.length<6;)h.push("");return[a,o].concat(h).join("|")}).join(";"),r=["T",e,i].join(",");this.broadcast(r)}catch{}}sendInputState(t){if(!(!t||!t.tankId)){if(t.peerId=this.id,this.isHost){this.applyInputState(t);return}try{this.broadcast(N.buildInput(t))}catch{var e=function(n){return n?1:0},i=["C",t.tankId,e(t.upPressed),e(t.rightPressed),e(t.downPressed),e(t.leftPressed),e(t.shooting),e(t.specialKeyPressed)].join(",");this.broadcast(i)}}}updatePlayersFromPayload(t){if(this.players=new Map,Array.isArray(t))for(let e=0;e<t.length;e++){let i=t[e];i&&i.id&&this.players.set(i.id,i.nickname||"Player")}this.id&&!this.players.has(this.id)&&this.players.set(this.id,this.nickname),this.emitPlayerList()}applyInputState(t){t&&(this.isHost&&(this.remoteTankConfigs=this.remoteTankConfigs||{},t.peerId&&!this.remoteTankConfigs[t.peerId]&&(this.remoteTankConfigs[t.peerId]=[])),this.game&&this.game.main_object&&typeof this.game.main_object.applyInputState=="function"&&this.game.main_object.applyInputState(t))}addPlayer(t,e){t&&(this.players.set(t,e||"Player"),this.broadcastPlayerList())}sendChatMessage(t){let e=E.encodeFreeText(this.nickname),i=E.encodeFreeText(t);this.broadcast(["M",e,i].join(","))}sendNotification(t){J("* "+t,"notification-message");let e=E.encodeFreeText(t);this.broadcast(["E",e].join(","))}getNickname(){return this.nickname}maybeEmitReady(t){this.readyNotified||(this.readyNotified=!0,B.emit("network-ready",{role:this.isHost?"host":"guest",roomId:this.isHost?this.id:this.roomName}))}startInstrumentation(){this.stopInstrumentation(),this._statsTimer=setInterval(()=>{let t=this._stats.sentBytes-this._lastStatsSnapshot.sentBytes,e=this._stats.recvBytes-this._lastStatsSnapshot.recvBytes,i=this._stats.sentMessages-this._lastStatsSnapshot.sentMessages,r=this._stats.recvMessages-this._lastStatsSnapshot.recvMessages;this._lastStatsSnapshot={sentBytes:this._stats.sentBytes,recvBytes:this._stats.recvBytes,sentMessages:this._stats.sentMessages,recvMessages:this._stats.recvMessages},this._stats.bytesSentPerSec=t,this._stats.bytesRecvPerSec=e,this._stats.sentPerSec=i,this._stats.recvPerSec=r,B.emit("network-stats",Object.assign({},this._stats))},1e3),this.isHost||(this._pingTimer=setInterval(()=>{let t=Math.floor(performance.now());try{this.broadcast(N.buildPing(t))}catch{}},2e3))}stopInstrumentation(){this._statsTimer&&(clearInterval(this._statsTimer),this._statsTimer=null),this._pingTimer&&(clearInterval(this._pingTimer),this._pingTimer=null),this._stats&&(this._stats.rttMs=null,this._stats.sentBytes=0,this._stats.recvBytes=0,this._stats.sentMessages=0,this._stats.recvMessages=0,this._stats.bytesSentPerSec=0,this._stats.bytesRecvPerSec=0,this._stats.sentPerSec=0,this._stats.recvPerSec=0),this._lastStatsSnapshot={sentBytes:0,recvBytes:0,sentMessages:0,recvMessages:0}}};function $t(s){return(s||"").replace(/[^a-zA-Z0-9 _-]/g,"").trim()}function qe(s){s=""+(s??"");let t=new Uint8Array(s.length*4),e=0;for(let i=0;i<s.length;i++){let r=s.charCodeAt(i);r<128?t[e++]=r:r<2048?(t[e++]=192|r>>6,t[e++]=128|r&63):r<65536?(t[e++]=224|r>>12,t[e++]=128|r>>6&63,t[e++]=128|r&63):(t[e++]=240|r>>18,t[e++]=128|r>>12&63,t[e++]=128|r>>6&63,t[e++]=128|r&63)}return t.slice(0,e)}function _t(){this._a=[]}_t.prototype.writeU8=function(s){this._a.push((s&255)>>>0)};_t.prototype.writeU16=function(s){s>>>=0,this._a.push(s&255,s>>>8&255)};_t.prototype.writeU32=function(s){s>>>=0,this._a.push(s&255,s>>>8&255,s>>>16&255,s>>>24&255)};_t.prototype.writeF32=function(s){let t=new ArrayBuffer(4);new DataView(t).setFloat32(0,+s||0,!0);let e=new Uint8Array(t);for(let i=0;i<4;i++)this._a.push(e[i])};_t.prototype.writeBytes=function(s){let t=s instanceof Uint8Array?s:new Uint8Array(s||0);for(let e=0;e<t.length;e++)this._a.push(t[e])};_t.prototype.writeStr8=function(s){let t=qe(s||""),e=Math.min(255,t.length);this.writeU8(e);for(let i=0;i<e;i++)this._a.push(t[i])};_t.prototype.writeStr16=function(s){let t=qe(s||""),e=Math.min(65535,t.length);this.writeU16(e);for(let i=0;i<e;i++)this._a.push(t[i])};_t.prototype.toBuffer=function(){let s=new Uint8Array(this._a.length);for(let t=0;t<s.length;t++)s[t]=this._a[t];return s.buffer};function J(s,t){var e=document.getElementById("chat-messages");if(e){var i=document.createElement("div");i.textContent=s,i.className="chat-message "+(t||"notification-message"),e.appendChild(i),e.scrollTop=e.scrollHeight}}var g=new pe;function _r(){let s=["Scout","Ranger","Vanguard","Maverick","Falcon","Viper","Nomad","Ghost","Reaper","Sentinel","Hunter","Bravo","Delta","Echo","Foxtrot","Saber","Specter","Havoc","Phoenix","Spartan","Titan","Bulldog","Badger","Wolverine","Gunner","Hammer","Raptor","Hawk","Comet","Meteor","Blaze","Gladius","Aegis","Paladin","Corsair","Dragoon","Lancer","Outrider","Pathfinder","Overwatch","Warhorse","Longbow","Blackjack","Wildcat","Cougar","Kodiak","Patriot","Valkyrie","Legion","Arcadian","Buckeye","Guardian","Centurion","Warlock","Sentury","Bastion","Onyx","Cinder","Inferno","Grizzly","Ajax","Atlas","Bishop","Crosshair","Diesel","Fury","Goliath","Hurricane","Iceman","Jaguar","Knight","Lynx","Maelstrom","Nomad-2","Oracle","Phantom","Quake","Ravager","Saber-2","Talon","Umbra","Vector","Warden","Xiphos","Yankee","Zephyr","Ironclad","Foxhound","Thunder","Lightning"],t=Math.floor(Math.random()*s.length);return s[t]}function K(s){this.game=s,this.connectOverlay=null,this.chatOverlay=null,this.chatPanel=null,this.statusEls=[],this.roomInput=null,this.nicknameInput=null,this.hostButton=null,this.joinButton=null,this.enterLobbyButton=null,this.playerListEl=null,this.roomCodeEl=null,this.chatInput=null,this.sendButton=null,this.closeConnectButton=null,this.closeChatButton=null,this._boundResize=null,this._chatDrag={active:!1,startX:0,startWidth:0},this.overlayEnabled=!0,this.overlayRequested=!1,this.ensureDom(),this.sendButton&&(this.sendButton.disabled=!1),this.chatInput&&(this.chatInput.disabled=!1),this.registerListeners()}K.prototype.ensureDom=function(){this.connectOverlay=document.getElementById("networking-connect-overlay"),this.chatOverlay=null,this.statusEls=Array.from(document.querySelectorAll("#network-status, #network-status-connect, #network-status-chat")),this.roomInput=document.getElementById("room-name"),this.nicknameInput=document.getElementById("nickname"),this.hostButton=document.getElementById("host-room-btn"),this.joinButton=document.getElementById("join-room-btn"),this.enterLobbyButton=document.getElementById("enter-lobby-btn"),this.playerListEl=document.getElementById("player-list"),this.roomCodeEl=document.getElementById("room-code"),this.chatInput=document.getElementById("chat-message-input"),this.sendButton=document.getElementById("chat-send-btn"),this.chatPanel=document.getElementById("networking-chat-panel"),this.closeConnectButton=document.getElementById("networking-close-connect-btn"),this.closeChatButton=document.getElementById("networking-close-chat-btn")};K.prototype.registerListeners=function(){var s=this;this.hostButton&&this.hostButton.addEventListener("click",function(){g.hostRoom(s.roomInput.value,s.nicknameInput.value),s.showChatOverlay()}),this.joinButton&&this.joinButton.addEventListener("click",function(){g.joinRoom(s.roomInput.value,s.nicknameInput.value),s.showChatOverlay()}),this.closeConnectButton&&this.closeConnectButton.addEventListener("click",function(){s.hideOverlay()}),this.sendButton&&this.sendButton.addEventListener("click",function(){s.handleSendMessage()}),this.chatInput&&this.chatInput.addEventListener("keydown",function(e){e.key==="Enter"&&(e.preventDefault(),s.handleSendMessage())}),B.on("network-status",function(e){for(var i=0;i<s.statusEls.length;i++)s.statusEls[i].textContent=e}),B.on("network-ready",function(e){if(e){s.sendButton&&(s.sendButton.disabled=!1),s.chatInput&&(s.chatInput.disabled=!1),s.overlayEnabled&&s.showChatOverlay();try{var i=localStorage.getItem("chatPanelWidthPx");if(i&&s.chatPanel){var r=Math.max(0,Math.min(window.innerWidth*.9,parseInt(i,10)||0));r>0&&(s.chatPanel.style.width=r+"px",s.chatPanel.classList.add("chat-open"))}}catch{}s.game&&s.game.pregame&&typeof s.game.pregame.emitTankConfig=="function"&&s.game.pregame.emitTankConfig()}}),B.on("network-player-list",function(e){s.renderPlayerList(e||[])}),B.on("network-stats",function(e){if(!(!e||!s.statusEls||s.statusEls.length===0)){var i=document.getElementById("network-status-connect"),r=null,n=document.getElementById("network-status"),a=[],o=[];if(typeof e.rttMs=="number"&&(a.push("Ping: "+e.rttMs+" ms"),o.push("Ping: "+e.rttMs+" ms")),o.push("Tx: "+e.sentPerSec+" msg/s"),o.push("Rx: "+e.recvPerSec+" msg/s"),o.push("Up: "+e.bytesSentPerSec+" B/s"),o.push("Down: "+e.bytesRecvPerSec+" B/s"),i){var h=(i.textContent||"").split(`
`)[0]||i.textContent;i.textContent=h+`
`+a.join(`
`)}if(n){var l=(n.textContent||"").split(`
`)[0]||n.textContent;n.textContent=l+`
`+o.join(`
`)}if(!i&&!r&&!n)for(var c=o,p=0;p<s.statusEls.length;p++){var d=s.statusEls[p],f=(d.textContent||"").split(`
`)[0]||d.textContent;d.textContent=f+`
`+c.join(`
`)}}});var t=document.getElementById("chat-resize-handle");t&&this.chatPanel&&(t.addEventListener("mousedown",function(e){e.preventDefault(),s._chatDrag.active=!0,s._chatDrag.startX=e.clientX,s._chatDrag.startWidth=s.chatPanel.getBoundingClientRect().width,document.body.classList.add("resizing-chat")}),window.addEventListener("mousemove",function(e){if(s._chatDrag.active){var i=s._chatDrag.startX-e.clientX,r=Math.max(0,Math.min(window.innerWidth*.9,s._chatDrag.startWidth+i));s.chatPanel.style.width=r+"px",s.chatPanel.classList.add("chat-open")}}),window.addEventListener("mouseup",function(){if(s._chatDrag.active){s._chatDrag.active=!1,document.body.classList.remove("resizing-chat");try{var e=s.chatPanel.getBoundingClientRect().width;localStorage.setItem("chatPanelWidthPx",Math.round(e))}catch{}}}))};K.prototype.layoutChatRight=function(){};K.prototype.handleSendMessage=function(){if(!this.chatInput.disabled){var s=(this.chatInput.value||"").trim();if(s){var t=g.getNickname?g.getNickname():"Me";J("You: "+s,"self-message"),g.sendChatMessage(s),this.chatInput.value=""}}};K.prototype.renderPlayerList=function(s){if(this.playerListEl){for(;this.playerListEl.firstChild;)this.playerListEl.removeChild(this.playerListEl.firstChild);if(!s||s.length===0){var t=document.createElement("li");t.textContent="Waiting for players...",t.className="player-list-empty",this.playerListEl.appendChild(t);return}for(var e=this.game&&this.game.pregame?this.game.pregame.tank_panels.length:0,i=0;i<s.length;i++){var r=document.createElement("li"),n=s[i],a=n.nickname||"Player";n.id&&g.id===n.id?(a+=" (This device",e&&(a+=", Tanks: "+e),a+=")"):a+=" (ID "+(n.id?n.id.substring(0,6):"????")+")",r.textContent=a,this.playerListEl.appendChild(r)}}};K.prototype.showOverlay=function(){this.overlayEnabled&&(g&&(g.connections||[]).length>0||g&&g.readyNotified?this.showChatOverlay():this.showConnectOverlay())};K.prototype.showConnectOverlay=function(){if(this.overlayEnabled&&(this.overlayRequested=!0,this.connectOverlay||this.ensureDom(),this.chatOverlay&&(this.chatOverlay.classList.add("hidden"),this.chatOverlay.style.display=""),this.connectOverlay&&(this.connectOverlay.classList.remove("hidden"),this.connectOverlay.style.display="flex",this.roomInput)))try{this.roomInput.focus()}catch{}};K.prototype.showChatOverlay=function(){if(this.overlayEnabled&&(this.ensureDom(),this.connectOverlay&&(this.connectOverlay.classList.add("hidden"),this.connectOverlay.style.display=""),this.chatPanel)){if(this.chatPanel.classList.remove("hidden"),this.chatPanel.classList.add("chat-open"),this.chatInput)try{this.chatInput.disabled=!1,this.chatInput.removeAttribute("disabled")}catch{}if(this.sendButton)try{this.sendButton.disabled=!1,this.sendButton.removeAttribute("disabled")}catch{}if(this.chatInput)try{this.chatInput.focus()}catch{}}};K.prototype.hideOverlay=function(){this.ensureDom(),this.overlayRequested=!1,this.connectOverlay&&(this.connectOverlay.classList.add("hidden"),this.connectOverlay.style.display=""),this.chatPanel&&(this.chatPanel.classList.add("chat-open"),this.chatPanel.classList.remove("hidden"))};K.prototype.enableOverlay=function(){this.overlayEnabled=!0};K.prototype.disableOverlay=function(){this.overlayEnabled=!1,this.hideOverlay()};var Ot=class{constructor(t,e,i,r,n){this.x=t|0,this.y=e|0,this.width=i|0,this.height=r|0,this.orientation=n,this.isActive=!0,this.N=null,this.S=null,this.W=null,this.E=null}getRect(){return[this.x,this.y,this.width,this.height]}},Qt=class{constructor(t,e){this.x=t|0,this.y=e|0,this.north=null,this.south=null,this.west=null,this.east=null}};function ft(s,t){return!(s[0]+s[2]<t[0]||s[0]>t[0]+t[2]||s[1]+s[3]<t[1]||s[1]>t[1]+t[3])}function Xe(s,t){if(!t||!Array.isArray(t))return;let e=t.indexOf(s);e>=0&&t.splice(e,1)}function Je(s){for(var t=[],e=s.slice();e.length>0;){var i=Math.floor(Math.random()*e.length);t.push(e[i]),e.splice(i,1)}return t}var jt=class{constructor(t,e,i){this.maze=t,this.row=e,this.col=i,this.north=null,this.east=null,this.south=null,this.west=null;var r=this.maze.getCellRect(e,i);this.width=r.width,this.height=r.height,this.wall_thiccness=t.wall_thiccness,this.x=r.x,this.y=r.y,this.visited=!1}draw(){}removeBorder(t){this.row==t.row&&(this.col==t.col-1&&(this.east&&(this.east.isActive=!1),t.west&&(t.west.isActive=!1)),this.col==t.col+1&&(this.west&&(this.west.isActive=!1),t.east&&(t.east.isActive=!1))),this.col==t.col&&(this.row==t.row-1&&(this.south&&(this.south.isActive=!1),t.north&&(t.north.isActive=!1)),this.row==t.row+1&&(this.north&&(this.north.isActive=!1),t.south&&(t.south.isActive=!1)))}getNeighbours(){var t=[];return this.col>0&&t.push(this.maze.squares[this.row][this.col-1]),this.col<this.maze.num_of_columns-1&&t.push(this.maze.squares[this.row][this.col+1]),this.row>0&&t.push(this.maze.squares[this.row-1][this.col]),this.row<this.maze.num_of_rows-1&&t.push(this.maze.squares[this.row+1][this.col]),t}getCenter(){return[this.x+this.width/2,this.y+this.height/2]}getWalls(){var t=[];return this.row===0&&this.north&&this.north.isActive&&t.push(this.north.getRect()),this.col===0&&this.west&&this.west.isActive&&t.push(this.west.getRect()),this.east&&this.east.isActive&&t.push(this.east.getRect()),this.south&&this.south.isActive&&t.push(this.south.getRect()),t}hasActiveBorderWith(t){if(this.row==t.row){if(this.col==t.col+1)return this.west;if(this.col==t.col-1)return this.east}if(this.col==t.col){if(this.row==t.row+1)return this.north;if(this.row==t.row-1)return this.south}return!1}};var Ft=null,$=null,Tt=null,me=null,ve=null,$e="",Qe="",Ze="";function kr(){if(Ft||(Ft=document.getElementById("hud-scoreboard")),!Ft)return null;if($||($=Ft.querySelector(".sb-inner"),$||($=document.createElement("div"),$.className="sb-inner",Ft.appendChild($))),Tt||(Tt=$.querySelector(".sb-players"),Tt||(Tt=document.createElement("div"),Tt.className="sb-players",$.insertBefore(Tt,$.firstChild||null))),ve||(ve=$.querySelector(".sb-test")),!me){let s=$.querySelector(".sb-network");me=s?s.querySelector("img"):null}return{root:Ft,inner:$,players:Tt,testBtn:ve,networkImg:me}}function ge(s){if(!s)return"";let t=document.getElementById(s);return!t||!("src"in t)?"":t.src||""}function xr(s){let t=document.createElement("div");t.className="sb-player",s&&(t.dataset.tankId=s);let e=document.createElement("img");e.className="sb-icon",e.alt="",e.hidden=!0,t.appendChild(e);let i=document.createElement("div");i.className="sb-row";let r=document.createElement("img");r.className="sb-tank",r.alt="",i.appendChild(r);let n=document.createElement("span");return n.className="sb-score",n.textContent="0",i.appendChild(n),t.appendChild(i),t._iconEl=e,t._tankEl=r,t._scoreEl=n,t}function ti({players:s=[],tankSpriteId:t="tank",networkIconId:e="network-icon"}={}){let i=kr();if(!i)return;let r=ge(t),n=ge(e)||"res/ui/network.png",a=JSON.stringify({players:s.map(c=>({id:c&&c.id?c.id:null,score:c&&typeof c.score<"u"?c.score:0,powerup:c&&c.powerupIconId?c.powerupIconId:null})),tankSpriteSrc:r,networkIconSrc:n});if(a===$e&&r===Qe&&n===Ze)return;$e=a,Qe=r,Ze=n;let o=i.players,h=new Map;Array.from(o.children).forEach(c=>{c.dataset&&c.dataset.tankId&&h.set(c.dataset.tankId,c)});let l=document.createDocumentFragment();for(let c=0;c<s.length;c+=1){let p=s[c]||{},d=p.id||`tank-${c+1}`,f=h.get(d);f?h.delete(d):f=xr(d),f._iconEl||(f._iconEl=f.querySelector(".sb-icon")),f._tankEl||(f._tankEl=f.querySelector(".sb-tank")),f._scoreEl||(f._scoreEl=f.querySelector(".sb-score")),f.dataset.tankId=d;let y=p.powerupIconId||null;if(y){let _=ge(y);_?(f._iconEl.src=_,f._iconEl.hidden=!1):f._iconEl.hidden=!0}else f._iconEl.hidden=!0;r&&(f._tankEl.src=r);let m=typeof p.score=="number"?p.score:parseInt(p.score,10)||0,w=String(m);f._scoreEl.textContent!==w&&(f._scoreEl.textContent=w),l.appendChild(f)}h.size>0&&h.forEach(c=>{c&&c.parentNode===o&&c.parentNode.removeChild(c)}),o.replaceChildren(l),i.networkImg&&(i.networkImg.src=n)}var Zt=class{constructor(t,e){this.game=t;let i={num_of_rows:6,num_of_columns:9,wall_thiccness:4,speed:1,move_speed:3,rotation_speed:9/100,bullet_speed:3,seconds_between_rounds:3,friendly_fire:!1,bullet_limit:7,bounce_limit:7,powerup_interval:8,powerup_limit:8,powerup_duration:10};this.settings=Object.assign({},i,e||{}),this.num_of_rows=this.settings.num_of_rows,this.num_of_columns=this.settings.num_of_columns,this.wall_thiccness=this.settings.wall_thiccness,this.scoreboardHeight=Math.floor(S.height*1/5),this.width=S.width-this.wall_thiccness,this.height=S.height-this.scoreboardHeight-this.wall_thiccness,this._buildGridEdges(),this.tanks=[],this.powerups=[],this.state={tanks:{},powerups:{},meta:{nextPowerupId:1,nextTankId:1}},this.pendingPowerupEvents=[],this.teleportMirrors={},this.lastSnapshot=null,this.message="Shoot the opposing tanks!",this.num_of_destroyed_tanks=0,this.spectator=!1,this.remoteState=null,this.remoteTankMeta=[],this.remoteTankMap={},this.remotePowerups=[],this.remoteBulletCache={},this.remoteBulletLerpDuration=60,this.remoteBulletPredictionWindow=120,this.remoteGlobalBullets=[],this.nextPowerupId=1,this.nextTankId=1,this.tankById={},this.lastStateBroadcast=0,this.lastRemoteStateTime=0,this.hostOwned=!1,this.tick=0,this.squares=[];for(var r=0;r<this.num_of_rows;r++){for(var n=[],a=0;a<this.num_of_columns;a++)n.push(new jt(this,r,a));this.squares.push(n)}this._initWalls(),this.extraFunctionsPerCycle=[],this.trippyCount=0}_buildGridEdges(){var t=this.num_of_rows,e=this.num_of_columns,i=Math.floor(this.width/e),r=this.width-i*e;this._colX=[0];for(var n=0;n<e;n++){var a=i+(n<r?1:0);this._colX.push(this._colX[n]+a)}var o=Math.floor(this.height/t),h=this.height-o*t;this._rowY=[0];for(var l=0;l<t;l++){var c=o+(l<h?1:0);this._rowY.push(this._rowY[l]+c)}}getCellRect(t,e){var i=this._colX[e],r=this._colX[e+1],n=this._rowY[t],a=this._rowY[t+1];return{x:i,y:n,width:r-i,height:a-n}}main(){if(this.tick+=1,this.spectator){this.drawSpectator();return}this.tanks.forEach(function(t){t.main()}),this.draw(),this.broadcastState()}draw(){if((this.trippyCount||0)>0){this.drawScoreboardTop(),this.drawDynamicObjects();return}this.drawScoreboardTop(),this.drawBackground(),this.drawDynamicObjects()}drawBackground(){u.save(),typeof u.setTransform=="function"&&u.setTransform(1,0,0,1,0,0);var t=this.scoreboardHeight,e=S.height-t;u.clearRect(0,t,S.width,e),u.translate(0,this.scoreboardHeight),u.translate(this.wall_thiccness/2,this.wall_thiccness/2);for(var i=0;i<this.squares.length;i++)for(var r=this.squares[i],n=0;n<r.length;n++){var a=r[n],o=(a.row+a.col)%2==0?"#C0C0C0":"#E0E0E0";u.fillStyle=o,u.fillRect(a.x,a.y,a.width,a.height)}u.fillStyle="black";for(var h=0;h<this.walls.length;h++){var l=this.walls[h];l.isActive&&u.fillRect(l.x,l.y,l.width,l.height)}u.restore()}prerenderBackground(){}beginGameplay(){this._generated||(this.randomize(),this.prerenderBackground(),this._generated=!0),g&&g.isHost&&(this.assignSequentialTankIds(),this.broadcastStartState()),this._powerupsLoopStarted||(this._powerupsLoopStarted=!0,setTimeout(this.tryAddPowerupAndRepeat.bind(this),this.settings.powerup_interval*1e3,this))}assignSequentialTankIds(){this.tankById={};for(var t=1,e=0;e<this.tanks.length;e++){var i=this.tanks[e];i.id=t,this.tankById[i.id]=i,t++}this.nextTankId=t}serializeTankRoster(){for(var t=[],e=0;e<this.tanks.length;e++){var i=this.tanks[e];t.push({id:i.id,x:Math.round(i.x)||0,y:Math.round(i.y)||0,rotation:i.rotation||0,colour:i.colour||i.color||"#000",width:i.width||20,height:i.height||20,ownerPeerId:i.ownerPeerId||null,controls:i.controls||[]})}return t}broadcastStartState(){if(!(!g||!g.isHost))try{var t={role:"host",type:"init",tanks:this.serializeTankRoster(),maze:this.serializeLayout?this.serializeLayout():null,gameConfig:this.settings};if(typeof this.serializeUnifiedSnapshot=="function"){var e=this.serializeUnifiedSnapshot();g.broadcast("U,"+e)}B.emit("network-ready",{role:"host",roomId:g.id})}catch{}}drawDynamicObjects(){try{this._pruneStaleExtraFunctions()}catch{}u.save(),u.translate(0,this.scoreboardHeight),u.translate(this.wall_thiccness/2,this.wall_thiccness/2),this.tanks.forEach(function(t){t.draw()}),this.powerups.forEach(function(t){t.draw()}),this.extraFunctionsPerCycle.forEach(function(t){try{t()}catch{}}),u.restore()}_pruneStaleExtraFunctions(){if(!(!Array.isArray(this.extraFunctionsPerCycle)||this.extraFunctionsPerCycle.length===0)){for(var t=this.teleportMirrors||{},e=[],i=0;i<this.extraFunctionsPerCycle.length;i++){var r=this.extraFunctionsPerCycle[i];r&&r.__tp_tankId!=null?t&&t[r.__tp_tankId]&&e.push(r):e.push(r)}this.extraFunctionsPerCycle=e}}_initWalls(){var t=this.wall_thiccness,e=t/2;this.walls=[],this.intersections=[];for(var i=0;i<=this.num_of_rows;i++){for(var r=[],n=0;n<=this.num_of_columns;n++)r.push(new Qt(this._colX[n],this._rowY[i]));this.intersections.push(r)}for(var n=0;n<=this.num_of_columns;n++)for(var i=0;i<this.num_of_rows;i++){var a=this._colX[n]-e,o=this._rowY[i]-e,h=this._rowY[i+1]-this._rowY[i]+t,l=new Ot(a,o,t,h,"vertical");l.N=this.intersections[i][n],l.S=this.intersections[i+1][n],n>0&&(this.squares[i][n-1].east=l),n<this.num_of_columns&&this.squares[i][n]&&(this.squares[i][n].west=l),this.intersections[i][n].east||(this.intersections[i][n].east=l),this.intersections[i+1][n].west||(this.intersections[i+1][n].west=l),this.walls.push(l)}for(var i=0;i<=this.num_of_rows;i++)for(var n=0;n<this.num_of_columns;n++){var c=this._colX[n]-e,p=this._rowY[i]-e,d=this._colX[n+1]-this._colX[n]+t,f=new Ot(c,p,d,t,"horizontal");f.W=this.intersections[i][n],f.E=this.intersections[i][n+1],i>0&&(this.squares[i-1][n].south=f),i<this.num_of_rows&&this.squares[i]&&this.squares[i][n]&&(this.squares[i][n].north=f),this.intersections[i][n].south||(this.intersections[i][n].south=f),this.intersections[i][n+1].north||(this.intersections[i][n+1].north=f),this.walls.push(f)}}drawScoreboardTop(){typeof u.setTransform=="function"&&u.setTransform(1,0,0,1,0,0);var t=this.scoreboardHeight;u.clearRect(0,0,S.width,t),this._gearBtnRect=null;try{Bt(),Et(!0)}catch{}for(var e=this.spectator?this.remoteTankMeta||[]:this.tanks||[],i=[],r=0;r<e.length;r++){var n=e[r];if(n){for(var a=typeof n.score=="number"?n.score:parseInt(n.score||"0",10)||0,o=null,h=n&&Array.isArray(n.powerups)?n.powerups:[],l=0;l<h.length;l++){var c=h[l];if(c){if(!this.spectator&&c.img&&c.img.id){o=c.img.id;break}if(c.spriteId){o=c.spriteId;break}}}i.push({id:n.id||"tank-"+(r+1),score:a,powerupIconId:o||null})}}ti({players:i})}testFlattenAndRegen(){try{for(var t=0;t<this.num_of_rows;t++)for(var e=0;e<this.num_of_columns;e++){var i=this.squares[t][e];i&&i.east&&(i.east.isActive=!1),i&&i.south&&(i.south.isActive=!1)}for(var r=(this.powerups||[]).slice(),n=0;n<r.length;n++){var a=r[n];try{a&&a.timeout&&(clearTimeout(a.timeout),a.timeout=null)}catch{}try{this.removePowerup(a)}catch{}}for(var o=Math.max(0,this.settings&&this.settings.powerup_limit?this.settings.powerup_limit:0),h=0;h<o;h++){var l=fe(this);this.placeObject(l),this.addPowerup(l)}this.drawBackground(),this.drawScoreboardTop()}catch{}}keyDownHandler(t){document.activeElement.tagName!="INPUT"&&this.tanks.forEach(function(e){e.keyDownHandler(t)})}keyUpHandler(t){this.tanks.forEach(function(e){typeof e.keyUpHandler=="function"&&e.keyUpHandler(t)})}randomize(){this.squares.forEach(function(e){e.forEach(function(i){i.visited=!1})}),(this.walls||[]).forEach(function(e){e.isActive=!0});var t=this.squares[0][0];this.visit(this.getRandomSquare(),this.getRandomSquare())}visit(t,e){t.removeBorder(e),e.visited=!0;var i=e.getNeighbours();i=Je(i);for(var r=0;r<i.length;r++)i[r].visited==!1&&this.visit(e,i[r])}getSquareAtXY(t){var e=t[0],i=t[1];return this.isOutOfBounds(t)?!1:this.squares[Math.floor(i/this.height*this.num_of_rows)][Math.floor(e/this.width*this.num_of_columns)]}getRandomSquare(){var t=Math.floor(Math.random()*this.squares.length),e=this.squares[t],i=e[Math.floor(Math.random()*e.length)];return i}doesRectCollide(t){if(this.isOutOfBounds([t[0],t[1]]))return!0;var e=this.getSquareAtXY([t[0],t[1]]);if(!e)return!0;var i=e.getNeighbours().concat([e]),r=[];i.forEach(function(a){a.getWalls().forEach(function(o){r.push(o)})});var n=!1;return r.forEach(function(a){ft(t,a)&&(n=!0)}),n}isOutOfBounds(t){return t[0]<=0||t[0]>=this.width||t[1]<=0||t[1]>=this.height}tankDestroyed(){if(this.num_of_destroyed_tanks+=1,this.num_of_destroyed_tanks==this.tanks.length-1)for(var t=0;t<this.tanks.length;t++){var e=this.tanks[t];if(e.is_dead==!1){e.score+=1,this.restart_helper(this.settings.seconds_between_rounds);return}}}restart_helper(t){if(t==0){this.restart();return}this.message="Next round starting in time seconds".replace("time",t),setTimeout(this.restart_helper.bind(this),1e3,t-1)}restart(){this.randomize(),this.message="restart",this.num_of_destroyed_tanks=0;for(var t=0;t<this.tanks.length;t++)this.tanks[t].restart();this.powerups=[],this.pendingPowerupEvents=[],this.teleportMirrors={},this.lastSnapshot=null}placeObject(t){var e=this.getRandomSquare(),i=this.wall_thiccness,r=e.west&&e.west.isActive?1:0,n=e.east&&e.east.isActive?1:0,a=e.north&&e.north.isActive?1:0,o=e.south&&e.south.isActive?1:0,h=e.x+i*r,l=e.x+e.width-i*n-t.width,c=e.y+i*a,p=e.y+e.height-i*o-t.height;t.x=h+Math.random()*(l-h),t.y=c+Math.random()*(p-c)}registerTank(t){this.tankById[t.id||"tank-"+this.tanks.length]=t}serializeLayout(){for(var t=[],e=0;e<this.squares.length;e++){for(var i=[],r=0;r<this.squares[e].length;r++){var n=this.squares[e][r];i.push({north:!!(n.north&&n.north.isActive),south:!!(n.south&&n.south.isActive),east:!!(n.east&&n.east.isActive),west:!!(n.west&&n.west.isActive)})}t.push(i)}return{num_of_rows:this.num_of_rows,num_of_columns:this.num_of_columns,wall_thiccness:this.wall_thiccness,squares:t}}loadLayout(t){if(!(!t||!t.squares)){this.num_of_rows=t.num_of_rows||this.num_of_rows,this.num_of_columns=t.num_of_columns||this.num_of_columns,this.wall_thiccness=t.wall_thiccness||this.wall_thiccness;for(var e=0;e<this.squares.length&&e<t.squares.length;e++)for(var i=0;i<this.squares[e].length&&i<t.squares[e].length;i++){var r=this.squares[e][i],n=t.squares[e][i]||{};r.north&&(r.north.isActive=!!n.north),r.south&&(r.south.isActive=!!n.south),r.east&&(r.east.isActive=!!n.east),r.west&&(r.west.isActive=!!n.west)}}}serializeState(){return this.captureState()}captureState(){var t=this,e=this.tanks.map(function(o,h){return t.cloneTankState({id:o.id||"tank-"+h,colour:o.colour,ownerPeerId:o.ownerPeerId,x:o.x,y:o.y,rotation:o.rotation,score:o.score,is_dead:o.is_dead,width:o.width,height:o.height,bullets:o.bullets.map(function(l){return{x:l.x,y:l.y,radius:l.radius,colour:o.colour}}),powerups:o.powerups.map(function(l){return l.serialize?l.serialize():{name:l.name,type:l.constructor&&l.constructor.name?l.constructor.name:l.name,spriteId:l.img&&l.img.id?l.img.id:null}})})}),i=this.serializeBoardPowerups(),r={message:this.message,tanks:e,powerups:i,events:this.consumePendingEvents?this.consumePendingEvents():[]};try{this.state.tanks={};for(var n=0;n<e.length;n++){var a=e[n];this.state.tanks[a.id]={id:a.id,x:a.x,y:a.y,rotation:a.rotation,width:a.width,height:a.height,colour:a.colour,score:a.score,is_dead:a.is_dead,powerups:(a.powerups||[]).map(function(o){return{type:o.type||o.name,spriteId:o.spriteId||null}})}}}catch{}return r}serializeBoardPowerups(){for(var t=[],e=0;e<this.powerups.length;e++){var i=this.powerups[e];if(i){i.id||(i.id="powerup-"+this.nextPowerupId++),t.push({id:i.id,type:i.constructor&&i.constructor.name?i.constructor.name:i.name,name:i.name,x:i.x,y:i.y,width:i.width,height:i.height,spriteId:i.img&&i.img.id?i.img.id:null,color:i.color||"#ffffff"});try{this.state&&(this.state.powerups[i.id]={id:i.id,type:t[t.length-1].type,x:i.x,y:i.y,width:i.width,height:i.height})}catch{}}}return t}cloneTankState(t){return JSON.parse(JSON.stringify(t))}clonePowerupState(t){return JSON.parse(JSON.stringify(t))}clonePowerupList(t){var e=this,i=Array.isArray(t)?t:[];return i.map(function(r){return e.clonePowerupState(r)})}cloneSnapshot(t){if(!t)return{message:"",tanks:[],powerups:[],events:[]};var e=Array.isArray(t.tanks)?t.tanks:[],i=this;return{message:t.message,tanks:e.map(function(r){return i.cloneTankState(r)}),powerups:i.clonePowerupList(t.powerups),events:[]}}collectRemoteTankMeta(){var t=[];if(!this.remoteTankMap)return t;for(var e in this.remoteTankMap)Object.prototype.hasOwnProperty.call(this.remoteTankMap,e)&&t.push(this.remoteTankMap[e]);return t}buildStatePacket(){var t=this.captureState(),e=null;if(!this.lastSnapshot)e={type:"state-init",state:t};else{var i=this.diffSnapshots(this.lastSnapshot,t);i&&(e={type:"state-delta",delta:i})}return this.lastSnapshot=this.cloneSnapshot(t),e}buildUnifiedDeltaPacket(){try{var t=this._lastUnifiedState||{tanks:{},powerups:{}},e=this.serializeUnifiedDelta(t);return this._lastUnifiedState=JSON.parse(this.serializeUnifiedSnapshot()),"V,"+e}catch{return null}}serializeUnifiedSnapshot(){try{return JSON.stringify({tanks:this.state.tanks||{},powerups:this.state.powerups||{}})}catch{return"{}"}}applyUnifiedSnapshot(t){try{var e=typeof t=="string"?JSON.parse(t):t||{};this.state.tanks=e.tanks||{},this.state.powerups=e.powerups||{},this.remoteTankMap={};for(var i in this.state.tanks)Object.prototype.hasOwnProperty.call(this.state.tanks,i)&&(this.remoteTankMap[i]=this.state.tanks[i]);this.remoteTankMeta=this.collectRemoteTankMeta(),typeof this.recomputeGlobalPowerups=="function"&&this.recomputeGlobalPowerups()}catch{}}serializeUnifiedDelta(t){var e={tanks:{set:{},del:[]},powerups:{set:{},del:[]}};try{var i=t&&t.tanks||{},r=this.state.tanks||{};for(var n in r)if(Object.prototype.hasOwnProperty.call(r,n)){var a=JSON.stringify(i[n]||null),o=JSON.stringify(r[n]);a!==o&&(e.tanks.set[n]=r[n])}for(var h in i)Object.prototype.hasOwnProperty.call(i,h)&&(Object.prototype.hasOwnProperty.call(r,h)||e.tanks.del.push(h));var l=t&&t.powerups||{},c=this.state.powerups||{};for(var p in c)if(Object.prototype.hasOwnProperty.call(c,p)){var d=JSON.stringify(l[p]||null),f=JSON.stringify(c[p]);d!==f&&(e.powerups.set[p]=c[p])}for(var y in l)Object.prototype.hasOwnProperty.call(l,y)&&(Object.prototype.hasOwnProperty.call(c,y)||e.powerups.del.push(y))}catch{}return JSON.stringify(e)}applyUnifiedDelta(t){try{var e=typeof t=="string"?JSON.parse(t):t||{},i=e.tanks||{},r=e.powerups||{};this.state.tanks=this.state.tanks||{},(i.del||[]).forEach(l=>{delete this.state.tanks[l],delete this.remoteTankMap[l]});var n=i.set||{};for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(this.state.tanks[a]=n[a],this.remoteTankMap[a]=n[a]);this.state.powerups=this.state.powerups||{},(r.del||[]).forEach(l=>{delete this.state.powerups[l]});var o=r.set||{};for(var h in o)Object.prototype.hasOwnProperty.call(o,h)&&(this.state.powerups[h]=o[h]);this.remoteTankMeta=this.collectRemoteTankMeta(),typeof this.recomputeGlobalPowerups=="function"&&this.recomputeGlobalPowerups()}catch{}}serializeInitString(){var t=this.settings||{},e=this.num_of_rows||t.num_of_rows||0,i=this.num_of_columns||t.num_of_columns||0,r=this.wall_thiccness||t.wall_thiccness||0,n=+(t.move_speed!=null?t.move_speed:0),a=+(t.rotation_speed!=null?t.rotation_speed:0),o=+(t.bullet_speed!=null?t.bullet_speed:0),h=+(t.bullet_limit!=null?t.bullet_limit:0),l=+(t.bounce_limit!=null?t.bounce_limit:0),c=+(t.powerup_interval!=null?t.powerup_interval:0),p=+(t.powerup_limit!=null?t.powerup_limit:0),d=+(t.powerup_duration!=null?t.powerup_duration:0),f=t.friendly_fire?1:0,y=this.serializeLayout?this.serializeLayout():null,m=y?btoa(unescape(encodeURIComponent(JSON.stringify(y)))):"",w=(this.powerups||[]).map(function(v){if(!v)return"";var b=Math.round(v.x)||0,P=Math.round(v.y)||0,k=Math.round(v.width)||0,U=Math.round(v.height)||0,T=v.img&&v.img.id?v.img.id:"",F=(v.color||"").replace(/[,|;]/g,"");return[b,P,k,U,T,F].join("|")}).filter(Boolean).join(";"),_=(this.tanks||[]).map(function(v,b){if(!v)return"";var P=v.id||"tank-"+b,k=Math.round(v.x)||0,U=Math.round(v.y)||0,T=+(v.rotation||0).toFixed(4),F=Math.round(v.width)||0,L=Math.round(v.height)||0,M=(v.colour||"").replace(/[,|;]/g,""),D=+(v.score||0);return[P,k,U,T,F,L,M,D].join("|")}).filter(Boolean).join(";");return["I",e,i,r,n,a,o,h,l,c,p,d,f,m,w,_].join(",")}serializeDeltaString(){var t=(this.tanks||[]).map(function(f,y){if(!f)return"";var m=f.id||"tank-"+y,w=Math.round(f.x)||0,_=Math.round(f.y)||0,v=+(f.rotation||0).toFixed(4),b=+(f.score||0),P=f.is_dead?0:1;return[m,w,_,v,b,P].join("|")}).filter(Boolean).join(";"),e=[];(this.tanks||[]).forEach(function(f){(f.bullets||[]).forEach(function(y){var m=+(y.direction&&y.direction[0]||0).toFixed(3),w=+(y.direction&&y.direction[1]||0).toFixed(3),_=(f.colour||"").replace(/[,|;]/g,""),v=Math.round(y.radius||1);e.push([Math.round(y.x)||0,Math.round(y.y)||0,m,w,_,v].join("|"))})});var i=(this.powerups||[]).map(function(f){if(!f)return"";var y=Math.round(f.x)||0,m=Math.round(f.y)||0,w=Math.round(f.width)||0,_=Math.round(f.height)||0,v=f.img&&f.img.id?f.img.id:"",b=(f.color||"").replace(/[,|;]/g,"");return[y,m,w,_,v,b].join("|")}).filter(Boolean).join(";"),r=this.consumePendingEvents(),n="";if(r&&r.length){for(var a=[],o=0;o<r.length;o++){var h=r[o];if(h){var l=(h.powerup||"").replace(/[,|;]/g,""),c=(h.status||"").replace(/[,|;]/g,""),p=(h.target||"").replace(/[,|;]/g,""),d=(h.tankId||"").replace(/[,|;]/g,"");a.push([l,c,p,d].join("|"))}}n=a.join(";")}return["D",t,e.join(";"),i,n].join(",")}applyInitString(t){if(!(typeof t!="string"||!t||t[0]!=="I")){var e=t.split(","),i=function(P){var k=parseInt(P,10);return isNaN(k)?0:k},r=function(P){var k=parseFloat(P);return isNaN(k)?0:k};this.num_of_rows=i(e[1]),this.num_of_columns=i(e[2]),this.wall_thiccness=i(e[3]),this.settings.move_speed=r(e[4]),this.settings.rotation_speed=r(e[5]),this.settings.bullet_speed=r(e[6]),this.settings.bullet_limit=i(e[7]),this.settings.bounce_limit=i(e[8]),this.settings.powerup_interval=r(e[9]),this.settings.powerup_limit=i(e[10]),this.settings.powerup_duration=r(e[11]),this.settings.friendly_fire=e[12]==="1";var n=null;try{var a=e[13]||"";if(a){var o=decodeURIComponent(escape(atob(a)));n=JSON.parse(o)}}catch{n=null}this._buildGridEdges(),this.squares=[];for(var h=0;h<this.num_of_rows;h++){for(var l=[],c=0;c<this.num_of_columns;c++)l.push(new jt(this,h,c));this.squares.push(l)}this._initWalls(),n&&n.squares&&this.loadLayout&&this.loadLayout(n),this.remotePowerups=[];var p=e[14]||"";if(p)for(var d=p.split(";"),f=0;f<d.length;f++){var y=d[f];if(y){var m=y.split("|");this.remotePowerups.push({x:parseInt(m[0],10)||0,y:parseInt(m[1],10)||0,width:parseInt(m[2],10)||0,height:parseInt(m[3],10)||0,spriteId:m[4]||"",color:m[5]||"#ffffff"})}}this.remoteTankMap={};var w=e[15]||"";if(w)for(var _=w.split(";"),v=0;v<_.length;v++){var y=_[v];if(y){var m=y.split("|"),b=m[0];this.remoteTankMap[b]={id:b,x:i(m[1]),y:i(m[2]),rotation:r(m[3]),width:i(m[4]),height:i(m[5]),colour:m[6]||"#ffffff",score:i(m[7])}}}this.remoteTankMeta=this.collectRemoteTankMeta(),this.remoteState={tanks:this.remoteTankMeta,powerups:this.remotePowerups},this.recomputeGlobalPowerups&&this.recomputeGlobalPowerups(),this.prerenderBackground(),this.message="Awaiting host updates..."}}applyDeltaString(t){if(!(typeof t!="string"||!t||t[0]!=="D")){var e=t.split(","),i=function(dt){var tt=parseInt(dt,10);return isNaN(tt)?0:tt},r=function(dt){var tt=parseFloat(dt);return isNaN(tt)?0:tt},n=1;e.length>=6&&(n=2);var a=e[n]||"";if(a)for(var o=a.split(";"),h=0;h<o.length;h++){var l=o[h];if(l){var c=l.split("|"),p=c[0],d=this.remoteTankMap&&this.remoteTankMap[p]?this.remoteTankMap[p]:{id:p};if(d.x=i(c[1]),d.y=i(c[2]),d.rotation=r(c[3]),d.score=i(c[4]),c.length>5&&c[5]!==""){var f=i(c[5]);d.is_dead=f===0}else typeof d.is_dead!="boolean"&&(d.is_dead=!1);this.remoteTankMap[p]=d}}this.remoteTankMeta=this.collectRemoteTankMeta();try{if(this.settings&&this.settings.friendly_fire)for(var y=this.remoteTankMeta||[],m=this.remoteGlobalBullets||[],w=0;w<y.length;w++){var _=y[w];if(!(!_||_.is_dead))for(var v=_.x,b=_.y,P=_.width||this.width/this.num_of_columns/3,k=_.height||this.height/this.num_of_rows/3,U=0;U<m.length;U++){var T=m[U];if(T&&!(T.colour&&_.colour&&T.colour===_.colour)){var F=T.radius||1,L=T.x-F,M=T.y-F,D=F*2,Q=F*2;if(ft([v,b,P,k],[L,M,D,Q])){_.is_dead=!0;var O=this.remoteTankMap&&this.remoteTankMap[_.id];O&&(O.is_dead=!0);break}}}}}catch{}var st=[],It=e[n+1]||"";if(It)for(var At=It.split(";"),St=0;St<At.length;St++){var pt=At[St];if(pt){var G=pt.split("|");st.push({x:i(G[0]),y:i(G[1]),vx:r(G[2]),vy:r(G[3]),colour:G[4]||"#000000",radius:i(G[5])||1})}}this.remoteGlobalBullets=st;var j=[],mt=e[n+2]||"";if(mt)for(var vt=mt.split(";"),nt=0;nt<vt.length;nt++){var gt=vt[nt];if(gt){var z=gt.split("|");j.push({x:i(z[0]),y:i(z[1]),width:i(z[2]),height:i(z[3]),spriteId:z[4]||"",color:z[5]||"#ffffff"})}}this.remotePowerups=j,this.remoteState={tanks:this.remoteTankMeta,powerups:this.remotePowerups};var lt=e[n+3]||"";if(lt)for(var Ct=lt.split(";"),Z=0;Z<Ct.length;Z++){var yt=Ct[Z];if(yt){var ct=yt.split("|"),ut={type:"powerup",powerup:ct[0]||"",status:ct[1]||"",target:ct[2]||"",tankId:ct[3]||""};this.applyPowerupEvent(ut)}}}}diffSnapshots(t,e){t=t||{},e=e||{};var i={},r=Array.isArray(t.tanks)?t.tanks:[],n=Array.isArray(e.tanks)?e.tanks:[],a=Array.isArray(t.powerups)?t.powerups:[],o=Array.isArray(e.powerups)?e.powerups:[];e.message!==t.message&&(i.message=e.message);var h=[],l={},c={};r.forEach(function(v,b){if(v){var P=v.id?v.id:"tank-"+b;l[P]=v}}),n.forEach(function(v,b){if(v){var P=v.id?v.id:"tank-"+b;c[P]=v}});var p=this;for(var d in c){var f=c[d],y=l[d];(!y||p.hasTankChanged(y,f))&&h.push(f)}h.length&&(i.tanks=h);var m=[];for(var w in l)c[w]||m.push(w);m.length&&(i.removedTanks=m),this.haveBoardPowerupsChanged(a,o)&&(i.powerups=this.clonePowerupList(o));var _=Array.isArray(e.events)?e.events:[];return _.length&&(i.events=_),Object.keys(i).length?i:null}hasTankChanged(t,e){return!t||!e?t!==e:!!(t.x!==e.x||t.y!==e.y||t.rotation!==e.rotation||t.colour!==e.colour||t.ownerPeerId!==e.ownerPeerId||t.width!==e.width||t.height!==e.height||t.score!==e.score||!!t.is_dead!=!!e.is_dead||this.haveBulletsChanged(t.bullets,e.bullets)||this.havePowerupsChanged(t.powerups,e.powerups))}haveBulletsChanged(t,e){if(t=t||[],e=e||[],t.length!==e.length)return!0;for(var i=0;i<t.length;i++){var r=t[i],n=e[i];if(r.x!==n.x||r.y!==n.y||r.radius!==n.radius)return!0}return!1}syncGlobalPowerups(){this.recomputeGlobalPowerups()}recomputeGlobalPowerups(){try{for(var t=this.remoteTankMeta||[],e=0,i=0;i<t.length;i++){var r=t[i];if(!(!r||!r.powerups))for(var n=0;n<r.powerups.length;n++){var a=r.powerups[n],o=(a&&(a.type||a.name||""))+"";if(/Trippy/i.test(o)){e++;break}}}this.trippyCount=e}catch{}}havePowerupsChanged(t,e){if(t=t||[],e=e||[],t.length!==e.length)return!0;for(var i=0;i<t.length;i++){var r=t[i],n=e[i];if((r&&r.type)!==(n&&n.type))return!0}return!1}haveBoardPowerupsChanged(t,e){if(t=Array.isArray(t)?t:[],e=Array.isArray(e)?e:[],t.length!==e.length)return!0;var i={};t.forEach(function(h,l){if(h){var c=h.id||"powerup-"+l;i[c]=h}});for(var r=0;r<e.length;r++){var n=e[r];if(!n)return!0;var a=n.id||"powerup-"+r,o=i[a];if(!o||o.x!==n.x||o.y!==n.y||o.width!==n.width||o.height!==n.height||(o.spriteId||null)!==(n.spriteId||null)||(o.type||null)!==(n.type||null)||(o.color||null)!==(n.color||null))return!0}return!1}getCachedSnapshot(){if(this.lastSnapshot)return this.cloneSnapshot(this.lastSnapshot);var t=this.captureState();return this.lastSnapshot=this.cloneSnapshot(t),t}applyInputState(t){if(!(!t||!t.tankId)){var e=this.tankById?this.tankById[t.tankId]:null;e&&e.applyNetworkInput({upPressed:!!t.upPressed,downPressed:!!t.downPressed,leftPressed:!!t.leftPressed,rightPressed:!!t.rightPressed,shooting:!!t.shooting,specialKeyPressed:!!t.specialKeyPressed})}}broadcastState(){if(!(!g||!g.isHost||!g.connections||g.connections.length===0)){var t=performance.now();if(!(this.lastSnapshot&&t-this.lastStateBroadcast<30)){var e=this.buildStatePacket();if(e){this.lastStateBroadcast=t;try{e.type==="state-init"?g.broadcast(this.serializeInitString()):e.type==="state-delta"&&g.broadcast(this.serializeDeltaString())}catch{}}}}}drawSpectator(){if(this.drawScoreboardTop(),!((this.trippyCount||0)>0))try{typeof u.setTransform=="function"&&u.setTransform(1,0,0,1,0,0),this.drawBackground()}catch{}if(u.save(),u.translate(0,this.scoreboardHeight),u.translate(this.wall_thiccness/2,this.wall_thiccness/2),!((this.trippyCount||0)>0)){u.fillStyle="black";for(var t=0;t<this.walls.length;t++){var e=this.walls[t];e.isActive&&u.fillRect(e.x,e.y,e.width,e.height)}}var i=null;if(this.state&&this.state.powerups&&Object.keys(this.state.powerups).length?i=Object.values(this.state.powerups):i=this.remoteState&&this.remoteState.powerups?this.remoteState.powerups:this.remotePowerups,i&&i.length)for(var r=0;r<i.length;r++)this.drawRemotePowerup(i[r]);if(this.remoteGlobalBullets&&this.remoteGlobalBullets.length)for(var n=0;n<this.remoteGlobalBullets.length;n++){var a=this.remoteGlobalBullets[n];this.drawRemoteBullet({x:a.x,y:a.y,radius:a.radius||1,colour:a.colour||"#000000"})}var o=this.remoteState&&this.remoteState.tanks?this.remoteState.tanks:this.remoteTankMeta;if(o)for(var t=0;t<o.length;t++){var h=o[t];this.drawRemoteTank(h);var l=h&&h.id,c=l&&this.teleportMirrors&&this.teleportMirrors[l]||h&&h.powerups&&h.powerups.some(function(d){return d&&d.type==="TeleportPowerup"});c&&this.drawTeleportMirrorState(h)}u.restore(),u.font="15px Verdana",u.fillStyle="black",u.fillText(this.message||"",S.width/2,this.scoreboardHeight+this.height+20)}drawRemotePowerup(t){if(t){var e=t.width||20,i=t.height||20,r=t.x||0,n=t.y||0,a=t.spriteId?document.getElementById(t.spriteId):null;if(a){var o=u.imageSmoothingEnabled;u.imageSmoothingEnabled=!0,u.drawImage(a,r,n,e,i),u.imageSmoothingEnabled=o;return}u.lineWidth=1,u.strokeStyle=t.color||"#ffffff",u.strokeRect(r,n,e,i)}}drawRemoteTank(t){if(t&&!t.is_dead){var e=t.width||this.width/this.num_of_columns/3,i=t.height||this.height/this.num_of_rows/3;u.save(),u.translate(t.x+e/2,t.y+i/2),u.rotate(t.rotation||0);var r=document.getElementById("tank");if(r){var n=u.imageSmoothingEnabled;u.imageSmoothingEnabled=!0,u.drawImage(r,-e/2,-i/2,e,i),u.imageSmoothingEnabled=n}else u.fillStyle=t.colour||"#ffffff",u.fillRect(-e/2,-i/2,e,i);u.restore()}}drawRemoteBullet(t){if(t){u.beginPath();var e=typeof t.radius=="number"&&t.radius>0?t.radius:1,i=t.colour||"#000000";u.fillStyle="#000000",u.strokeStyle=i,u.lineWidth=1,u.arc(t.x,t.y,e,0,2*Math.PI),u.fill(),u.stroke()}}drawTeleportMirrorState(t){var e=t.width||this.width/this.num_of_columns/3,i=t.height||this.height/this.num_of_rows/3;u.save(),u.translate(S.width-(t.x+e/2),this.height-(t.y+i/2)),u.rotate(t.rotation||0);var r=u.globalAlpha;u.globalAlpha=.3;var n=document.getElementById("tank");if(n){var a=u.imageSmoothingEnabled;u.imageSmoothingEnabled=!0,u.drawImage(n,-e/2,-i/2,e,i),u.imageSmoothingEnabled=a}else u.fillStyle=t.colour||"#ffffff",u.fillRect(-e/2,-i/2,e,i);u.globalAlpha=r,u.restore()}tryAddPowerupAndRepeat(){if(!this.spectator){if(this.powerups.length!=this.settings.powerup_limit){this.powerups.length>=this.settings.powerup_limit&&this.powerups.shift();var t=fe(this);this.placeObject(t),this.addPowerup(t),this.message=t.getMessage()}setTimeout(this.tryAddPowerupAndRepeat.bind(this),this.settings.powerup_interval*1e3,this)}}addPowerup(t){if(t){t.id||(t.id="powerup-"+this.nextPowerupId++),this.powerups.push(t),t.registerDelegate&&t.registerDelegate(this.broadcastPowerupEvent.bind(this));try{if(g&&g.isHost){var e=t.constructor&&t.constructor.name?t.constructor.name:t.name||"",i=t.img&&t.img.id?t.img.id:"",r=(t.color||"").replace(/[|]/g,""),n=[e,t.id,Math.round(t.x)||0,Math.round(t.y)||0,Math.round(t.width)||0,Math.round(t.height)||0,i,r].join("|");g.broadcast(["S",n].join(","))}}catch{}}}removePowerup(t){this.powerups.splice(this.powerups.indexOf(t),1)}broadcastPowerupEvent(t){if(t){this.pendingPowerupEvents||(this.pendingPowerupEvents=[]),this.pendingPowerupEvents.push(t);try{if(this.game&&this.game.peer_manager&&this.game.peer_manager.isHost&&typeof this.buildUnifiedDeltaPacket=="function"){var e=this.buildUnifiedDeltaPacket();e&&typeof this.game.peer_manager.broadcast=="function"&&this.game.peer_manager.broadcast(e)}}catch{}}}consumePendingEvents(){var t=this.pendingPowerupEvents||[];return this.pendingPowerupEvents=[],t}applyPowerupEvent(t){if(t){var e=null;if(t.tankId&&this.tankById&&(e=this.tankById[t.tankId]||null),t.powerup==="TeleportPowerup"&&t.tankId&&(this.teleportMirrors||(this.teleportMirrors={}),t.status==="activate"?this.teleportMirrors[t.tankId]=!0:t.status==="deactivate"&&delete this.teleportMirrors[t.tankId]),t.tankId){this.state=this.state||{tanks:{},powerups:{},meta:{nextPowerupId:0}};var i=this.state.tanks[t.tankId]||(this.state.tanks[t.tankId]={id:t.tankId,powerups:[]});if(t.status==="activate"){var r=this.resolvePowerupSpriteId(t.powerup);i.powerups=r?[{type:t.powerup,spriteId:r}]:[{type:t.powerup}]}else t.status==="deactivate"&&(i.powerups=[]);if(this.remoteTankMap){var n=this.remoteTankMap[t.tankId]||(this.remoteTankMap[t.tankId]={id:t.tankId});n.powerups=(i.powerups||[]).slice(),this.remoteTankMeta=this.collectRemoteTankMeta(),this.remoteState={tanks:this.remoteTankMeta,powerups:this.remotePowerups}}typeof this.recomputeGlobalPowerups=="function"&&this.recomputeGlobalPowerups()}var a=null;if(t.powerupId&&this.powerups)for(var o=0;o<this.powerups.length;o++){var h=this.powerups[o];if(h&&h.id===t.powerupId){a=h;break}}if(!a&&this.powerups)for(var l=0;l<this.powerups.length;l++){var c=this.powerups[l];if(c&&String(c.id)===String(t.powerupId)){a=c;break}}if(t.status==="activate"){if(a){if(typeof a.pickup=="function"){a.pickup(e||t.tankId||"");return}if(typeof a.onBulletHit=="function"&&e){a.onBulletHit(e);return}if(typeof a.effect=="function"){a.effect(e);return}}return}if(t.status==="deactivate"){if(e&&Array.isArray(e.powerups))for(var p=0;p<e.powerups.length;p++){var d=e.powerups[p],f=d&&d.constructor&&d.constructor.name?d.constructor.name:d&&d.name;f===t.powerup&&(typeof d.teardown=="function"?d.teardown():typeof d.undo=="function"&&d.undo(e))}a&&(typeof a.teardown=="function"?a.teardown():typeof a.undo=="function"&&a.undo(e));return}}}resolvePowerupSpriteId(t){var e=String(t||"");return/Trippy/i.test(e)?"pills":/Remove\s*Bullet\s*Limit|RemoveBulletLimit/i.test(e)?"unlimited":/Triple\s*-?Shot|TripleShot/i.test(e)?"tripleshot":/MoveThroughWalls|ghost/i.test(e)?"ghost":/Teleport/i.test(e)?"teleport":/Cannon(ball)?/i.test(e)?"cannonball":/Invis/i.test(e)?"invisible":/Shinra/i.test(e)?"repel":/Hex/i.test(e)?"hex":null}addTank(t){this.tanks.push(t)}onclick(t,e){}};var ye=class{constructor({x:t=0,y:e=0,width:i=0,height:r=0,visible:n=!0}={}){this.x=t,this.y=e,this.width=i,this.height=r,this.visible=n,this.children=[],this.parent=null}addChild(t){return t?(t.parent&&t.parent.removeChild(t),t.parent=this,this.children.push(t),t):null}removeChild(t){let e=this.children.indexOf(t);e!==-1&&(t.parent=null,this.children.splice(e,1))}setChildren(t){this.children.slice().forEach(e=>this.removeChild(e)),(t||[]).forEach(e=>this.addChild(e))}containsPoint(t,e){return this.visible&&t>=this.x&&e>=this.y&&t<=this.x+this.width&&e<=this.y+this.height}draw(t){this.visible&&(this.drawSelf(t),this.children.forEach(e=>e.draw(t)))}drawSelf(t){}dispatchClick(t,e){if(!this.containsPoint(t,e))return!1;for(let i=this.children.length-1;i>=0;i--)if(this.children[i].dispatchClick(t,e))return!0;return this.handleClick(t,e)}handleClick(){return!1}},Nt=ye;var we=class extends Nt{constructor(t){super({x:0,y:0,width:S.width/5,height:S.height}),this.colour=t,this.buttons=[],this.north_border=5,this.east_border=5/2,this.south_border=5,this.west_border=5/2}addButton(t){this.buttons.push(t),this.addChild(t)}},Ut=we;var _e=class extends Nt{constructor(t,e=0,i=0,r=""){super({x:0,y:i,width:t&&t.width?t.width/1.5:0,height:28}),this.text=r,this.panel=t}get_as_Rect(){return[this.x,this.y,this.width,this.height]}update(){}resize_horiontals(){}center_horizontally(){}center_vertically(){}handleClick(){return this.onclick?(this.onclick(),!0):!1}},rt=_e;var ke=class extends rt{constructor(t,e,i,r,n=""){super(t,e,i,r+": "),this.control=r+": ",this.value=n,this.panel.addButton(this)}keyDownHandler(t){this.value=t,this.panel&&this.panel.pregame&&typeof this.panel.pregame.emitTankConfig=="function"&&this.panel.pregame.emitTankConfig()}onclick(){this.panel.pregame.focus=this}},Lt=ke;var xe=class extends Ut{constructor(t,e="green",i=void 0){super(e),this.panelId="panel-"+Math.random().toString(36).slice(2,8),this.pregame=t;var r=new rt(this,0,this.height*10/12,"delete");r.onclick=function(){this.pregame.removeTankPanel(this)}.bind(this),this.addButton(r),r.center_horizontally();for(var n=["up","right","down","left","attack","special"],a=0;a<n.length;a++){var o=new Lt(this,0,this.height*(3+a)/12,n[a],i?i[a]:void 0);o.center_horizontally()}this.pregame&&typeof this.pregame.emitTankConfig=="function"&&this.pregame.emitTankConfig()}},zt=xe;var be=class{constructor(t,e,i,r,n=1){this.tank=t,this.direction=e,this.x=i,this.y=r,this.radius=n,this.bounces=0,this.time_created=t.maze.tick}main(){this.handleMovement(),this.handleTankCollisions(),this.handlePowerupCollisions()}draw(){u.beginPath(),u.fillStyle="black",u.strokeStyle=this.tank.colour,u.lineWidth=1,u.arc(this.x,this.y,this.radius,0,2*Math.PI),u.fill(),u.stroke()}handleMovement(){this.tank.maze.doesRectCollide([this.x-this.radius+this.direction[0],this.y-this.radius,this.radius,this.radius])?(this.direction[0]*=-1,this.bounces+=1):this.x+=this.direction[0],this.tank.maze.doesRectCollide([this.x-this.radius,this.y-this.radius+this.direction[1],this.radius,this.radius])?(this.direction[1]*=-1,this.bounces+=1):this.y+=this.direction[1],this.bounces>=this.tank.bounce_limit&&this.tank.removeBullet(this)}handleTankCollisions(){this.tank.maze.tanks.forEach(function(t){if(!(t==this.tank&&this.tank.maze.settings.friendly_fire==!1)&&t.is_dead==!1){var e=[this.x-this.radius,this.y-this.radius,this.radius*2,this.radius*2],i=[t.x,t.y,t.width,t.height];if(ft(i,e)){if(t==this.tank&&this.tank.maze.tick-this.time_created<10)return;debugger;t.onBulletHit()}}}.bind(this))}handlePowerupCollisions(){this.tank.maze.powerups.forEach(function(t){var e=[this.x-this.radius,this.y-this.radius,this.radius*2,this.radius*2],i=[t.x,t.y,t.width,t.height];ft(i,e)&&t.onBulletHit(this.tank)}.bind(this))}},ei=be;var ii=20,Pe=["up","right","down","left","fire","special"];function te(){return{up:!1,right:!1,down:!1,left:!1,fire:!1,special:!1}}function Ie(s,t){return{x:Math.sin(s)*t,y:-Math.cos(s)*t}}var Se=class{constructor(t,e,i,r,n="black",a){this.x=t,this.y=e,this.maze=i,this.colour=n,this.powerups=[],this.maze.tanks.push(this);let o=a||{};this.disableInput=!!o.disableInput;let h=this.maze.squares[0][0];this.width=this.maze.width/this.maze.num_of_columns/3,this.height=this.maze.height/this.maze.num_of_rows/3,this.rotation=0,this.bullets=[],this.bullet_limit=this.maze.settings.bullet_limit,this.bounce_limit=this.maze.settings.bounce_limit,this.score=0,this.is_dead=!1,this.poweruplock=!1,this.move_speed=this.maze.settings.move_speed*Math.min(h.width,h.height)/60*.8,this.rotation_speed=this.maze.settings.rotation_speed*1.2,this.localInput=te(),this.networkInput=te(),this.activePowerups=[],this.pendingPowerupUpdates=!1,this.fireWasActive=!1,this.upPressed=!1,this.rightPressed=!1,this.downPressed=!1,this.leftPressed=!1,this.shooting=!1,this.specialKeyPressed=!1,this.hasFiredThisPress=!1,this.special=function(){},this.rechargeDuration=this.maze&&this.maze.settings&&typeof this.maze.settings.recharge_duration=="number"?this.maze.settings.recharge_duration:ii,this.setControls(r)}setControls(t){this.controls=Array.isArray(t)?t.slice(0,Pe.length):[]}setLocalAction(t,e){Object.prototype.hasOwnProperty.call(this.localInput,t)&&this.localInput[t]!==e&&(this.localInput[t]=e,t==="special"&&!e&&(this.poweruplock=!1),t==="fire"&&(e||(this.hasFiredThisPress=!1)),this.syncDerivedInput())}applyNetworkInput(t){t&&(Pe.forEach((e,i)=>{let r=e==="fire"?"shooting":e==="special"?"specialKeyPressed":`${e}Pressed`;e==="fire"&&typeof t.shooting=="boolean"?this.networkInput.fire=t.shooting:e==="special"&&typeof t.specialKeyPressed=="boolean"?(this.networkInput.special=t.specialKeyPressed,t.specialKeyPressed||(this.poweruplock=!1)):typeof t[r]=="boolean"&&(this.networkInput[e]=t[r])}),this.syncDerivedInput(),this.pendingPowerupUpdates=!0)}syncDerivedInput(){this.upPressed=this.isActionActive("up"),this.rightPressed=this.isActionActive("right"),this.downPressed=this.isActionActive("down"),this.leftPressed=this.isActionActive("left"),this.shooting=this.isActionActive("fire"),this.specialKeyPressed=this.isActionActive("special"),this.shooting||(this.fireWasActive=!1,this.hasFiredThisPress=!1),this.specialKeyPressed||(this.poweruplock=!1)}isActionActive(t){return!!(this.localInput[t]||this.networkInput[t])}actionForKey(t){let e=this.controls?this.controls.indexOf(t):-1;return e>=0?Pe[e]:null}setLocalActionForKey(t,e){let i=this.actionForKey(t);i&&this.setLocalAction(i,e)}main(){this.is_dead||(this.shouldFire()&&this.fire(),this.isActionActive("special")&&this.special()),this.bullets.forEach(t=>t.main()),this.is_dead||this.handleMovement()}draw(){this.drawBullets(),!this.is_dead&&this.drawBody()}drawBullets(){this.bullets.forEach(t=>t.draw())}drawBody(){if(!this.img){var t=document.getElementById("tank");t&&t.tagName==="IMG"&&t.complete&&t.naturalWidth>0&&(this.img=t)}if(u.save(),u.translate(this.x+this.width/2,this.y+this.height/2),u.rotate(this.rotation),this.img&&this.img.tagName==="IMG"&&this.img.complete&&this.img.naturalWidth>0){var e=u.imageSmoothingEnabled;u.imageSmoothingEnabled=!0,u.drawImage(this.img,-this.width/2,-this.height/2,this.width,this.height),u.imageSmoothingEnabled=e}else u.fillStyle=this.colour,u.fillRect(-this.width/2,-this.height/2,this.width,this.height);u.restore()}getPowerupState(){if(this.pendingPowerupUpdates){this.pendingPowerupUpdates=!1;var t=this.powerups.map(function(e){return e.name});return{tankId:this.id,powerups:t}}}shouldFire(){return this.isActionActive("fire")?this.hasFiredThisPress||this.bullets.length>=this.bullet_limit||this.isWithinRechargeWindow()?!1:(this.hasFiredThisPress=!0,this.fireWasActive=!0,!0):(this.fireWasActive=!1,!1)}isWithinRechargeWindow(){var t=typeof this.rechargeDuration=="number"?this.rechargeDuration:ii;if(!t||t<=0||!Array.isArray(this.bullets)||this.bullets.length===0)return!1;for(var e=this.maze&&typeof this.maze.tick=="number"?this.maze.tick:0,i=0;i<this.bullets.length;i++){var r=this.bullets[i];if(!(!r||r.time_created==null)){var n=e-r.time_created;if(n>0&&n<t)return!0}}return!1}fire(){this.fireHelper(this.rotation,this.maze.settings.bullet_speed)}fireHelper(t,e){let i=Ie(t,e),r=this.x+this.width/2,n=this.y+this.height/2,a=1,o=r+Math.sin(t),h=n-Math.cos(t),l=new ei(this,[i.x,i.y],o,h,a);this.bullets.push(l)}fire_helper(t,e){this.fireHelper(t,e)}handleMovement(){if(this.isActionActive("right")&&(this.rotation+=this.rotation_speed),this.isActionActive("left")&&(this.rotation-=this.rotation_speed),this.isActionActive("up")){let t=Ie(this.rotation,this.move_speed);this.tryMovingTo([this.x+t.x,this.y]),this.tryMovingTo([this.x,this.y+t.y])}if(this.isActionActive("down")){let t=Ie(this.rotation,-this.move_speed);this.tryMovingTo([this.x+t.x,this.y]),this.tryMovingTo([this.x,this.y+t.y])}}tryMovingTo(t){if(this.maze.doesRectCollide([this.x,this.y,this.width,this.height])){let i=this.maze.getSquareAtXY([this.x,this.y]).getCenter();this.x=i[0],this.y=i[1]}if(!this.maze.doesRectCollide([t[0],t[1],this.width,this.height])){this.x=t[0],this.y=t[1];return}if(!this.maze.doesRectCollide([t[0],this.y,this.width,this.height])){this.x=t[0];return}if(!this.maze.doesRectCollide([this.x,t[1],this.width,this.height])){this.y=t[1];return}let e=this.maze.getSquareAtXY([this.x,this.y]).getCenter();this.x=e[0],this.y=e[1]}keyDownHandler(t){if(this.disableInput)return;let e=typeof t=="string"?t:t&&t.key;e&&this.setLocalActionForKey(e,!0)}keyUpHandler(t){if(this.disableInput)return;let e=typeof t=="string"?t:t&&t.key;e&&this.setLocalActionForKey(e,!1)}loadImage(t){this.img=t}originalMovement(){let t=this.move_speed;this.upPressed&&this.tryMovingTo([this.x,this.y-t]),this.rightPressed&&this.tryMovingTo([this.x+t,this.y]),this.downPressed&&this.tryMovingTo([this.x,this.y+t]),this.leftPressed&&this.tryMovingTo([this.x-t,this.y])}onBulletHit(){this.destroy()}destroy(){this.is_dead=!0,this.maze.tankDestroyed()}restart(){this.is_dead=!1;let t=this.maze.getRandomSquare().getCenter();this.x=t[0],this.y=t[1],this.bullets=[],this.fireWasActive=!1,this.localInput=te(),this.networkInput=te(),this.syncDerivedInput(),this.removeAllPowerups()}addPowerup(t){this.removeAllPowerups(),this.powerups.push(t),t.effect(this),this.pendingPowerupUpdates=!0}removePowerup(t){let e=this.powerups.indexOf(t);if(e!==-1){try{t&&t.timeout&&(clearTimeout(t.timeout),t.timeout=null)}catch{}t.undo(this),typeof t.notifyDeactivate=="function"&&t.notifyDeactivate(this),this.powerups.splice(e,1),this.pendingPowerupUpdates=!0}}removeAllPowerups(){this.powerups.slice().forEach(t=>{t.tank.removePowerup(t)})}removeBullet(t){Xe(t,this.bullets)}},Ce=Se;var Ht=null,xt=null,ri=!1,kt=null,V=null;function ee(){Ht||(Ht=document.getElementById("pregame-overlay")),xt||(xt=document.getElementById("pregame-inner"))}function bt(s){ee(),Ht&&Ht.classList.toggle("hidden",!s)}function si(){ee(),xt&&xt.replaceChildren()}function ni(s){return s?`${s.text||""}${s.value||""}`:""}function ai(s,t){V&&V!==t&&V.classList.remove("pg-control--active"),kt=s||null,V=t||null,V&&V.classList.add("pg-control--active")}function br(s,t){!kt||kt!==s||(V&&V!==t&&V.classList.remove("pg-control--active"),V=t,V.classList.add("pg-control--active"))}function Ee(){ai(null,null)}function Pr(s){ri||(document.addEventListener("keydown",t=>{if(!kt)return;t.stopPropagation(),t.preventDefault();let e=t.key;try{kt.value=e,V&&(V.textContent=ni(kt)),s&&typeof s.emitTankConfig=="function"&&s.emitTankConfig()}catch{}Ee()},!0),ri=!0)}function Ir(s,t){if(!t)return"default";let i=(s&&s.colour_templates||[]).findIndex(r=>typeof r=="string"&&r.toLowerCase()===t.toLowerCase());return i===-1?"default":String(i)}function Sr(s,t){let e=document.createElement("section");e.className="pg-card pg-card--start";let i=document.createElement("h2");i.className="pg-card__title",i.textContent="Pregame",e.appendChild(i);let r=document.createElement("p");r.className="pg-card__description",r.textContent="Configure tanks, adjust settings, and start the match when you're ready.",e.appendChild(r);let n=document.createElement("div");n.className="pg-action-list",e.appendChild(n);let a=s.start_panel;function o(h,l,c=""){let p=document.createElement("button");return p.type="button",p.className=c?`pg-btn ${c}`:"pg-btn",p.textContent=h,p.addEventListener("click",l),n.appendChild(p),p}o("Start",()=>{a&&typeof a.start=="function"&&a.start.call(s)},"pg-btn--primary"),o("Add Tank",()=>{let h=s.tank_panels.length,l=s.colour_templates||[],c=s.controls_templates||[],p=l[h%l.length]||l[0]||"#63C132",d=c[h%c.length]||c[0]||["ArrowUp","ArrowRight","ArrowDown","ArrowLeft","1","2"];s.addTankPanel(new zt(s,p,d))}),o("Settings",()=>{s.showSettingsPanel()}),o("Networking",()=>{let h=s&&s.game&&s.game.networking;h&&typeof h.showConnectOverlay=="function"&&h.showConnectOverlay()}),t.appendChild(e)}function Cr(s,t){let e=document.createElement("section");e.className="pg-tank-stack";let i=document.createElement("div");i.className="pg-stack-header",i.textContent="Tanks",e.appendChild(i);let r=document.createElement("div");r.className="pg-tank-grid",e.appendChild(r);let n=s.tank_panels||[];if(!n.length){let o=document.createElement("p");o.className="pg-empty-state",o.textContent="Click \u201CAdd Tank\u201D to configure local players.",r.appendChild(o),t.appendChild(e);return}let a=["Up","Right","Down","Left","Attack","Special"];n.forEach((o,h)=>{let l=document.createElement("article");l.className="pg-card pg-tank";let c=Ir(s,o.colour);l.dataset.palette=c;let p=document.createElement("header");p.className="pg-tank__title";let d=document.createElement("span");d.className="pg-tank__swatch",p.appendChild(d);let f=document.createElement("span");f.textContent=`Tank ${h+1}`,p.appendChild(f),l.appendChild(p);let y=document.createElement("div");y.className="pg-control-list",l.appendChild(y);for(let _=0;_<a.length;_++){let v=o.buttons[1+_],b=document.createElement("button");b.type="button",b.className="pg-control",b.dataset.role=a[_].toLowerCase(),b.textContent=ni(v),b.title="Click, then press a key",b.addEventListener("click",P=>{P.preventDefault(),P.stopPropagation(),v&&typeof v.onclick=="function"?v.onclick():s&&(s.focus=v),ai(v,b)}),y.appendChild(b),br(v,b)}let m=document.createElement("div");m.className="pg-tank__footer";let w=document.createElement("button");w.type="button",w.className="pg-btn pg-btn--danger",w.textContent="Delete Tank",w.addEventListener("click",_=>{_.preventDefault(),kt&&kt.panel===o&&Ee(),s.removeTankPanel(o)}),m.appendChild(w),l.appendChild(m),r.appendChild(l)}),t.appendChild(e)}function Wt(s){if(ee(),!Ht||!xt)return;Pr(s),si();let t=document.createElement("div");t.className="pg-main-layout",Sr(s,t),Cr(s,t),xt.appendChild(t)}function oi(s){if(ee(),!Ht||!xt)return;Ee(),si();let t=s.settings,e=document.createElement("div");e.className="pg-settings-layout";let i=document.createElement("section");i.className="pg-card pg-card--settings";let r=document.createElement("h2");r.className="pg-card__title",r.textContent="Settings",i.appendChild(r);let n=document.createElement("div");n.className="pg-setting-list",i.appendChild(n),(t.buttons||[]).forEach(l=>{if(!l||l===t.back)return;let c=document.createElement("label");c.className="pg-setting";let p=document.createElement("span");if(p.className="pg-setting__label",p.textContent=l.text||"",c.appendChild(p),(l.text||"").toLowerCase().includes("friendly fire")){c.classList.add("pg-setting--toggle");let d=document.createElement("input");d.type="checkbox",d.checked=(l.value||"").toString().toLowerCase()==="true",d.addEventListener("change",()=>{l.value=d.checked?"true":"false"}),c.appendChild(d)}else{let d=document.createElement("input");d.type="text",d.value=(l.value||"").toString(),d.addEventListener("input",()=>{l.value=d.value}),c.appendChild(d)}n.appendChild(c)});let o=document.createElement("div");o.className="pg-settings__footer";let h=document.createElement("button");h.type="button",h.className="pg-btn pg-btn--primary",h.textContent=t.back&&t.back.text?t.back.text:"Back",h.addEventListener("click",()=>{if(t.save()===!1){h.textContent=t.back&&t.back.text?t.back.text:"Back";return}s.showMainPanels()}),o.appendChild(h),i.appendChild(o),e.appendChild(i),xt.appendChild(e)}var Be=class extends Ut{constructor(t,e){super(t),this.pregame=e,this.west_border=5,this.east_border=5;var i=new rt(this,0,0,"Start");i.onclick=this.start.bind(this.pregame),i.center_horizontally(),i.y=S.height*9/20,this.addButton(i);var r=new rt(this,0,0,"Add Tank");r.onclick=function(){var o=this.panel.pregame,h=o.tank_panels.length;o.addTankPanel(new zt(o,o.colour_templates[h],o.controls_templates[h]))},r.y=S.height*11/20,r.center_horizontally(),this.addButton(r);var n=new rt(this,0,0,"Settings");n.onclick=function(){this.pregame.showSettingsPanel()}.bind(this),n.y=S.height*13/20,n.center_horizontally(),this.addButton(n);var a=new rt(this,0,0,"Networking");a.onclick=function(){this.pregame.game&&this.pregame.game.networking&&(this.pregame.game.networking.showConnectOverlay(),g&&typeof g.emitPlayerList=="function"&&g.emitPlayerList())}.bind(this),a.y=S.height*15/20,a.center_horizontally(),this.addButton(a)}start(){if(this.pregame&&this.pregame.game&&this.pregame.game.networking)try{this.pregame.game.networking.disableOverlay()}catch{}if(g&&g.connections&&g.connections.length>0&&!g.isHost){J("* Only the host can start the match.","notification-message");return}var t=this.game.maze;this.game.main_object=t,typeof t.beginGameplay=="function"&&t.beginGameplay();try{Et(!0),Bt()}catch{}try{bt(!1)}catch{}t.hostOwned=!0;for(var e=[],i=g&&g.id?g.id:"local",r=0;r<this.tank_panels.length;r++){var n=this.tank_panels[r],a=n.buttons,o=[a[1].value,a[2].value,a[3].value,a[4].value,a[5].value,a[6].value],h=t.getRandomSquare().getCenter(),l=new Ce(0,0,t,o,n.colour);l.id=i+"-"+(n.panelId||"tank-"+r),l.ownerPeerId=i;var c=document.getElementById("tank");c&&c.tagName==="IMG"&&c.complete&&c.naturalWidth>0&&l.loadImage(c),t.registerTank&&t.registerTank(l),t.placeObject(l),e.push({id:l.id,colour:l.colour,controls:o,ownerPeerId:i,score:l.score,x:l.x,y:l.y,rotation:l.rotation,width:l.width,height:l.height})}if(g&&g.isHost){var p=g.remoteTankConfigs||{};Object.keys(p).forEach(function(d){!p[d]||p[d].length===0||d!==i&&p[d].forEach(function(f,y){var m=f.controls&&f.controls.length?f.controls:["w","d","s","a","f","g"],w=new Ce(0,0,t,m,f.colour||"#cccccc",{disableInput:!0});w.id=d+"-"+(f.panelId||"tank-"+y),w.ownerPeerId=d,w.score=f.score||0;var _=document.getElementById("tank");_&&w.loadImage(_),t.registerTank&&t.registerTank(w),t.placeObject(w),e.push({id:w.id,colour:w.colour,controls:m,ownerPeerId:d,score:w.score,x:w.x,y:w.y,rotation:w.rotation,width:w.width,height:w.height})})})}if(g&&g.isHost&&g.connections&&g.connections.length>0){if(typeof t.serializeInitString=="function")try{g.broadcast(t.serializeInitString())}catch{}g.maybeEmitReady&&g.maybeEmitReady("host-start")}}},hi=Be;var Te=class extends Lt{constructor(t,e,i,r,n="",a){super(t,e,i,r,n),this.attribute_name=a;var o=this.panel.pregame.game,h=o.maze&&o.maze.settings?o.maze.settings:{};this.value=(a in h?h[a]:"").toString()}keyDownHandler(t){if(t=="Backspace"){this.value=this.value.slice(0,-1);return}if(t=="Enter"){this.panel.pregame.focus=this.panel.back;return}this.value+=t}onclick(){this.panel.pregame.focus=this,this.value=""}},li=Te;var Ae=class extends Ut{constructor(t){super("Green"),this.width=S.width,this.pregame=t,this.settings=[["Number of Rows","num_of_rows"],["Number of Columns","num_of_columns"],["Movement Speed","move_speed"],["Friendly Fire","friendly_fire"],["Number of Bullets","bullet_limit"],["Time Between Powerups (s)","powerup_interval"],["Max powerups on screen","powerup_limit"],["Duration of powerups (s)","powerup_duration"]],this.settings.forEach(function(n){this.make_button(n)}.bind(this)),this.addBackButton();for(var e=this.buttons.length,i=0;i<e;i++){var r=this.buttons[i];r.y=S.height*4/5/(e-1)*i+r.height,r.resize_horiontals()}}addBackButton(){var t=new rt(this,0,0,"Back");this.back=t,t.y=S.height*5/6,t.update(),t.onclick=function(){var e=this.save();e&&this.pregame.showMainPanels()}.bind(this),t.keyDownHandler=function(e){e=="Enter"&&this.panel.pregame.focus==this&&this.onclick()},this.addButton(t)}save(){for(var t=this.back,e=[0,1,4,6],i=[2,5,7],r=0;r<e.length;r++){var n=this.buttons[e[r]];if(!this.isPosInt(n.value))return t.text="x must be positive Integer".replace("x",n.text).replace(":",""),!1;var a=n.panel.pregame.game,o=n.attribute_name,h=n.value,l=["num_of_rows","num_of_columns","bullet_limit","powerup_limit","seconds_between_rounds"],c=["move_speed","rotation_speed","bullet_speed","powerup_interval","powerup_duration"],p=h;l.indexOf(o)!==-1&&(p=parseInt(h,10)),c.indexOf(o)!==-1&&(p=parseFloat(h)),a.maze.settings[o]=p}for(var r=0;r<i.length;r++){var n=this.buttons[i[r]];if(!this.isPosNumber(n.value))return t.text="x must be positive Integer".replace("x",n.text).replace(":",""),!1;var d=n.panel.pregame.game,f=n.attribute_name;d.maze.settings[f]=parseFloat(n.value)}var y=this.buttons[3];return this.pregame.game.maze.settings.friendly_fire=y.value=="true",t.text="Back",!0}isPosInt(t){if(isNaN(t))return!1;var e=parseFloat(t);return!(!Number.isInteger(e)||e<0)}isPosNumber(t){if(isNaN(t))return!1;var e=parseFloat(t);return!(e<=0)}make_button(t){var e=t[0],i=t[1];this[i]=new li(this,0,0,e,"",i),t[0]=="Friendly Fire"&&(this[i].onclick=function(){this.panel.pregame.focus=this,this.value=="true"?this.value="false":this.value="true"})}},ci=Ae;var ie=class{constructor(t,e){this.game=t,this.height=S.height,this.width=S.width,this.root=new Nt({x:0,y:0,width:this.width,height:this.height}),this.focus=null,this.start_panel=new hi("red",this),this.tank_panels=[],this.settings=new ci(this),this.current_panels=[],this.colour_templates=["#63C132","#FFAD69","#54F2F2","#D90429","#04A777","#042A2B","#6D98BA","#D3B99F","#1E3888","#1282A2","#D90368"],this.controls_templates=[["ArrowUp","ArrowRight","ArrowDown","ArrowLeft","1","2"],["w","d","s","a","f","g"],["y","j","h","g","k","l"]],this.showMainPanels(),this.updatePanelHorizontals(),this.ensureDefaultTank();try{bt(!0),Wt(this)}catch{}}main(){}draw(){}syncRootWithPanels(t){this.current_panels=t,this.root.setChildren(t)}showMainPanels(){this.focus=null,this.syncRootWithPanels([this.start_panel].concat(this.tank_panels));try{bt(!0),Wt(this)}catch{}}showSettingsPanel(){this.focus=null,this.syncRootWithPanels([this.settings]);try{bt(!0),oi(this)}catch{}}addTankPanel(t){this.tank_panels.push(t),this.showMainPanels(),this.updatePanelHorizontals(),this.emitTankConfig();try{Wt(this)}catch{}}removeTankPanel(t){this.tank_panels.splice(this.tank_panels.indexOf(t),1),this.showMainPanels(),this.updatePanelHorizontals(),this.emitTankConfig();try{Wt(this)}catch{}}updatePanelHorizontals(){(this.tank_panels||[]).forEach(function(t){!t||!Array.isArray(t.buttons)||(t.buttons.forEach(function(e){e&&typeof e.update=="function"&&e.update()}),t.east_border=5/2)}),this.tank_panels.length>0&&(this.tank_panels[this.tank_panels.length-1].east_border=5)}onclick(t,e){this.button_has_been_found=!1;for(var i=this.current_panels||[],r=0;r<i.length&&!this.button_has_been_found;r++)for(var n=i[r],a=n.buttons||[],o=0;o<a.length&&!this.button_has_been_found;o++){var h=a[o],l=[t,e,1,1],c=h.get_as_Rect?h.get_as_Rect():[h.x,h.y,h.width,h.height],p=typeof ft=="function"?ft(l,c):t>=h.x&&e>=h.y&&t<=h.x+h.width&&e<=h.y+h.height;p&&(this.button_has_been_found=!0,typeof h.onclick=="function"&&h.onclick())}}keyDownHandler(t){this.focus!=null&&this.focus.keyDownHandler(t)}emitTankConfig(){if(typeof g.sendTankConfig=="function"){var t=this.getTankPanelConfigs();g.sendTankConfig(t)}}getTankPanelConfigs(){return this.tank_panels.map(function(t,e){var i=t.buttons.filter(function(r){return r instanceof Lt}).map(function(r){return r.value||""});return{panelId:t.panelId||"panel-"+e,colour:t.colour,controls:i}})}ensureDefaultTank(){if(this.tank_panels.length===0){var t=this.colour_templates[0]||"#63C132",e=this.controls_templates[0]||["ArrowUp","ArrowRight","ArrowDown","ArrowLeft","1","2"];this.addTankPanel(new zt(this,t,e))}}};var re=class{constructor(){this.maze=new Zt(this);try{window.__mazeRef=this.maze}catch{}this.pregame=new ie(this,S.height*3/4),this.networking=new K(this),this.main_object=this.pregame,this.clientControlMap={},this.clientInputState={},this.clientInputHandlers=null,this.clientInputBound=!1;try{Et(!1)}catch{}try{Ke()}catch{}}main(){this.main_object.main()}onclick(t,e){this.main_object.onclick(t,e)}keyDownHandler(t){this.main_object.keyDownHandler(t)}keyUpHandler(t){this.main_object&&typeof this.main_object.keyUpHandler=="function"&&this.main_object.keyUpHandler(t)}startFromHostCompact(t){this.pregame.focus=null,this.networking&&this.networking.hideOverlay(),this.maze&&typeof this.maze.applyInitString=="function"&&this.maze.applyInitString(t);try{u.setTransform(1,0,0,1,0,0),u.clearRect(0,0,S.width,S.height)}catch{}this.maze.spectator=!0,this.main_object=this.maze,this.maze.beginGameplay&&this.maze.beginGameplay();try{Et(!0),Bt(),bt(!1)}catch{}this.setupClientControllers({tanks:this.maze.remoteTankMeta})}updateStateFromHostCompact(t){!t||!this.maze||typeof this.maze.applyDeltaString!="function"||this.maze.applyDeltaString(t)}setupClientControllers(t){this.unregisterClientInputRelay(),this.clientControlMap={},this.clientInputState={};var e=g;if(!e||e.isHost||!e.id){this.clientInputBound=!1;return}for(var i=e.id,r=t&&t.tanks?t.tanks:[],n=[{action:"up",payloadKey:"upPressed"},{action:"right",payloadKey:"rightPressed"},{action:"down",payloadKey:"downPressed"},{action:"left",payloadKey:"leftPressed"},{action:"fire",payloadKey:"shooting"},{action:"special",payloadKey:"specialKeyPressed"}],a=!1,o=e&&e.localTankConfigs?e.localTankConfigs.slice():[],h=new Set,l=0;l<r.length;l++){var c=r[l],p=c&&c.ownerPeerId?c.ownerPeerId:null;if(!p&&c&&c.id&&i&&c.id.indexOf(i+"-")===0&&(p=i),p===i){a=!0,this.clientInputState[c.id]={upPressed:!1,rightPressed:!1,downPressed:!1,leftPressed:!1,shooting:!1,specialKeyPressed:!1};var d=Array.isArray(c.controls)?c.controls.slice():null;if(!d||d.length===0){for(var f=c&&c.id?c.id.substring((i+"-").length):"",y=-1,m=0;m<o.length;m++){var w=o[m];if(!h.has(m)&&w&&w.panelId&&f&&w.panelId===f){y=m;break}}if(y===-1){for(var _=0;_<o.length;_++)if(!h.has(_)){y=_;break}}y>=0&&o[y]&&Array.isArray(o[y].controls)&&(d=o[y].controls.slice(),h.add(y))}d=Array.isArray(d)?d:[];for(var v=0;v<d.length&&v<n.length;v++){var b=d[v];b&&(this.clientControlMap[b]={tankId:c.id,action:n[v].action,payloadKey:n[v].payloadKey})}}}a?this.registerClientInputRelay():this.clientInputBound=!1}registerClientInputRelay(){this.clientInputBound||(this.clientInputHandlers={keydown:this.handleClientKeyDown.bind(this),keyup:this.handleClientKeyUp.bind(this)},document.addEventListener("keydown",this.clientInputHandlers.keydown,!0),document.addEventListener("keyup",this.clientInputHandlers.keyup,!0),this.clientInputBound=!0)}unregisterClientInputRelay(){!this.clientInputBound||!this.clientInputHandlers||(document.removeEventListener("keydown",this.clientInputHandlers.keydown,!0),document.removeEventListener("keyup",this.clientInputHandlers.keyup,!0),this.clientInputHandlers=null,this.clientInputBound=!1)}handleClientKeyDown(t){var e=g;if(!(!e||e.isHost)&&!ui()){var i=this.clientControlMap[t.key];if(i){var r=this.clientInputState[i.tankId];if(r){var n=this.setInputStateFlag(r,i.payloadKey,!0);n&&this.queueInputSend(i.tankId),t.key.indexOf("Arrow")===0&&t.preventDefault()}}}}handleClientKeyUp(t){var e=g;if(!(!e||e.isHost)&&!ui()){var i=this.clientControlMap[t.key];if(i){var r=this.clientInputState[i.tankId];if(r){var n=this.setInputStateFlag(r,i.payloadKey,!1);n&&this.queueInputSend(i.tankId)}}}}setInputStateFlag(t,e,i){return t[e]===i?!1:(t[e]=i,!0)}queueInputSend(t){var e=g;if(!(!e||!e.sendInputState)){var i=this.clientInputState[t];i&&e.sendInputState({tankId:t,upPressed:!!i.upPressed,downPressed:!!i.downPressed,leftPressed:!!i.leftPressed,rightPressed:!!i.rightPressed,shooting:!!i.shooting,specialKeyPressed:!!i.specialKeyPressed})}}};function ui(){try{var s=document&&document.activeElement?document.activeElement:null;if(!s)return!1;var t=(s.tagName||"").toLowerCase();if(t==="input"||t==="textarea"||s.isContentEditable)return!0}catch{}return!1}var Pt=new re;g.game=Pt;function di(){Pt.main_object!==Pt.maze&&u.setTransform(1,0,0,1,0,0),Pt.main(),requestAnimationFrame(di)}function Er(){S.addEventListener("click",function(s){let t=S.getBoundingClientRect(),e=he/t.width,i=le/t.height,r=(s.clientX-t.left)*e,n=(s.clientY-t.top)*i;Pt.onclick(r,n)},!1),addEventListener("keydown",function(s){Pt.keyDownHandler(s.key)},!1),addEventListener("keyup",function(s){typeof Pt.keyUpHandler=="function"&&Pt.keyUpHandler(s.key)},!1),di()}Er();})();
//# sourceMappingURL=bundle.js.map
