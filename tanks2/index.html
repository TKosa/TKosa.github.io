<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tanks2</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { background: #fff; }
    /* Let JS control canvas CSS size for aspect-preserving letterboxing */
    #myCanvas { display: block; }
    /* Stage wraps canvas so overlays can size via CSS */
    .game-stage { position: relative; display: inline-block; line-height: 0; }
    .pregame-overlay { position: absolute; inset: 0; z-index: 20; pointer-events: auto; display: flex; align-items: center; justify-content: center; background: rgba(8, 16, 32, 0.58); backdrop-filter: blur(2px); }
    .pregame-overlay.hidden { display: none; }
    .pg-inner { width: 100%; height: 100%; padding: 32px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; font-family: system-ui, sans-serif; color: var(--net-text); pointer-events: auto; overflow: auto; }
    /* Simple HUD scoreboard overlay aligned to canvas top */
    .hud-scoreboard { position: fixed; z-index: 10; left: 0; top: 0; width: 0; height: 0; pointer-events: auto; }
    /* Disable clicks by default, re-enable for specific controls */
    .hud-scoreboard * { pointer-events: none; }
    .hud-scoreboard.hidden { display: none; }
    .hud-scoreboard .sb-inner { position: relative; width: 100%; height: 100%; box-sizing: border-box; background: rgba(160,160,160,0.92); border: 1px solid #808080; border-radius: 6px; padding: 6px 72px 6px 10px; display: flex; align-items: stretch; justify-content: flex-start; font-family: Verdana, system-ui, sans-serif; }
    /* Equal columns that stretch edge-to-edge; leftmost at 0%, rightmost at 100% */
    .hud-scoreboard .sb-players { display: grid; grid-auto-flow: column; grid-auto-columns: minmax(0, 1fr); align-items: end; width: 100%; height: 100%; pointer-events: none; column-gap: 0; justify-content: stretch; }
    .hud-scoreboard .sb-player { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; gap: 2px; color: #111; font-weight: 600; font-size: 18px; }
    .hud-scoreboard .sb-row { display: flex; align-items: center; gap: 6px; }
    .hud-scoreboard .sb-tank { width: 18px; height: 18px; object-fit: contain; image-rendering: auto; filter: drop-shadow(0 1px 0 rgba(0,0,0,0.35)); }
    .hud-scoreboard .sb-icon { width: 18px; height: 18px; object-fit: contain; image-rendering: auto; filter: drop-shadow(0 1px 0 rgba(0,0,0,0.5)); transform: translateX(8px); }
    /* Network button: icon-only, transparent, at far right */
    .hud-scoreboard .sb-network {
      position: absolute;
      right: 6px;
      top: 6px;
      pointer-events: auto;
      cursor: pointer;
      user-select: none;
      background: transparent;
      border: none;
      padding: 0;
      line-height: 0; /* tighten button box around icon */
    }
    .hud-scoreboard .sb-network, .hud-scoreboard .sb-network * { pointer-events: auto; }
    .hud-scoreboard .sb-network img { width: 22px; height: 22px; display: block; }
    /* Test button: shifted left enough to avoid overlap with network icon */
    .hud-scoreboard .sb-test {
      position: absolute;
      right: 36px; /* icon(22) + gap(14) */
      top: 6px;
      height: 22px;
      padding: 0 6px;
      font-size: 12px;
      border: 1px solid #2b5b8e;
      background: #133055;
      color: #e8f2ff;
      border-radius: 4px;
      cursor: pointer;
    }
    .hud-scoreboard .sb-test:hover { background: #1a3b66; }
    .hud-scoreboard .sb-test, .hud-scoreboard .sb-test * { pointer-events: auto; }
  </style>
  <!-- PeerJS (global UMD build) -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script type="module" src="js/main.js"></script>
</head>
<body>
  <div id="app-shell">
    <div id="game-slot">
      <div id="game-stage" class="game-stage">
        <canvas id="myCanvas" width="1280" height="720"></canvas>
        <!-- Pregame UI overlay (HTML panels instead of canvas drawing) -->
        <div id="pregame-overlay" class="pregame-overlay hidden">
          <div class="pg-inner" id="pregame-inner"></div>
        </div>
      </div>
      <div id="networking-chat-panel" class="net-panel hidden">
        <div id="chat-resize-handle" aria-hidden="true"></div>
        <div id="chat">
          <div id="chat-messages"></div>
          <div id="chat-input">
            <input id="chat-message-input" type="text" placeholder="Type a message" />
            <button id="chat-send-btn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Pregame overlay styles continued: panel look -->
  <style>
    .pg-main-layout { display: flex; flex-direction: row; gap: 24px; width: 100%; max-width: min(1100px, 94vw); align-items: stretch; }
    .pg-card { flex: 0 0 auto; background: var(--net-bg); border: 1px solid var(--net-border); box-shadow: 0 0 0 1px var(--net-border), 0 12px 32px rgba(8, 0, 32, 0.45), inset 0 0 40px rgba(0,0,0,0.35); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 16px; box-sizing: border-box; min-height: 0; }
    .pg-card__title { margin: 0; font-size: 20px; font-weight: 600; letter-spacing: 0.4px; color: var(--net-accent); }
    .pg-card__description { margin: 0; font-size: 14px; line-height: 1.4; color: var(--net-muted); }
    .pg-action-list { display: flex; flex-direction: column; gap: 12px; margin-top: auto; }
    .pg-btn { display: inline-flex; align-items: center; justify-content: center; width: 100%; padding: 10px 14px; font: 14px/1.2 system-ui, sans-serif; border-radius: 8px; border: 1px solid var(--net-btn-border); background: var(--net-btn-bg); color: var(--net-text); cursor: pointer; transition: background 140ms ease, transform 140ms ease, border-color 140ms ease; box-sizing: border-box; }
    .pg-btn:hover { background: var(--net-btn-hover); transform: translateY(-1px); }
    .pg-btn--primary { background: linear-gradient(180deg, rgba(37, 98, 168, 0.85), rgba(20, 58, 105, 0.95)); border-color: #4e8de0; box-shadow: 0 0 0 1px rgba(78, 141, 224, 0.35); }
    .pg-btn--primary:hover { background: linear-gradient(180deg, rgba(62, 128, 206, 0.9), rgba(33, 86, 158, 0.95)); }
    .pg-btn--danger { background: linear-gradient(180deg, rgba(166, 44, 60, 0.9), rgba(102, 26, 36, 0.95)); border-color: #c03a4f; color: #ffe7ec; }
    .pg-btn--danger:hover { background: linear-gradient(180deg, rgba(186, 64, 80, 0.95), rgba(124, 32, 44, 0.95)); }
    .pg-card--start { flex: 0 0 260px; max-width: 280px; gap: 20px; }
    .pg-tank-stack { flex: 1 1 auto; display: flex; flex-direction: column; gap: 18px; min-height: 0; }
    .pg-stack-header { font-size: 18px; font-weight: 600; letter-spacing: 0.4px; color: var(--net-accent); margin: 4px 0 0; }
    .pg-tank-grid { flex: 1 1 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; padding-right: 4px; overflow-y: auto; align-content: start; }
    .pg-empty-state { margin: 0 auto; font-size: 14px; color: var(--net-muted); padding: 12px 0; text-align: center; }
    .pg-card.pg-tank { position: relative; padding: 16px; gap: 12px; border: 2px solid var(--tank-border, rgba(75, 125, 182, 0.9)); background: linear-gradient(180deg, rgba(13, 28, 52, 0.88), rgba(9, 20, 40, 0.94)); overflow: hidden; }
    .pg-card.pg-tank::before { content: ''; position: absolute; inset: -40% -40% auto; height: 70%; background: radial-gradient(circle at top, var(--tank-glow, rgba(159, 209, 255, 0.2)) 0%, transparent 70%); opacity: 0.85; pointer-events: none; }
    .pg-card.pg-tank > * { position: relative; z-index: 1; }
    .pg-tank__title { margin: 0; font-size: 15px; font-weight: 600; letter-spacing: 0.3px; display: flex; align-items: center; gap: 10px; }
    .pg-tank__swatch { width: 16px; height: 16px; border-radius: 999px; background: var(--tank-border, #4e8de0); border: 2px solid rgba(255,255,255,0.35); box-shadow: 0 0 0 1px rgba(0,0,0,0.25); flex: 0 0 auto; }
    .pg-control-list { display: flex; flex-direction: column; gap: 8px; }
    .pg-control { display: flex; align-items: center; justify-content: center; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--net-input-border); background: rgba(16, 33, 60, 0.85); color: var(--net-text); font: 13px/1.2 system-ui, sans-serif; cursor: pointer; transition: border-color 140ms ease, background 140ms ease, transform 140ms ease, box-shadow 140ms ease; }
    .pg-control:hover { border-color: var(--net-btn-border); background: rgba(28, 56, 92, 0.9); transform: translateY(-1px); }
    .pg-control--active { border-color: var(--net-accent); box-shadow: 0 0 0 1px rgba(159, 209, 255, 0.45), 0 0 12px rgba(159, 209, 255, 0.3); background: rgba(30, 70, 120, 0.85); }
    .pg-tank__footer { display: flex; justify-content: flex-end; margin-top: auto; }
    .pg-settings-layout { display: flex; width: 100%; justify-content: center; }
    .pg-card--settings { width: min(640px, 90%); gap: 20px; }
    .pg-setting-list { display: flex; flex-direction: column; gap: 12px; }
    .pg-setting { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--net-input-border); background: rgba(12, 28, 52, 0.72); font: 14px/1.3 system-ui, sans-serif; color: var(--net-text); }
    .pg-setting__label { flex: 1 1 auto; margin-right: 12px; }
    .pg-setting input[type="text"] { flex: 0 1 180px; min-width: 140px; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--net-input-border); background: var(--net-input-bg); color: var(--net-text); font: 14px/1.2 system-ui; outline: none; text-align: right; transition: border-color 120ms ease, background 120ms ease; }
    .pg-setting input[type="text"]:focus { border-color: var(--net-accent); background: rgba(28, 56, 92, 0.9); }
    .pg-setting--toggle { cursor: pointer; }
    .pg-setting--toggle input { width: 20px; height: 20px; accent-color: var(--net-accent); cursor: pointer; }
    .pg-setting--toggle input:focus-visible { outline: 2px solid var(--net-accent); outline-offset: 2px; }
    .pg-settings__footer { display: flex; justify-content: flex-end; margin-top: auto; }
    .pg-inner::-webkit-scrollbar { width: 10px; }
    .pg-inner::-webkit-scrollbar-thumb { background: rgba(112, 135, 168, 0.4); border-radius: 6px; }
    .pg-inner::-webkit-scrollbar-track { background: rgba(10, 22, 46, 0.35); }
    .pg-card.pg-tank[data-palette="0"] { --tank-border: #63C132; --tank-glow: rgba(99, 193, 50, 0.28); }
    .pg-card.pg-tank[data-palette="1"] { --tank-border: #FFAD69; --tank-glow: rgba(255, 173, 105, 0.32); }
    .pg-card.pg-tank[data-palette="2"] { --tank-border: #54F2F2; --tank-glow: rgba(84, 242, 242, 0.32); }
    .pg-card.pg-tank[data-palette="3"] { --tank-border: #D90429; --tank-glow: rgba(217, 4, 41, 0.42); }
    .pg-card.pg-tank[data-palette="4"] { --tank-border: #04A777; --tank-glow: rgba(4, 167, 119, 0.32); }
    .pg-card.pg-tank[data-palette="5"] { --tank-border: #042A2B; --tank-glow: rgba(4, 42, 43, 0.45); }
    .pg-card.pg-tank[data-palette="6"] { --tank-border: #6D98BA; --tank-glow: rgba(109, 152, 186, 0.3); }
    .pg-card.pg-tank[data-palette="7"] { --tank-border: #D3B99F; --tank-glow: rgba(211, 185, 159, 0.35); }
    .pg-card.pg-tank[data-palette="8"] { --tank-border: #1E3888; --tank-glow: rgba(30, 56, 136, 0.38); }
    .pg-card.pg-tank[data-palette="9"] { --tank-border: #1282A2; --tank-glow: rgba(18, 130, 162, 0.34); }
    .pg-card.pg-tank[data-palette="10"] { --tank-border: #D90368; --tank-glow: rgba(217, 3, 104, 0.38); }
    .pg-card.pg-tank[data-palette="default"] { --tank-border: #4e8de0; --tank-glow: rgba(78, 141, 224, 0.32); }
    @media (max-width: 960px) {
      .pg-main-layout { flex-direction: column; }
      .pg-card--start { width: 100%; max-width: none; }
    }
    @media (max-width: 720px) {
      .pg-tank-grid { grid-template-columns: minmax(220px, 1fr); }
    }
  </style>
  
  <!-- HTML HUD scoreboard overlay (only visible during gameplay) -->
  <div id="hud-scoreboard" class="hud-scoreboard hidden">
    <div class="sb-inner">
      <div class="sb-players"></div>
      <!-- <button class="sb-test" type="button" title="Flatten walls + regen powerups">Test</button> -->
      <button class="sb-network" type="button" title="Network Stats">
        <img src="res/ui/network.png" alt="network" />
      </button>
    </div>
  </div>
  <!-- Networking overlays UI -->
  <style>
    /* Theme */
    :root {
      --net-bg: rgba(10, 22, 46, 0.92);
      --net-overlay-tint: rgba(8, 16, 32, 0.6);
      --net-border: #214d7a;
      --net-glow: rgba(79, 181, 255, 0.35);
      --net-accent: #9fd1ff;
      --net-text: #e8f2ff;
      --net-muted: #9bb3cd;
      --net-input-bg: #0f223f;
      --net-input-border: #2b4e76;
      --net-btn-bg: #133055;
      --net-btn-border: #2b5b8e;
      --net-btn-hover: #1a3b66;
      --net-chat-self: #62e0a1;
      --net-chat-note: #8fb0d1;
    }

    /* Shared styles */
    .net-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: var(--net-overlay-tint); z-index: 1000; font-family: system-ui, sans-serif; color: var(--net-text); }
    .net-overlay.hidden { display: none !important; }
    .net-panel { position: relative; background: var(--net-bg); border: 1px solid var(--net-border); box-shadow: 0 0 0 1px var(--net-border), 0 8px 30px var(--net-glow), inset 0 0 40px rgba(0,0,0,0.35); width: min(860px, 92vw); max-height: 90vh; padding: 16px; overflow: auto; border-radius: 10px; }
    .net-panel h2 { margin: 0 0 8px 0; font-size: 18px; letter-spacing: 0.5px; color: var(--net-accent); }
    .net-status { margin: 4px 0 12px 0; font-size: 13px; color: var(--net-muted); white-space: pre-line; }
    .net-controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .net-controls input { padding: 8px 10px; border: 1px solid var(--net-input-border); border-radius: 6px; background: var(--net-input-bg); color: var(--net-text); outline: none; }
    .net-controls input::placeholder { color: #6d8db1; }
    .net-controls button { padding: 8px 12px; border: 1px solid var(--net-btn-border); background: var(--net-btn-bg); color: var(--net-text); border-radius: 6px; cursor: pointer; transition: background 120ms ease; }
    .net-controls button:hover { background: var(--net-btn-hover); }
    .net-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 12px; }
    #player-list { border: 1px solid var(--net-input-border); padding: 8px; min-height: 160px; background: rgba(8,20,40,0.6); margin: 0; list-style: none; border-radius: 6px; }
    #player-list li { padding: 6px 4px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    #player-list li:last-child { border-bottom: none; }
    #player-list .player-list-empty { color: var(--net-muted); font-style: italic; }
    .chat-message { margin: 2px 0; }
    .chat-message.notification-message { color: var(--net-chat-note); font-style: italic; }
    .chat-message.self-message { color: var(--net-chat-self); }
    .net-close { position: absolute; right: 16px; top: 16px; border: 1px solid var(--net-btn-border); background: var(--net-btn-bg); color: var(--net-text); border-radius: 6px; padding: 6px 10px; cursor: pointer; }
  </style>
  <!-- Connect overlay -->
  <div id="networking-connect-overlay" class="net-overlay hidden">
    <div id="networking-connect-panel" class="net-panel">
      <button id="networking-close-connect-btn" class="net-close">Close</button>
      <h2>Networking</h2>
      <div class="net-status"><span id="network-status-connect">Idle</span></div>
      <div class="net-controls">
        <input id="nickname" type="text" placeholder="Nickname" />
        <input id="room-name" type="text" placeholder="Room Name or Code" />
        <button id="host-room-btn">Host Room</button>
        <button id="join-room-btn">Join Room</button>
      </div>
    </div>
  </div>

  <!-- Chat/Lobby overlay -->
  <style>
    /* Right-docked chat panel: lives directly next to canvas */
    /* App shell: canvas and chat side-by-side */
    #app-shell { position: fixed; inset: 0; display: flex; flex-direction: row; align-items: center; }
    /* Game area flexes to fill remaining width beside chat */
    #game-slot { position: relative; flex: 1 1 auto; display: flex; align-items: center; justify-content: center; min-width: 0; }
    #myCanvas { display: block; max-width: 100%; max-height: 100%; }
    /* Right-side chat panel docks inside app shell (not overlay) */
    #networking-chat-panel {
      position: relative;
      /* Let CSS compute available height next to the canvas */
      height: -webkit-fill-available; /* Safari/Chrome */
      height: -moz-available;        /* Firefox */
      z-index: 1;
      padding: 0 12px; /* no vertical padding so outer height matches canvas exactly */
      display: flex;
      flex-direction: column;
      width: var(--chat-width, 0px);
      min-width: 0;
      overflow: hidden;
      transition: width 160ms ease;
      box-sizing: border-box;
      max-height: none;
      min-height: 0;
      border-left: 1px solid var(--net-border);
      height: webkit-fill-available; /* Safari */
    }
    #networking-chat-panel.hidden { display: none; }
    #networking-chat-panel.chat-open { --chat-width: min(34vw, 420px); }
    /* Drag handle at left edge */
    #chat-resize-handle { position: absolute; left: 0; top: 0; bottom: 0; width: 8px; cursor: col-resize; }
    #chat-resize-handle::after { content: ''; position: absolute; left: 2px; top: 0; bottom: 0; width: 2px; background: rgba(255,255,255,0.08); }
    /* Chat content fills remaining height; allow children to shrink for scrolling */
    #networking-chat-panel #chat { display: flex; flex-direction: column; flex: 1 1 auto; min-height: 0; min-width: 0; overflow: hidden; }
    /* Reuse theme for chat internals */
    #chat-messages { padding: 8px; flex: 1 1 auto; min-height: 0; min-width: 0; overflow-y: auto; overflow-x: hidden; background: rgba(8,20,40,0.6); color: var(--net-text); border: 1px solid var(--net-input-border); border-radius: 6px; word-break: break-word; overflow-wrap: anywhere; }
    #chat-input { display: flex; gap: 8px; margin-top: 8px; height: 41.6px; flex-shrink: 0; min-width: 0; overflow: hidden; }
    #chat-message-input { flex: 1 1 auto; min-width: 0; padding: 8px 10px; border: 1px solid var(--net-input-border); border-radius: 6px; background: var(--net-input-bg); color: var(--net-text); outline: none; }
    #chat-send-btn { flex: 0 0 auto; padding: 8px 12px; border: 1px solid var(--net-btn-border); background: var(--net-btn-bg); color: var(--net-text); border-radius: 6px; cursor: pointer; transition: background 120ms ease; }
    #chat-send-btn:hover { background: var(--net-btn-hover); }
  </style>
  

  <!-- Network stats overlay (gear button toggles this) -->
  <div id="net-stats-overlay" class="net-overlay hidden">
    <div class="net-panel">
      <button class="net-close" onclick="this.closest('.net-overlay').classList.add('hidden')">Close</button>
      <h2>Network Stats</h2>
      <div class="net-status"><span id="network-status">Idle</span></div>
    </div>
  </div>
  <!-- Hidden sprite assets referencing resources/ (provide your actual files) -->
  <img id="tank" alt="tank" style="display:none" src="res/tanks/tank1.png" />
  <img id="pills" alt="trippy" style="display:none" src="res/powerups/pills.png" />
  <img id="unlimited" alt="unlimited" style="display:none" src="res/powerups/unlimited.png" />
  <img id="tripleshot" alt="tripleshot" style="display:none" src="res/powerups/tripleshot.png" />
  <img id="ghost" alt="ghost" style="display:none" src="res/powerups/ghost.png" />
  <img id="teleport" alt="teleport" style="display:none" src="res/powerups/teleport.png" />
  <img id="cannonball" alt="cannonball" style="display:none" src="res/powerups/cannonball.png" />
  <img id="invisible" alt="invisible" style="display:none" src="res/powerups/invisible.png" />
  <img id="repel" alt="repel" style="display:none" src="res/powerups/repel.png" />
  <img id="hex" alt="hex" style="display:none" src="res/powerups/hex.png" />
  <img id="network-icon" alt="network" style="display:none" src="res/ui/network.png" />
</body>
</html>
